<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#020617">
    <meta name="description" content="Kala-SimuX Pro: The Ultimate Physics Engine">
    <link rel="icon" type="image/png" href="./Kala-SimuX.png">
    <link rel="manifest" href="manifest.json">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;500;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=JetBrains+Mono:wght@400;700&family=Noto+Sans+Devanagari:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    
    <title>Kala-SimuX Pro: Architect Edition</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Rajdhani', 'sans-serif'], 
                        display: ['Orbitron', 'sans-serif'], 
                        serif: ['Crimson Text', 'serif'], 
                        mono: ['JetBrains Mono', 'monospace'],
                        hindi: ['Noto Sans Devanagari', 'sans-serif'] 
                    },
                    colors: { cosmic: { 900: '#020617', 800: '#0f172a', 700: '#1e293b' } },
                    animation: { 'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite', 'spin-slow': 'spin 8s linear infinite', 'fade-in': 'fadeIn 0.3s ease-out' },
                    keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } }
                }
            }
        }
    </script>

    <style>
        /* CORE RESET */
        html, body { height: 100%; height: 100dvh; margin: 0; padding: 0; overflow: hidden; background-color: #020617; color: #e2e8f0; -webkit-tap-highlight-color: transparent; user-select: none; }
        #root { height: 100%; height: 100dvh; width: 100%; display: flex; flex-direction: column; }
        
        /* SCROLLBARS */
        .scroller { overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch; scroll-behavior: smooth; }
        .scroller::-webkit-scrollbar { width: 6px; }
        .scroller::-webkit-scrollbar-track { background: #0f172a; }
        .scroller::-webkit-scrollbar-thumb { background: #0ea5e9; border-radius: 3px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* GLASS UI */
        .glass-panel { background: rgba(15, 23, 42, 0.96); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .glass-card { background: linear-gradient(145deg, rgba(30, 41, 59, 0.4) 0%, rgba(15, 23, 42, 0.6) 100%); backdrop-filter: blur(12px); border: 1px solid rgba(148, 163, 184, 0.1); transition: all 0.2s ease; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .glass-card:active { transform: scale(0.99); border-color: rgba(6, 182, 212, 0.5); }
        
        /* TEXTBOOK STYLES */
        .paper-bg { background-color: #fcfbf7; color: #1a1a1a; font-family: 'Crimson Text', serif; padding: 32px; box-shadow: inset 0 0 60px rgba(0,0,0,0.05); position: relative; line-height: 1.8; font-size: 1.15rem; }
        .paper-bg h3 { font-family: 'Crimson Text', serif; color: #000; font-weight: 700; letter-spacing: -0.01em; margin-top: 1.5em; margin-bottom: 0.8em; font-size: 1.5rem; border-bottom: 2px solid #e5e5e5; padding-bottom: 5px; }
        .paper-bg p { margin-bottom: 1.2rem; text-align: justify; }
        .paper-bg strong { color: #0f172a; font-weight: 700; }
        .paper-bg ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 1.2rem; }
        
        /* HINDI TEXT STYLES */
        .hindi-text { font-family: 'Noto Sans Devanagari', sans-serif; line-height: 2.0; font-size: 1.1rem; }
        .hindi-highlight { color: #fbbf24; font-weight: 700; background: rgba(251, 191, 36, 0.1); padding: 0 4px; border-radius: 4px; }
        
        /* DATA TABLE */
        .data-table { width: 100%; border-collapse: collapse; font-family: 'JetBrains Mono', monospace; font-size: 11px; }
        .data-table th { text-align: left; color: #94a3b8; padding: 8px 6px; border-bottom: 1px solid #334155; font-weight: 700; text-transform: uppercase; background: rgba(15, 23, 42, 0.9); position: sticky; top: 0; z-index: 10; backdrop-filter: blur(4px); }
        .data-table td { padding: 6px; border-bottom: 1px solid #1e293b; color: #cbd5e1; font-feature-settings: "tnum"; }
        .data-table tr:nth-child(even) { background: rgba(255,255,255,0.02); }
        
        #loader { position: fixed; inset: 0; background: #020617; display: flex; justify-content: center; align-items: center; z-index: 100; transition: opacity 0.5s; flex-direction: column; gap: 24px;}
        .glow { text-shadow: 0 0 10px currentColor; }
    </style>
</head>
<body>

<div id="loader">
    <div class="relative">
        <div class="w-24 h-24 border-t-4 border-b-4 border-cyan-500 rounded-full animate-spin"></div>
        <div class="w-16 h-16 border-r-4 border-l-4 border-purple-500 rounded-full animate-spin-slow absolute top-4 left-4"></div>
        <div class="absolute inset-0 flex items-center justify-center font-bold text-white text-xs font-display animate-pulse">KSX</div>
    </div>
    <div class="text-cyan-500 font-mono text-sm animate-pulse tracking-[0.4em] font-bold mt-4">KALA-SIMUX ULTRA</div>
    <div class="text-slate-500 text-xs font-mono" id="loader-status">Initializing Physics Core...</div>
</div>

<div id="root"></div>

<script>
    // --- OFFLINE CAPABILITY ---
    if ('serviceWorker' in navigator) {
        const swCode = `
            const CACHE_NAME = 'kala-simux-v23';
            const ASSETS = [
                'https://unpkg.com/react@18/umd/react.production.min.js',
                'https://unpkg.com/react-dom@18/umd/react-dom.production.min.js',
                'https://unpkg.com/@babel/standalone/babel.min.js',
                'https://cdn.tailwindcss.com',
                'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js',
                'https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js',
                'https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js',
                'https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css'
            ];
            self.addEventListener('install', (e) => {
                e.waitUntil(caches.open(CACHE_NAME).then(cache => cache.addAll(ASSETS)));
                self.skipWaiting();
            });
            self.addEventListener('fetch', (e) => {
                e.respondWith(caches.match(e.request).then(res => res || fetch(e.request)));
            });
        `;
        const blob = new Blob([swCode], {type: 'application/javascript'});
        const swUrl = URL.createObjectURL(blob);
        window.addEventListener('load', () => {
            navigator.serviceWorker.register(swUrl).catch(console.error);
        });
    }
</script>

<script type="text/babel">
const { useState, useEffect, useRef, useMemo, useCallback, createContext, useContext } = React;

// --- ADAPTIVE UI HOOK ---
const useUIAdaptation = () => {
    const [mode, setMode] = useState('desktop'); 
    useEffect(() => {
        const check = () => {
            const w = window.innerWidth;
            const isTouch = window.matchMedia('(pointer: coarse)').matches;
            if (w > 1024 && isTouch) setMode('board'); // Digital Board
            else if (w < 768) setMode('mobile');
            else setMode('desktop');
        };
        check(); window.addEventListener('resize', check); return () => window.removeEventListener('resize', check);
    }, []);
    return useMemo(() => ({
        mode,
        btnSize: mode === 'board' ? 'p-4 text-lg' : 'p-2 text-xs',
        gap: mode === 'board' ? 'gap-6' : 'gap-2',
        text: mode === 'board' ? 'text-lg' : 'text-xs'
    }), [mode]);
};

// --- TOAST CONTEXT ---
const ToastContext = createContext();
const ToastProvider = ({ children }) => {
    const [toasts, setToasts] = useState([]);
    const addToast = (msg, type='info') => {
        const id = Date.now();
        setToasts(p => [...p, { id, msg, type }]);
        setTimeout(() => setToasts(p => p.filter(t => t.id !== id)), 3000);
    };
    return (
        <ToastContext.Provider value={addToast}>
            {children}
            <div className="fixed top-16 right-4 z-50 flex flex-col gap-2 pointer-events-none">
                {toasts.map(t => (
                    <div key={t.id} className={`animate-fade-in glass-card px-4 py-2 rounded-lg border-l-4 ${t.type==='error'?'border-red-500 text-red-100':'border-cyan-500 text-cyan-100'} shadow-xl text-xs font-bold font-display tracking-wider flex items-center gap-2`}>
                        <span className="text-lg">{t.type==='error'?'!':'✓'}</span> {t.msg}
                    </div>
                ))}
            </div>
        </ToastContext.Provider>
    );
};
const useToast = () => useContext(ToastContext);

// --- AUDIO ENGINE ---
const useAudioEngine = () => {
    const ctxRef = useRef(null);
    const masterGainRef = useRef(null);
    const [enabled, setEnabled] = useState(false);
    const init = useCallback(() => {
        if (!ctxRef.current && (window.AudioContext || window.webkitAudioContext)) {
            const AC = window.AudioContext || window.webkitAudioContext;
            ctxRef.current = new AC();
            masterGainRef.current = ctxRef.current.createGain();
            masterGainRef.current.gain.value = 0.2; 
            masterGainRef.current.connect(ctxRef.current.destination);
            setEnabled(true);
        } else if (ctxRef.current && ctxRef.current.state === 'suspended') { ctxRef.current.resume(); }
    }, []);
    const playTone = useCallback((freq, type='sine', duration=0.1, vol=0.5) => {
        if (!ctxRef.current || !enabled) return;
        try {
            const osc = ctxRef.current.createOscillator(); const gain = ctxRef.current.createGain();
            osc.type = type; osc.frequency.setValueAtTime(freq, ctxRef.current.currentTime);
            gain.gain.setValueAtTime(vol, ctxRef.current.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, ctxRef.current.currentTime + duration);
            osc.connect(gain); gain.connect(masterGainRef.current);
            osc.start(); osc.stop(ctxRef.current.currentTime + duration);
        } catch(e) {}
    }, [enabled]);
    const playCollision = useCallback((mass) => { const freq = Math.max(80, 600 - mass * 5); playTone(freq, 'triangle', 0.1, Math.min(0.8, mass/20)); }, [playTone]);
    return { init, playTone, playCollision, enabled, setEnabled };
};

// --- RECORDER HOOK ---
const useCanvasRecorder = (canvasRef) => {
    const [recording, setRecording] = useState(false);
    const mediaRecorder = useRef(null);
    const chunks = useRef([]);
    const toast = useToast();
    const startRecording = useCallback(() => {
        if (!canvasRef.current) return;
        try {
            const stream = canvasRef.current.captureStream(60); 
            let mimeType = 'video/webm';
            if (MediaRecorder.isTypeSupported('video/webm;codecs=vp9')) mimeType = 'video/webm;codecs=vp9';
            else if (MediaRecorder.isTypeSupported('video/mp4')) mimeType = 'video/mp4'; 
            
            mediaRecorder.current = new MediaRecorder(stream, { mimeType }); 
            mediaRecorder.current.ondataavailable = (e) => { if (e.data.size > 0) chunks.current.push(e.data); };
            mediaRecorder.current.onstop = () => {
                const blob = new Blob(chunks.current, { type: mimeType });
                chunks.current = [];
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `kala_simux_${Date.now()}.${mimeType==='video/mp4'?'mp4':'webm'}`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
                if(toast) toast("Recording Saved");
            };
            mediaRecorder.current.start();
            setRecording(true);
            if(toast) toast("Recording Started");
        } catch(e) { console.error("Recorder error:", e); if(toast) toast("Recorder Failed", "error"); }
    }, [toast]);
    const stopRecording = useCallback(() => { if (mediaRecorder.current && recording) { mediaRecorder.current.stop(); setRecording(false); } }, [recording]);
    return { recording, startRecording, stopRecording };
};

// --- UTILITIES ---
const useHaptics = () => useCallback((p=10) => { if (navigator.vibrate) navigator.vibrate(p); }, []);
const useLocalStorage = (key, initialValue) => {
    const [storedValue, setStoredValue] = useState(() => { try { const item = window.localStorage.getItem(key); return item ? JSON.parse(item) : initialValue; } catch (error) { return initialValue; } });
    const setValue = (value) => { try { const valueToStore = value instanceof Function ? value(storedValue) : value; setStoredValue(valueToStore); window.localStorage.setItem(key, JSON.stringify(valueToStore)); } catch (error) { console.log(error); } };
    return [storedValue, setValue];
};
const parseEq = (eq) => { if (!eq) return "0"; try { let s = eq.toLowerCase().replace(/\s/g, '').replace(/\^/g, '**'); ['sin','cos','tan','sqrt','exp','log','abs','pi','max','min','pow'].forEach(f => s = s.replaceAll(f, `Math.${f.toUpperCase() === 'PI' ? 'PI' : f}`)); return s; } catch(e) { return "0"; } };

// --- COMPONENTS ---
const Latex = ({ tex, dark=true }) => {
    const ref = useRef(null);
    useEffect(() => { if (ref.current && window.katex) { try { window.katex.render(tex, ref.current, { throwOnError: false }); } catch(e){} } else if(ref.current) { ref.current.innerText = tex; } }, [tex, dark]);
    return <span ref={ref} className={`font-serif italic px-1 ${dark ? 'text-cyan-300' : 'text-black font-bold'}`} />;
};

const EqInput = ({ label, sub, val, set, color }) => (
    <div className={`glass-card p-3 rounded-lg border-l-2 ${color} flex flex-col gap-1 shadow-lg`}>
        <span className="text-[10px] font-bold text-slate-400 uppercase tracking-wider font-display">{label}</span>
        <div className="flex gap-2 items-center">
            <span className="text-xs font-mono text-slate-500 shrink-0"><Latex tex={sub} /></span>
            <input value={val} onChange={e=>set(e.target.value)} className="bg-slate-900/50 border border-slate-700 text-cyan-400 w-full rounded px-2 py-1 text-xs font-mono focus:border-cyan-400 outline-none transition-colors" spellCheck="false" />
        </div>
    </div>
);

const ParamInput = ({ label, val, set, step="0.01", unit="", min=null, max=null }) => (
    <div className="flex justify-between items-center text-xs text-slate-300 border-b border-white/5 py-2 hover:bg-white/5 px-2 transition rounded">
        <span>{label}</span>
        <div className="flex items-center gap-2">
            <input type="number" step={step} min={min} max={max} value={val} onChange={e=>set(parseFloat(e.target.value))} className="w-20 bg-slate-900 border border-slate-700 text-yellow-400 rounded px-2 py-1 text-right font-mono text-xs focus:border-yellow-500 outline-none" />
            <span className="text-[9px] text-slate-500 w-4 font-bold">{unit}</span>
        </div>
    </div>
);

const GraphCard = ({ title, data, x, y, col }) => {
    if(!data || data.length < 2) return <div className="glass-card h-24 rounded flex items-center justify-center text-[10px] text-slate-600 font-mono border border-white/5">BUFFERING...</div>;
    const xs = data.map(d=>(d[x]!==undefined ? d[x] : 0)); const ys = data.map(d=>(d[y]!==undefined ? d[y] : 0));
    const minX = Math.min(...xs), maxX = Math.max(...xs);
    const minY = Math.min(...ys), maxY = Math.max(...ys);
    const pts = data.map(d => {
        const valX = d[x]!==undefined ? d[x] : 0; const valY = d[y]!==undefined ? d[y] : 0;
        const px = ((valX - minX) / (maxX - minX || 1)) * 100;
        const py = 100 - ((valY - minY) / (maxY - minY || 1)) * 100;
        return `${px},${py}`;
    }).join(' ');
    return (
        <div className="glass-card p-2 rounded-lg">
            <div className="text-[10px] text-slate-400 mb-1 font-mono uppercase tracking-widest">{title}</div>
            <svg viewBox="0 0 100 100" className="w-full h-16 bg-black/20 rounded overflow-hidden" preserveAspectRatio="none"><polyline points={pts} fill="none" stroke={col} strokeWidth="1.5" vectorEffect="non-scaling-stroke" /></svg>
        </div>
    );
};

// --- ICONS (Same as previous) ---
const Icons = {
    Menu: () => <svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>,
    Back: () => <svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>,
    Atom: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="1"/><path d="M20.2 20.2c2.04-2.03.02-7.36-4.5-11.9-4.54-4.52-9.87-6.54-11.9-4.5-2.04 2.03-.02 7.36 4.5 11.9 4.54 4.52 9.87 6.54 11.9 4.5Z"/><path d="M15.7 15.7c4.52-4.54 6.54-9.87 4.5-11.9-2.03-2.04-7.36-.02-11.9 4.5-4.52 4.54-6.54 9.87-4.5 11.9 2.03 2.04 7.36.02 11.9-4.5Z"/></svg>,
    Book: () => <svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>,
    Lab: () => <svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><path d="M2 12h20"/><path d="M2 12l5-5"/><path d="M22 12l-5 5"/></svg>,
    User: () => <svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
    Close: () => <svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>,
    Play: () => <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>,
    Pause: () => <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>,
    Reset: () => <svg width="16" height="16" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>,
    Plus: () => <svg width="16" height="16" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
    Trash: () => <svg width="14" height="14" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>,
    Expand: () => <svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/></svg>,
    Shrink: () => <svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"/></svg>,
    Record: () => <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="8" fill="red"/></svg>,
    StopRec: () => <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><rect x="6" y="6" width="12" height="12" rx="2" fill="red"/></svg>,
    Axes: () => <svg width="16" height="16" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M3 21h18M3 21v-18"/></svg>,
    Trail: () => <svg width="16" height="16" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M3 12h18M3 6h18M3 18h18" strokeDasharray="4 4"/></svg>,
    Camera: () => <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>,
    Wave: () => <svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M2 12s3-7 7-7 7 7 7 7 7-7 7-7M2 12s3 7 7 7 7-7 7-7 7 7 7 7" opacity="0.5"/></svg>,
    Quantum: () => <svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M12 2a10 10 0 100 20 10 10 0 000-20z"></path><path d="M2 12h20M12 2v20"></path><path d="M4.93 4.93l14.14 14.14M4.93 19.07L19.07 4.93"></path></svg>,
    Code: () => <svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><polyline points="16 18 22 12 16 6"></polyline><polyline points="8 6 2 12 8 18"></polyline></svg>
};

const useOrbitControls = (ref, initialZoom = 30) => {
    const camera = useRef({ yaw: 0.5, pitch: 0.3, zoom: initialZoom, x: 0, y: 0 });
    const drag = useRef({ active: false, x: 0, y: 0, dist: 0, mode: 'rotate' });
    useEffect(() => {
        const el = ref.current; if(!el) return;
        const getDist = (touches) => Math.hypot(touches[0].clientX - touches[1].clientX, touches[0].clientY - touches[1].clientY);
        const start = (e) => { 
            drag.current.active = true; 
            if(e.touches && e.touches.length === 2) { drag.current.dist = getDist(e.touches); drag.current.mode = 'zoom'; } 
            else { const t = e.touches ? e.touches[0] : e; drag.current.x = t.clientX; drag.current.y = t.clientY; drag.current.mode = e.shiftKey ? 'pan' : 'rotate'; }
        };
        const move = (e) => {
            if(!drag.current.active) return;
            if(e.touches && e.touches.length === 2) { const newDist = getDist(e.touches); camera.current.zoom *= newDist / drag.current.dist; drag.current.dist = newDist; } 
            else {
                const t = e.touches ? e.touches[0] : e; const dx = t.clientX - drag.current.x; const dy = t.clientY - drag.current.y;
                if (drag.current.mode === 'pan') { camera.current.x -= dx * 0.1; camera.current.y += dy * 0.1; } 
                else { camera.current.yaw += dx * 0.01; camera.current.pitch += dy * 0.01; camera.current.pitch = Math.max(-1.5, Math.min(1.5, camera.current.pitch)); }
                drag.current.x = t.clientX; drag.current.y = t.clientY;
            }
        };
        const wheel = (e) => { e.preventDefault(); camera.current.zoom *= (1 - Math.sign(e.deltaY) * 0.1); };
        const end = () => drag.current.active = false;
        el.addEventListener('mousedown', start); el.addEventListener('touchstart', start, {passive: false}); el.addEventListener('wheel', wheel, {passive: false});
        window.addEventListener('mousemove', move); window.addEventListener('touchmove', move, {passive: false}); window.addEventListener('mouseup', end); window.addEventListener('touchend', end);
        return () => { el.removeEventListener('mousedown', start); el.removeEventListener('touchstart', start); el.removeEventListener('wheel', wheel); window.removeEventListener('mousemove', move); window.removeEventListener('touchmove', move); window.removeEventListener('mouseup', end); window.removeEventListener('touchend', end); };
    }, []);
    return camera;
};

const SimCanvas = ({ draw, initZoom=30, interact=null, showAxes=false, onInitRecorder }) => {
    const canvasRef = useRef(null);
    const cam = useOrbitControls(canvasRef, initZoom);
    const drawRef = useRef(draw);
    const toast = useToast();
    useEffect(() => { if(initZoom) cam.current.zoom = initZoom; }, [initZoom]);
    useEffect(() => { drawRef.current = draw; }, [draw]);
    useEffect(() => { if(onInitRecorder) onInitRecorder(canvasRef); }, [onInitRecorder]);

    const takeSnapshot = () => {
        if(!canvasRef.current) return;
        const link = document.createElement('a');
        link.download = `kala_snapshot_${Date.now()}.png`;
        link.href = canvasRef.current.toDataURL();
        link.click();
        if(toast) toast("Snapshot Saved");
    };

    useEffect(() => {
        const cvs = canvasRef.current; if(!cvs) return;
        const ctx = cvs.getContext('2d');
        let fid;
        const render = () => {
            if(!canvasRef.current) return;
            const w = cvs.width = cvs.clientWidth; const h = cvs.height = cvs.clientHeight;
            const cx = w/2, cy = h/2;
            const grad = ctx.createLinearGradient(0,0,0,h); grad.addColorStop(0, '#020617'); grad.addColorStop(1, '#0f172a');
            ctx.fillStyle = grad; ctx.fillRect(0,0,w,h);
            const project = (x,y,z) => {
                const { yaw, pitch, zoom, x: camX, y: camY } = cam.current;
                const tx = x - camX; const ty = y - camY; 
                let x1 = tx * Math.cos(yaw) - z * Math.sin(yaw); let z1 = z * Math.cos(yaw) + tx * Math.sin(yaw);
                let y2 = ty * Math.cos(pitch) - z1 * Math.sin(pitch); let z2 = z1 * Math.cos(pitch) + ty * Math.sin(pitch);
                const scale = 500 / (500 - z2) * zoom;
                return { x: cx + x1 * scale, y: cy - y2 * scale, s: scale, z: z2 };
            };
            if (showAxes) {
                const o = project(0,0,0); const x = project(10,0,0); const y = project(0,10,0); const z = project(0,0,10);
                ctx.lineWidth = 1; 
                ctx.beginPath(); ctx.strokeStyle = '#ef4444'; ctx.moveTo(o.x, o.y); ctx.lineTo(x.x, x.y); ctx.stroke(); 
                ctx.beginPath(); ctx.strokeStyle = '#22c55e'; ctx.moveTo(o.x, o.y); ctx.lineTo(y.x, y.y); ctx.stroke(); 
                ctx.beginPath(); ctx.strokeStyle = '#3b82f6'; ctx.moveTo(o.x, o.y); ctx.lineTo(z.x, z.y); ctx.stroke(); 
            }
            if(drawRef.current) try { drawRef.current(ctx, project, w, h); } catch(e) { }
            fid = requestAnimationFrame(render);
        };
        render(); return () => cancelAnimationFrame(fid);
    }, [showAxes]); 
    
    const handleInteract = (e) => {
        if(!interact) return;
        const cvs = canvasRef.current;
        const rect = cvs.getBoundingClientRect();
        const clientX = e.clientX || e.touches[0].clientX; const clientY = e.clientY || e.touches[0].clientY;
        interact(clientX - rect.left, clientY - rect.top, cvs.width, cvs.height);
    };
    return (
        <div className="relative w-full h-full touch-none group">
            <canvas ref={canvasRef} onClick={interact ? handleInteract : null} className="w-full h-full block cursor-move" />
            <button onClick={takeSnapshot} className="absolute bottom-4 right-4 p-2 bg-slate-800/50 text-slate-400 hover:text-white rounded-full opacity-0 group-hover:opacity-100 transition duration-300 backdrop-blur"><Icons.Camera /></button>
        </div>
    );
};

// --- 1. ODESOLVER (FIXED: Table Data Rendering for N-Body & Custom) ---
const ODESolver = () => {
    const vibrate = useHaptics();
    const audio = useAudioEngine();
    const toast = useToast();
    const { btnSize, gap, text } = useUIAdaptation(); 
    
    // PRESETS
    const PRESETS = {
        custom: { name: "Custom System (General)", mode: 'custom', vars: {x:1, y:1}, eqs: {x: "y", y: "-x - 0.1*y"}, zoom: 15, dt: 0.01 },
        shm: { name: "Damped Harmonic", mode: 'newtonian', unit: 'SI', bodies: [{x:3, y:0, z:0, vx:0, vy:0, vz:0, m:1, r:1}], eqs: {x: "-4*x - 0.1*vx", y: "-4*y - 0.1*vy", z: "-4*z - 0.1*vz"}, zoom: 30, dt: 0.02 },
        lorenz: { name: "Lorenz Attractor", mode: 'custom', vars: {x:0.1, y:0, z:0}, eqs: {x: "10*(y-x)", y: "x*(28-z)-y", z: "x*y - (8/3)*z"}, zoom: 6, dt: 0.008 },
        rossler: { name: "Rössler Attractor", mode: 'custom', vars: {x:0, y:0, z:0}, eqs: {x: "-y - z", y: "x + 0.2*y", z: "0.2 + z*(x - 5.7)"}, zoom: 10, dt: 0.01 },
        solar: { 
            name: "Solar System (9 Bodies)", mode: 'gravity_nbody', unit: 'AU', zoom: 60, G: 39.478, dt: 0.002,
            forceEq: "G * m1 * m2 / (r^2)", 
            bodies: [
                {name: 'Sun', x:0, y:0, z:0, vx:0, vy:0, vz:0, m:1, r:4, fixed:true, col:'#fbbf24'},
                {name: 'Mercury', x:0.39, y:0, z:0, vx:0, vy:10.0, vz:0, m:1.6e-7, r:0.8, col:'#a3a3a3'},
                {name: 'Venus', x:0.72, y:0, z:0, vx:0, vy:7.35, vz:0, m:2.4e-6, r:1.2, col:'#ea580c'},
                {name: 'Earth', x:1.00, y:0, z:0, vx:0, vy:6.28, vz:0, m:3.0e-6, r:1.3, col:'#3b82f6'},
                {name: 'Mars', x:1.52, y:0, z:0, vx:0, vy:5.08, vz:0, m:3.2e-7, r:1.0, col:'#ef4444'},
                {name: 'Jupiter', x:5.20, y:0, z:0, vx:0, vy:2.75, vz:0, m:9.5e-4, r:2.5, col:'#d97706'},
                {name: 'Saturn', x:9.58, y:0, z:0, vx:0, vy:2.02, vz:0, m:2.8e-4, r:2.2, col:'#fcd34d'},
                {name: 'Uranus', x:19.2, y:0, z:0, vx:0, vy:1.43, vz:0, m:4.3e-5, r:1.8, col:'#22d3ee'},
                {name: 'Neptune', x:30.05, y:0, z:0, vx:0, vy:1.13, vz:0, m:5.1e-5, r:1.8, col:'#3b82f6'}
            ]
        },
        three_body: { name: "3-Body Chaos", mode: 'gravity_nbody', unit: 'SI', forceEq: "G * m1 * m2 / (r^2)", dt: 0.015, bodies: [{x:10, y:0, z:0, vx:0, vy:2, vz:0, m:100, r:2, col:'#fbbf24'}, {x:-10, y:0, z:0, vx:0, vy:-2, vz:0, m:100, r:2, col:'#3b82f6'}, {x:0, y:15, z:0, vx:3, vy:0, vz:0, m:50, r:1.5, col:'#ef4444'}], G: 1, zoom: 40 },
        accretion: { name: "Protoplanetary Disk", mode: 'gravity_nbody', unit: 'SI', forceEq: "G * m1 * m2 / (r^2)", G:1, dt: 0.01, zoom: 60, bodies: [] } 
    };

    const [fullScreen, setFullScreen] = useState(false); 
    const [tab, setTab] = useState('story'); 
    const [playing, setPlaying] = useState(true);
    const [mode, setMode] = useState('custom');
    const [unitSys, setUnitSys] = useState('SI');
    
    // State
    const [eqs, setEqs] = useState(PRESETS.custom.eqs);
    const [customVars, setCustomVars] = useState(PRESETS.custom.vars);
    const [bodies, setBodies] = useState([]); 
    const [G_const, setG_const] = useState(1);
    const [forceEq, setForceEq] = useState("G * m1 * m2 / (r^2)");
    const [camZoom, setCamZoom] = useState(30); 
    const [dt, setDt] = useState(0.01);
    
    // View Settings
    const [showTrails, setShowTrails] = useState(true);
    const [showAxes, setShowAxes] = useState(true);
    const [collisions, setCollisions] = useState(true);
    
    // Refs
    const stateRef = useRef(JSON.parse(JSON.stringify(PRESETS.custom.vars))); 
    const bodiesRef = useRef([]); 
    const historyRef = useRef([]); 
    const [displayData, setDisplayData] = useState([]); 
    const timeRef = useRef(0);
    const funcRef = useRef(null); 
    const forceFuncRef = useRef(null); 
    const [stats, setStats] = useState({ke: 0, count: 1}); 

    // Recorder
    const canvasRef = useRef(null);
    const { recording, startRecording, stopRecording } = useCanvasRecorder(canvasRef);

    // --- INITIALIZATION ---
    useEffect(() => { 
        audio.init();
        if(mode === 'custom') {
            const varNames = Object.keys(eqs);
            const args = [...varNames, 't'];
            const body = `return { ${varNames.map(v => `${v}: ${parseEq(eqs[v])}`).join(', ')} };`;
            try { funcRef.current = new Function(...args, body); } catch(e) { console.log("Parse Error", e); }
        } else if(mode === 'newtonian') {
            try { funcRef.current = new Function('x','y','z','vx','vy','vz','t', `return { fx: ${parseEq(eqs.x)}, fy: ${parseEq(eqs.y)}, fz: ${parseEq(eqs.z)} };`); } catch(e) { } 
        } else {
            try { forceFuncRef.current = new Function('m1', 'm2', 'r', 'G', `return ${parseEq(forceEq)};`); } catch(e) {}
        }
    }, [eqs, mode, forceEq]);

    const loadPreset = (key) => {
        const p = PRESETS[key];
        setMode(p.mode); setUnitSys(p.unit || 'SI');
        
        if(p.mode === 'custom') {
            setEqs(p.eqs); setCustomVars(p.vars);
            stateRef.current = {...p.vars};
        } else {
            if(p.eqs) setEqs(p.eqs);
            if(p.G) setG_const(p.G);
            if(p.forceEq) setForceEq(p.forceEq);
            let initialBodies = p.bodies;
            
            if(key === 'accretion') {
                initialBodies = [{x:0, y:0, z:0, vx:0, vy:0, vz:0, m:500, r:4, fixed:true, col:'#fbbf24'}];
                for(let i=0; i<60; i++) {
                    const ang = Math.random() * Math.PI * 2;
                    const dist = 15 + Math.random() * 40;
                    const v = Math.sqrt(500/dist); 
                    initialBodies.push({
                        x: Math.cos(ang)*dist, y: Math.sin(ang)*dist, z: (Math.random()-0.5)*1,
                        vx: -Math.sin(ang)*v, vy: Math.cos(ang)*v, vz: 0,
                        m: 0.2 + Math.random(), r: 0.5 + Math.random()*0.3,
                        col: `hsl(${Math.random()*60 + 200}, 70%, 50%)`
                    });
                }
            }
            setBodies(initialBodies); bodiesRef.current = JSON.parse(JSON.stringify(initialBodies));
        }
        
        setCamZoom(p.zoom || 30);
        timeRef.current = 0; historyRef.current = []; setDisplayData([]);
        setDt(p.dt || 0.01); 
        vibrate();
        if(toast) toast(`Loaded: ${p.name}`);
    };

    const addBody = () => {
        const newBody = { x: Math.random()*10-5, y: Math.random()*10-5, z:0, vx:0, vy:0, vz:0, m:1, r:1, col:'#22d3ee', name:'Body' };
        bodiesRef.current.push(newBody);
        setBodies([...bodiesRef.current]);
    };

    const removeBody = (idx) => {
        if(bodiesRef.current.length <= 1) return;
        bodiesRef.current.splice(idx, 1);
        setBodies([...bodiesRef.current]);
    };

    // --- INTEGRATOR (PHYSICS ENGINE) ---
    useEffect(() => {
        let frameId;
        const loop = () => {
            if (!playing) return;
            const t = timeRef.current;

            if(mode === 'custom' && funcRef.current) {
                const s = stateRef.current;
                const vars = Object.keys(s);
                const f = funcRef.current;
                try {
                    const k1 = f(...vars.map(v=>s[v]), t);
                    const k2 = f(...vars.map(v=>s[v] + k1[v]*0.5*dt), t + 0.5*dt);
                    const k3 = f(...vars.map(v=>s[v] + k2[v]*0.5*dt), t + 0.5*dt);
                    const k4 = f(...vars.map(v=>s[v] + k3[v]*dt), t + dt);
                    vars.forEach(v => { s[v] += (dt/6)*(k1[v] + 2*k2[v] + 2*k3[v] + k4[v]); });
                    if(Math.random()>0.9) setStats({ke: 0, count: vars.length});
                    historyRef.current.push({...s});
                } catch(e) {}
            }
            else if(mode === 'gravity_nbody') {
                let currentBodies = bodiesRef.current;
                const N = currentBodies.length;
                const calcForce = forceFuncRef.current; 
                
                if(collisions && N > 1) {
                    const toRemove = new Set();
                    for(let i=0; i<N; i++) {
                        if(toRemove.has(i)) continue;
                        for(let j=i+1; j<N; j++) {
                            if(toRemove.has(j)) continue;
                            const b1 = currentBodies[i], b2 = currentBodies[j];
                            const dx = b1.x - b2.x, dy = b1.y - b2.y, dz = b1.z - b2.z;
                            const dist = Math.sqrt(dx*dx + dy*dy + dz*dz);
                            if(dist < (b1.r + b2.r) * 0.8) { 
                                const totalM = b1.m + b2.m;
                                b1.vx = (b1.vx*b1.m + b2.vx*b2.m) / totalM; b1.vy = (b1.vy*b1.m + b2.vy*b2.m) / totalM; b1.vz = (b1.vz*b1.m + b2.vz*b2.m) / totalM;
                                b1.x = (b1.x*b1.m + b2.x*b2.m) / totalM; b1.y = (b1.y*b1.m + b2.y*b2.m) / totalM; b1.z = (b1.z*b1.m + b2.z*b2.m) / totalM;
                                b1.m = totalM; b1.r = Math.pow(b1.r**3 + b2.r**3, 1/3); 
                                toRemove.add(j);
                                audio.playCollision(totalM); vibrate(20);
                            }
                        }
                    }
                    if(toRemove.size > 0) {
                        currentBodies = currentBodies.filter((_, i) => !toRemove.has(i));
                        bodiesRef.current = currentBodies;
                    }
                }

                const accels = currentBodies.map((bi, i) => {
                    if(bi.fixed) return {ax:0, ay:0, az:0};
                    let ax=0, ay=0, az=0;
                    for(let j=0; j<currentBodies.length; j++) {
                        if(i===j) continue;
                        const bj = currentBodies[j];
                        const dx = bj.x - bi.x; const dy = bj.y - bi.y; const dz = bj.z - bi.z;
                        const r2 = dx*dx + dy*dy + dz*dz + 0.001; const r = Math.sqrt(r2);
                        let f_mag = 0;
                        if(calcForce) { try { f_mag = calcForce(bi.m, bj.m, r, G_const); } catch(e){} } else { f_mag = (G_const * bj.m * bi.m) / r2; }
                        const a_mag = f_mag / bi.m; 
                        ax += a_mag * (dx/r); ay += a_mag * (dy/r); az += a_mag * (dz/r);
                    }
                    return {ax, ay, az};
                });
                
                let sysKE = 0;
                currentBodies.forEach((b, i) => {
                    if(!b.fixed) {
                        b.vx += accels[i].ax * dt; b.vy += accels[i].ay * dt; b.vz += accels[i].az * dt;
                        b.x += b.vx * dt; b.y += b.vy * dt; b.z += b.vz * dt;
                        sysKE += 0.5 * b.m * (b.vx**2 + b.vy**2 + b.vz**2);
                    }
                });
                if(Math.random() > 0.9) setStats({ke: sysKE, count: currentBodies.length});
                historyRef.current.push(JSON.parse(JSON.stringify(currentBodies)));
            }
            else if(mode === 'newtonian' && funcRef.current) {
                const b = bodiesRef.current[0]; const calc = funcRef.current;
                const evalState = (x, y, z, vx, vy, vz, t) => { const res = calc(x, y, z, vx, vy, vz, t); return { dx: vx, dy: vy, dz: vz, dvx: res.fx, dvy: res.fy, dvz: res.fz }; };
                const k1 = evalState(b.x, b.y, b.z, b.vx, b.vy, b.vz, t);
                const k2 = evalState(b.x+k1.dx*0.5*dt, b.y+k1.dy*0.5*dt, b.z+k1.dz*0.5*dt, b.vx+k1.dvx*0.5*dt, b.vy+k1.dvy*0.5*dt, b.vz+k1.dvz*0.5*dt, t+0.5*dt);
                const k3 = evalState(b.x+k2.dx*0.5*dt, b.y+k2.dy*0.5*dt, b.z+k2.dz*0.5*dt, b.vx+k2.dvx*0.5*dt, b.vy+k2.dvy*0.5*dt, b.vz+k2.dvz*0.5*dt, t+0.5*dt);
                const k4 = evalState(b.x+k3.dx*dt, b.y+k3.dy*dt, b.z+k3.dz*dt, b.vx+k3.dvx*dt, b.vy+k3.dvy*dt, b.vz+k3.dvz*dt, t+dt);
                b.x += (dt/6)*(k1.dx + 2*k2.dx + 2*k3.dx + k4.dx); b.y += (dt/6)*(k1.dy + 2*k2.dy + 2*k3.dy + k4.dy); b.z += (dt/6)*(k1.dz + 2*k2.dz + 2*k3.dz + k4.dz);
                b.vx += (dt/6)*(k1.dvx + 2*k2.dvx + 2*k3.dvx + k4.dvx); b.vy += (dt/6)*(k1.dvy + 2*k2.dvy + 2*k3.dvy + k4.dvy); b.vz += (dt/6)*(k1.dvz + 2*k2.dvz + 2*k3.dvz + k4.dvz);
                historyRef.current.push(JSON.parse(JSON.stringify(bodiesRef.current)));
            }

            timeRef.current += dt;
            if (historyRef.current.length > 800) historyRef.current.shift();
            frameId = requestAnimationFrame(loop);
        };
        if(playing) loop(); return () => cancelAnimationFrame(frameId);
    }, [playing, mode, dt, G_const, forceEq, collisions]);

    // --- DATA SAMPLING (FIXED FOR TABLE) ---
    useEffect(() => { 
        const id = setInterval(() => { 
            if(playing && historyRef.current.length > 0) { 
                const lastEntry = historyRef.current[historyRef.current.length-1]; 
                let dataPt = null;
                
                // Logic: Flatten the data for the table
                if(mode === 'custom') { 
                    // Custom variables are already an object like {x:1, y:2}
                    dataPt = { t: timeRef.current, ...lastEntry }; 
                } else if (Array.isArray(lastEntry)) { 
                    // N-Body Mode: lastEntry is Array<Body>
                    // We extract the first NON-FIXED body to show its trajectory data
                    // If all are fixed (unlikely), show the first one.
                    const p = lastEntry.find(b => !b.fixed) || lastEntry[0]; 
                    if(p) {
                        dataPt = {
                            t: timeRef.current, 
                            x: p.x, y: p.y, z: p.z, 
                            vx: p.vx, vy: p.vy, 
                            v: Math.sqrt(p.vx**2 + p.vy**2 + p.vz**2)
                        }; 
                    }
                }
                
                if(dataPt) {
                    setDisplayData(prev => { 
                        const nu = [...prev, dataPt]; 
                        return nu.length > 200 ? nu.slice(-200) : nu; 
                    }); 
                }
            } 
        }, 200); 
        return () => clearInterval(id); 
    }, [playing, mode]);

    const draw = (ctx, project, w, h) => {
        const hist = historyRef.current; if(hist.length === 0) return;
        
        // Custom Draw Logic
        if(mode === 'custom') {
            if(showTrails) {
                const vars = Object.keys(hist[0]);
                const xKey = vars[0], yKey = vars[1], zKey = vars[2] || null;
                ctx.beginPath(); ctx.strokeStyle = '#22d3ee'; ctx.lineWidth = 2;
                for(let i=0; i<hist.length; i++) {
                    const s = hist[i];
                    const p = project(s[xKey], s[yKey], zKey ? s[zKey] : 0);
                    if(i===0) ctx.moveTo(p.x, p.y); else ctx.lineTo(p.x, p.y);
                }
                ctx.stroke();
            }
            const curr = stateRef.current;
            const vars = Object.keys(curr);
            const p = project(curr[vars[0]], curr[vars[1]], vars[2] ? curr[vars[2]] : 0);
            ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(p.x, p.y, 4, 0, 7); ctx.fill();
            return;
        }

        // N-Body Draw Logic
        const activeBodies = bodiesRef.current;
        if(showTrails) {
            const numTracks = hist[0].length;
            ctx.lineWidth = 1;
            for(let t=0; t<numTracks; t++) {
                ctx.beginPath();
                let started = false;
                for(let i=0; i<hist.length; i+=4) {
                    if(hist[i][t]) {
                        const p = project(hist[i][t].x, hist[i][t].y, hist[i][t].z);
                        if(!started) { ctx.moveTo(p.x, p.y); started=true; } else ctx.lineTo(p.x, p.y);
                    }
                }
                const col = activeBodies[t] ? activeBodies[t].col : '#555';
                ctx.strokeStyle = col; ctx.globalAlpha = 0.4; ctx.stroke(); ctx.globalAlpha = 1.0;
            }
        }

        for(let bIdx=0; bIdx < activeBodies.length; bIdx++) {
             const b = activeBodies[bIdx];
             const color = b.col || '#3b82f6';
             const pc = project(b.x, b.y, b.z);
             const r_viz = (b.r || 1) * (pc.s/15);
             const grad = ctx.createRadialGradient(pc.x, pc.y, r_viz*0.2, pc.x, pc.y, r_viz*3); 
             grad.addColorStop(0, color); grad.addColorStop(1, 'rgba(0,0,0,0)'); 
             ctx.fillStyle = grad; ctx.beginPath(); ctx.arc(pc.x, pc.y, r_viz*3, 0, 7); ctx.fill();
             ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(pc.x, pc.y, Math.max(1, r_viz), 0, 7); ctx.fill();
             if(mode === 'gravity_nbody' && b.name && unitSys === 'AU') { 
                ctx.fillStyle = color; ctx.font = '10px Rajdhani'; ctx.fillText(b.name, pc.x + 10, pc.y); 
             }
        }
    };

    // --- TABLE RENDERER ---
    const renderTable = () => {
        if(displayData.length === 0) return <div className={`text-slate-500 italic p-4 text-center ${text}`}>Collecting telemetry data...</div>;
        
        // Dynamically get headers from the first valid data point
        const headers = Object.keys(displayData[0]);
        
        return (
            <table className="data-table">
                <thead>
                    <tr>{headers.map(h => <th key={h}>{h.toUpperCase()}</th>)}</tr>
                </thead>
                <tbody>
                    {displayData.slice().reverse().map((row, i) => (
                        <tr key={i}>
                            {headers.map(h => (
                                <td key={h} className={h==='t'?'text-cyan-400 font-bold':''}>
                                    {typeof row[h] === 'number' ? row[h].toFixed(3) : row[h]}
                                </td>
                            ))}
                        </tr>
                    ))}
                </tbody>
            </table>
        );
    };

    return ( 
        <div className={`flex flex-col h-[calc(100dvh-60px)] -m-4 relative ${fullScreen ? 'fixed inset-0 z-50 m-0 bg-slate-950' : ''}`}> 
            <div className={`relative transition-all duration-500 bg-slate-900 overflow-hidden shadow-xl z-20 ${fullScreen ? 'absolute inset-0 h-full' : 'h-[40%] shrink-0'}`}> 
                <SimCanvas draw={draw} initZoom={camZoom} showAxes={showAxes} onInitRecorder={(ref) => canvasRef.current = ref.current} /> 
                <div className={`absolute top-4 right-4 flex items-center ${gap}`}> 
                    <button onClick={recording ? stopRecording : startRecording} className={`${btnSize} rounded-full backdrop-blur border border-white/10 ${recording ? 'bg-red-500/20 text-red-500 animate-pulse' : 'bg-slate-800/80 text-white'}`}>{recording ? <Icons.StopRec /> : <Icons.Record />}</button>
                    <button onClick={() => { loadPreset('shm'); vibrate(); }} className={`${btnSize} rounded-full bg-slate-800/80 text-slate-400 hover:text-white backdrop-blur border border-white/10`}><Icons.Reset /></button> 
                    <button onClick={() => {setPlaying(!playing); vibrate();}} className={`${btnSize} rounded-full bg-blue-600/90 text-white shadow-lg shadow-blue-500/50 backdrop-blur`}>{playing ? <Icons.Pause /> : <Icons.Play />}</button> 
                    <button onClick={() => {setFullScreen(!fullScreen);}} className={`${btnSize} rounded-full bg-slate-800/80 text-slate-400 hover:text-white backdrop-blur border border-white/10`}>{fullScreen ? <Icons.Shrink /> : <Icons.Expand />}</button> 
                </div> 
                <div className="absolute bottom-2 left-2 flex gap-4 text-[10px] font-mono text-slate-400 bg-black/50 p-1 px-2 rounded backdrop-blur pointer-events-none">
                    <span>T: <span className="text-cyan-400">{timeRef.current.toFixed(2)}</span> {unitSys==='AU'?'yr':'s'}</span>
                    {mode !== 'custom' && <span>N: <span className="text-purple-400">{stats.count}</span></span>}
                </div>
            </div> 

            {!fullScreen && ( 
                <div className="flex-1 flex flex-col glass-panel overflow-hidden border-t-0"> 
                    <div className="flex border-b border-white/10 shrink-0 bg-slate-900/50"> {['story', 'textbook', 'lab', 'graph', 'data'].map(id => (<button key={id} onClick={() => setTab(id)} className={`flex-1 py-3 text-[10px] font-bold uppercase tracking-widest transition font-display ${tab === id ? 'text-cyan-400 bg-white/5 border-b-2 border-cyan-500' : 'text-slate-500 hover:text-slate-300'}`}>{id}</button>))} </div> 
                    <div className="flex-1 overflow-hidden relative bg-slate-900/80"> 
                        {tab === 'story' && (
                            <div className="h-full overflow-y-auto scroller p-6 space-y-8 pb-20">
                                <div className="animate-in fade-in slide-in-from-bottom-4 duration-700">
                                    <h3 className="text-yellow-500 font-bold text-xs uppercase tracking-widest mb-2 font-display">1687: THE CLOCKWORK UNIVERSE</h3>
                                    <h1 className="text-3xl font-bold text-white mb-4 font-display">Principia Mathematica</h1>
                                    <p className="text-slate-300 text-sm leading-7">For thousands of years, humanity looked at the stars and saw gods. Then, in 1687, Isaac Newton published the <em>Philosophiæ Naturalis Principia Mathematica</em>. In it, he connected the fall of an apple to the orbit of the moon with a single, elegant idea: <strong>Universal Gravitation</strong>.</p>
                                    <div className="border-l-2 border-indigo-500/30 pl-4 py-2 my-6">
                                        <div className="text-slate-400 text-xs italic mb-2"><Latex tex="F = G \frac{mM}{r^2}" /></div>
                                        <p className="text-slate-300 text-sm leading-6">This equation promised a universe that ran like a clock. Predictable. Perfect. Solvable.</p>
                                    </div>
                                    <h4 className="text-white font-bold text-sm font-display mb-2">The Three-Body Problem</h4>
                                    <p className="text-slate-300 text-sm leading-7">Newton solved the two-body problem (Earth & Sun) exactly. But he found that adding just one more body—the Moon—made the math impossible to solve analytically. This is the "Three-Body Problem." Centuries later, Henri Poincaré discovered that these systems aren't just hard; they are <strong>Chaotic</strong>. A butterfly flapping its wings can change the fate of solar systems. This simulator uses numerical integration (Runge-Kutta methods) to approximate these impossible solutions step-by-step.</p>
                                </div>
                            </div>
                        )}
                        {tab === 'textbook' && (
                            <div className="h-full overflow-y-auto scroller p-4 pb-20">
                                <div className="paper-bg text-sm rounded-sm mb-4 shadow-xl">
                                    <h3 className="text-black font-bold text-xl mb-4 border-b border-black/10 pb-2">Dynamics & Chaos</h3>
                                    
                                    <p><strong>1. Newton's Law of Gravitation</strong></p>
                                    <div className="my-2 text-center"><Latex tex="F_g = G \frac{m_1 m_2}{r^2}" dark={false} /></div>
                                    <p>Every point mass attracts every other point mass. <Latex tex="G" dark={false} /> is the gravitational constant (<Latex tex="6.67 \times 10^{-11}" dark={false} /> in SI).</p>

                                    <p><strong>2. Equations of Motion (N-Body)</strong></p>
                                    <p>For a system of <Latex tex="N" dark={false} /> bodies, the acceleration of the <Latex tex="i" dark={false} />-th body is the sum of forces from all other <Latex tex="j" dark={false} /> bodies:</p>
                                    <div className="my-2 text-center"><Latex tex="\vec{a}_i = \sum_{j \neq i} G m_j \frac{\vec{r}_j - \vec{r}_i}{|\vec{r}_j - \vec{r}_i|^3}" dark={false} /></div>

                                    <p><strong>3. Vis-viva Equation</strong></p>
                                    <p>Used to calculate orbital speed at distance <Latex tex="r" dark={false} /> given a semi-major axis <Latex tex="a" dark={false} />:</p>
                                    <div className="my-2 text-center"><Latex tex="v^2 = GM \left( \frac{2}{r} - \frac{1}{a} \right)" dark={false} /></div>

                                    <p><strong>4. Numerical Integration (RK4)</strong></p>
                                    <p>To solve these differential equations, we calculate the slope at four points within a time step <Latex tex="\Delta t" dark={false} />:</p>
                                    <ul className="list-disc pl-5 mt-1 space-y-1">
                                        <li><Latex tex="k_1 = f(y, t)" dark={false} /></li>
                                        <li><Latex tex="k_2 = f(y + k_1 \frac{\Delta t}{2}, t + \frac{\Delta t}{2})" dark={false} /></li>
                                        <li><Latex tex="k_3 = f(y + k_2 \frac{\Delta t}{2}, t + \frac{\Delta t}{2})" dark={false} /></li>
                                        <li><Latex tex="k_4 = f(y + k_3 \Delta t, t + \Delta t)" dark={false} /></li>
                                    </ul>
                                </div>
                            </div>
                        )}
                        {tab === 'lab' && ( 
                            <div className="h-full overflow-y-auto p-4 space-y-4 scroller pb-20"> 
                                <div className="flex gap-2 overflow-x-auto pb-2 no-scrollbar">
                                    {Object.entries(PRESETS).map(([k, v]) => (<button key={k} onClick={() => loadPreset(k)} className="shrink-0 px-3 py-1 rounded border border-slate-700 text-[10px] font-bold text-slate-400 hover:bg-cyan-900/50 hover:text-cyan-300 hover:border-cyan-500 transition font-display">{v.name}</button>))}
                                </div> 
                                
                                <div className="glass-card p-4 space-y-3 border-l-2 border-yellow-500">
                                    <div className="text-[10px] font-bold text-yellow-500 uppercase tracking-wider font-display">Simulation Core</div>
                                    <ParamInput label="Time Step (dt)" val={dt} set={setDt} step="0.001" unit={unitSys==='AU'?'yr':'s'} />
                                    <ParamInput label="G Constant" val={G_const} set={setG_const} step="0.1" unit="" />
                                    
                                    <div className="grid grid-cols-2 gap-2 pt-2 border-t border-white/5">
                                        <button onClick={()=>setShowTrails(!showTrails)} className={`flex items-center justify-between px-2 py-1 rounded text-xs ${showTrails ? 'bg-cyan-500/20 text-cyan-300' : 'bg-slate-800 text-slate-500'}`}><span>Trails</span><Icons.Trail /></button>
                                        <button onClick={()=>setShowAxes(!showAxes)} className={`flex items-center justify-between px-2 py-1 rounded text-xs ${showAxes ? 'bg-cyan-500/20 text-cyan-300' : 'bg-slate-800 text-slate-500'}`}><span>Axes</span><Icons.Axes /></button>
                                        <button onClick={()=>setCollisions(!collisions)} className={`flex items-center justify-between px-2 py-1 rounded text-xs ${collisions ? 'bg-green-500/20 text-green-300' : 'bg-slate-800 text-slate-500'}`}><span>Collisions</span><div className={`w-2 h-2 rounded-full ${collisions?'bg-green-500':'bg-slate-500'}`} /></button>
                                        <button onClick={()=>setUnitSys(unitSys==='SI'?'AU':'SI')} className="flex items-center justify-between px-2 py-1 rounded text-xs bg-slate-800 text-yellow-400"><span>Unit: {unitSys}</span></button>
                                    </div>
                                </div>

                                {mode === 'custom' ? (
                                    <div className="space-y-2">
                                        <div className="text-[10px] font-bold text-pink-500 uppercase tracking-wider font-display">General ODE System</div>
                                        <div className="glass-card p-3 border border-pink-500/30">
                                            <p className="text-[10px] text-slate-400 mb-2">Define any variables (x, y, a, b...) and their derivatives w.r.t time.</p>
                                            {Object.keys(eqs).map(v => (
                                                <div key={v} className="flex items-center gap-2 mb-2">
                                                    <span className="text-xs font-mono text-pink-400 w-8">d{v}/dt=</span>
                                                    <input value={eqs[v]} onChange={(e) => setEqs({...eqs, [v]: e.target.value})} className="flex-1 bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs font-mono text-white" />
                                                    <button onClick={()=>{const n={...eqs}; delete n[v]; setEqs(n);}} className="text-red-500"><Icons.Trash /></button>
                                                </div>
                                            ))}
                                            <button onClick={()=>{const v=prompt("Variable Name?"); if(v) setEqs({...eqs, [v]:"0"});}} className="w-full py-1 bg-pink-500/20 text-pink-400 text-xs rounded hover:bg-pink-500/30">+ Add Variable</button>
                                        </div>
                                    </div>
                                ) : mode === 'gravity_nbody' ? (
                                    <>
                                        <EqInput label="Universal Force Law F(m1, m2, r, G)" sub="F =" val={forceEq} set={setForceEq} color="border-red-500" />
                                        <div className="space-y-2">
                                            <div className="flex justify-between items-center text-[10px] text-slate-400 uppercase font-bold tracking-wider">
                                                <span>Bodies ({bodies.length})</span>
                                                <button onClick={addBody} className="text-cyan-400 hover:text-white flex items-center gap-1"><Icons.Plus /> Add</button>
                                            </div>
                                            {bodies.map((b, i) => (
                                                <div key={i} className="glass-card p-2 rounded flex items-center justify-between">
                                                    <div className="flex items-center gap-2">
                                                        <div className="w-2 h-2 rounded-full" style={{backgroundColor: b.col}}></div>
                                                        <span className="text-xs font-mono text-slate-300">{b.name || `Body ${i}`}</span>
                                                    </div>
                                                    <div className="flex items-center gap-2">
                                                        <span className="text-[9px] text-slate-500">m:{b.m.toFixed(1)}</span>
                                                        <button onClick={() => removeBody(i)} className="text-red-500 hover:text-white"><Icons.Trash /></button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </>
                                ) : (
                                    <div className="grid gap-3"> 
                                        <EqInput label="X-Accel" sub="\ddot{x}=" val={eqs.x} set={v=>setEqs({...eqs,x:v})} color="border-blue-500" /> 
                                        <EqInput label="Y-Accel" sub="\ddot{y}=" val={eqs.y} set={v=>setEqs({...eqs,y:v})} color="border-purple-500" /> 
                                        <EqInput label="Z-Accel" sub="\ddot{z}=" val={eqs.z} set={v=>setEqs({...eqs,z:v})} color="border-emerald-500" /> 
                                    </div> 
                                )}
                            </div> 
                        )}
                        {tab === 'graph' && (<div className="h-full overflow-y-auto p-4 space-y-4 scroller"><GraphCard title="Phase Space (Vx vs X)" data={displayData} x="x" y="vx" col="#fbbf24" /><GraphCard title="Trajectory (Y vs X)" data={displayData} x="x" y="y" col="#3b82f6" /></div>)}
                        {tab === 'data' && (
                            <div className="h-full flex flex-col">
                                <div className="p-2 flex justify-between border-b border-white/10"><span className="text-[10px] text-slate-500 pt-1 font-display uppercase">Data Stream</span><button onClick={()=>{const doc=new jspdf.jsPDF();doc.autoTable({head:[Object.keys(displayData[0] || {})], body:displayData.map(Object.values)});doc.save('sim_data.pdf')}} className="bg-slate-800 text-cyan-400 text-[10px] px-3 py-1 rounded border border-slate-700 hover:bg-cyan-900">EXPORT PDF</button></div>
                                <div className="flex-1 overflow-auto scroller">
                                    {renderTable()}
                                </div>
                            </div>
                        )}
                    </div> 
                </div> 
            )} 
        </div> 
    );
};
// --- 2. EMSOLVER (Electromagnetism: Maxwell & Lorentz) ---
const EMSolver = () => {
    const vibrate = useHaptics();
    const toast = useToast();
    const { btnSize, gap, text } = useUIAdaptation();
    
    const PRESETS = { 
        cyclotron: { name: "Cyclotron Motion", Ex: "0", Ey: "0", Ez: "0", Bx: "0", By: "0", Bz: "1", q: 1, m: 1 }, 
        drift: { name: "E x B Drift", Ex: "0", Ey: "1", Ez: "0", Bx: "0", By: "0", Bz: "1", q: 1, m: 1 }, 
        wave: { name: "EM Wave Field", Ex: "cos(t-z)", Ey: "0", Ez: "0", Bx: "0", By: "cos(t-z)", Bz: "0", q: 1, m: 1 } 
    };

    const [fullScreen, setFullScreen] = useState(false); 
    const [tab, setTab] = useState('textbook'); 
    const [playing, setPlaying] = useState(true); 
    const [fields, setFields] = useLocalStorage('em_fields', PRESETS.cyclotron); 
    const [dt, setDt] = useState(0.02);
    const [precision, setPrecision] = useState(4);
    
    // View Settings
    const [showTrails, setShowTrails] = useState(true);
    const [showAxes, setShowAxes] = useState(false);
    
    // Physics State
    const historyRef = useRef([]); 
    const [displayData, setDisplayData] = useState([]); 
    const bodiesRef = useRef([{ x: 0, y: 0, z: 0, vx: 2, vy: 0, vz: 0, Ex:0, Ey:0, Ez:0, Bx:0, By:0, Bz:0, Fx:0, Fy:0, Fz:0 }]); 
    const timeRef = useRef(0); 
    const fieldFuncRef = useRef(null); 
    const [stats, setStats] = useState({v: 0, f: 0}); 
    
    const canvasRef = useRef(null);
    const { recording, startRecording, stopRecording } = useCanvasRecorder(canvasRef);

    useEffect(() => { 
        try { 
            fieldFuncRef.current = new Function('x','y','z','t', `return { Ex: ${parseEq(fields.Ex)}, Ey: ${parseEq(fields.Ey)}, Ez: ${parseEq(fields.Ez)}, Bx: ${parseEq(fields.Bx)}, By: ${parseEq(fields.By)}, Bz: ${parseEq(fields.Bz)} };`); 
        } catch(e) { } 
    }, [fields]);

    const loadPreset = (key) => { 
        const p = PRESETS[key]; 
        setFields(p); 
        bodiesRef.current = [{ x:0,y:0,z:0,vx:2,vy:0,vz:0,Ex:0,Ey:0,Ez:0,Bx:0,By:0,Bz:0,Fx:0,Fy:0,Fz:0 }]; 
        timeRef.current = 0; 
        historyRef.current = []; 
        setDisplayData([]); 
        vibrate(); 
        if(toast) toast(`Loaded: ${p.name}`); 
    };
    
    useEffect(() => { 
        let frameId; 
        const loop = () => { 
            if (!playing || !fieldFuncRef.current) return; 
            const b = bodiesRef.current[0]; 
            const t = timeRef.current; 
            const calc = fieldFuncRef.current; 
            const {q,m} = fields; 

            // RK4 Integrator for Lorentz Force
            const getAccel = (x, y, z, vx, vy, vz, t) => { 
                const f = calc(x, y, z, t); 
                return { 
                    ax: (q/m)*(f.Ex + vy*f.Bz - vz*f.By), 
                    ay: (q/m)*(f.Ey + vz*f.Bx - vx*f.Bz), 
                    az: (q/m)*(f.Ez + vx*f.By - vy*f.Bx), 
                    f 
                }; 
            }; 

            const k1 = getAccel(b.x, b.y, b.z, b.vx, b.vy, b.vz, t); 
            const k2 = getAccel(b.x+b.vx*0.5*dt, b.y+b.vy*0.5*dt, b.z+b.vz*0.5*dt, b.vx+k1.ax*0.5*dt, b.vy+k1.ay*0.5*dt, b.vz+k1.az*0.5*dt, t+0.5*dt); 
            const k3 = getAccel(b.x+b.vx*0.5*dt, b.y+b.vy*0.5*dt, b.z+b.vz*0.5*dt, b.vx+k2.ax*0.5*dt, b.vy+k2.ay*0.5*dt, b.vz+k2.az*0.5*dt, t+0.5*dt); 
            const k4 = getAccel(b.x+b.vx*dt, b.y+b.vy*dt, b.z+b.vz*dt, b.vx+k3.ax*dt, b.vy+k3.ay*dt, b.vz+k3.az*dt, t+dt); 

            const nx = b.x + (dt/6)*(b.vx + 2*(b.vx+k1.ax*0.5*dt) + 2*(b.vx+k2.ax*0.5*dt) + (b.vx+k3.ax*dt)); 
            const nvx = b.vx + (dt/6)*(k1.ax + 2*k2.ax + 2*k3.ax + k4.ax); 
            const nvy = b.vy + (dt/6)*(k1.ay + 2*k2.ay + 2*k3.ay + k4.ay); 
            const nvz = b.vz + (dt/6)*(k1.az + 2*k2.az + 2*k3.az + k4.az); 
            const ny = b.y + b.vy*dt; 
            const nz = b.z + b.vz*dt; 
            
            const f = calc(nx, ny, nz, t+dt); 
            const newBody = { x:nx, y:ny, z:nz, vx:nvx, vy:nvy, vz:nvz, ...f, Fx:k4.ax*m, Fy:k4.ay*m, Fz:k4.az*m }; 
            
            bodiesRef.current = [newBody]; 
            timeRef.current += dt; 
            historyRef.current.push(newBody); 
            if (historyRef.current.length > 1500) historyRef.current.shift(); 
            
            if(Math.random() > 0.8) setStats({v: Math.sqrt(nvx**2+nvy**2+nvz**2), f: Math.sqrt(newBody.Fx**2+newBody.Fy**2+newBody.Fz**2)});
            frameId = requestAnimationFrame(loop); 
        }; 
        if(playing) loop(); return () => cancelAnimationFrame(frameId); 
    }, [playing, fields, dt]);

    // Data Sampling
    useEffect(() => { 
        const id = setInterval(() => { 
            if(playing && historyRef.current.length > 0) { 
                const last = historyRef.current[historyRef.current.length-1]; 
                setDisplayData(prev => { 
                    const nu = [...prev, { t: timeRef.current, ...last }]; 
                    if(nu.length > 500) return nu.slice(-500); 
                    return nu; 
                }); 
            } 
        }, 200); 
        return () => clearInterval(id); 
    }, [playing]);
    
    const draw = (ctx, project, w, h) => { 
        const hist = historyRef.current; 
        
        // Draw Field Grid (if enabled)
        if(fieldFuncRef.current && showAxes) {
            ctx.globalAlpha = 0.1; ctx.strokeStyle = '#475569';
            for(let x=-20; x<=20; x+=10) { 
                for(let y=-20; y<=20; y+=10) { 
                    const p = project(x,y,0); 
                    try { 
                        const f = fieldFuncRef.current(x,y,0,timeRef.current); 
                        if(Math.abs(f.Bz) > 0.1) { ctx.beginPath(); ctx.arc(p.x, p.y, 2, 0, 7); ctx.stroke(); } 
                    } catch(e){} 
                } 
            }
            ctx.globalAlpha = 1.0;
        }

        // Draw Trails
        if (hist.length > 1 && showTrails) { 
            ctx.beginPath(); ctx.strokeStyle = '#a855f7'; ctx.lineWidth = 2; ctx.shadowBlur = 10; ctx.shadowColor = '#a855f7'; ctx.globalAlpha = 0.6; 
            for(let i=0; i<hist.length; i+=2) { 
                const p = project(hist[i].x, hist[i].y, hist[i].z); 
                if (i===0) ctx.moveTo(p.x, p.y); else ctx.lineTo(p.x, p.y); 
            } 
            ctx.stroke(); ctx.shadowBlur = 0; ctx.globalAlpha = 1.0; 
        } 
        
        // Draw Particle
        const b = bodiesRef.current[0]; 
        const p = project(b.x, b.y, b.z); 
        const rad = Math.max(2, 6 * (p.s/20)); 
        ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(p.x, p.y, rad, 0, 7); ctx.fill(); 
        
        // Draw Force Vectors
        const dv = (vx,vy,vz,c) => { 
            const e = project(b.x+vx*0.5, b.y+vy*0.5, b.z+vz*0.5); 
            ctx.beginPath(); ctx.strokeStyle = c; ctx.lineWidth = 2; ctx.moveTo(p.x, p.y); ctx.lineTo(e.x, e.y); ctx.stroke(); 
        }; 
        dv(b.Ex,b.Ey,b.Ez,'#fbbf24'); // Electric Field Vector
        dv(b.Bx,b.By,b.Bz,'#22d3ee'); // Magnetic Field Vector
        dv(b.Fx,b.Fy,b.Fz,'#ef4444'); // Net Force Vector
    };
    
    return ( 
        <div className={`flex flex-col h-[calc(100dvh-60px)] -m-4 relative ${fullScreen ? 'fixed inset-0 z-50 m-0 bg-slate-950' : ''}`}> 
            <div className={`relative transition-all duration-500 bg-slate-900 overflow-hidden shadow-xl z-20 ${fullScreen ? 'absolute inset-0 h-full' : 'h-[35%] shrink-0'}`}> 
                <SimCanvas draw={draw} initZoom={20} showAxes={showAxes} onInitRecorder={(ref) => canvasRef.current = ref.current} /> 
                <div className={`absolute top-4 right-4 flex items-center ${gap}`}> 
                    <button onClick={recording ? stopRecording : startRecording} className={`${btnSize} rounded-full backdrop-blur border border-white/10 ${recording ? 'bg-red-500/20 text-red-500 animate-pulse' : 'bg-slate-800/80 text-white'}`}>{recording ? <Icons.StopRec /> : <Icons.Record />}</button> 
                    <button onClick={() => { bodiesRef.current=[{x:0,y:0,z:0,vx:2,vy:0,vz:0,Ex:0,Ey:0,Ez:0,Bx:0,By:0,Bz:0,Fx:0,Fy:0,Fz:0}]; timeRef.current=0; historyRef.current=[]; setDisplayData([]); vibrate(); }} className={`${btnSize} rounded-full bg-slate-800/80 text-slate-400 hover:text-white backdrop-blur border border-white/10`}><Icons.Reset /></button> 
                    <button onClick={() => {setPlaying(!playing); vibrate();}} className={`${btnSize} rounded-full bg-blue-600/90 text-white shadow-lg shadow-blue-500/50 backdrop-blur`}>{playing ? <Icons.Pause /> : <Icons.Play />}</button> 
                    <button onClick={()=>setFullScreen(!fullScreen)} className={`${btnSize} rounded-full bg-slate-800/80 text-slate-400 hover:text-white backdrop-blur border border-white/10`}>{fullScreen ? <Icons.Shrink /> : <Icons.Expand />}</button> 
                </div> 
                <div className="absolute bottom-4 left-4 text-[10px] font-mono text-slate-400 pointer-events-none"> 
                    <span className="text-yellow-400 font-bold">|v|: {stats.v.toFixed(precision)}</span> | <span className="text-red-400 font-bold">F: {stats.f.toFixed(precision)}</span> 
                </div> 
            </div> 

            {!fullScreen && ( 
                <div className="flex-1 flex flex-col glass-panel overflow-hidden border-t-0"> 
                    <div className="flex border-b border-white/10 shrink-0 bg-slate-900/50"> 
                        {['story', 'textbook', 'lab', 'table', 'graph'].map(id => (<button key={id} onClick={() => setTab(id)} className={`flex-1 py-3 text-[10px] font-bold uppercase tracking-widest transition font-display ${tab === id ? 'text-cyan-400 bg-white/5 border-b-2 border-cyan-500' : 'text-slate-500 hover:text-slate-300'}`}>{id}</button>))} 
                    </div> 
                    <div className="flex-1 overflow-hidden relative bg-slate-900/80"> 
                        {tab === 'story' && (
                            <div className="h-full overflow-y-auto scroller p-6 space-y-8 pb-20">
                                <div className="animate-in fade-in slide-in-from-bottom-4 duration-700">
                                    <h3 className="text-violet-500 font-bold text-xs uppercase tracking-widest mb-2 font-display">1865: THE SOURCE CODE</h3>
                                    <h1 className="text-3xl font-bold text-white mb-4 font-display">Electromagnetism</h1>
                                    <p className="text-slate-300 text-sm leading-7">Before the 19th century, electricity and magnetism were seen as separate novelties. <strong>James Clerk Maxwell</strong> unified them with four elegant equations. He showed that changing electric fields create magnetic fields, and vice versa.</p>
                                    <div className="glass-card p-4 rounded-xl border border-white/10 shadow-lg my-6"> 
                                        <h4 className="text-white font-bold text-sm font-display mb-2">Lorentz Force Law</h4> 
                                        <div className="font-mono text-violet-300 text-xs mb-2"><Latex tex="\vec{F} = q(\vec{E} + \vec{v} \times \vec{B})" /></div> 
                                        <p className="text-slate-300 text-xs leading-5"> This simulation solves the Lorentz Force Law in real-time. The particle reads the fields at its location and updates its velocity instantly. </p> 
                                    </div>
                                </div>
                            </div>
                        )}
                        {tab === 'textbook' && (
                            <div className="h-full overflow-y-auto scroller p-4 pb-20">
                                <div className="paper-bg text-sm rounded-sm mb-4 shadow-xl">
                                    <h3 className="text-black font-bold text-xl mb-4 border-b border-black/10 pb-2">Maxwell's Equations</h3>
                                    <p><strong>1. Gauss's Law</strong></p>
                                    <div className="my-2 text-center text-xs"><Latex tex="\nabla \cdot E = \frac{\rho}{\epsilon_0}" dark={false} /></div>
                                    <p>Electric charge produces an electric field.</p>
                                    <p><strong>2. Gauss's Law for Magnetism</strong></p>
                                    <div className="my-2 text-center text-xs"><Latex tex="\nabla \cdot B = 0" dark={false} /></div>
                                    <p>There are no magnetic monopoles.</p>
                                    <p><strong>3. Faraday's Law</strong></p>
                                    <div className="my-2 text-center text-xs"><Latex tex="\nabla \times E = -\frac{\partial B}{\partial t}" dark={false} /></div>
                                    <p>A changing magnetic field induces an electric field.</p>
                                    <p><strong>4. Ampere-Maxwell Law</strong></p>
                                    <div className="my-2 text-center text-xs"><Latex tex="\nabla \times B = \mu_0 J + \mu_0 \epsilon_0 \frac{\partial E}{\partial t}" dark={false} /></div>
                                    <p>Moving charges and changing E-fields create B-fields.</p>
                                </div>
                            </div>
                        )}
                        {tab === 'lab' && ( 
                            <div className="h-full overflow-y-auto p-4 space-y-4 scroller"> 
                                <div className="flex gap-2 overflow-x-auto pb-2 no-scrollbar">{Object.entries(PRESETS).map(([k, v]) => (<button key={k} onClick={() => loadPreset(k)} className="shrink-0 px-3 py-1 rounded border border-slate-700 text-[10px] font-bold text-slate-400 hover:bg-violet-900/50 hover:text-violet-300 hover:border-violet-500 transition font-display">{v.name}</button>))}</div> 
                                <div className="glass-card p-4 space-y-3 border-l-2 border-yellow-500">
                                    <div className="text-[10px] font-bold text-yellow-500 uppercase tracking-wider font-display">System Settings</div>
                                    <ParamInput label="Time Step (dt)" val={dt} set={setDt} step="0.001" unit="s" />
                                    <div className="grid grid-cols-2 gap-2 pt-2 border-t border-white/5">
                                        <button onClick={()=>setShowTrails(!showTrails)} className={`flex items-center justify-between px-2 py-1 rounded text-xs ${showTrails ? 'bg-violet-500/20 text-violet-300' : 'bg-slate-800 text-slate-500'}`}><span>Trails</span><Icons.Trail /></button>
                                        <button onClick={()=>setShowAxes(!showAxes)} className={`flex items-center justify-between px-2 py-1 rounded text-xs ${showAxes ? 'bg-violet-500/20 text-violet-300' : 'bg-slate-800 text-slate-500'}`}><span>Field Grid</span><Icons.Axes /></button>
                                    </div>
                                </div>
                                <div className="grid grid-cols-2 gap-3"> 
                                    <div className="space-y-2"><div className="text-[10px] font-bold text-yellow-500 uppercase tracking-wider">Electric (E)</div><EqInput label="Ex" val={fields.Ex} set={v=>setFields({...fields,Ex:v})} color="border-yellow-500"/><EqInput label="Ey" val={fields.Ey} set={v=>setFields({...fields,Ey:v})} color="border-yellow-500"/><EqInput label="Ez" val={fields.Ez} set={v=>setFields({...fields,Ez:v})} color="border-yellow-500"/></div> 
                                    <div className="space-y-2"><div className="text-[10px] font-bold text-cyan-500 uppercase tracking-wider">Magnetic (B)</div><EqInput label="Bx" val={fields.Bx} set={v=>setFields({...fields,Bx:v})} color="border-cyan-500"/><EqInput label="By" val={fields.By} set={v=>setFields({...fields,By:v})} color="border-cyan-500"/><EqInput label="Bz" val={fields.Bz} set={v=>setFields({...fields,Bz:v})} color="border-cyan-500"/></div> 
                                </div> 
                            </div> 
                        )} 
                        {tab === 'table' && ( 
                            <div className="h-full flex flex-col"> 
                                <div className="p-2 flex justify-between border-b border-white/10"><span className="text-[10px] text-slate-500 pt-1 font-display uppercase">Real-time Data</span><button onClick={()=>{const doc=new jspdf.jsPDF();doc.autoTable({head:[['T','X','Y','Vx','Vy']],body:displayData.map(d=>[d.t.toFixed(precision),d.x.toFixed(precision),d.y.toFixed(precision),d.vx.toFixed(precision),d.vy.toFixed(precision)])});doc.save('em_data.pdf')}} className="bg-slate-800 text-cyan-400 text-[10px] px-3 py-1 rounded border border-slate-700 hover:bg-cyan-900">EXPORT PDF</button></div> 
                                <div className="flex-1 overflow-auto scroller">
                                    {displayData.length > 0 ? (
                                        <table className="data-table">
                                            <thead><tr><th>T</th><th>X</th><th>Y</th><th>Vx</th><th>Vy</th></tr></thead>
                                            <tbody>{displayData.slice().reverse().map((r, i) => (<tr key={i}><td className="text-violet-400 font-bold">{r.t.toFixed(precision)}</td><td>{r.x.toFixed(precision)}</td><td>{r.y.toFixed(precision)}</td><td>{r.vx.toFixed(precision)}</td><td>{r.vy.toFixed(precision)}</td></tr>))}</tbody>
                                        </table>
                                    ) : (
                                        <div className="text-slate-500 italic p-4 text-center">Collecting data points...</div>
                                    )}
                                </div> 
                            </div> 
                        )} 
                        {tab === 'graph' && (<div className="h-full overflow-y-auto p-4 space-y-4 scroller"><div className="grid grid-cols-2 gap-3"><GraphCard title="Pos X-Y" data={displayData} x="x" y="y" col="#fbbf24" /><GraphCard title="Phase Vx-Vy" data={displayData} x="vx" y="vy" col="#22d3ee" /></div></div>)} 
                    </div> 
                </div> 
            )} 
        </div> 
    );
};

// --- 3. THERMOSOLVER (Thermodynamics & Statistical Mechanics) ---
const ThermoSolver = () => {
    const vibrate = useHaptics();
    const toast = useToast();
    const { btnSize, gap, text } = useUIAdaptation();
    
    const PRESETS = { 
        zero: { name: "Zeroth Law (Mixing)", force: "0", setup: "mixing" }, 
        first: { name: "First Law (Work)", force: "0", setup: "work" }, 
        second: { name: "Second Law (Entropy)", force: "0", setup: "entropy" }, 
        real: { name: "Real Gas (VDW)", force: "400*((1/r)**12 - (1/r)**6)", setup: "mixing" } // Lennard-Jones
    };
    const [fullScreen, setFullScreen] = useState(false); 
    const [tab, setTab] = useState('story'); 
    const [playing, setPlaying] = useState(true);
    const [config, setConfig] = useLocalStorage('thermo_cfg', { N: 150, force: "0", heat: 1.0, volume: 1.0 });
    const [precision, setPrecision] = useState(2);
    
    const bodiesRef = useRef([]); 
    const statsRef = useRef({ P:0, T:0, V:0, S:0 }); 
    const timeRef = useRef(0);
    const [displayData, setDisplayData] = useState([]); 
    const funcRef = useRef(null);
    
    const canvasRef = useRef(null);
    const { recording, startRecording, stopRecording } = useCanvasRecorder(canvasRef);
    
    const init = (mode) => {
        let arr = []; const N = config.N;
        for(let i=0; i<N; i++) {
            let x, y, z, vx, vy, vz, color;
            // Setup Initial Conditions
            if(mode === 'mixing') { 
                if(i < N/2) { x=Math.random()*40+5; y=Math.random()*40+5; z=Math.random()*40+5; vx=(Math.random()-0.5)*4; vy=(Math.random()-0.5)*4; vz=(Math.random()-0.5)*4; color='#ef4444'; } 
                else { x=Math.random()*40+55; y=Math.random()*40+5; z=Math.random()*40+5; vx=(Math.random()-0.5)*1; vy=(Math.random()-0.5)*1; vz=(Math.random()-0.5)*1; color='#3b82f6'; } 
            } 
            else if (mode === 'work') { x=Math.random()*90+5; y=Math.random()*40+5; z=Math.random()*40+5; vx=(Math.random()-0.5)*3; vy=(Math.random()-0.5)*3; vz=(Math.random()-0.5)*3; color='#fbbf24'; } 
            else { x=Math.random()*20+5; y=Math.random()*20+5; z=Math.random()*20+5; vx=(Math.random()-0.5)*5; vy=(Math.random()-0.5)*5; vz=(Math.random()-0.5)*5; color='#10b981'; }
            arr.push({ x, y, z, vx, vy, vz, color });
        }
        bodiesRef.current = arr; timeRef.current = 0; setDisplayData([]); vibrate();
        if(toast) toast("Thermodynamic System Reset");
    };
    
    useEffect(() => init(PRESETS.zero.setup), []);
    
    // Physics Engine
    useEffect(() => {
        if(!playing) return;
        try { funcRef.current = new Function('r', `return ${parseEq(config.force)}`); } catch(e) { return; }
        let frame;
        const loop = () => {
            const dt = 0.1; const boxW = 100 * config.volume; const boxH = 50; const boxD = 50;
            let P_impulse = 0; let KE = 0; 
            const forceFunc = funcRef.current;
            const bodies = bodiesRef.current;
            
            // Particle Interactions (Simplified O(N^2) for demo)
            if(config.force !== "0" && forceFunc) { 
                for(let i=0; i<bodies.length; i++){ 
                    for(let j=i+1; j<bodies.length; j++){ 
                        const b1 = bodies[i]; const b2 = bodies[j]; 
                        const dx = b2.x - b1.x; const dy = b2.y - b1.y; const dz = b2.z - b1.z; 
                        const r2 = dx*dx + dy*dy + dz*dz; 
                        if(r2 < 100 && r2 > 0.5) { // Cutoff range
                            const r = Math.sqrt(r2); 
                            const f = forceFunc(r); 
                            const fx = f * dx/r; const fy = f * dy/r; const fz = f * dz/r; 
                            b1.vx -= fx*dt; b1.vy -= fy*dt; b1.vz -= fz*dt; 
                            b2.vx += fx*dt; b2.vy += fy*dt; b2.vz += fz*dt; 
                        } 
                    } 
                } 
            }
            
            // Movement & Wall Collisions
            bodies.forEach(b => { 
                b.x += b.vx * dt; b.y += b.vy * dt; b.z += b.vz * dt; 
                
                // Thermostat (Heat Injection)
                if(Math.random() < 0.02) { 
                    const heatFactor = config.heat;
                    b.vx += (Math.random()-0.5)*heatFactor; 
                    b.vy += (Math.random()-0.5)*heatFactor; 
                    b.vz += (Math.random()-0.5)*heatFactor; 
                } 
                
                // Wall Bounces & Pressure Calculation
                if(b.x < 0) { b.x = 0; b.vx *= -1; P_impulse += Math.abs(b.vx); } 
                if(b.x > boxW) { b.x = boxW; b.vx *= -1; P_impulse += Math.abs(b.vx); } 
                if(b.y < 0) { b.y = 0; b.vy *= -1; P_impulse += Math.abs(b.vy); } 
                if(b.y > boxH) { b.y = boxH; b.vy *= -1; P_impulse += Math.abs(b.vy); } 
                if(b.z < 0) { b.z = 0; b.vz *= -1; P_impulse += Math.abs(b.vz); } 
                if(b.z > boxD) { b.z = boxD; b.vz *= -1; P_impulse += Math.abs(b.vz); } 
                
                KE += 0.5 * (b.vx**2 + b.vy**2 + b.vz**2); 
                
                // Color by speed
                const speed = Math.sqrt(b.vx**2 + b.vy**2 + b.vz**2); 
                b.color = speed > 4 ? '#ef4444' : speed > 2 ? '#fbbf24' : '#3b82f6'; 
            });
            
            timeRef.current += dt; 
            
            // Update Stats (averaged)
            if(Math.random() > 0.8) { 
                const newP = P_impulse / (dt * (2*(boxW*boxH + boxW*boxD + boxH*boxD))); 
                const newT = KE / bodies.length;
                statsRef.current.P = statsRef.current.P * 0.9 + newP * 0.1; // Smoothing
                statsRef.current.T = statsRef.current.T * 0.9 + newT * 0.1;
                statsRef.current.V = boxW * boxH * boxD; 
                // Boltzmann Entropy Approx S ~ ln(V) + 1.5 ln(T)
                statsRef.current.S = Math.log(Math.max(1, statsRef.current.V)) + 1.5 * Math.log(Math.max(1, statsRef.current.T)); 
            } 
            frame = requestAnimationFrame(loop);
        };
        loop(); return () => cancelAnimationFrame(frame);
    }, [playing, config]);

    // Data Logging
    useEffect(() => { 
        const id = setInterval(() => { 
            if(playing) { 
                const s = statsRef.current; 
                setDisplayData(p => { 
                    const n = [...p, { t: timeRef.current, P: s.P, V: s.V, T: s.T, S: s.S }]; 
                    return n.length > 300 ? n.slice(-300) : n; 
                }); 
            } 
        }, 250); 
        return () => clearInterval(id); 
    }, [playing]);
    
    const draw = (ctx, project, w, h) => {
        const boxW = 100*config.volume; const boxH = 50; const boxD = 50;
        // Draw Box Edges
        const corners = [ [0,0,0], [boxW,0,0], [boxW,boxH,0], [0,boxH,0], [0,0,boxD], [boxW,0,boxD], [boxW,boxH,boxD], [0,boxH,boxD] ]
            .map(c => project(c[0]-boxW/2, c[1]-boxH/2, c[2]-boxD/2));
        
        ctx.strokeStyle = '#64748b'; ctx.lineWidth = 1; 
        const edges = [[0,1],[1,2],[2,3],[3,0], [4,5],[5,6],[6,7],[7,4], [0,4],[1,5],[2,6],[3,7]]; 
        edges.forEach(e => { ctx.beginPath(); ctx.moveTo(corners[e[0]].x, corners[e[0]].y); ctx.lineTo(corners[e[1]].x, corners[e[1]].y); ctx.stroke(); });
        
        // Draw Particles
        bodiesRef.current.forEach(b => { 
            const p = project(b.x-boxW/2, b.y-boxH/2, b.z-boxD/2); 
            ctx.fillStyle = b.color; 
            ctx.beginPath(); ctx.arc(p.x, p.y, Math.max(1.5, 4*(p.s/20)), 0, 7); ctx.fill(); 
        });
    };
    
    // --- DYNAMIC TABLE RENDERER ---
    const renderTable = () => {
        if(displayData.length === 0) return <div className="text-slate-500 text-xs p-4 italic text-center">Initializing sensors...</div>;
        const headers = Object.keys(displayData[0]);
        return (
            <table className="data-table">
                <thead><tr>{headers.map(h => <th key={h}>{h.toUpperCase()}</th>)}</tr></thead>
                <tbody>
                    {displayData.slice().reverse().map((r, i) => (
                        <tr key={i}>
                            {headers.map(h => (
                                <td key={h} className={h==='t'?'text-amber-400 font-bold':''}>
                                    {typeof r[h] === 'number' ? r[h].toFixed(precision) : r[h]}
                                </td>
                            ))}
                        </tr>
                    ))}
                </tbody>
            </table>
        );
    };
    
    return ( 
        <div className={`flex flex-col h-[calc(100dvh-60px)] -m-4 relative ${fullScreen ? 'fixed inset-0 z-50 m-0 bg-slate-950' : ''}`}> 
            <div className={`relative transition-all duration-500 bg-slate-900 overflow-hidden shadow-xl z-20 ${fullScreen ? 'absolute inset-0 h-full' : 'h-[35%] shrink-0'}`}> 
                <SimCanvas draw={draw} initZoom={15} onInitRecorder={(ref) => canvasRef.current = ref.current} /> 
                <div className={`absolute top-4 right-4 flex items-center ${gap}`}> 
                    <button onClick={recording ? stopRecording : startRecording} className={`${btnSize} rounded-full backdrop-blur border border-white/10 ${recording ? 'bg-red-500/20 text-red-500 animate-pulse' : 'bg-slate-800/80 text-white'}`}>{recording ? <Icons.StopRec /> : <Icons.Record />}</button> 
                    <button onClick={() => init('mixing')} className={`${btnSize} rounded-full bg-slate-800/80 text-slate-400 hover:text-white backdrop-blur border border-white/10`}><Icons.Reset /></button> 
                    <button onClick={() => {setPlaying(!playing); vibrate();}} className={`${btnSize} rounded-full bg-blue-600/90 text-white shadow-lg shadow-blue-500/50 backdrop-blur`}>{playing ? <Icons.Pause /> : <Icons.Play />}</button> 
                    <button onClick={()=>setFullScreen(!fullScreen)} className={`${btnSize} rounded-full bg-slate-800/80 text-slate-400 hover:text-white backdrop-blur border border-white/10`}>{fullScreen ? <Icons.Shrink /> : <Icons.Expand />}</button> 
                </div> 
                <div className="absolute bottom-4 left-4 text-[10px] font-mono text-slate-400 flex gap-4 font-bold pointer-events-none"> 
                    <span className="text-amber-400">P: {statsRef.current.P.toFixed(3)}</span><span className="text-red-400">T: {statsRef.current.T.toFixed(precision)}</span><span className="text-blue-400">S: {statsRef.current.S.toFixed(precision)}</span> 
                </div> 
            </div> 

            {!fullScreen && ( 
                <div className="flex-1 flex flex-col glass-panel overflow-hidden border-t-0"> 
                    <div className="flex border-b border-white/10 shrink-0 bg-slate-900/50"> 
                        {['story', 'textbook', 'lab', 'table', 'graph'].map(id => (<button key={id} onClick={() => setTab(id)} className={`flex-1 py-3 text-[10px] font-bold uppercase tracking-widest transition font-display ${tab === id ? 'text-amber-400 bg-white/5 border-b-2 border-amber-500' : 'text-slate-500 hover:text-slate-300'}`}>{id}</button>))} 
                    </div> 
                    <div className="flex-1 overflow-hidden relative bg-slate-900/80"> 
                        {tab === 'story' && (
                            <div className="h-full overflow-y-auto scroller p-6 space-y-8 pb-20">
                                <div className="animate-in fade-in slide-in-from-bottom-4 duration-700">
                                    <h3 className="text-amber-500 font-bold text-xs uppercase tracking-widest mb-2 font-display">1877: THE ARROW OF TIME</h3>
                                    <h1 className="text-3xl font-bold text-white mb-4 font-display">Order to Chaos</h1>
                                    <p className="text-slate-300 text-sm leading-7">Why does a dropped egg break but never un-break? Newton's laws work backward in time just as well as forward. Yet, life flows in only one direction.</p>
                                    <div className="border-l-2 border-amber-500/30 pl-4 py-2 my-6"> 
                                        <p className="text-slate-400 text-xs italic mb-2">"Ludwig Boltzmann"</p> 
                                        <p className="text-slate-300 text-sm leading-6"> Boltzmann found the answer in the chaos of atoms. He argued that disorder is simply more probable than order. </p> 
                                    </div>
                                    <h4 className="text-white font-bold text-sm font-display mb-2">Entropy as Information</h4>
                                    <p className="text-slate-300 text-sm leading-7">Boltzmann's insight was that "heat" is just the kinetic energy of atoms. High entropy means we have very little information about where any specific atom is (disorder). Low entropy means the atoms are organized.</p>
                                </div>
                            </div>
                        )}
                        {tab === 'textbook' && (
                            <div className="h-full overflow-y-auto scroller p-4 pb-20">
                                <div className="paper-bg text-sm rounded-sm mb-4 shadow-xl">
                                    <h3 className="text-black font-bold text-xl mb-4 border-b border-black/10 pb-2">Thermodynamics</h3>
                                    <p><strong>1. Ideal Gas Law</strong></p>
                                    <div className="my-2 text-center"><Latex tex="PV = N k_B T" dark={false} /></div>
                                    <p><strong>2. Boltzmann's Entropy</strong></p>
                                    <div className="my-2 text-center"><Latex tex="S = k_B \ln \Omega" dark={false} /></div>
                                    <p><strong>3. Equipartition Theorem</strong></p>
                                    <div className="my-2 text-center"><Latex tex="U = \frac{f}{2} N k_B T" dark={false} /></div>
                                </div>
                            </div>
                        )}
                        {tab === 'lab' && ( 
                            <div className="h-full overflow-y-auto p-4 space-y-4 scroller"> 
                                <div className="flex gap-2 overflow-x-auto pb-2 no-scrollbar">{Object.entries(PRESETS).map(([k, v]) => (<button key={k} onClick={() => { setConfig({...config, force:v.force}); init(v.setup); }} className="shrink-0 px-3 py-1 rounded border border-slate-700 text-[10px] font-bold text-slate-400 hover:bg-amber-900/50 hover:text-amber-300 hover:border-amber-500 transition font-display">{v.name}</button>))}</div> 
                                <div className="glass-card p-4 space-y-3 border-l-2 border-amber-500">
                                    <div className="text-[10px] font-bold text-amber-500 uppercase tracking-wider font-display">System Settings</div>
                                    <ParamInput label="Precision" val={precision} set={setPrecision} step="1" unit="d" />
                                </div>
                                <div className="grid gap-4"> 
                                    <div className="space-y-2"><div className="text-[10px] font-bold text-orange-500 uppercase tracking-widest font-display">Process Control</div> 
                                    <div className="glass-card p-3 rounded flex flex-col gap-2"> 
                                        <div className="flex justify-between text-xs text-slate-400"><span>Heat Injection (T)</span><span className="font-mono text-orange-400">{config.heat}</span></div> 
                                        <input type="range" min="0" max="2" step="0.1" value={config.heat} onChange={e=>setConfig({...config, heat:parseFloat(e.target.value)})} className="w-full h-1 bg-orange-900/50 rounded appearance-none accent-orange-500 cursor-pointer" /> 
                                        <div className="flex justify-between text-xs text-slate-400 mt-2"><span>Volume (V)</span><span className="font-mono text-blue-400">{config.volume}</span></div> 
                                        <input type="range" min="0.3" max="1" step="0.1" value={config.volume} onChange={e=>setConfig({...config, volume:parseFloat(e.target.value)})} className="w-full h-1 bg-blue-900/50 rounded appearance-none accent-blue-500 cursor-pointer" /> 
                                    </div> 
                                    </div> <EqInput label="Interaction Potential F(r)" sub="F(r) =" val={config.force} set={v=>setConfig({...config, force:v})} color="border-emerald-500" /> 
                                </div> 
                            </div> 
                        )} 
                        {tab === 'table' && ( 
                            <div className="h-full flex flex-col"> 
                                <div className="p-2 flex justify-between border-b border-white/10"><span className="text-[10px] text-slate-500 pt-1 font-display uppercase">Thermodynamic State</span><button onClick={()=>{const doc=new jspdf.jsPDF();doc.autoTable({head:[Object.keys(displayData[0]||{})], body:displayData.map(Object.values)});doc.save('thermo_data.pdf')}} className="bg-slate-800 text-amber-400 text-[10px] px-3 py-1 rounded border border-slate-700 hover:bg-amber-900">EXPORT PDF</button></div> 
                                <div className="flex-1 overflow-auto scroller">{renderTable()}</div> 
                            </div> 
                        )} 
                        {tab === 'graph' && (<div className="h-full overflow-y-auto p-4 space-y-4 scroller"><div className="grid grid-cols-2 gap-3"><GraphCard title="PV Diagram" data={displayData} x="V" y="P" col="#fbbf24" /><GraphCard title="Entropy vs Time" data={displayData} x="t" y="S" col="#10b981" /></div></div>)} 
                    </div> 
                </div> 
            )} 
        </div> 
    );
};
// --- 4. WAVESOLVER (1D String, Sound, Light & 2D Ripple Tank) ---
const WaveSolver = () => {
    const vibrate = useHaptics();
    const toast = useToast();
    const { btnSize, gap, text } = useUIAdaptation();
    
    const PRESETS = { 
        string: { name: "String (1D)", type: 'trans', eq: "3 * sin(x - 2*t)", mode: '1d' }, 
        sound: { name: "Sound (1D)", type: 'long', eq: "3 * cos(x - 3*t)", mode: '1d' }, 
        light: { name: "Light (EM)", type: 'light', eq: "3 * sin(x - 4*t)", mode: '1d' }, 
        ripple: { name: "Ripple Tank (2D)", type: '2d', eq: "0", mode: '2d' } 
    };

    const [fullScreen, setFullScreen] = useState(false); 
    const [tab, setTab] = useState('story'); 
    const [playing, setPlaying] = useState(true);
    const [config, setConfig] = useLocalStorage('wave_cfg', PRESETS.string); 
    const [eqStr, setEqStr] = useState(PRESETS.string.eq);
    const [precision, setPrecision] = useState(3);
    
    const timeRef = useRef(0); 
    const funcRef = useRef(null); 
    const [displayData, setDisplayData] = useState([]);
    
    // 2D Wave Grid Refs
    const gridRef = useRef({ curr: [], prev: [], size: 60 });
    const canvasRef = useRef(null);
    const { recording, startRecording, stopRecording } = useCanvasRecorder(canvasRef);
    
    // Compile Equation
    useEffect(() => { 
        if(config.mode === '1d') {
            try { funcRef.current = new Function('x','t', `return ${parseEq(eqStr)}`); } catch(e) {} 
        }
    }, [eqStr, config.mode]);
    
    // Initialize 2D Grid
    const initGrid = () => {
        const size = 60; 
        const curr = []; const prev = [];
        for(let i=0; i<size; i++) { 
            curr[i] = new Float32Array(size); 
            prev[i] = new Float32Array(size); 
        }
        gridRef.current = { curr, prev, size };
        if(toast && config.mode === '2d') toast("Ripple Tank Reset");
    };

    useEffect(() => { if(config.mode === '2d') initGrid(); }, [config.mode]);

    // Physics Loop
    useEffect(() => { 
        if(!playing) return; 
        let frame; 
        const loop = () => { 
            timeRef.current += 0.05; 
            
            // 1D Logic
            if(config.mode === '1d' && funcRef.current && Math.random() > 0.8) { 
                try {
                    const y0 = funcRef.current(0, timeRef.current); 
                    setDisplayData(p => { 
                        const n = [...p, { t: timeRef.current, y: y0 }]; 
                        return n.length > 500 ? n.slice(-500) : n; 
                    }); 
                } catch(e) {}
            } 
            // 2D Logic (Wave Equation FDTD)
            else if (config.mode === '2d') {
                const { curr, prev, size } = gridRef.current;
                const damping = 0.99;
                for(let i=1; i<size-1; i++) {
                    for(let j=1; j<size-1; j++) {
                        const val = (curr[i-1][j] + curr[i+1][j] + curr[i][j-1] + curr[i][j+1]) / 2 - prev[i][j];
                        prev[i][j] = curr[i][j];
                        curr[i][j] = val * damping;
                    }
                }
                // Source oscillator in center
                curr[size/2][size/2] = Math.sin(timeRef.current * 2) * 5; 
            }
            frame = requestAnimationFrame(loop); 
        }; 
        loop(); return () => cancelAnimationFrame(frame); 
    }, [playing, config.mode]);
    
    // Interaction (Ripple Tank)
    const interact = (x, y, w, h) => {
        if(config.mode !== '2d') return;
        const { curr, size } = gridRef.current;
        const gx = Math.floor((x/w)*size); 
        const gy = Math.floor((y/h)*size);
        if(gx > 1 && gx < size-1 && gy > 1 && gy < size-1) { 
            curr[gx][gy] = 50; // Touch impact
            vibrate(5); 
        }
    };

    const draw = (ctx, project, w, h) => {
        const t = timeRef.current; 
        
        // 2D Draw
        if(config.mode === '2d') {
            const { curr, size } = gridRef.current;
            const cellW = w / size; const cellH = h / size;
            for(let i=0; i<size; i++) {
                for(let j=0; j<size; j++) {
                    const val = curr[i][j];
                    // Map amplitude to Blue intensity
                    const intensity = Math.min(255, Math.max(0, 10 + Math.abs(val) * 20));
                    ctx.fillStyle = `rgb(${intensity*0.1}, ${intensity*0.5}, ${intensity})`;
                    ctx.fillRect(i*cellW, j*cellH, cellW+0.5, cellH+0.5);
                }
            }
            return;
        }

        // 1D Draw
        const f = funcRef.current; if(!f) return;
        
        // Axis
        const start = project(-20, 0, 0); const end = project(20, 0, 0); 
        ctx.beginPath(); ctx.strokeStyle = '#475569'; ctx.moveTo(start.x, start.y); ctx.lineTo(end.x, end.y); ctx.stroke();
        
        // Calculate Points
        const points = []; 
        for(let x = -15; x <= 15; x += 0.5) { 
            points.push({x, y: f(x, t)}); 
        }

        if(config.type === 'trans') { 
            // Transverse Wave
            ctx.beginPath(); ctx.strokeStyle = '#ec4899'; ctx.lineWidth = 2; ctx.shadowBlur = 10; ctx.shadowColor = '#ec4899'; 
            points.forEach((pt, i) => { 
                const p = project(pt.x, pt.y, 0); 
                if(i===0) ctx.moveTo(p.x, p.y); else ctx.lineTo(p.x, p.y); 
                // Particle Visualization
                ctx.fillStyle = '#fbcfe8'; ctx.beginPath(); ctx.arc(p.x, p.y, 2, 0, 7); ctx.fill(); 
            }); 
            ctx.stroke(); ctx.shadowBlur = 0; 
        } 
        else if (config.type === 'long') { 
            // Longitudinal Wave
            points.forEach(pt => { 
                const dx = pt.y * 0.3; // Displacement in X
                const p = project(pt.x + dx, 0, 0); 
                const top = project(pt.x + dx, 2, 0); 
                const bot = project(pt.x + dx, -2, 0); 
                
                // Draw compression lines
                ctx.beginPath(); ctx.strokeStyle = `rgba(236, 72, 153, ${0.3 + Math.abs(pt.y)*0.2})`; 
                ctx.moveTo(top.x, top.y); ctx.lineTo(bot.x, bot.y); ctx.stroke(); 
                
                // Draw particles
                ctx.fillStyle = '#ec4899'; ctx.beginPath(); ctx.arc(p.x, p.y, Math.max(1, 4-Math.abs(dx)), 0, 7); ctx.fill(); 
            }); 
        }
        else if (config.type === 'light') { 
            // EM Wave (E and B fields orthogonal)
            ctx.beginPath(); ctx.strokeStyle = '#fbbf24'; ctx.lineWidth = 2; ctx.shadowBlur = 8; ctx.shadowColor = '#fbbf24'; 
            points.forEach((pt, i) => { 
                const p = project(pt.x, pt.y, 0); 
                if(i===0) ctx.moveTo(p.x, p.y); else ctx.lineTo(p.x, p.y); 
            }); 
            ctx.stroke(); 
            
            ctx.beginPath(); ctx.strokeStyle = '#22d3ee'; ctx.lineWidth = 2; ctx.shadowBlur = 8; ctx.shadowColor = '#22d3ee'; 
            points.forEach((pt, i) => { 
                const p = project(pt.x, 0, pt.y); // B field in Z
                if(i===0) ctx.moveTo(p.x, p.y); else ctx.lineTo(p.x, p.y); 
            }); 
            ctx.stroke(); ctx.shadowBlur = 0; 
        }
    };
    
    // --- DYNAMIC TABLE RENDERER ---
    const renderTable = () => {
        if(displayData.length === 0) return <div className="text-slate-500 italic p-4 text-center">Awaiting wave data...</div>;
        const headers = Object.keys(displayData[0]);
        return (
            <table className="data-table">
                <thead><tr>{headers.map(h => <th key={h}>{h.toUpperCase()}</th>)}</tr></thead>
                <tbody>
                    {displayData.slice().reverse().map((r, i) => (
                        <tr key={i}>
                            {headers.map(h => <td key={h} className={h==='t'?'text-pink-400 font-bold':''}>{typeof r[h]==='number'?r[h].toFixed(precision):r[h]}</td>)}
                        </tr>
                    ))}
                </tbody>
            </table>
        );
    };
    
    return ( 
        <div className={`flex flex-col h-[calc(100dvh-60px)] -m-4 relative ${fullScreen ? 'fixed inset-0 z-50 m-0 bg-slate-950' : ''}`}> 
            <div className={`relative transition-all duration-500 bg-slate-900 overflow-hidden shadow-xl z-20 ${fullScreen ? 'absolute inset-0 h-full' : 'h-[35%] shrink-0'}`}> 
                <SimCanvas draw={draw} initZoom={25} interact={interact} onInitRecorder={(ref) => canvasRef.current = ref.current} /> 
                <div className={`absolute top-4 right-4 flex items-center ${gap}`}> 
                    <button onClick={recording ? stopRecording : startRecording} className={`${btnSize} rounded-full backdrop-blur border border-white/10 ${recording ? 'bg-red-500/20 text-red-500 animate-pulse' : 'bg-slate-800/80 text-white'}`}>{recording ? <Icons.StopRec /> : <Icons.Record />}</button> 
                    <button onClick={() => { timeRef.current=0; setDisplayData([]); vibrate(); }} className={`${btnSize} rounded-full bg-slate-800/80 text-slate-400 hover:text-white backdrop-blur border border-white/10`}><Icons.Reset /></button> 
                    <button onClick={() => {setPlaying(!playing); vibrate();}} className={`${btnSize} rounded-full bg-blue-600/90 text-white shadow-lg shadow-blue-500/50 backdrop-blur`}>{playing ? <Icons.Pause /> : <Icons.Play />}</button> 
                    <button onClick={()=>setFullScreen(!fullScreen)} className={`${btnSize} rounded-full bg-slate-800/80 text-slate-400 hover:text-white backdrop-blur border border-white/10`}>{fullScreen ? <Icons.Shrink /> : <Icons.Expand />}</button> 
                </div> 
                <div className="absolute bottom-4 left-4 text-[10px] font-mono text-slate-400 pointer-events-none"> 
                    <span className="text-pink-400 font-bold">{config.name}</span> | <span className="text-slate-500">{config.mode==='2d' ? 'Touch to Ripple' : 'y(x,t)'}</span> 
                </div> 
            </div> 

            {!fullScreen && ( 
                <div className="flex-1 flex flex-col glass-panel overflow-hidden border-t-0"> 
                    <div className="flex border-b border-white/10 shrink-0 bg-slate-900/50"> 
                        {['story', 'textbook', 'sim', 'table', 'graph'].map(id => (<button key={id} onClick={() => setTab(id)} className={`flex-1 py-3 text-[10px] font-bold uppercase tracking-widest transition font-display ${tab === id ? 'text-pink-400 bg-white/5 border-b-2 border-pink-500' : 'text-slate-500 hover:text-slate-300'}`}>{id}</button>))} 
                    </div> 
                    <div className="flex-1 overflow-hidden relative"> 
                        {tab === 'story' && (
                            <div className="h-full overflow-y-auto scroller p-6 space-y-8 pb-20">
                                <div className="animate-in fade-in slide-in-from-bottom-4 duration-700">
                                    <h3 className="text-pink-500 font-bold text-xs uppercase tracking-widest mb-2 font-display">1801: THE RIPPLE EFFECT</h3>
                                    <h1 className="text-3xl font-bold text-white mb-4 font-display">Particle or Wave?</h1>
                                    <p className="text-slate-300 text-sm leading-7">Newton said light was a particle. Thomas Young disagreed. In 1801, Young fired light through two narrow slits and saw something impossible for particles: <strong>Interference</strong>.</p>
                                    <div className="glass-card p-4 rounded-xl border border-white/10 shadow-lg my-6"> 
                                        <h4 className="text-white font-bold text-sm font-display mb-2">The Wave Equation</h4> 
                                        <div className="text-pink-300 font-mono text-xs mb-2"><Latex tex="\frac{\partial^2 y}{\partial t^2} = v^2 \nabla^2 y" /></div> 
                                        <p className="text-slate-300 text-xs leading-5"> From the pluck of a guitar string to the colors of a soap bubble, the Wave Equation describes it all. </p> 
                                    </div>
                                </div>
                            </div>
                        )}
                        {tab === 'textbook' && (
                            <div className="h-full overflow-y-auto scroller p-4 pb-20">
                                <div className="paper-bg text-sm rounded-sm mb-4 shadow-xl">
                                    <h3 className="text-black font-bold text-xl mb-4 border-b border-black/10 pb-2">Wave Mechanics</h3>
                                    <p><strong>1. The Wave Equation</strong></p>
                                    <div className="my-2 text-center"><Latex tex="\frac{\partial^2 y}{\partial t^2} = v^2 \frac{\partial^2 y}{\partial x^2}" dark={false} /></div>
                                    <p><strong>2. Harmonic Solution</strong></p>
                                    <div className="my-2 text-center"><Latex tex="y(x,t) = A \sin(kx - \omega t)" dark={false} /></div>
                                    <p><strong>3. Phase Velocity</strong></p>
                                    <div className="my-2 text-center"><Latex tex="v = \lambda f" dark={false} /></div>
                                </div>
                            </div>
                        )}
                        {tab === 'sim' && ( 
                            <div className="h-full overflow-y-auto p-4 space-y-4 scroller"> 
                                <div className="flex gap-2 overflow-x-auto pb-2 no-scrollbar">{Object.entries(PRESETS).map(([k, v]) => (<button key={k} onClick={() => { setConfig(v); setEqStr(v.eq); vibrate(); }} className="shrink-0 px-3 py-1 rounded border border-slate-700 text-[10px] font-bold text-slate-400 hover:bg-pink-900/50 hover:text-pink-300 hover:border-pink-500 transition font-display">{v.name}</button>))}</div> 
                                {config.mode === '1d' ? ( <EqInput label="Wave Function y(x,t)" sub="y =" val={eqStr} set={setEqStr} color="border-pink-500" /> ) : ( <div className="p-4 text-center text-xs text-slate-400 italic glass-card rounded"> Touch/Click the simulation area to create ripples. </div> )}
                                <div className="glass-card p-4 space-y-3 border-l-2 border-pink-500">
                                    <div className="text-[10px] font-bold text-pink-500 uppercase tracking-wider font-display">Display Settings</div>
                                    <ParamInput label="Precision" val={precision} set={setPrecision} step="1" unit="d" />
                                </div>
                            </div> 
                        )} 
                        {tab === 'table' && ( 
                            <div className="h-full flex flex-col"> 
                                <div className="p-2 flex justify-between border-b border-white/10"><span className="text-[10px] text-slate-500 pt-1 font-display uppercase">Source Displacement (x=0)</span><button onClick={()=>{const doc=new jspdf.jsPDF();doc.autoTable({head:[Object.keys(displayData[0]||{})], body:displayData.map(Object.values)});doc.save('wave_data.pdf')}} className="bg-slate-800 text-pink-400 text-[10px] px-3 py-1 rounded border border-slate-700 hover:bg-pink-900">EXPORT PDF</button></div> 
                                <div className="flex-1 overflow-auto scroller">{renderTable()}</div> 
                            </div> 
                        )} 
                        {tab === 'graph' && (<div className="h-full overflow-y-auto p-4 space-y-4 scroller"><GraphCard title="Source Oscillation (y vs t at x=0)" data={displayData} x="t" y="y" col="#ec4899" /></div>)} 
                    </div> 
                </div> 
            )} 
        </div> 
    );
};

// --- 5. QUANTUM SOLVER (Schrödinger Equation) ---
const QuantumSolver = () => {
    const vibrate = useHaptics();
    const toast = useToast();
    const { btnSize, gap, text } = useUIAdaptation();
    const PRESETS = {
        well: { name: "Infinite Well", potType: "well", height: 1000, desc: "Particle trapped in box" },
        harmonic: { name: "Harmonic Osc.", potType: "harmonic", height: 0.5, desc: "Quantum Oscillator" },
        barrier: { name: "Tunneling", potType: "barrier", height: 25, desc: "Quantum Tunneling" }
    };

    const [fullScreen, setFullScreen] = useState(false);
    const [tab, setTab] = useState('story');
    const [playing, setPlaying] = useState(true);
    const [preset, setPreset] = useState('well');
    
    const [params, setParams] = useState({ height: 1000, width: 10, mass: 1 });
    const [displayData, setDisplayData] = useState([]);
    const [precision, setPrecision] = useState(3);

    const gridRef = useRef({ re: [], im: [], V: [], size: 100 });
    const timeRef = useRef(0);
    const canvasRef = useRef(null);
    const { recording, startRecording, stopRecording } = useCanvasRecorder(canvasRef);
    
    // Init Wavefunction (Gaussian Packet)
    const init = (key) => {
        const p = PRESETS[key];
        const size = 100;
        const re = new Float32Array(size);
        const im = new Float32Array(size);
        const V = new Float32Array(size);
        
        setParams(prev => ({ ...prev, height: p.height })); 

        for(let i=0; i<size; i++) {
            const x = (i - size/2) * 0.1;
            const x0 = key === 'barrier' ? -3 : 0; // Shift start for tunneling
            const env = Math.exp(-Math.pow(x-x0, 2));
            const k = key === 'barrier' ? 5 : 0; // Momentum
            re[i] = env * Math.cos(k*x);
            im[i] = env * Math.sin(k*x);
        }
        gridRef.current = { re, im, V, size };
        timeRef.current = 0;
        updatePotential(key, p.height);
        setDisplayData([]);
        if(toast) toast(`Preset Loaded: ${p.name}`);
    };

    const updatePotential = (key, hVal) => {
        const { V, size } = gridRef.current;
        const width = params.width; 
        for(let i=0; i<size; i++) {
            const x = (i - size/2) * 0.1;
            let val = 0;
            if (key === 'harmonic') val = hVal * x * x; 
            else if (key === 'barrier') { if (Math.abs(x - 2) < width/20) val = hVal; }
            else if (key === 'well') { if (Math.abs(x) > width/2) val = hVal; }
            V[i] = val;
        }
    };

    useEffect(() => init(preset), [preset]);
    useEffect(() => updatePotential(preset, params.height), [params.height, params.width]);

    // Schrödinger Integration
    useEffect(() => {
        if (!playing) return;
        let frame;
        const loop = () => {
            const { re, im, V, size } = gridRef.current;
            const dt = 0.005 / params.mass; 
            const dx = 0.1;
            const idx2 = 1 / (dx*dx);
            
            const nextRe = new Float32Array(size);
            const nextIm = new Float32Array(size);
            
            let probSum = 0; let centerOfMass = 0;

            // Simple Finite Difference (Real-Time approximation)
            for(let i=1; i<size-1; i++) {
                const lapRe = (re[i+1] - 2*re[i] + re[i-1]) * idx2;
                const lapIm = (im[i+1] - 2*im[i] + im[i-1]) * idx2;
                
                // H = -0.5*Laplacian + V
                const H_re = -0.5 * lapRe + V[i] * re[i];
                const H_im = -0.5 * lapIm + V[i] * im[i];
                
                // dPsi/dt = -i H Psi
                nextRe[i] = re[i] + H_im * dt;
                nextIm[i] = im[i] - H_re * dt;
                
                const prob = nextRe[i]**2 + nextIm[i]**2;
                probSum += prob; 
                centerOfMass += i * prob;
            }
            
            // Boundary Conditions (Hard Walls)
            nextRe[0]=0; nextRe[size-1]=0; nextIm[0]=0; nextIm[size-1]=0;
            
            gridRef.current.re = nextRe; 
            gridRef.current.im = nextIm;
            timeRef.current += dt;

            // Stats Logging
            if (Math.random() > 0.95) {
                setDisplayData(prev => {
                    const nu = [...prev, { 
                        t: timeRef.current, 
                        prob: probSum, 
                        com: probSum > 0 ? (centerOfMass/probSum - size/2)*0.1 : 0 
                    }];
                    return nu.slice(-100);
                });
            }
            frame = requestAnimationFrame(loop);
        };
        loop(); return () => cancelAnimationFrame(frame);
    }, [playing, params.mass]);

    const draw = (ctx, project, w, h) => {
        const { re, im, V, size } = gridRef.current;
        const scaleX = w / size;
        const centerY = h/2;
        
        // Draw Potential V(x)
        ctx.beginPath(); ctx.strokeStyle = '#334155'; ctx.lineWidth = 2;
        for(let i=0; i<size; i++) { 
            const y = centerY + 50 - Math.min(100, V[i] * 5); 
            if(i===0) ctx.moveTo(i*scaleX, y); else ctx.lineTo(i*scaleX, y); 
        }
        ctx.stroke();

        // Draw Probability Density |Psi|^2
        ctx.beginPath(); ctx.strokeStyle = '#22d3ee'; ctx.lineWidth = 3; ctx.shadowBlur = 15; ctx.shadowColor = '#22d3ee';
        for(let i=0; i<size; i++) { 
            const prob = (re[i]*re[i] + im[i]*im[i]); 
            const y = centerY + 50 - prob * 150; 
            if(i===0) ctx.moveTo(i*scaleX, y); else ctx.lineTo(i*scaleX, y); 
        }
        ctx.stroke(); ctx.shadowBlur = 0;
        
        // Draw Real Part (Phase)
        ctx.beginPath(); ctx.strokeStyle = 'rgba(236, 72, 153, 0.4)'; ctx.lineWidth = 1;
        for(let i=0; i<size; i++) { 
            const y = centerY + 50 - re[i] * 50; 
            if(i===0) ctx.moveTo(i*scaleX, y); else ctx.lineTo(i*scaleX, y); 
        }
        ctx.stroke();
    };

    const renderTable = () => {
        if(displayData.length === 0) return <div className={`text-slate-500 italic p-4 text-center ${text}`}>Calculating wavefunction...</div>;
        const headers = Object.keys(displayData[0]);
        return (
            <table className="data-table">
                <thead><tr>{headers.map(h => <th key={h}>{h.toUpperCase()}</th>)}</tr></thead>
                <tbody>
                    {displayData.slice().reverse().map((r, i) => (
                        <tr key={i}>
                            {headers.map(h => <td key={h} className={h==='t'?'text-cyan-400 font-bold':''}>{typeof r[h]==='number'?r[h].toFixed(precision):r[h]}</td>)}
                        </tr>
                    ))}
                </tbody>
            </table>
        );
    };

    return ( 
        <div className={`flex flex-col h-[calc(100dvh-60px)] -m-4 relative ${fullScreen ? 'fixed inset-0 z-50 m-0 bg-slate-950' : ''}`}> 
            <div className={`relative transition-all duration-500 bg-slate-900 overflow-hidden shadow-xl z-20 ${fullScreen ? 'absolute inset-0 h-full' : 'h-[35%] shrink-0'}`}> 
                <SimCanvas draw={draw} initZoom={1} onInitRecorder={(ref) => canvasRef.current = ref.current} /> 
                <div className={`absolute top-4 right-4 flex items-center ${gap}`}>
                    <button onClick={recording ? stopRecording : startRecording} className={`${btnSize} rounded-full backdrop-blur border border-white/10 ${recording ? 'bg-red-500/20 text-red-500 animate-pulse' : 'bg-slate-800/80 text-white'}`}>{recording ? <Icons.StopRec /> : <Icons.Record />}</button>
                    <button onClick={() => {init(preset); vibrate();}} className={`${btnSize} rounded-full bg-slate-800/80 text-slate-400 hover:text-white backdrop-blur border border-white/10`}><Icons.Reset /></button>
                    <button onClick={() => {setPlaying(!playing); vibrate();}} className={`${btnSize} rounded-full bg-blue-600/90 text-white shadow-lg shadow-blue-500/50 backdrop-blur`}>{playing ? <Icons.Pause /> : <Icons.Play />}</button>
                    <button onClick={()=>setFullScreen(!fullScreen)} className={`${btnSize} rounded-full bg-slate-800/80 text-slate-400 hover:text-white backdrop-blur border border-white/10`}>{fullScreen ? <Icons.Shrink /> : <Icons.Expand />}</button>
                </div>
                <div className="absolute bottom-4 left-4 text-[10px] font-mono text-slate-400 pointer-events-none">
                    <span className="text-cyan-400 font-bold">|Ψ|² Probability</span> | <span className="text-pink-400/60">Re(Ψ) Phase</span>
                </div>
            </div>
            {!fullScreen && ( 
                <div className="flex-1 flex flex-col glass-panel overflow-hidden border-t-0"> 
                    <div className="flex border-b border-white/10 shrink-0 bg-slate-900/50"> 
                        {['story', 'lab', 'table', 'textbook'].map(id => (<button key={id} onClick={() => setTab(id)} className={`flex-1 py-3 text-[10px] font-bold uppercase tracking-widest transition font-display ${tab === id ? 'text-cyan-400 bg-white/5 border-b-2 border-cyan-500' : 'text-slate-500 hover:text-slate-300'}`}>{id}</button>))} 
                    </div> 
                    <div className="flex-1 overflow-hidden relative">
                        {tab === 'story' && (
                            <div className="h-full overflow-y-auto scroller p-6 space-y-8 pb-20">
                                <div className="animate-in fade-in slide-in-from-bottom-4 duration-700">
                                    <h3 className="text-cyan-500 font-bold text-xs uppercase tracking-widest mb-2 font-display">1926: THE PROBABILITY WAVE</h3>
                                    <h1 className="text-3xl font-bold text-white mb-4 font-display">Schrödinger's Equation</h1>
                                    <p className="text-slate-300 text-sm leading-7">In the 1920s, physicists were baffled. Electrons seemed to be in two places at once. <strong>Erwin Schrödinger</strong> proposed a radical idea: particles are actually waves. But unlike water waves, these are waves of <em>probability</em>.</p>
                                    <div className="glass-card p-4 rounded-xl border border-white/10 shadow-lg my-6"> 
                                        <div className="text-cyan-300 font-mono text-xs mb-2 text-center"><Latex tex="i\hbar \frac{\partial \Psi}{\partial t} = \hat{H} \Psi" /></div> 
                                        <p className="text-slate-300 text-xs leading-5 text-center mt-2"> "Energy determines how the wavefunction rotates in the complex plane." </p> 
                                    </div>
                                    <h3 className="text-white font-bold text-lg mb-2 mt-6 border-b border-white/10 pb-1 font-display">Quantum Tunneling</h3>
                                    <p className="text-slate-300 text-sm leading-7">In the classical world, a ball cannot roll over a hill if it doesn't have enough energy. In the quantum world, the wavefunction can "leak" through the barrier, allowing the particle to appear on the other side. This is how the sun burns and how microchips work.</p>
                                </div>
                            </div>
                        )}
                        {tab === 'textbook' && (
                            <div className="h-full overflow-y-auto scroller p-4 pb-20">
                                <div className="paper-bg text-sm rounded-sm mb-4 shadow-xl">
                                    <h3 className="text-black font-bold text-xl mb-4 border-b border-black/10 pb-2">Quantum Mechanics</h3>
                                    <p><strong>1. Time-Dependent Schrödinger Equation</strong></p>
                                    <div className="my-2 text-center"><Latex tex="i\hbar \frac{\partial}{\partial t} \Psi(x,t) = \left[ -\frac{\hbar^2}{2m}\frac{\partial^2}{\partial x^2} + V(x) \right] \Psi(x,t)" dark={false} /></div>
                                    
                                    <p><strong>2. The Born Rule</strong></p>
                                    <div className="my-2 text-center"><Latex tex="P(x) = |\Psi(x)|^2 = \Psi^* \Psi" dark={false} /></div>
                                    
                                    <p><strong>3. Expectation Value</strong></p>
                                    <div className="my-2 text-center"><Latex tex="\langle x \rangle = \int_{-\infty}^{\infty} \Psi^* x \Psi \, dx" dark={false} /></div>
                                </div>
                            </div>
                        )}
                        {tab === 'lab' && (
                            <div className="h-full overflow-y-auto p-4 space-y-4 scroller">
                                <div className="flex gap-2 overflow-x-auto pb-2 no-scrollbar">{Object.entries(PRESETS).map(([k, v]) => (<button key={k} onClick={() => { setPreset(k); vibrate(); }} className="shrink-0 px-3 py-1 rounded border border-slate-700 text-[10px] font-bold text-slate-400 hover:bg-cyan-900/50 hover:text-cyan-300 hover:border-cyan-500 transition font-display">{v.name}</button>))}</div>
                                <div className="glass-card p-4 space-y-3 border-l-2 border-cyan-500">
                                    <div className="text-[10px] font-bold text-cyan-500 uppercase tracking-wider font-display">Parameters</div>
                                    <ParamInput label="Potential Height (V₀)" val={params.height} set={v => setParams(p => ({...p, height: v}))} step="10" min="0" max="2000" />
                                    <ParamInput label="Potential Width/Shape" val={params.width} set={v => setParams(p => ({...p, width: v}))} step="1" min="1" max="50" />
                                    <ParamInput label="Particle Mass (m)" val={params.mass} set={v => setParams(p => ({...p, mass: v}))} step="0.1" min="0.1" max="5" />
                                </div>
                            </div>
                        )}
                        {tab === 'table' && ( 
                            <div className="h-full flex flex-col"> 
                                <div className="p-2 flex justify-between border-b border-white/10"><span className="text-[10px] text-slate-500 pt-1 font-display uppercase">Wavefunction Data</span><button onClick={()=>{const doc=new jspdf.jsPDF();doc.autoTable({head:[['Time','Prob Sum','Expectation X']],body:displayData.map(d=>[d.t.toFixed(precision),d.prob.toFixed(precision),d.com.toFixed(precision)])});doc.save('quantum_data.pdf')}} className="bg-slate-800 text-cyan-400 text-[10px] px-3 py-1 rounded border border-slate-700 hover:bg-cyan-900">EXPORT PDF</button></div> 
                                <div className="flex-1 overflow-auto scroller">{renderTable()}</div> 
                            </div> 
                        )}
                    </div>
                </div>
            )}
        </div>
    );
};

// --- 6. RAY OPTICS SOLVER (Geometric Optics) ---
const RayOpticsSolver = () => {
    const vibrate = useHaptics();
    const { btnSize, gap, text } = useUIAdaptation();
    
    const PRESETS = {
        convex: { name: "Convex Lens Setup", elements: [{type:'lens', x:0, y:0, f:50, h:80}], sources: [{y:20, ang:0}, {y:0, ang:0}, {y:-20, ang:0}] },
        concave: { name: "Concave Lens Setup", elements: [{type:'lens', x:0, y:0, f:-50, h:80}], sources: [{y:20, ang:0}, {y:0, ang:0}, {y:-20, ang:0}] },
        mirror: { name: "Concave Mirror", elements: [{type:'mirror', x:50, y:0, r:100, h:80}], sources: [{y:30, ang:0}, {y:10, ang:0}] },
        telescope: { name: "Keplerian Telescope", elements: [{type:'lens', x:-100, y:0, f:100, h:100}, {type:'lens', x:60, y:0, f:30, h:40}], sources: [{y:40, ang:0}, {y:20, ang:0}, {y:0, ang:0}] }
    };

    const [fullScreen, setFullScreen] = useState(false);
    const [tab, setTab] = useState('lab');
    const [elements, setElements] = useState(PRESETS.convex.elements);
    const [sources, setSources] = useState(PRESETS.convex.sources);
    const [selectedIdx, setSelectedIdx] = useState(0); 
    
    const canvasRef = useRef(null);
    const { recording, startRecording, stopRecording } = useCanvasRecorder(canvasRef);
    
    const updateElement = (idx, field, val) => {
        const newEls = [...elements]; 
        newEls[idx] = { ...newEls[idx], [field]: val }; 
        setElements(newEls);
    };

    const interact = (x, y, w, h) => {
        // Simplified picking logic: find closest element in x
        const cx = x - w/2;
        // Transform screen x to world x is roughly scale dependent, but simplified here
        // Ideally we project click to world coordinates. 
        // For now, we cycle selection on click for better UX on mobile.
        setSelectedIdx(prev => (prev + 1) % elements.length);
        vibrate();
    };

    const trace = (ctx, project, w, h) => {
        sources.forEach(src => {
            let x = -w/2 + 20; let y = src.y; let ang = src.ang;
            ctx.beginPath(); ctx.strokeStyle = '#fbbf24'; ctx.lineWidth = 1.5; ctx.shadowBlur = 5; ctx.shadowColor = '#fbbf24';
            let p = project(x, y, 0); ctx.moveTo(p.x, p.y);
            
            let currentX = x; let currentY = y;
            // Sort elements by position to trace sequentially
            const sorted = elements.map((e,i)=>({...e, origIdx:i})).sort((a,b) => a.x - b.x);
            
            for(let i=0; i<sorted.length; i++) {
                const el = sorted[i];
                if(el.x <= currentX) continue; 
                
                const dx = el.x - currentX; 
                const dy = dx * Math.tan(ang); 
                const nextY = currentY + dy;
                
                // Intersection Check (Element Height)
                if(Math.abs(nextY - el.y) <= el.h/2) {
                    p = project(el.x, nextY, 0); ctx.lineTo(p.x, p.y);
                    
                    if(el.type === 'lens') { 
                        // Thin Lens Approximation: delta_theta = -y/f
                        const y_rel = nextY - el.y; 
                        ang = ang - (y_rel / el.f); 
                        currentX = el.x; currentY = nextY; 
                    } 
                    else if (el.type === 'mirror') { 
                        // Reflection
                        ang = Math.PI - ang; 
                        if(el.r) { 
                            const y_rel = nextY - el.y; 
                            // Approximate curved mirror normal
                            const normal = Math.asin(Math.max(-1, Math.min(1, y_rel/el.r))); 
                            ang = Math.PI - ang + 2*normal; 
                        } 
                        currentX = el.x; currentY = nextY; 
                        break; // Stop tracing after mirror
                    }
                }
            }
            
            // Ray to infinity
            const farX = w/2; 
            const farY = currentY + (farX - currentX) * Math.tan(ang);
            p = project(farX, farY, 0); ctx.lineTo(p.x, p.y); ctx.stroke(); ctx.shadowBlur = 0;
        });
    };

    const draw = (ctx, project, w, h) => {
        // Optical Axis
        const start = project(-w/2, 0, 0); const end = project(w/2, 0, 0);
        ctx.beginPath(); ctx.strokeStyle = '#334155'; ctx.setLineDash([5, 5]); ctx.moveTo(start.x, start.y); ctx.lineTo(end.x, end.y); ctx.stroke(); ctx.setLineDash([]);
        
        elements.forEach((el, i) => {
            const p = project(el.x, el.y, 0); 
            const h_proj = el.h * (p.s/20); 
            
            ctx.beginPath();
            const isSel = i === selectedIdx;
            
            if(el.type === 'lens') {
                ctx.strokeStyle = isSel ? '#f472b6' : '#38bdf8'; 
                ctx.fillStyle = 'rgba(56, 189, 248, 0.1)'; 
                ctx.lineWidth = isSel ? 3 : 2;
                ctx.ellipse(p.x, p.y, el.f > 0 ? 6 : 3, h_proj, 0, 0, Math.PI*2); 
                ctx.fill(); ctx.stroke();
                
                // Visual Markers for Focal Points
                if(isSel) {
                    const f1 = project(el.x - el.f, el.y, 0); const f2 = project(el.x + el.f, el.y, 0);
                    ctx.fillStyle = '#f472b6'; 
                    ctx.beginPath(); ctx.arc(f1.x, f1.y, 3, 0, 7); ctx.fill(); // F
                    ctx.beginPath(); ctx.arc(f2.x, f2.y, 3, 0, 7); ctx.fill(); // F'
                }
            } else if (el.type === 'mirror') {
                ctx.strokeStyle = isSel ? '#f472b6' : '#94a3b8'; ctx.lineWidth = 4;
                ctx.moveTo(p.x, p.y - h_proj); 
                if(el.r) ctx.quadraticCurveTo(p.x - (el.r>0?15:-15), p.y, p.x, p.y + h_proj); 
                else ctx.lineTo(p.x, p.y + h_proj); 
                ctx.stroke();
            }
        });
        trace(ctx, project, w, h);
    };
    
    const renderTable = () => {
        if(!elements || elements.length === 0) return <div className="text-slate-500 italic p-4 text-center">No optical elements defined.</div>;
        return (
            <table className="data-table">
                <thead><tr><th>Type</th><th>Pos (x)</th><th>Focal (f)</th><th>Height</th></tr></thead>
                <tbody>
                    {elements.map((e, i) => (
                        <tr key={i} className={i===selectedIdx ? 'bg-yellow-500/20' : ''}>
                            <td className="text-yellow-400 font-bold capitalize">{e.type}</td>
                            <td>{e.x}</td><td>{e.f}</td><td>{e.h}</td>
                        </tr>
                    ))}
                </tbody>
            </table>
        );
    };

    return (
        <div className={`flex flex-col h-[calc(100dvh-60px)] -m-4 relative ${fullScreen ? 'fixed inset-0 z-50 m-0 bg-slate-950' : ''}`}>
             <div className={`relative transition-all duration-500 bg-slate-900 overflow-hidden shadow-xl z-20 ${fullScreen ? 'absolute inset-0 h-full' : 'h-[40%] shrink-0'}`}> 
                <SimCanvas draw={draw} initZoom={25} interact={interact} onInitRecorder={(ref) => canvasRef.current = ref.current} />
                 <div className={`absolute top-4 right-4 flex items-center ${gap}`}>
                    <button onClick={recording ? stopRecording : startRecording} className={`${btnSize} rounded-full backdrop-blur border border-white/10 ${recording ? 'bg-red-500/20 text-red-500 animate-pulse' : 'bg-slate-800/80 text-white'}`}>{recording ? <Icons.StopRec /> : <Icons.Record />}</button>
                    <button onClick={()=>setFullScreen(!fullScreen)} className={`${btnSize} rounded-full bg-slate-800/80 text-slate-400 hover:text-white backdrop-blur border border-white/10`}>{fullScreen ? <Icons.Shrink /> : <Icons.Expand />}</button>
                </div>
            </div>
            {!fullScreen && (
                <div className="flex-1 flex flex-col glass-panel overflow-hidden border-t-0">
                     <div className="flex border-b border-white/10 shrink-0 bg-slate-900/50"> 
                        {['story', 'textbook', 'lab', 'data'].map(id => (<button key={id} onClick={() => setTab(id)} className={`flex-1 py-3 text-[10px] font-bold uppercase tracking-widest transition font-display ${tab === id ? 'text-yellow-400 bg-white/5 border-b-2 border-yellow-500' : 'text-slate-500 hover:text-slate-300'}`}>{id}</button>))}
                    </div>
                    <div className="flex-1 overflow-y-auto scroller">
                        {tab === 'story' && (
                            <div className="p-6 pb-20">
                                <div className="animate-in fade-in slide-in-from-bottom-4 duration-700">
                                    <h3 className="text-yellow-500 font-bold text-xs uppercase tracking-widest mb-2 font-display">1704: OPTICKS</h3>
                                    <h1 className="text-3xl font-bold text-white mb-4 font-display">Bending Light</h1>
                                    <p className="text-slate-300 text-sm leading-7">For centuries, the nature of light was a mystery. Isaac Newton argued that light was a stream of particles (corpuscles). He used prisms to show that white light is a mixture of colors. However, Christiaan Huygens argued light was a wave.</p>
                                    <div className="border-l-2 border-yellow-500/30 pl-4 py-2 my-6"> <p className="text-slate-400 text-xs italic mb-2">"Fermat's Principle"</p> <p className="text-slate-300 text-sm leading-6"> Regardless of its nature, light obeys the Principle of Least Time: it takes the path that minimizes travel time. This explains why lenses bend light—glass slows light down, so rays curve to minimize their time inside the glass. </p> </div>
                                </div>
                            </div>
                        )}
                        {tab === 'textbook' && (
                            <div className="p-4 pb-20">
                                <div className="paper-bg text-sm rounded-sm mb-4 shadow-xl">
                                    <h3 className="text-black font-bold text-xl mb-4 border-b border-black/10 pb-2">Geometric Optics</h3>
                                    <p><strong>1. Lens Maker's Formula</strong></p>
                                    <div className="my-2 text-center"><Latex tex="\frac{1}{f} = (n-1)\left(\frac{1}{R_1} - \frac{1}{R_2}\right)" dark={false} /></div>
                                    <p><strong>2. Thin Lens Equation</strong></p>
                                    <div className="my-2 text-center"><Latex tex="\frac{1}{f} = \frac{1}{d_o} + \frac{1}{d_i}" dark={false} /></div>
                                    <p><strong>3. Magnification</strong></p>
                                    <div className="my-2 text-center"><Latex tex="M = -\frac{d_i}{d_o} = \frac{h_i}{h_o}" dark={false} /></div>
                                </div>
                            </div>
                        )}
                        {tab === 'lab' && (
                            <div className="p-4 space-y-4 pb-20">
                                <div className="flex gap-2 overflow-x-auto pb-2 no-scrollbar">{Object.entries(PRESETS).map(([k, v]) => (<button key={k} onClick={() => { setElements(v.elements); setSources(v.sources); vibrate(); }} className="shrink-0 px-3 py-1 rounded border border-slate-700 text-[10px] font-bold text-slate-400 hover:bg-yellow-900/50 hover:text-yellow-300 hover:border-yellow-500 transition font-display">{v.name}</button>))}</div>
                                <div className="space-y-2">
                                     <div className="text-[10px] font-bold text-slate-400 uppercase tracking-wider font-display">Element List (Tap Graph to Select)</div>
                                     {elements.map((el, i) => (
                                         <button key={i} onClick={() => setSelectedIdx(i)} className={`w-full glass-card p-3 rounded flex justify-between items-center border ${selectedIdx===i ? 'border-yellow-500 bg-yellow-500/10' : 'border-white/5'}`}>
                                             <span className="text-xs font-mono text-cyan-300 capitalize">{el.type}</span>
                                             <div className="flex gap-2"><span className="text-[10px] text-slate-500">x: {el.x}</span><span className="text-[10px] text-slate-500">f: {el.f}</span></div>
                                         </button>
                                     ))}
                                </div>
                                <div className="glass-card p-4 space-y-3 border-l-2 border-yellow-500 mt-4">
                                    <div className="text-[10px] font-bold text-yellow-500 uppercase tracking-wider font-display">Edit Element #{selectedIdx + 1}</div>
                                    <ParamInput label="Position (x)" val={elements[selectedIdx]?.x || 0} set={v => updateElement(selectedIdx, 'x', v)} step="5" min="-100" max="100" />
                                    <ParamInput label="Focal Length (f)" val={elements[selectedIdx]?.f || 50} set={v => updateElement(selectedIdx, 'f', v)} step="5" min="-200" max="200" />
                                </div>
                            </div>
                        )}
                        {tab === 'data' && (
                             <div className="h-full flex flex-col">
                                <div className="p-2 flex justify-between border-b border-white/10"><span className="text-[10px] text-slate-500 pt-1 font-display uppercase">Optical Bench Configuration</span><button onClick={()=>{const doc=new jspdf.jsPDF();doc.autoTable({head:[['Type','Position (x)','Focal Len (f)','Height']],body:elements.map(e=>[e.type,e.x,e.f,e.h])});doc.save('optics_setup.pdf')}} className="bg-slate-800 text-yellow-400 text-[10px] px-3 py-1 rounded border border-slate-700 hover:bg-yellow-900">EXPORT PDF</button></div>
                                <div className="flex-1 overflow-auto scroller">{renderTable()}</div>
                            </div>
                        )}
                    </div>
                </div>
            )}
        </div>
    );
};
// --- 7. RELATIVITY SOLVER (Stellar Aberration) ---
const RelativitySolver = () => {
    const [fullScreen, setFullScreen] = useState(false); 
    const [tab, setTab] = useState('story'); 
    const [speed, setSpeed] = useState(50); 
    const timeRef = useRef(0);
    const canvasRef = useRef(null);
    const { recording, startRecording, stopRecording } = useCanvasRecorder(canvasRef);
    const { btnSize, gap } = useUIAdaptation();
    
    // Animation Loop
    useEffect(() => { 
        let frame; 
        const loop = () => { 
            timeRef.current += 1; 
            frame = requestAnimationFrame(loop); 
        }; 
        loop(); return () => cancelAnimationFrame(frame); 
    }, []);
    
    const draw = (ctx, project, w, h) => {
        const t = timeRef.current; 
        // Calculate Aberration Angle: tan(theta) = v/c
        // We scale speed 0-100 to represent a significant fraction of c for visualization
        const angle = Math.atan(speed / 100);
        
        // Starfield
        ctx.fillStyle = '#ffffff';
        for(let i=0; i<40; i++) { 
            const sx = (i*67) % w; 
            const sy = (i*43) % h; 
            const flicker = Math.sin(t * 0.1 + i) > 0.9 ? 1.5 : 1; 
            ctx.globalAlpha = (Math.sin(t * 0.05 + i) + 1) / 2 * 0.5; 
            ctx.beginPath(); ctx.arc(sx, sy, 1 * flicker, 0, 7); ctx.fill(); 
        }
        ctx.globalAlpha = 1.0; 
        
        // The Target Star (Gamma Draconis)
        const starX = w/2; 
        const starY = 40; 
        ctx.shadowBlur = 20; ctx.shadowColor = '#fbbf24'; 
        ctx.fillStyle = '#fbbf24'; ctx.beginPath(); ctx.arc(starX, starY, 4, 0, 7); ctx.fill(); 
        ctx.shadowBlur = 0;
        
        // Rain/Light Analogy
        ctx.strokeStyle = '#94a3b8'; ctx.lineWidth = 1.5; 
        const dropSpeed = 5; 
        const cx = w/2; 
        const runnerY = h - 60; // Earth Position

        // Draw "Rain" (Light from Star)
        for(let x = -250; x < 250; x+=25) { 
            const dropOffset = (t * dropSpeed + x * 33) % h; 
            const rx = cx + x; 
            
            // True Path (Vertical)
            ctx.beginPath(); ctx.strokeStyle = 'rgba(148, 163, 184, 0.15)'; 
            ctx.moveTo(rx, dropOffset); ctx.lineTo(rx, dropOffset + 25); ctx.stroke(); 
            
            // Apparent Path (Tilted due to speed)
            if(speed > 5) { 
                const slantX = Math.tan(angle) * 25; 
                ctx.beginPath(); ctx.strokeStyle = 'rgba(250, 204, 21, 0.6)'; 
                ctx.moveTo(rx, dropOffset); ctx.lineTo(rx - slantX, dropOffset + 25); ctx.stroke(); 
            } 
        }
        
        // Telescope / Umbrella Vector
        const len = 60; 
        const ex = cx + Math.sin(angle) * len; 
        const ey = runnerY - Math.cos(angle) * len; 
        
        ctx.strokeStyle = '#38bdf8'; ctx.lineWidth = 4; ctx.lineCap = 'round'; ctx.shadowBlur = 10; ctx.shadowColor = '#38bdf8'; 
        ctx.beginPath(); ctx.moveTo(cx, runnerY); ctx.lineTo(ex, ey); ctx.stroke(); ctx.shadowBlur = 0;
        
        // Earth/Observer
        ctx.fillStyle = '#38bdf8'; ctx.beginPath(); ctx.arc(cx, runnerY, 6, 0, 7); ctx.fill();
        
        // HUD
        ctx.fillStyle = '#fff'; ctx.font = 'bold 12px Rajdhani, monospace'; ctx.textAlign = 'left'; 
        ctx.fillText(`v: ${speed} km/s (scaled)`, 20, h-30); 
        ctx.fillText(`θ: ${(angle * 180/Math.PI).toFixed(1)}°`, 20, h-15);
    };

    return ( 
        <div className={`flex flex-col h-[calc(100dvh-60px)] -m-4 relative ${fullScreen ? 'fixed inset-0 z-50 m-0 bg-slate-950' : ''}`}> 
            <div className={`relative transition-all duration-500 bg-slate-900 overflow-hidden shadow-xl z-20 ${fullScreen ? 'absolute inset-0 h-full' : 'h-[40%] shrink-0'}`}> 
                <SimCanvas draw={draw} initZoom={25} onInitRecorder={(ref) => canvasRef.current = ref.current} /> 
                <div className={`absolute top-4 right-4 flex items-center ${gap}`}> 
                    <button onClick={recording ? stopRecording : startRecording} className={`${btnSize} rounded-full backdrop-blur border border-white/10 ${recording ? 'bg-red-500/20 text-red-500 animate-pulse' : 'bg-slate-800/80 text-white'}`}>{recording ? <Icons.StopRec /> : <Icons.Record />}</button>
                    <button onClick={()=>setFullScreen(!fullScreen)} className={`${btnSize} rounded-full bg-slate-800/80 text-slate-400 hover:text-white backdrop-blur border border-white/10`}>{fullScreen ? <Icons.Shrink /> : <Icons.Expand />}</button> 
                </div> 
                <div className="absolute bottom-4 right-4 text-[10px] font-mono text-slate-400 text-right pointer-events-none"> 
                    <div className="flex items-center gap-2 justify-end"><span className="w-2 h-2 rounded-full bg-slate-600"></span> True Direction</div> 
                    <div className="flex items-center gap-2 justify-end"><span className="w-2 h-2 rounded-full bg-yellow-400 shadow shadow-yellow-500/50"></span> Apparent (Aberration)</div> 
                </div> 
            </div> 
            {!fullScreen && ( 
                <div className="flex-1 flex flex-col glass-panel overflow-hidden border-t-0"> 
                    <div className="flex border-b border-white/10 shrink-0 bg-slate-900/50"> 
                        {['story', 'textbook'].map(id => (<button key={id} onClick={() => setTab(id)} className={`flex-1 py-3 text-[10px] font-bold uppercase tracking-widest transition font-display ${tab === id ? 'text-yellow-400 bg-white/5 border-b-2 border-yellow-500' : 'text-slate-500 hover:text-slate-300'}`}>{id}</button>))}
                    </div>
                    <div className="flex-1 overflow-y-auto scroller relative"> 
                        {tab === 'story' && ( 
                            <div className="p-6 space-y-8 pb-20">
                                <div className="animate-in fade-in slide-in-from-bottom-4 duration-700"> 
                                    <h3 className="text-yellow-500 font-bold text-xs uppercase tracking-widest mb-4 font-display">1725: THE RAIN OF LIGHT</h3>
                                    
                                    {/* HINDI STORY CONTENT STARTS HERE */}
                                    <div className="hindi-text text-slate-200 space-y-6">
                                        <p>
                                            यह कथा ड्रैगन के सिर पर स्थित एक तारे, <span className="hindi-highlight">'गामा ड्रैकोनिस'</span> की है, और उससे भी अधिक यह कथा मनुष्य की उस दृष्टि की है जो सत्य को खोजना चाहती है।
                                        </p>
                                        <p>
                                            वर्ष 1669 में <span className="text-cyan-400 font-bold">रॉबर्ट हुक</span> ने अपनी दूरबीन इस तारे पर साधी। वह कोपरनिकस के सिद्धांत—कि पृथ्वी सूर्य का चक्कर लगाती है—का प्रमाण खोज रहा था। उसे तारे की स्थिति में एक बड़ा बदलाव दिखा। हुक ने उसे <span className="hindi-highlight">'पॅरलॅक्स' (Parallax/दृष्टि-भेद)</span> मान लिया।
                                        </p>
                                        <p>
                                            पॅरलॅक्स दूरी का खेल है। जैसे ट्रेन में चलते हुए पास के पेड़ तेज़ी से पीछे भागते दिखते हैं, लेकिन दूर का पहाड़ स्थिर या बहुत धीमा लगता है। वैसे ही पृथ्वी के घूमने पर पास के तारे की जगह बदलनी चाहिए।
                                        </p>
                                        <p>
                                            जब तुम यात्रा में हो, तो क्या केवल बाहर का दृश्य बदलता है? नहीं, तुम्हारा पूरा अस्तित्व एक सापेक्षता में होता है। जो स्टेशन अभी भविष्य में था, वह वर्तमान बनता है और पल भर में अतीत हो जाता है। पास की झोपड़ी एक झटके में ओझल हो जाती है, दूर का पहाड़ घंटों तक साथ चलता है।
                                        </p>
                                        <p>
                                            हम सब अपने-अपने 'पॅरलॅक्स' से दुनिया को देख रहे हैं और सोच रहे हैं कि हम सत्य देख रहे हैं। हम सत्य नहीं, केवल एक सापेक्ष कोण देख रहे हैं।
                                        </p>
                                        <p>
                                            पृथ्वी अपनी कक्षा में जब एक छोर से दूसरे छोर (छह महीने का अंतर) पर जाती है, तो पास के तारे की पृष्ठभूमि बदलनी चाहिए। पृथ्वी भी तो सूरज के चारों ओर एक यात्रा पर है। इस यात्रा में जब वह एक ओर होती है, तो पास के तारे की स्थिति कहीं और दिखती है; और छह महीने बाद जब दूसरी ओर पहुँचती है, तो तारे की स्थिति थोड़ी बदली हुई दिखती है। यह बदलाव ही पॅरलॅक्स है। और यह तारे की दूरी पर निर्भर करता है - तारा जितना पास, बदलाव उतना ज्यादा।
                                        </p>
                                        <p className="border-l-2 border-red-500 pl-3 italic text-slate-400">
                                            हुक ने जो देखा वह पॅरलॅक्स नहीं था, लेकिन उन्होंने इसे अपने सिद्धांत की पुष्टि मान लिया।
                                        </p>
                                        <p>
                                            करीब साठ साल बाद, 1725 में, एक और खोजी आया - <span className="text-cyan-400 font-bold">ब्रैडली</span>। उसने भी उसी तारे को देखा। उसने भी तारे की स्थिति में बदलाव देखा, लगभग उतना ही। पर वह हुक की तरह निष्कर्ष पर नहीं कूदा।
                                        </p>
                                        <p>
                                            उसने पाया कि तारे का यह झुकाव तब सबसे ज्यादा नहीं था जब पृथ्वी अपनी यात्रा में तारे के 'बगल' से गुज़र रही थी (जैसा पॅरलॅक्स के लिए होना चाहिए)। नहीं! यह झुकाव तो तब सबसे ज्यादा था जब पृथ्वी सीधा तारे की 'ओर' जा रही थी या उससे 'दूर' जा रही थी! यह पॅरलॅक्स (दूरी का प्रभाव) नहीं हो सकता था।
                                        </p>
                                        <p>
                                            ब्रैडली ने पहचाना कि यह दूरी का नहीं, गति का खेल है। उसने इसे नाम दिया—<span className="hindi-highlight">'एबरेशन' (Aberration/पथ-भ्रम)</span>, जो दूरी का नहीं, बल्कि गति का परिणाम है। एक ऐसा झुकाव जो दूरी से नहीं, बल्कि पृथ्वी की गति से जन्म लेता है।
                                        </p>
                                        
                                        <h4 className="text-yellow-400 font-bold font-display mt-6 mb-2">वर्षा और गति</h4>
                                        <p>
                                            इसे समझने के लिए एक व्यावहारिक उदाहरण लें: मान लीजिए बारिश सीधी नीचे गिर रही है। यदि आप खड़े हैं, तो छाता सीधा रखेंगे। लेकिन यदि आप दौड़ने लगें, तो आपको छाता आगे झुकाना पड़ेगा, क्योंकि आपकी गति के कारण बारिश तिरछी आती हुई प्रतीत होगी।
                                        </p>
                                        <p>
                                            बारिश की दिशा नहीं बदली, तुम्हारी गति के कारण तुम्हें उसका पथ बदला हुआ दिख रहा है। बस यही है एबरेशन। प्रकाश की किरणें हैं बारिश की बूंदें, और हमारी पृथ्वी उस प्रकाश की बारिश में बहुत तेज़ी से दौड़ रही है। इस दौड़ के कारण हमें तारों से आता प्रकाश सीधा नहीं, थोड़ा झुका हुआ, तिरछा आता हुआ प्रतीत होता है। यह तारे की दूरी पर निर्भर नहीं करता, यह तो हमारी अपनी गति का परिणाम है।
                                        </p>
                                        <p>
                                            पृथ्वी की गति (v) और प्रकाश की गति (c) के कारण, सीधा आता हुआ प्रकाश हमें थोड़ा झुका हुआ (तिरछा) दिखाई देता है। प्रकाश की बूंदें ऊपर से आ रही हैं, शांत, सीधी। और पृथ्वी अपनी नाव पर सवार होकर प्रति सेकंड लगभग 30 किलोमीटर की गति से इस प्रकाश-वर्षा में दौड़ रही है।
                                        </p>
                                        <p>
                                            सोचो, छह महीने पृथ्वी सूर्य के चारों ओर घूमते हुए प्रकाश की उन बूंदों की ओर दौड़ती है। जैसे तुम बारिश में आगे की ओर दौड़ो। बारिश कहां से आती हुई लगेगी? सामने से! तुम्हें छाता आगे झुकाना पड़ेगा। तारे का प्रकाश सामने से आता हुआ दिखेगा, अपनी जगह से थोड़ा आगे।
                                        </p>
                                        <p>
                                            और फिर बाकी छह महीने पृथ्वी घूमकर उन बूंदों से दूर भागती है। जैसे तुम बारिश से दूर भागो। अब बारिश पीछे से आती हुई लगेगी। तारे का प्रकाश पीछे से आता हुआ दिखेगा, अपनी जगह से थोड़ा पीछे।
                                        </p>
                                        <p>
                                            ब्रैडली ने इसी रहस्य को पकड़ा। उसने कहा, "अरे! तारे का सबसे बड़ा झुकाव तो तब होता है जब हम या तो उसकी छाती पर चढ़ रहे होते हैं या उससे पीठ फेरकर भाग रहे होते हैं! बगल से निकलने पर नहीं।" पॅरलॅक्स का पूरा सिद्धांत यहां गिर गया। यह तारे की दूरी का नहीं, यह तो पृथ्वी की अपनी ही 'चाल' का धोखा था। इस दौड़ के कारण तारे का सीधा प्रकाश हमें तिरछा दिखता है। यह तारा नहीं, यह हमारी अपनी गति है जो दृश्य को बदल रही है।
                                        </p>

                                        <h4 className="text-yellow-400 font-bold font-display mt-6 mb-2">प्रकाश की गति और अतीत का दर्शन</h4>
                                        <p>
                                            ब्रैडली ने पृथ्वी की गति (v) और प्रकाश के इस झुकाव (c) के कोण को मापा और एक क्रांतिकारी गणना की उसने दुनिया को बताया कि सूर्य की किरण को हम तक पहुँचने में 8 मिनट और 12 सेकंड लगते हैं। इस गणना से एक अद्भुत तथ्य सामने आया: सूर्य से पृथ्वी तक प्रकाश को पहुँचने में 8 मिनट और 12 सेकंड लगते हैं।
                                        </p>
                                        <p>
                                            वैज्ञानिक दृष्टि से इसका अर्थ गहरा है: हम जब भी सूर्य को देखते हैं, हम उसे वर्तमान में नहीं देख रहे होते, बल्कि हम 8 मिनट पुराने अतीत को देख रहे होते हैं। प्रकाश की गति सीमित है, अनंत नहीं।
                                        </p>

                                        <h4 className="text-yellow-400 font-bold font-display mt-6 mb-2">तो क्या है यह एबरेशन?</h4>
                                        <p>
                                            <strong>पथ-भ्रम (Aberration) का असली मर्म:</strong> कल्पना करो, तुम एक ट्रेन में बैठे हो जो रुकी हुई है। बाहर बारिश हो रही है, बूंदें आकाश से सीधी, एकदम सीधी नीचे गिर रही हैं। खिड़की पर वे सीधी रेखा में गिरेंगी। यह है सत्य, जैसा वह है। लेकिन फिर ट्रेन चल पड़ती है... और एक चमत्कार घटता है। वही बूंदें जो सीधी गिर रही थीं, अब तुम्हें खिड़की पर तिरछी आती हुई दिखती हैं! जितनी तेज़ ट्रेन भागेगी, बूंदें उतनी ही तिरछी दिखेंगी।
                                        </p>
                                        <p>
                                            आप एक चलती हुई ट्रेन में हैं। बाहर बारिश सीधी गिर रही है, यह एक तथ्य है। लेकिन आपको खिड़की से वह तिरछी आती हुई दिखती है। क्यों? क्या बारिश ने अपनी दिशा बदल दी? नहीं। बारिश वैसी ही है। आपकी अपनी गति ने आपके लिए उस तथ्य को विकृत कर दिया है, एक झुकाव दे दिया है। आपकी गति और बारिश की गति मिलकर एक आभासी (apparent) दिशा बना रही है।
                                        </p>
                                        <p>
                                            क्या बारिश ने अपना ढंग बदल लिया? क्या आकाश झुक गया? नहीं। कुछ भी नहीं बदला। बदला है तो बस तुम्हारा अपना वेग, तुम्हारी अपनी गति। तुम्हारी गति और बारिश की गति, इन दोनों ने मिलकर तुम्हारी आँखों के लिए एक नया, तिरछा सत्य रच दिया है। ब्रैडली ने कहा, तारों के साथ भी ठीक यही हो रहा है!
                                        </p>
                                        <p>
                                            तारे से प्रकाश की किरणें सीधी आ रही हैं, वर्षा की बूंदों की तरह। और हमारी पृथ्वी एक बहुत तेज़ रफ़्तार ट्रेन की तरह इस ब्रह्मांड में भागी जा रही है। अपनी इस गति के कारण, हमें तारे से आता सीधा प्रकाश भी थोड़ा तिरछा, थोड़ा झुका हुआ प्रतीत होता है। यही है तारकीय पथ-भ्रम (Stellar Aberration)। यह तारे का नहीं, हमारी अपनी दौड़ का परिणाम है।
                                        </p>
                                        <p>
                                            तारे का प्रकाश सीधा आ रहा है। पृथ्वी अपनी गति में है। और पृथ्वी की यह गति, प्रकाश की गति के साथ मिलकर, हमारे लिए तारे की स्थिति को विकृत कर देती है। हम तारे को वहां नहीं देखते जहां वह है, हम उसे वहां देखते हैं जहां हमारी अपनी गति उसे दिखाती है।
                                        </p>
                                        <p className="text-white font-bold">
                                            तो, क्या आप इस बात की गहराई देख रहे हैं? विकृति तारे में नहीं है, विकृति देखने वाले की अपनी गति में है। The distortion is in the observer.
                                        </p>

                                        <div className="glass-card p-4 border border-white/20 mt-6 bg-yellow-500/10">
                                            <h4 className="text-yellow-400 font-bold font-display mb-2">पॅरलॅक्स और एबरेशन का भेद :</h4>
                                            <ul className="list-disc pl-5 space-y-2">
                                                <li><strong>पॅरलॅक्स</strong> दूरी का खेल है। यह इस पर निर्भर करता है कि तारा हमसे कितना दूर या पास है।</li>
                                                <li><strong>एबरेशन</strong> गति का खेल है। यह प्रकाश की गति और पृथ्वी की गति का सापेक्ष परिणाम है। इसका तारे की दूरी से कोई लेना-देना नहीं।</li>
                                            </ul>
                                            <p className="mt-4 font-bold text-center">
                                                हुक ने जो देखा, वह एक भ्रम था। ब्रैडली ने उस भ्रम के पार देखा।
                                            </p>
                                        </div>
                                    </div>
                                    {/* HINDI STORY CONTENT ENDS HERE */}

                                    <div className="space-y-2 mb-4 mt-8 pt-4 border-t border-white/10"> 
                                        <div className="flex justify-between text-xs text-cyan-400 font-bold font-display"> <span>Static (v=0)</span> <span>Light Speed (v=c)</span> </div> 
                                        <input type="range" min="0" max="100" value={speed} onChange={(e) => setSpeed(parseFloat(e.target.value))} className="w-full h-1 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-cyan-500" /> 
                                        <div className="text-center text-xs text-slate-500 mt-1">Velocity: <span className="text-cyan-400 font-mono">{speed} km/s</span></div> 
                                    </div> 
                                </div>
                            </div> 
                        )} 
                        {tab === 'textbook' && (
                            <div className="h-full overflow-y-auto scroller p-4 pb-20">
                                <div className="paper-bg text-sm rounded-sm mb-4 shadow-xl">
                                    <h3 className="text-black font-bold text-xl mb-4 border-b border-black/10 pb-2">Relativity & Optics</h3>
                                    <p><strong>1. Stellar Aberration (Classical)</strong></p>
                                    <div className="my-2 text-center"><Latex tex="\tan \theta = \frac{v}{c}" dark={false} /></div>
                                    <p><strong>2. Relativistic Aberration</strong></p>
                                    <div className="my-2 text-center"><Latex tex="\cos \theta' = \frac{\cos \theta + \beta}{1 + \beta \cos \theta}" dark={false} /></div>
                                    <p className="text-slate-900 text-xs">Where <Latex tex="\beta = v/c" dark={false} />.</p>
                                </div>
                            </div>
                        )}
                    </div> 
                </div> 
            )} 
        </div> 
    );
};

// --- SIMULATION FALLBACK ---
const SimCanvasFallback = ({ type }) => {
    return <div className="rounded-xl overflow-hidden mt-4 shadow-inner border border-white/10 h-60 flex items-center justify-center bg-black/50 text-slate-500 font-mono text-xs">Module {type} Loading...</div>;
};

// --- MAIN APP COMPONENT ---
const App = () => {
    const [view, setView] = useLocalStorage('simux_view', 'home'); 
    const [sim, setSim] = useState(null); 
    const [menu, setMenu] = useState(false);
    const vibrate = useHaptics();
    const audio = useAudioEngine();
    const { mode } = useUIAdaptation();

    useEffect(() => {
        const loader = document.getElementById('loader');
        if (loader) { loader.style.opacity = '0'; setTimeout(() => loader.remove(), 500); }
    }, []);

    const PROFILE = { name: "Abhishek Kumar", role: "Physics Faculty (9+ yrs)", details: ["B.Tech (CSE)", "Ex-Faculty: Jaipuria School", "Ex-Faculty: S.P. College Pune", "Expert: Python, LaTeX"] };
    
    const SIMS = [ 
        { id: 'orbit', title: 'N-Body ODE Solver', desc: 'Solar System, Chaos & Custom ODEs', color: 'text-indigo-400', iconBg: 'bg-indigo-500/20' }, 
        { id: 'em', title: 'Electromagnetism', desc: 'Maxwell & Lorentz Dynamics', color: 'text-violet-400', iconBg: 'bg-violet-500/20' }, 
        { id: 'quantum', title: 'Quantum Mechanics', desc: 'Schrödinger & Wells', color: 'text-cyan-400', iconBg: 'bg-cyan-500/20' },
        { id: 'thermo', title: 'Thermodynamics', desc: 'Stat Mech & 3 Laws', color: 'text-amber-400', iconBg: 'bg-amber-500/20' }, 
        { id: 'wave', title: 'Wave Motion', desc: 'String, Sound, & Ripples', color: 'text-pink-400', iconBg: 'bg-pink-500/20' }, 
        { id: 'optics', title: 'Ray Optics', desc: 'Lenses & Mirrors', color: 'text-yellow-400', iconBg: 'bg-yellow-500/20' },
        { id: 'relativity', title: 'Relativity', desc: 'Aberration & Speed of Light', color: 'text-emerald-400', iconBg: 'bg-emerald-500/20' } 
    ];

    const BOOKS = [ 
        { id: 1, title: "Electronics and Circuits", desc: "Analog & Digital Systems", color: "text-purple-400 border-purple-500/30", links: [ { label: "Google Play", url: "https://play.google.com/store/books/details?id=retaEQAAQBAJ" }, { label: "Audiobook", url: "https://play.google.com/store/audiobooks/details?id=AQAAAEBKaVwpBM" } ] }, 
        { id: 2, title: "Quantum Field Theory", desc: "Advanced Physics", color: "text-cyan-400 border-cyan-500/30", links: [ { label: "Amazon", url: "https://a.co/d/gR8mRuz" }, { label: "Pothi", url: "https://store.pothi.com/book/abhishek-kumar-quantum-field-theory-3/" } ] }, 
        { id: 3, title: "Planetary Motion", desc: "Gravity Dynamics", color: "text-blue-400 border-blue-500/30", links: [ { label: "Amazon", url: "https://amzn.in/d/9HdcrQx" }, { label: "Flipkart", url: "https://www.flipkart.com/gravity-planetary-motion/p/itm84b6b08e673e0" } ] }, 
        { id: 4, title: "Relativity: Speed of Light", desc: "Special Relativity", color: "text-amber-400 border-amber-500/30", links: [ { label: "Amazon", url: "https://amzn.in/d/36O230l" }, { label: "Flipkart", url: "https://dl.flipkart.com/s/pO6BTiuuuN" } ] } 
    ];
    
    const YOUTUBE_VIDEOS = [ { id: "OSpU_nuSSQQ", title: "Concept of Angle: Introduction", url: "https://youtu.be/OSpU_nuSSQQ?si=HsnScqm9XnpgNmPx" }, { id: "FzBTUK1d3qk", title: "Degree and Radian: Nakshatra Prediction", url: "https://youtu.be/FzBTUK1d3qk?si=mBxve68JnzsmZYji" } ];

    return (
        <ToastProvider>
            <div className={`flex flex-col h-full bg-transparent text-slate-200 font-sans transition-all duration-300 ${mode==='board'?'scale-100':'scale-100'}`}>
                {/* HEADER */}
                <header className="glass-panel border-b border-white/5 px-4 py-4 flex justify-between items-center shrink-0 sticky top-0 z-30">
                    <div className="flex items-center gap-3 cursor-pointer" onClick={() => { setView('home'); vibrate(); }}>
                        <div className="w-8 h-8 rounded bg-gradient-to-br from-blue-600 to-cyan-500 text-white flex items-center justify-center font-bold shadow-[0_0_15px_rgba(37,99,235,0.5)]">K</div>
                        <span className="font-bold text-white tracking-widest font-display text-lg">KALA-SIMUX</span>
                    </div>
                    <button onClick={() => { setMenu(true); vibrate(); }} className="p-2 text-cyan-400 hover:text-white transition hover:drop-shadow-[0_0_5px_cyan]"><Icons.Menu /></button>
                </header>

                {/* SIDE MENU */}
                <div className={`fixed inset-0 z-50 bg-black/80 backdrop-blur-sm transition-opacity ${menu ? 'opacity-100' : 'opacity-0 pointer-events-none'}`} onClick={() => setMenu(false)}>
                    <div className={`absolute right-0 top-0 bottom-0 w-72 glass-panel border-l border-white/10 shadow-2xl p-6 transition-transform duration-300 ${menu ? 'translate-x-0' : 'translate-x-full'}`} onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-8"><h2 className="font-bold text-xl font-display text-cyan-400">ACCESS</h2><button onClick={() => setMenu(false)} className="text-slate-400 hover:text-white"><Icons.Close /></button></div>
                        <div className="text-center mb-6"> <div className="w-20 h-20 bg-slate-800 border border-cyan-500/50 text-cyan-400 rounded-full mx-auto flex items-center justify-center mb-3 shadow-[0_0_20px_rgba(6,182,212,0.2)]"><Icons.User /></div> <h3 className="font-bold text-lg text-white font-display">{PROFILE.name}</h3> <p className="text-sm text-cyan-500/80">{PROFILE.role}</p> </div>
                        <div className="space-y-3 text-sm text-slate-400 font-mono">{PROFILE.details.map((d, i) => <div key={i} className="pl-3 border-l-2 border-cyan-800">{d}</div>)}</div>
                        <div className="mt-8 pt-4 border-t border-white/10 text-center">
                            <span className="text-[10px] text-green-500 font-mono uppercase tracking-widest">System v22.0 ({mode.toUpperCase()})</span>
                        </div>
                    </div>
                </div>

                {/* MAIN CONTENT */}
                <main className="flex-1 overflow-y-auto scroller p-4 pb-28 relative z-10">
                    {view === 'home' && (
                        <div className="space-y-8 animate-in fade-in duration-500">
                            <div className="relative p-6 rounded-2xl glass-card overflow-hidden border border-white/10 group">
                                <div className="absolute top-0 right-0 w-32 h-32 bg-cyan-500/20 blur-[50px] rounded-full -mr-10 -mt-10"></div>
                                <div className="relative z-10 text-center"> <h1 className="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-500 font-display mb-2 drop-shadow-[0_0_10px_rgba(6,182,212,0.3)]">KALA-SIMUX</h1> <p className="text-xs text-cyan-200/70 font-mono tracking-wider">FROM MOTION WE MEASURE TIME<br/>WITH TIME WE SIMULATE MOTION</p> </div>
                            </div>
                            <div>
                                <h3 className="font-bold text-slate-500 mb-4 text-xs uppercase tracking-[0.2em] font-display pl-2">Simulation Modules</h3>
                                <div className={`grid ${mode === 'board' ? 'grid-cols-2 gap-6' : 'grid-cols-1 gap-3'}`}> {SIMS.map(s => ( <button key={s.id} onClick={() => { setSim(s.id); setView('sim'); vibrate(); audio.init(); }} className="group glass-card p-4 rounded-xl flex items-center gap-4 text-left hover:border-cyan-500/50 hover:shadow-[0_0_15px_rgba(6,182,212,0.15)] relative overflow-hidden transition-all active:scale-95"> <div className="absolute inset-0 bg-gradient-to-r from-cyan-500/10 to-transparent opacity-0 group-hover:opacity-100 transition duration-500"></div> <div className={`w-12 h-12 rounded-lg flex items-center justify-center shrink-0 ${s.iconBg} ${s.color} border border-white/5`}> {s.id === 'quantum' ? <Icons.Quantum /> : s.id === 'wave' ? <Icons.Wave /> : <Icons.Atom />} </div> <div className="relative z-10"> <div className="font-bold text-slate-100 font-display text-sm group-hover:text-cyan-300 transition">{s.title}</div> <div className="text-[10px] text-slate-400 font-mono">{s.desc}</div> </div> <div className="ml-auto text-slate-600 group-hover:text-cyan-400 transition transform group-hover:translate-x-1">→</div> </button> ))} </div>
                            </div>
                        </div>
                    )}
                    
                    {view === 'sim' && (
                        <div className="animate-in slide-in-from-bottom duration-500">
                            <button onClick={() => { setView('home'); vibrate(); }} className="flex items-center gap-2 text-cyan-500 mb-4 font-bold text-xs uppercase tracking-widest hover:text-cyan-300 transition"><Icons.Back /> Return to Hub</button>
                            <h2 className="text-xl font-bold text-white mb-2 font-display uppercase tracking-wider">{SIMS.find(s=>s.id===sim)?.title}</h2>
                            <div className="rounded-xl overflow-hidden border border-white/10 shadow-2xl shadow-black/50 bg-black/40"> 
                                {sim === 'orbit' ? <ODESolver /> : 
                                 sim === 'em' ? <EMSolver /> : 
                                 sim === 'thermo' ? <ThermoSolver /> : 
                                 sim === 'wave' ? <WaveSolver /> : 
                                 sim === 'quantum' ? <QuantumSolver /> :
                                 sim === 'optics' ? <RayOpticsSolver /> :
                                 sim === 'relativity' ? <RelativitySolver /> : 
                                 <SimCanvasFallback type={sim} />} 
                            </div>
                        </div>
                    )}
                    
                    {view === 'books' && (
                        <div className="space-y-8 animate-in fade-in duration-500">
                            <div className="space-y-4">
                                <h2 className="font-bold text-xl text-white font-display border-l-4 border-purple-500 pl-3">Archives & Texts</h2>
                                {BOOKS.map(b => ( <div key={b.id} className={`glass-card rounded-xl p-4 flex gap-4 border ${b.color} border-opacity-20 hover:border-opacity-60 transition`}> <div className="w-16 h-20 bg-slate-900/50 rounded flex items-center justify-center shrink-0 border border-white/10"> <div className={b.color.split(' ')[0]}><Icons.Book /></div> </div> <div className="flex-1 flex flex-col"> <h3 className="font-bold text-slate-100 font-display text-sm">{b.title}</h3> <p className="text-[10px] text-slate-400 mt-1 mb-3 font-mono">{b.desc}</p> <div className="mt-auto flex gap-2"> {b.links.map((link, i) => ( <a key={i} href={link.url} target="_blank" className="flex-1 bg-white/5 hover:bg-white/10 text-cyan-400 text-[9px] font-bold py-1.5 px-2 rounded border border-white/10 text-center uppercase tracking-wider transition"> {link.label} </a> ))} </div> </div> </div> ))}
                            </div>
                            <div className="space-y-4">
                                <h2 className="font-bold text-xl text-white font-display border-l-4 border-red-500 pl-3 flex items-center gap-2"> Data Feeds </h2>
                                {YOUTUBE_VIDEOS.map(v => ( <a key={v.id} href={v.url} target="_blank" className="block glass-card rounded-xl overflow-hidden group border border-white/10 hover:border-red-500/50 transition relative"> <div className="relative aspect-video bg-black"> <img src={`https://img.youtube.com/vi/${v.id}/mqdefault.jpg`} alt={v.title} className="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition duration-500" /> <div className="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent"></div> <div className="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition duration-300"> <div className="w-12 h-12 bg-red-600/90 rounded-full flex items-center justify-center text-white shadow-[0_0_20px_rgba(220,38,38,0.6)] backdrop-blur"> <Icons.Play /> </div> </div> </div> <div className="p-3"> <h3 className="font-bold text-slate-200 text-xs leading-tight font-display line-clamp-2 group-hover:text-red-400 transition">{v.title}</h3> <div className="mt-2 flex items-center gap-2 text-[9px] text-slate-500 font-bold uppercase tracking-widest font-mono"> <span className="w-1.5 h-1.5 rounded-full bg-red-500 animate-pulse"></span> Live Feed </div> </div> </a> ))}
                            </div>
                        </div>
                    )}
                </main>

                {/* FLOATING DOCK */}
                <div className="fixed bottom-6 left-0 right-0 flex justify-center z-40 pointer-events-none">
                    <nav className={`glass-panel rounded-full px-6 py-2 flex items-center gap-8 pointer-events-auto border border-white/10 shadow-[0_10px_30px_rgba(0,0,0,0.5)] ${mode==='board'?'scale-125':''}`}>
                        <button onClick={() => { setView('home'); vibrate(); }} className={`flex flex-col items-center gap-1 p-2 transition duration-300 ${view!=='books'?'text-cyan-400 scale-110 drop-shadow-[0_0_8px_cyan]':'text-slate-500 hover:text-slate-300'}`}> <Icons.Lab /> <span className="text-[8px] font-bold uppercase tracking-widest font-display">Sims</span> </button>
                        <div className="w-px h-8 bg-white/10"></div>
                        <button onClick={() => { setView('books'); vibrate(); }} className={`flex flex-col items-center gap-1 p-2 transition duration-300 ${view==='books'?'text-purple-400 scale-110 drop-shadow-[0_0_8px_purple]':'text-slate-500 hover:text-slate-300'}`}> <Icons.Book /> <span className="text-[8px] font-bold uppercase tracking-widest font-display">Data</span> </button>
                    </nav>
                </div>
            </div>
        </ToastProvider>
    );
};

const root = ReactDOM.createRoot(document.getElementById('root')); 
root.render(<App />);
</script>
</body>
</html>

