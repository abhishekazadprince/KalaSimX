<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#020617">
    <meta name="description" content="Kala-SimuX Pro: The Ultimate Physics Engine">
    <link rel="icon" type="image/png" href="./Kala-SimuX.png">
    <link rel="manifest" href="manifest.json">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;500;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=JetBrains+Mono:wght@400;700&family=Noto+Sans+Devanagari:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <title>Kala-SimuX Pro: Architect Edition</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Rajdhani', 'sans-serif'], 
                        display: ['Orbitron', 'sans-serif'], 
                        serif: ['Crimson Text', 'serif'], 
                        mono: ['JetBrains Mono', 'monospace'],
                        hindi: ['Noto Sans Devanagari', 'sans-serif'] 
                    },
                    colors: { cosmic: { 900: '#020617', 800: '#0f172a', 700: '#1e293b' } },
                    animation: { 'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite', 'spin-slow': 'spin 8s linear infinite', 'fade-in': 'fadeIn 0.3s ease-out' },
                    keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } }
                }
            }
        }
    </script>

    <style>
        /* CORE RESET */
        html, body { height: 100%; height: 100dvh; margin: 0; padding: 0; overflow: hidden; background-color: #020617; color: #e2e8f0; -webkit-tap-highlight-color: transparent; user-select: none; }
        #root { height: 100%; height: 100dvh; width: 100%; display: flex; flex-direction: column; }
        
        /* SCROLLBARS */
        .scroller { overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch; scroll-behavior: smooth; }
        .scroller::-webkit-scrollbar { width: 6px; }
        .scroller::-webkit-scrollbar-track { background: #0f172a; }
        .scroller::-webkit-scrollbar-thumb { background: #0ea5e9; border-radius: 3px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* GLASS UI */
        .glass-panel { background: rgba(15, 23, 42, 0.96); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .glass-card { background: linear-gradient(145deg, rgba(30, 41, 59, 0.4) 0%, rgba(15, 23, 42, 0.6) 100%); backdrop-filter: blur(12px); border: 1px solid rgba(148, 163, 184, 0.1); transition: all 0.2s ease; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .glass-card:active { transform: scale(0.99); border-color: rgba(6, 182, 212, 0.5); }
        
        /* TEXTBOOK STYLES */
        .paper-bg { background-color: #fcfbf7; color: #1a1a1a; font-family: 'Crimson Text', serif; padding: 32px; box-shadow: inset 0 0 60px rgba(0,0,0,0.05); position: relative; line-height: 1.8; font-size: 1.15rem; }
        .paper-bg h3 { font-family: 'Crimson Text', serif; color: #000; font-weight: 700; letter-spacing: -0.01em; margin-top: 1.5em; margin-bottom: 0.8em; font-size: 1.5rem; border-bottom: 2px solid #e5e5e5; padding-bottom: 5px; }
        .paper-bg p { margin-bottom: 1.2rem; text-align: justify; }
        .paper-bg strong { color: #0f172a; font-weight: 700; }
        .paper-bg ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 1.2rem; }
        
        /* HINDI TEXT STYLES */
        .hindi-text { font-family: 'Noto Sans Devanagari', sans-serif; line-height: 2.0; font-size: 1.1rem; }
        .hindi-highlight { color: #fbbf24; font-weight: 700; background: rgba(251, 191, 36, 0.1); padding: 0 4px; border-radius: 4px; }
        
        /* DATA TABLE */
        .data-table { width: 100%; border-collapse: collapse; font-family: 'JetBrains Mono', monospace; font-size: 11px; }
        .data-table th { text-align: left; color: #94a3b8; padding: 8px 6px; border-bottom: 1px solid #334155; font-weight: 700; text-transform: uppercase; background: rgba(15, 23, 42, 0.9); position: sticky; top: 0; z-index: 10; backdrop-filter: blur(4px); }
        .data-table td { padding: 6px; border-bottom: 1px solid #1e293b; color: #cbd5e1; font-feature-settings: "tnum"; }
        .data-table tr:nth-child(even) { background: rgba(255,255,255,0.02); }
        
        #loader { position: fixed; inset: 0; background: #020617; display: flex; justify-content: center; align-items: center; z-index: 100; transition: opacity 0.5s; flex-direction: column; gap: 24px;}
        .glow { text-shadow: 0 0 10px currentColor; }
        .theme-lab .glass-panel { background: rgba(20, 20, 20, 0.85); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
        .theme-blueprint .glass-panel { background: rgba(30, 58, 138, 0.85); backdrop-filter: blur(8px); border: 1px solid rgba(147, 197, 253, 0.3); }
        .theme-matrix .glass-panel { background: rgba(0, 20, 0, 0.9); backdrop-filter: blur(12px); border: 1px solid rgba(34, 197, 94, 0.3); color: #4ade80; }
        .glass-btn { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); transition: all 0.2s; cursor: pointer; }
        .glass-btn:hover { background: rgba(255,255,255,0.15); border-color: rgba(255,255,255,0.3); }
        .glass-btn.active { background: rgba(251, 191, 36, 0.2); border-color: #fbbf24; color: #fbbf24; }
        .active-tab { border-bottom: 2px solid #fbbf24; color: #fbbf24; background: rgba(251, 191, 36, 0.1); }
        .canvas-container { cursor: grab; }
        .canvas-container:active { cursor: grabbing; }
        .canvas-container.dragging-element { cursor: ew-resize; }
        .canvas-container.tool-active { cursor: crosshair; }
    </style>
</head>
<body>

<div id="loader">
    <div class="relative">
        <div class="w-24 h-24 border-t-4 border-b-4 border-cyan-500 rounded-full animate-spin"></div>
        <div class="w-16 h-16 border-r-4 border-l-4 border-purple-500 rounded-full animate-spin-slow absolute top-4 left-4"></div>
        <div class="absolute inset-0 flex items-center justify-center font-bold text-white text-xs font-display animate-pulse">KSX</div>
    </div>
    <div class="text-cyan-500 font-mono text-sm animate-pulse tracking-[0.4em] font-bold mt-4">KALA-SIMUX ULTRA</div>
    <div class="text-slate-500 text-xs font-mono" id="loader-status">Initializing Physics Core...</div>
</div>

<div id="root"></div>

<script>
    // --- OFFLINE CAPABILITY ---
    if ('serviceWorker' in navigator) {
        const swCode = `
            const CACHE_NAME = 'kala-simux-v23';
            const ASSETS = [
                'https://unpkg.com/react@18/umd/react.production.min.js',
                'https://unpkg.com/react-dom@18/umd/react-dom.production.min.js',
                'https://unpkg.com/@babel/standalone/babel.min.js',
                'https://cdn.tailwindcss.com',
                'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js',
                'https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js',
                'https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js',
                'https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css'
            ];
            self.addEventListener('install', (e) => {
                e.waitUntil(caches.open(CACHE_NAME).then(cache => cache.addAll(ASSETS)));
                self.skipWaiting();
            });
            self.addEventListener('fetch', (e) => {
                e.respondWith(caches.match(e.request).then(res => res || fetch(e.request)));
            });
        `;
        const blob = new Blob([swCode], {type: 'application/javascript'});
        const swUrl = URL.createObjectURL(blob);
        window.addEventListener('load', () => {
            navigator.serviceWorker.register(swUrl).catch(console.error);
        });
    }
</script>

<script type="text/babel">
const { useState, useEffect, useRef, useMemo, useCallback, createContext, useContext } = React;

// --- ADAPTIVE UI HOOK ---
const useUIAdaptation = () => {
    const [mode, setMode] = useState('desktop'); 
    useEffect(() => {
        const check = () => {
            const w = window.innerWidth;
            const isTouch = window.matchMedia('(pointer: coarse)').matches;
            if (w > 1024 && isTouch) setMode('board'); // Digital Board
            else if (w < 768) setMode('mobile');
            else setMode('desktop');
        };
        check(); window.addEventListener('resize', check); return () => window.removeEventListener('resize', check);
    }, []);
    return useMemo(() => ({
        mode,
        btnSize: mode === 'board' ? 'p-4 text-lg' : 'p-2 text-xs',
        gap: mode === 'board' ? 'gap-6' : 'gap-2',
        text: mode === 'board' ? 'text-lg' : 'text-xs'
    }), [mode]);
};

// --- TOAST CONTEXT ---
const ToastContext = createContext();
const ToastProvider = ({ children }) => {
    const [toasts, setToasts] = useState([]);
    const addToast = (msg, type='info') => {
        const id = Date.now();
        setToasts(p => [...p, { id, msg, type }]);
        setTimeout(() => setToasts(p => p.filter(t => t.id !== id)), 3000);
    };
    return (
        <ToastContext.Provider value={addToast}>
            {children}
            <div className="fixed top-16 right-4 z-50 flex flex-col gap-2 pointer-events-none">
                {toasts.map(t => (
                    <div key={t.id} className={`animate-fade-in glass-card px-4 py-2 rounded-lg border-l-4 ${t.type==='error'?'border-red-500 text-red-100':'border-cyan-500 text-cyan-100'} shadow-xl text-xs font-bold font-display tracking-wider flex items-center gap-2`}>
                        <span className="text-lg">{t.type==='error'?'!':'âœ“'}</span> {t.msg}
                    </div>
                ))}
            </div>
        </ToastContext.Provider>
    );
};
const useToast = () => useContext(ToastContext);

// --- AUDIO ENGINE ---
const useAudioEngine = () => {
    const ctxRef = useRef(null);
    const masterGainRef = useRef(null);
    const [enabled, setEnabled] = useState(false);
    const init = useCallback(() => {
        if (!ctxRef.current && (window.AudioContext || window.webkitAudioContext)) {
            const AC = window.AudioContext || window.webkitAudioContext;
            ctxRef.current = new AC();
            masterGainRef.current = ctxRef.current.createGain();
            masterGainRef.current.gain.value = 0.2; 
            masterGainRef.current.connect(ctxRef.current.destination);
            setEnabled(true);
        } else if (ctxRef.current && ctxRef.current.state === 'suspended') { ctxRef.current.resume(); }
    }, []);
    const playTone = useCallback((freq, type='sine', duration=0.1, vol=0.5) => {
        if (!ctxRef.current || !enabled) return;
        try {
            const osc = ctxRef.current.createOscillator(); const gain = ctxRef.current.createGain();
            osc.type = type; osc.frequency.setValueAtTime(freq, ctxRef.current.currentTime);
            gain.gain.setValueAtTime(vol, ctxRef.current.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, ctxRef.current.currentTime + duration);
            osc.connect(gain); gain.connect(masterGainRef.current);
            osc.start(); osc.stop(ctxRef.current.currentTime + duration);
        } catch(e) {}
    }, [enabled]);
    const playCollision = useCallback((mass) => { const freq = Math.max(80, 600 - mass * 5); playTone(freq, 'triangle', 0.1, Math.min(0.8, mass/20)); }, [playTone]);
    return { init, playTone, playCollision, enabled, setEnabled };
};

// --- RECORDER HOOK ---
const useCanvasRecorder = (canvasRef) => {
    const [recording, setRecording] = useState(false);
    const mediaRecorder = useRef(null);
    const chunks = useRef([]);
    const toast = useToast();
    const startRecording = useCallback(() => {
        if (!canvasRef.current) return;
        try {
            const stream = canvasRef.current.captureStream(60); 
            let mimeType = 'video/webm';
            if (MediaRecorder.isTypeSupported('video/webm;codecs=vp9')) mimeType = 'video/webm;codecs=vp9';
            else if (MediaRecorder.isTypeSupported('video/mp4')) mimeType = 'video/mp4'; 
            
            mediaRecorder.current = new MediaRecorder(stream, { mimeType }); 
            mediaRecorder.current.ondataavailable = (e) => { if (e.data.size > 0) chunks.current.push(e.data); };
            mediaRecorder.current.onstop = () => {
                const blob = new Blob(chunks.current, { type: mimeType });
                chunks.current = [];
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `kala_simux_${Date.now()}.${mimeType==='video/mp4'?'mp4':'webm'}`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
                if(toast) toast("Recording Saved");
            };
            mediaRecorder.current.start();
            setRecording(true);
            if(toast) toast("Recording Started");
        } catch(e) { console.error("Recorder error:", e); if(toast) toast("Recorder Failed", "error"); }
    }, [toast]);
    const stopRecording = useCallback(() => { if (mediaRecorder.current && recording) { mediaRecorder.current.stop(); setRecording(false); } }, [recording]);
    return { recording, startRecording, stopRecording };
};

// --- UTILITIES ---
const useHaptics = () => useCallback((p=10) => { if (navigator.vibrate) navigator.vibrate(p); }, []);
const useLocalStorage = (key, initialValue) => {
    const [storedValue, setStoredValue] = useState(() => { try { const item = window.localStorage.getItem(key); return item ? JSON.parse(item) : initialValue; } catch (error) { return initialValue; } });
    const setValue = (value) => { try { const valueToStore = value instanceof Function ? value(storedValue) : value; setStoredValue(valueToStore); window.localStorage.setItem(key, JSON.stringify(valueToStore)); } catch (error) { console.log(error); } };
    return [storedValue, setValue];
};
const parseEq = (eq) => { if (!eq) return "0"; try { let s = eq.toLowerCase().replace(/\s/g, '').replace(/\^/g, '**'); ['sin','cos','tan','sqrt','exp','log','abs','pi','max','min','pow'].forEach(f => s = s.replaceAll(f, `Math.${f.toUpperCase() === 'PI' ? 'PI' : f}`)); return s; } catch(e) { return "0"; } };

// --- COMPONENTS ---
const Latex = ({ tex, dark=true }) => {
    const ref = useRef(null);
    useEffect(() => { if (ref.current && window.katex) { try { window.katex.render(tex, ref.current, { throwOnError: false }); } catch(e){} } else if(ref.current) { ref.current.innerText = tex; } }, [tex, dark]);
    return <span ref={ref} className={`font-serif italic px-1 ${dark ? 'text-cyan-300' : 'text-black font-bold'}`} />;
};

const EqInput = ({ label, sub, val, set, color }) => (
    <div className={`glass-card p-3 rounded-lg border-l-2 ${color} flex flex-col gap-1 shadow-lg`}>
        <span className="text-[10px] font-bold text-slate-400 uppercase tracking-wider font-display">{label}</span>
        <div className="flex gap-2 items-center">
            <span className="text-xs font-mono text-slate-500 shrink-0"><Latex tex={sub} /></span>
            <input value={val} onChange={e=>set(e.target.value)} className="bg-slate-900/50 border border-slate-700 text-cyan-400 w-full rounded px-2 py-1 text-xs font-mono focus:border-cyan-400 outline-none transition-colors" spellCheck="false" />
        </div>
    </div>
);

const ParamInput = ({ label, val, set, step="0.01", unit="", min=null, max=null }) => (
    <div className="flex justify-between items-center text-xs text-slate-300 border-b border-white/5 py-2 hover:bg-white/5 px-2 transition rounded">
        <span>{label}</span>
        <div className="flex items-center gap-2">
            <input type="number" step={step} min={min} max={max} value={val} onChange={e=>set(parseFloat(e.target.value))} className="w-20 bg-slate-900 border border-slate-700 text-yellow-400 rounded px-2 py-1 text-right font-mono text-xs focus:border-yellow-500 outline-none" />
            <span className="text-[9px] text-slate-500 w-4 font-bold">{unit}</span>
        </div>
    </div>
);

const GraphCard = ({ title, data, x, y, col }) => {
    if(!data || data.length < 2) return <div className="glass-card h-24 rounded flex items-center justify-center text-[10px] text-slate-600 font-mono border border-white/5">BUFFERING...</div>;
    const xs = data.map(d=>(d[x]!==undefined ? d[x] : 0)); const ys = data.map(d=>(d[y]!==undefined ? d[y] : 0));
    const minX = Math.min(...xs), maxX = Math.max(...xs);
    const minY = Math.min(...ys), maxY = Math.max(...ys);
    const pts = data.map(d => {
        const valX = d[x]!==undefined ? d[x] : 0; const valY = d[y]!==undefined ? d[y] : 0;
        const px = ((valX - minX) / (maxX - minX || 1)) * 100;
        const py = 100 - ((valY - minY) / (maxY - minY || 1)) * 100;
        return `${px},${py}`;
    }).join(' ');
    return (
        <div className="glass-card p-2 rounded-lg">
            <div className="text-[10px] text-slate-400 mb-1 font-mono uppercase tracking-widest">{title}</div>
            <svg viewBox="0 0 100 100" className="w-full h-16 bg-black/20 rounded overflow-hidden" preserveAspectRatio="none"><polyline points={pts} fill="none" stroke={col} strokeWidth="1.5" vectorEffect="non-scaling-stroke" /></svg>
        </div>
    );
};

// --- ICONS (Same as previous) ---
const Icons = {
    Menu: () => <svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>,
    Back: () => <svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>,
    Atom: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="1"/><path d="M20.2 20.2c2.04-2.03.02-7.36-4.5-11.9-4.54-4.52-9.87-6.54-11.9-4.5-2.04 2.03-.02 7.36 4.5 11.9 4.54 4.52 9.87 6.54 11.9 4.5Z"/><path d="M15.7 15.7c4.52-4.54 6.54-9.87 4.5-11.9-2.03-2.04-7.36-.02-11.9 4.5-4.52 4.54-6.54 9.87-4.5 11.9 2.03 2.04 7.36.02 11.9-4.5Z"/></svg>,
    Book: () => <svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>,
    Lab: () => <svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><path d="M2 12h20"/><path d="M2 12l5-5"/><path d="M22 12l-5 5"/></svg>,
    User: () => <svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
    Close: () => <svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>,
    Play: () => <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>,
    Pause: () => <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>,
    Reset: () => <svg width="16" height="16" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>,
    Plus: () => <svg width="16" height="16" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
    Trash: () => <svg width="14" height="14" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>,
    Expand: () => <svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/></svg>,
    Shrink: () => <svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"/></svg>,
    Record: () => <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="8" fill="red"/></svg>,
    StopRec: () => <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><rect x="6" y="6" width="12" height="12" rx="2" fill="red"/></svg>,
    Axes: () => <svg width="16" height="16" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M3 21h18M3 21v-18"/></svg>,
    Trail: () => <svg width="16" height="16" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M3 12h18M3 6h18M3 18h18" strokeDasharray="4 4"/></svg>,
    Camera: () => <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>,
    Wave: () => <svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M2 12s3-7 7-7 7 7 7 7 7-7 7-7M2 12s3 7 7 7 7-7 7-7 7 7 7 7" opacity="0.5"/></svg>,
    Quantum: () => <svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M12 2a10 10 0 100 20 10 10 0 000-20z"></path><path d="M2 12h20M12 2v20"></path><path d="M4.93 4.93l14.14 14.14M4.93 19.07L19.07 4.93"></path></svg>,
    Code: () => <svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><polyline points="16 18 22 12 16 6"></polyline><polyline points="8 6 2 12 8 18"></polyline></svg>
};

const useOrbitControls = (ref, initialZoom = 30) => {
    const camera = useRef({ yaw: 0.5, pitch: 0.3, zoom: initialZoom, x: 0, y: 0 });
    const drag = useRef({ active: false, x: 0, y: 0, dist: 0, mode: 'rotate' });
    useEffect(() => {
        const el = ref.current; if(!el) return;
        const getDist = (touches) => Math.hypot(touches[0].clientX - touches[1].clientX, touches[0].clientY - touches[1].clientY);
        const start = (e) => { 
            drag.current.active = true; 
            if(e.touches && e.touches.length === 2) { drag.current.dist = getDist(e.touches); drag.current.mode = 'zoom'; } 
            else { const t = e.touches ? e.touches[0] : e; drag.current.x = t.clientX; drag.current.y = t.clientY; drag.current.mode = e.shiftKey ? 'pan' : 'rotate'; }
        };
        const move = (e) => {
            if(!drag.current.active) return;
            if(e.touches && e.touches.length === 2) { const newDist = getDist(e.touches); camera.current.zoom *= newDist / drag.current.dist; drag.current.dist = newDist; } 
            else {
                const t = e.touches ? e.touches[0] : e; const dx = t.clientX - drag.current.x; const dy = t.clientY - drag.current.y;
                if (drag.current.mode === 'pan') { camera.current.x -= dx * 0.1; camera.current.y += dy * 0.1; } 
                else { camera.current.yaw += dx * 0.01; camera.current.pitch += dy * 0.01; camera.current.pitch = Math.max(-1.5, Math.min(1.5, camera.current.pitch)); }
                drag.current.x = t.clientX; drag.current.y = t.clientY;
            }
        };
        const wheel = (e) => { e.preventDefault(); camera.current.zoom *= (1 - Math.sign(e.deltaY) * 0.1); };
        const end = () => drag.current.active = false;
        el.addEventListener('mousedown', start); el.addEventListener('touchstart', start, {passive: false}); el.addEventListener('wheel', wheel, {passive: false});
        window.addEventListener('mousemove', move); window.addEventListener('touchmove', move, {passive: false}); window.addEventListener('mouseup', end); window.addEventListener('touchend', end);
        return () => { el.removeEventListener('mousedown', start); el.removeEventListener('touchstart', start); el.removeEventListener('wheel', wheel); window.removeEventListener('mousemove', move); window.removeEventListener('touchmove', move); window.removeEventListener('mouseup', end); window.removeEventListener('touchend', end); };
    }, []);
    return camera;
};

const SimCanvas = ({ draw, initZoom=30, interact=null, showAxes=false, onInitRecorder }) => {
    const canvasRef = useRef(null);
    const cam = useOrbitControls(canvasRef, initZoom);
    const drawRef = useRef(draw);
    const toast = useToast();
    useEffect(() => { if(initZoom) cam.current.zoom = initZoom; }, [initZoom]);
    useEffect(() => { drawRef.current = draw; }, [draw]);
    useEffect(() => { if(onInitRecorder) onInitRecorder(canvasRef); }, [onInitRecorder]);

    const takeSnapshot = () => {
        if(!canvasRef.current) return;
        const link = document.createElement('a');
        link.download = `kala_snapshot_${Date.now()}.png`;
        link.href = canvasRef.current.toDataURL();
        link.click();
        if(toast) toast("Snapshot Saved");
    };

    useEffect(() => {
        const cvs = canvasRef.current; if(!cvs) return;
        const ctx = cvs.getContext('2d');
        let fid;
        const render = () => {
            if(!canvasRef.current) return;
            const w = cvs.width = cvs.clientWidth; const h = cvs.height = cvs.clientHeight;
            const cx = w/2, cy = h/2;
            const grad = ctx.createLinearGradient(0,0,0,h); grad.addColorStop(0, '#020617'); grad.addColorStop(1, '#0f172a');
            ctx.fillStyle = grad; ctx.fillRect(0,0,w,h);
            const project = (x,y,z) => {
                const { yaw, pitch, zoom, x: camX, y: camY } = cam.current;
                const tx = x - camX; const ty = y - camY; 
                let x1 = tx * Math.cos(yaw) - z * Math.sin(yaw); let z1 = z * Math.cos(yaw) + tx * Math.sin(yaw);
                let y2 = ty * Math.cos(pitch) - z1 * Math.sin(pitch); let z2 = z1 * Math.cos(pitch) + ty * Math.sin(pitch);
                const scale = 500 / (500 - z2) * zoom;
                return { x: cx + x1 * scale, y: cy - y2 * scale, s: scale, z: z2 };
            };
            if (showAxes) {
                const o = project(0,0,0); const x = project(10,0,0); const y = project(0,10,0); const z = project(0,0,10);
                ctx.lineWidth = 1; 
                ctx.beginPath(); ctx.strokeStyle = '#ef4444'; ctx.moveTo(o.x, o.y); ctx.lineTo(x.x, x.y); ctx.stroke(); 
                ctx.beginPath(); ctx.strokeStyle = '#22c55e'; ctx.moveTo(o.x, o.y); ctx.lineTo(y.x, y.y); ctx.stroke(); 
                ctx.beginPath(); ctx.strokeStyle = '#3b82f6'; ctx.moveTo(o.x, o.y); ctx.lineTo(z.x, z.y); ctx.stroke(); 
            }
            if(drawRef.current) try { drawRef.current(ctx, project, w, h); } catch(e) { }
            fid = requestAnimationFrame(render);
        };
        render(); return () => cancelAnimationFrame(fid);
    }, [showAxes]); 
    
    const handleInteract = (e) => {
        if(!interact) return;
        const cvs = canvasRef.current;
        const rect = cvs.getBoundingClientRect();
        const clientX = e.clientX || e.touches[0].clientX; const clientY = e.clientY || e.touches[0].clientY;
        interact(clientX - rect.left, clientY - rect.top, cvs.width, cvs.height);
    };
    return (
        <div className="relative w-full h-full touch-none group">
            <canvas ref={canvasRef} onClick={interact ? handleInteract : null} className="w-full h-full block cursor-move" />
            <button onClick={takeSnapshot} className="absolute bottom-4 right-4 p-2 bg-slate-800/50 text-slate-400 hover:text-white rounded-full opacity-0 group-hover:opacity-100 transition duration-300 backdrop-blur"><Icons.Camera /></button>
        </div>
    );
};
const ODESolver = () => {
    const vibrate = useHaptics();
    const audio = useAudioEngine();
    const toast = useToast();
    const { btnSize, gap, text } = useUIAdaptation(); 

    // --- MATH PARSER (FIXED) ---
    // Correction: Removed .toLowerCase() to preserve variable casing (e.g., 'L', 'F0')
    const parseEq = (str) => {
        if (!str) return "0";
        let s = str; // Kept original casing for variables
        s = s.replace(/\^/g, '**'); // Power operator
        
        // Replace functions with Math.fn (e.g., sin -> Math.sin)
        // We use a Regex with word boundaries (\b) to avoid replacing variables that contain these substrings.
        const mathFunctions = ['sin', 'cos', 'tan', 'sqrt', 'abs', 'exp', 'log', 'max', 'min', 'pow'];
        mathFunctions.forEach(fn => {
            const regex = new RegExp(`\\b${fn}\\b`, 'g');
            s = s.replace(regex, `Math.${fn}`);
        });
        
        // Handle PI separately to ensure uppercase Math.PI
        s = s.replace(/\bpi\b/gi, 'Math.PI');
        
        return s;
    };

    // --- PRESET SCENARIOS ---
    const SCENARIOS = {
        // --- GRAVITY (Symplectic Kernel) ---
        solar: {
            id: 'solar', name: "Solar System (9-Body)", kernel: 'gravity', render: 'orbit',
            desc: "Full N-Body (AU/Years)",
            G: 39.478, dt: 0.002, trail: 1000, zoom: 45,
            bodies: [
                {name: 'Sun', x:0, y:0, z:0, vx:0, vy:0, vz:0, m:1, r:5, fixed:true, col:'#fbbf24'},
                {name: 'Mercury', x:0.39, y:0, z:0, vx:0, vy:10.02, vz:0, m:1.66e-7, r:1.2, col:'#a3a3a3'},
                {name: 'Venus', x:0.72, y:0, z:0, vx:0, vy:7.38, vz:0, m:2.45e-6, r:1.8, col:'#ea580c'},
                {name: 'Earth', x:1.00, y:0, z:0, vx:0, vy:6.28, vz:0, m:3.00e-6, r:2.0, col:'#3b82f6'},
                {name: 'Mars', x:1.52, y:0, z:0, vx:0, vy:5.08, vz:0, m:3.21e-7, r:1.6, col:'#ef4444'},
                {name: 'Jupiter', x:5.20, y:0, z:0, vx:0, vy:2.75, vz:0, m:9.54e-4, r:4.0, col:'#d97706'},
                {name: 'Saturn', x:9.58, y:0, z:0, vx:0, vy:2.02, vz:0, m:2.86e-4, r:3.5, col:'#fcd34d'},
                {name: 'Uranus', x:19.22, y:0, z:0, vx:0, vy:1.43, vz:0, m:4.36e-5, r:3.0, col:'#22d3ee'},
                {name: 'Neptune', x:30.05, y:0, z:0, vx:0, vy:1.13, vz:0, m:5.15e-5, r:3.0, col:'#3b82f6'},
                {name: 'Pluto', x:39.48, y:0, z:0, vx:0, vy:0.98, vz:0, m:6.58e-9, r:1.0, col:'#fda4af'}
            ],
            eqStr: "F = G * m1 * m2 / r^2"
        },
        disk: {
            id: 'disk', name: "Accretion Disk", kernel: 'gravity', render: 'orbit',
            desc: "120+ Particles (Galaxy Formation)",
            G: 1, dt: 0.01, trail: 0, zoom: 60,
            bodies: [], // Auto-generated
            eqStr: "F = G * m1 * m2 / r^2"
        },
        three_body: {
            id: 'three_body', name: "3-Body Chaos", kernel: 'gravity', render: 'orbit',
            desc: "Figure-8 Stable Solution",
            G: 1, dt: 0.005, trail: 2000, zoom: 15,
            bodies: [
                {name: 'A', x:0.97000436, y:-0.24308753, z:0, vx:0.466203685, vy:0.43236573, vz:0, m:1, r:2, col:'#fbbf24'},
                {name: 'B', x:-0.97000436, y:0.24308753, z:0, vx:0.466203685, vy:0.43236573, vz:0, m:1, r:2, col:'#3b82f6'},
                {name: 'C', x:0, y:0, z:0, vx:-0.93240737, vy:-0.86473146, vz:0, m:1, r:2, col:'#ef4444'}
            ],
            eqStr: "F = G * m1 * m2 / r^2"
        },
        lagrange: {
             id: 'lagrange', name: "Lagrange L4", kernel: 'gravity', render: 'orbit',
             desc: "Restricted 3-Body (Trojan)",
             G: 1, dt: 0.01, trail: 1500, zoom: 45,
             bodies: [
                 {name: 'Star', x:0, y:0, z:0, vx:0, vy:0, vz:0, m:100, r:6, fixed:true, col:'#fbbf24'},
                 {name: 'Planet', x:10, y:0, z:0, vx:0, vy:3.162, vz:0, m:1, r:3, col:'#3b82f6'}, 
                 {name: 'Trojan', x:5.0, y:8.66, z:0, vx:-2.738, vy:1.581, vz:0, m:0.001, r:1.5, col:'#10b981'} 
             ],
             eqStr: "F = G * m1 * m2 / r^2"
        },

        // --- OSCILLATORS (RK4 Kernel) ---
        shm: {
            id: 'shm', name: "Simple Harmonic", kernel: 'ode', render: 'bob',
            desc: "F = -kx (Ideal)",
            vars: { x: 5, v: 0, k: 2, m: 1 }, 
            eqs: { x: "v", v: "-(k/m)*x", k:"0", m:"0" }, 
            dt: 0.02, zoom: 15, trail: 600
        },
        damped: {
            id: 'damped', name: "Damped Harmonic", kernel: 'ode', render: 'bob',
            desc: "F = -kx - cv (Friction)",
            vars: { x: 5, v: 0, k: 2, m: 1, c: 0.3 }, 
            eqs: { x: "v", v: "(-k*x - c*v)/m", k:"0", m:"0", c:"0" },
            dt: 0.02, zoom: 15, trail: 600
        },
        resonance: {
            id: 'resonance', name: "Driven Resonance", kernel: 'ode', render: 'bob',
            desc: "F = F0*cos(w*t) - kx - cv",
            // Note: w=3 matches natural freq sqrt(9/1)=3
            vars: { x: 0, v: 0, k: 9, m: 1, c: 0.1, F0: 5, w: 3 }, 
            eqs: { x: "v", v: "(-k*x - c*v + F0*cos(w*t))/m", k:"0", m:"0", c:"0", F0:"0", w:"0" },
            dt: 0.02, zoom: 20, trail: 1000
        },
        pendulum: {
            id: 'pendulum', name: "Non-Linear Pendulum", kernel: 'ode', render: 'pendulum',
            desc: "Jacobian Elliptic (Large Angle)",
            vars: { theta: 3.1, omega: 0, g: 9.8, L: 5, c: 0.1 },
            eqs: { theta: "omega", omega: "-(g/L)*sin(theta) - c*omega", g:"0", L:"0", c:"0" },
            dt: 0.015, zoom: 12, trail: 800
        },

        // --- MECHANICS ---
        projectile: {
            id: 'projectile', name: "Projectile (Air Drag)", kernel: 'ode', render: 'projectile',
            desc: "Quadratic Drag (v^2)",
            vars: { x: -30, y: 0, vx: 30, vy: 40, m: 1, g: 9.8, k: 0.02 },
            eqs: { 
                x: "vx", y: "vy", 
                vx: "-(k/m)*vx*sqrt(vx^2 + vy^2)", 
                vy: "-g - (k/m)*vy*sqrt(vx^2 + vy^2)",
                m:"0", g:"0", k:"0"
            },
            dt: 0.015, zoom: 60, trail: 500
        },
        lorenz: {
            id: 'lorenz', name: "Lorenz Attractor", kernel: 'ode', render: 'phase',
            desc: "Chaos Theory (Butterfly)",
            vars: { x: 1, y: 1, z: 1, s: 10, r: 28, b: 2.66 },
            eqs: { x: "s*(y-x)", y: "x*(r-z)-y", z: "x*y - b*z", s:"0", r:"0", b:"0" },
            dt: 0.006, zoom: 50, trail: 3000
        },
        custom: {
            id: 'custom', name: "General ODE", kernel: 'ode', render: 'phase',
            desc: "User Defined System",
            vars: { x: 1, y: 0, z: 0 },
            eqs: { x: "y", y: "-x", z: "0" },
            dt: 0.01, zoom: 10, trail: 500
        }
    };

    // --- STATE MANAGEMENT ---
    const [config, setConfig] = useState(SCENARIOS.solar);
    const [playing, setPlaying] = useState(true);
    const [tab, setTab] = useState('story');
    const [fullScreen, setFullScreen] = useState(false);
    
    // Physics Engine State
    const timeRef = useRef(0);
    const stateRef = useRef(null); 
    const historyRef = useRef([]); // Unlimited history for PDF
    const [displayData, setDisplayData] = useState([]); // Sliced for UI
    
    // Function Compilation Refs
    const funcRef = useRef(null); 
    const forceFuncRef = useRef(null);

    // User Settings
    const [showTrails, setShowTrails] = useState(true);
    const [showAxes, setShowAxes] = useState(true);
    const [trailLen, setTrailLen] = useState(800);
    const [infiniteTrail, setInfiniteTrail] = useState(false);
    const [precision, setPrecision] = useState(4);
    const [dtOverride, setDtOverride] = useState(null);
    
    const canvasRef = useRef(null);
    const { recording, startRecording, stopRecording } = useCanvasRecorder(canvasRef);

    // --- LOADER ---
    const loadScenario = (key) => {
        setPlaying(false);
        const s = JSON.parse(JSON.stringify(SCENARIOS[key]));
        setConfig(s);
        setDtOverride(s.dt);
        setTrailLen(s.trail || 800);
        setInfiniteTrail(false);
        
        timeRef.current = 0;
        historyRef.current = [];
        setDisplayData([]);
        
        // 1. Gravity (Array)
        if(s.kernel === 'gravity') {
            if(s.id === 'disk') {
                const disk = [{name:'BH', x:0, y:0, z:0, vx:0, vy:0, vz:0, m:200, r:4, fixed:true, col:'#fbbf24'}];
                for(let i=0; i<120; i++) {
                    const ang = Math.random() * Math.PI * 2;
                    const dist = 10 + Math.random() * 50;
                    const v = Math.sqrt(s.G * 200 / dist);
                    disk.push({
                        name: `P${i}`, x: Math.cos(ang)*dist, y: Math.sin(ang)*dist, z: (Math.random()-0.5)*1.5,
                        vx: -Math.sin(ang)*v, vy: Math.cos(ang)*v, vz: 0, m: 0.1, r: 0.6, col: '#fff'
                    });
                }
                stateRef.current = disk;
            } else {
                stateRef.current = s.bodies;
            }
            try { forceFuncRef.current = new Function('m1', 'm2', 'r', 'G', `return ${parseEq(s.eqStr.split('=')[1] || "G*m1*m2/r^2")}`); } catch(e){}
        } 
        // 2. ODE (Object)
        else if (s.kernel === 'ode') {
            stateRef.current = { ...s.vars };
            compileODE(s.vars, s.eqs);
        }
        
        setTimeout(() => setPlaying(true), 100);
        vibrate();
        if(toast) toast(`Loaded: ${s.name}`);
    };

    useEffect(() => loadScenario('solar'), []);

    const compileODE = (vars, eqs) => {
        try {
            const vNames = Object.keys(vars);
            const args = [...vNames, 't'];
            const body = `return { ${vNames.map(v => `${v}: ${parseEq(eqs[v])}`).join(', ')} };`;
            funcRef.current = new Function(...args, body);
        } catch(e) { console.error("ODE Compile Error", e); }
    };

    // --- PHYSICS KERNEL ---
    useEffect(() => {
        let frame;
        const loop = () => {
            if(!playing || !stateRef.current) return;
            const dt = dtOverride || 0.01;
            const t = timeRef.current;
            
            // GRAVITY KERNEL
            if(config.kernel === 'gravity' && Array.isArray(stateRef.current)) {
                const bodies = stateRef.current;
                const N = bodies.length;
                const G = config.G;
                const forceFn = forceFuncRef.current;

                for(let i=0; i<N; i++) {
                    if(bodies[i].fixed) continue;
                    let ax=0, ay=0, az=0;
                    for(let j=0; j<N; j++) {
                        if(i===j) continue;
                        const dx = bodies[j].x - bodies[i].x;
                        const dy = bodies[j].y - bodies[i].y;
                        const dz = bodies[j].z - bodies[i].z;
                        const r2 = dx*dx + dy*dy + dz*dz + 1e-6;
                        const r = Math.sqrt(r2);
                        let f = 0;
                        if(forceFn) { try{f=forceFn(bodies[i].m, bodies[j].m, r, G);}catch(e){f=G*bodies[i].m*bodies[j].m/r2;} }
                        else { f = G*bodies[i].m*bodies[j].m/r2; }
                        const a = f / bodies[i].m;
                        ax += a * (dx/r); ay += a * (dy/r); az += a * (dz/r);
                    }
                    bodies[i].vx += ax * dt; bodies[i].vy += ay * dt; bodies[i].vz += az * dt;
                }
                for(let i=0; i<N; i++) {
                    if(!bodies[i].fixed) {
                        bodies[i].x += bodies[i].vx * dt; bodies[i].y += bodies[i].vy * dt; bodies[i].z += bodies[i].vz * dt;
                    }
                }
                historyRef.current.push(JSON.parse(JSON.stringify(bodies)));
            }
            
            // ODE KERNEL
            else if (config.kernel === 'ode' && !Array.isArray(stateRef.current) && funcRef.current) {
                const s = stateRef.current;
                const vars = Object.keys(config.vars);
                const f = funcRef.current;
                
                try {
                    const k1 = f(...vars.map(v=>s[v]), t);
                    const s2={}; vars.forEach(v=>s2[v]=s[v]+k1[v]*0.5*dt);
                    const k2 = f(...vars.map(v=>s2[v]), t+0.5*dt);
                    const s3={}; vars.forEach(v=>s3[v]=s[v]+k2[v]*0.5*dt);
                    const k3 = f(...vars.map(v=>s3[v]), t+0.5*dt);
                    const s4={}; vars.forEach(v=>s4[v]=s[v]+k3[v]*dt);
                    const k4 = f(...vars.map(v=>s4[v]), t+dt);
                    
                    vars.forEach(v => { s[v] += (dt/6)*(k1[v]+2*k2[v]+2*k3[v]+k4[v]); });
                    
                    // Bounce for Projectile
                    if(config.render === 'projectile' && s.y < 0) {
                        s.y = 0; s.vy = -s.vy * 0.7; s.vx *= 0.9;
                        if(Math.abs(s.vy) < 0.5) s.vy = 0;
                    }
                    
                    historyRef.current.push({...s, t});
                } catch(e) {}
            }

            timeRef.current += dt;
            if(!infiniteTrail && historyRef.current.length > trailLen) historyRef.current.shift();
            frame = requestAnimationFrame(loop);
        };
        loop(); return () => cancelAnimationFrame(frame);
    }, [playing, dtOverride, config.id, trailLen, infiniteTrail]);

    // --- DATA SAMPLING ---
    useEffect(() => {
        const id = setInterval(() => {
            if(!playing || historyRef.current.length === 0) return;
            const last = historyRef.current[historyRef.current.length-1];
            let pt = {};
            if(config.kernel === 'gravity' && Array.isArray(last)) {
                const b = last.find(x => !x.fixed) || last[0];
                pt = { t: timeRef.current, Name: b.name, X: b.x, Y: b.y, V: Math.hypot(b.vx, b.vy) };
            } else if (config.kernel === 'ode' && !Array.isArray(last)) {
                pt = { t: timeRef.current, ...last };
            }
            setDisplayData(prev => { const nu = [...prev, pt]; return nu.length > 200 ? nu.slice(-200) : nu; });
        }, 200);
        return () => clearInterval(id);
    }, [playing, config.id]);

    // --- DRAWING ---
    const draw = (ctx, project, w, h) => {
        const hist = historyRef.current;
        if(hist.length === 0) return;

        if(showAxes) {
            const o = project(0,0,0); const x = project(10,0,0); const y = project(0,10,0);
            ctx.lineWidth = 1;
            ctx.beginPath(); ctx.strokeStyle = '#ef4444'; ctx.moveTo(o.x, o.y); ctx.lineTo(x.x, x.y); ctx.stroke(); 
            ctx.beginPath(); ctx.strokeStyle = '#22c55e'; ctx.moveTo(o.x, o.y); ctx.lineTo(y.x, y.y); ctx.stroke(); 
            if(config.render === 'projectile' || config.render === 'bob') {
                const g1 = project(-200,0,0); const g2 = project(200,0,0);
                ctx.beginPath(); ctx.strokeStyle = '#64748b'; ctx.moveTo(g1.x, g1.y); ctx.lineTo(g2.x, g2.y); ctx.stroke();
            }
        }

        if(config.render === 'orbit' && Array.isArray(hist[0])) {
            if(showTrails) {
                const num = hist[0].length;
                for(let b=0; b<num; b++) {
                    const col = hist[hist.length-1][b].col;
                    ctx.beginPath(); ctx.strokeStyle = col; ctx.globalAlpha = 0.5;
                    let st = false;
                    for(let i=0; i<hist.length; i+=2) {
                        const p = project(hist[i][b].x, hist[i][b].y, hist[i][b].z);
                        if(!st) { ctx.moveTo(p.x, p.y); st=true; } else ctx.lineTo(p.x, p.y);
                    }
                    ctx.stroke(); ctx.globalAlpha = 1;
                }
            }
            hist[hist.length-1].forEach(b => {
                const p = project(b.x, b.y, b.z);
                const r = b.m > 0.5 ? 5 : 2; 
                ctx.fillStyle = b.col; ctx.beginPath(); ctx.arc(p.x, p.y, r, 0, 7); ctx.fill();
            });
        }
        else if (config.render === 'bob' && !Array.isArray(hist[0])) {
            const last = hist[hist.length-1];
            const p = project(last.x, 0, 0); 
            ctx.fillStyle = '#22d3ee'; ctx.beginPath(); ctx.arc(p.x, p.y, 8, 0, 7); ctx.fill();
            if(showTrails) {
                ctx.beginPath(); ctx.strokeStyle = '#f59e0b'; ctx.globalAlpha = 0.6;
                hist.forEach((h, i) => {
                    const pt = project(h.x, h.v, 0); // Phase Plot
                    if(i===0) ctx.moveTo(pt.x, pt.y); else ctx.lineTo(pt.x, pt.y);
                });
                ctx.stroke(); ctx.globalAlpha = 1;
            }
        }
        else if (config.render === 'pendulum' && !Array.isArray(hist[0])) {
            const last = hist[hist.length-1];
            const L = last.L || 5;
            const bx = L * Math.sin(last.theta);
            const by = -L * Math.cos(last.theta);
            const o = project(0,0,0);
            const bob = project(bx, by, 0);
            ctx.beginPath(); ctx.strokeStyle = '#fff'; ctx.lineWidth = 2; ctx.moveTo(o.x, o.y); ctx.lineTo(bob.x, bob.y); ctx.stroke();
            ctx.fillStyle = '#ef4444'; ctx.beginPath(); ctx.arc(bob.x, bob.y, 8, 0, 7); ctx.fill();
            if(showTrails) {
                ctx.beginPath(); ctx.strokeStyle = '#ef4444'; ctx.globalAlpha = 0.3;
                hist.forEach((h, i) => {
                    const tx = (h.L||5) * Math.sin(h.theta);
                    const ty = -(h.L||5) * Math.cos(h.theta);
                    const pt = project(tx, ty, 0);
                    if(i===0) ctx.moveTo(pt.x, pt.y); else ctx.lineTo(pt.x, pt.y);
                });
                ctx.stroke(); ctx.globalAlpha = 1;
            }
        }
        else if (!Array.isArray(hist[0])) {
            const vars = Object.keys(config.vars);
            if(showTrails) {
                ctx.beginPath(); ctx.strokeStyle = '#a855f7';
                hist.forEach((h, i) => {
                    const p = project(h[vars[0]], h[vars[1]], vars[2]?h[vars[2]]:0);
                    if(i===0) ctx.moveTo(p.x, p.y); else ctx.lineTo(p.x, p.y);
                });
                ctx.stroke();
            }
            const last = hist[hist.length-1];
            const p = project(last[vars[0]], last[vars[1]], vars[2]?last[vars[2]]:0);
            ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(p.x, p.y, 5, 0, 7); ctx.fill();
        }
    };

    // --- PDF GRAPHING ---
    const drawPDFGraph = (doc, data, xKey, yKey, startX, startY, w, h, title, col) => {
        if(!data || data.length < 5) return;
        let minX=Infinity, maxX=-Infinity, minY=Infinity, maxY=-Infinity;
        data.forEach(d => {
            const vx=d[xKey]||0, vy=d[yKey]||0;
            if(vx<minX) minX=vx; if(vx>maxX) maxX=vx;
            if(vy<minY) minY=vy; if(vy>maxY) maxY=vy;
        });
        const rx = maxX-minX||1, ry = maxY-minY||1;
        
        doc.setDrawColor(200); doc.rect(startX, startY, w, h);
        doc.setTextColor(100); doc.setFontSize(8); doc.text(title, startX, startY-2);
        
        doc.setDrawColor(col[0], col[1], col[2]); doc.setLineWidth(0.3);
        let px=0, py=0;
        data.forEach((d, i) => {
            const nx = startX + ((d[xKey]||0)-minX)/rx * w;
            const ny = (startY+h) - ((d[yKey]||0)-minY)/ry * h;
            if(i>0) doc.line(px, py, nx, ny);
            px=nx; py=ny;
        });
    };

    // --- GENERATE REPORT ---
    const generatePDF = () => {
        const doc = new jspdf.jsPDF();
        
        // PAGE 1: HEADER & SNAPSHOT
        doc.setFillColor(15, 23, 42); doc.rect(0, 0, 210, 40, 'F');
        doc.setTextColor(6, 182, 212); doc.setFontSize(18); doc.text("Research Analysis Report", 14, 20);
        doc.setTextColor(200); doc.setFontSize(10); doc.text(config.name, 14, 30);
        
        let y = 50;
        if(canvasRef.current) {
            try { doc.addImage(canvasRef.current.toDataURL('image/jpeg', 0.8), 'JPEG', 14, y, 100, 60); } catch(e){}
        }
        
        // Vector Graphs
        doc.setTextColor(0); doc.text("Data Plots:", 120, y);
        const sampleGraph = historyRef.current.filter((_,i)=>i%5===0);
        let keys = sampleGraph.length>0 ? (Array.isArray(sampleGraph[0]) ? [] : Object.keys(sampleGraph[0])) : [];
        
        if(keys.length >= 2) {
            drawPDFGraph(doc, sampleGraph, 't', keys[0], 120, y+5, 80, 40, `${keys[0].toUpperCase()} vs Time`, [251,191,36]);
            drawPDFGraph(doc, sampleGraph, keys[0], keys[1], 120, y+55, 80, 40, `${keys[1].toUpperCase()} vs ${keys[0].toUpperCase()}`, [34,211,238]);
        }
        y += 110;

        // Config Table
        const params = config.kernel==='gravity' 
            ? [['Bodies', stateRef.current.length], ['G', config.G], ['dt', config.dt]] 
            : Object.entries(config.eqs).filter(e=>e[1]!=="0").map(([k,v]) => [`d${k}'`, v]);
        doc.autoTable({ startY: y, head: [['Param', 'Value']], body: params, theme:'grid' });

        // PAGE 2+: FULL LOG
        doc.addPage();
        doc.text("Telemetry Log", 14, 20);
        let tableData = [];
        let tableHead = [];
        if(config.kernel === 'gravity') {
            tableHead = ['Time', 'Body', 'X', 'Y', 'V'];
            tableData = historyRef.current.filter((_,i)=>i%10===0).map((frame, i) => {
                const b = frame.find(x => !x.fixed) || frame[0];
                return [(i*config.dt).toFixed(2), b.name, b.x.toFixed(2), b.y.toFixed(2), Math.hypot(b.vx, b.vy).toFixed(2)];
            });
        } else {
            tableHead = keys;
            tableData = historyRef.current.filter((_,i)=>i%10===0).map(r => Object.values(r).map(v => typeof v==='number'?v.toFixed(precision):v));
        }
        doc.autoTable({ startY: 25, head: [tableHead], body: tableData, theme: 'striped', styles: { fontSize: 7 }, showHead: 'firstPage' });

        doc.save(`${config.id}_analysis.pdf`);
        if(toast) toast("Research Report Exported");
    };

    return (
        <div className={`flex flex-col h-[calc(100dvh-60px)] -m-4 relative ${fullScreen ? 'fixed inset-0 z-50 m-0 bg-slate-950' : ''}`}>
            {/* VIEWPORT */}
            <div className={`relative transition-all duration-500 bg-slate-900 overflow-hidden shadow-xl z-20 ${fullScreen ? 'absolute inset-0 h-full' : 'h-[50%] shrink-0'}`}>
                <SimCanvas draw={draw} initZoom={config.zoom} showAxes={showAxes} onInitRecorder={(ref) => canvasRef.current = ref.current} />
                <div className={`absolute top-4 right-4 flex items-center ${gap}`}>
                    <button onClick={recording ? stopRecording : startRecording} className={`${btnSize} rounded-full backdrop-blur border border-white/10 ${recording ? 'bg-red-500/20 text-red-500 animate-pulse' : 'bg-slate-800/80 text-white'}`}>{recording ? <Icons.StopRec /> : <Icons.Record />}</button>
                    <button onClick={() => loadScenario(config.id)} className={`${btnSize} rounded-full bg-slate-800/80 text-slate-400 hover:text-white backdrop-blur border border-white/10`}><Icons.Reset /></button>
                    <button onClick={() => setPlaying(!playing)} className={`${btnSize} rounded-full bg-blue-600/90 text-white shadow-lg backdrop-blur`}>{playing ? <Icons.Pause /> : <Icons.Play />}</button>
                    <button onClick={() => setFullScreen(!fullScreen)} className={`${btnSize} rounded-full bg-slate-800/80 text-slate-400 hover:text-white backdrop-blur border border-white/10`}>{fullScreen ? <Icons.Shrink /> : <Icons.Expand />}</button>
                </div>
                <div className="absolute bottom-2 left-2 pointer-events-none bg-black/40 backdrop-blur px-2 py-1 rounded border border-white/5">
                    <div className="text-[10px] font-mono text-cyan-400">t: {timeRef.current.toFixed(2)}</div>
                    <div className="text-[10px] font-mono text-slate-400">{config.name}</div>
                </div>
            </div>

            {/* CONTROLS */}
            {!fullScreen && (
                <div className="flex-1 flex flex-col glass-panel overflow-hidden border-t-0">
                    <div className="flex border-b border-white/10 shrink-0 bg-slate-900/50 overflow-x-auto no-scrollbar">
                        {['story', 'lab', 'equation', 'graph', 'data'].map(id => (
                            <button key={id} onClick={() => setTab(id)} className={`flex-1 min-w-[70px] py-3 text-[10px] font-bold uppercase tracking-widest transition font-display ${tab === id ? 'text-cyan-400 bg-white/5 border-b-2 border-cyan-500' : 'text-slate-500 hover:text-slate-300'}`}>{id}</button>
                        ))}
                    </div>

                    <div className="flex-1 overflow-y-auto scroller p-4 relative bg-slate-900/80">
                        {tab === 'story' && (
                            <div className="space-y-8 animate-in fade-in duration-700">
                                <div className="border-l-4 border-yellow-500 pl-4">
                                    <h3 className="text-yellow-500 font-bold text-xs uppercase tracking-widest mb-1 font-display">1687: THE CLOCKWORK</h3>
                                    <h1 className="text-2xl font-bold text-white mb-2 font-display">Newton's Dream</h1>
                                    <p className="text-slate-300 text-sm leading-relaxed">
                                        For centuries, humanity looked at the stars and saw gods. Then Isaac Newton connected the apple falling to the moon orbiting with a single, elegant equation: <strong>Universal Gravitation</strong>. He believed the universe was a perfect clock, its future entirely predictable if we knew its present state.
                                    </p>
                                </div>
                                <div className="border-l-4 border-pink-500 pl-4">
                                    <h3 className="text-pink-500 font-bold text-xs uppercase tracking-widest mb-1 font-display">1890: CHAOS</h3>
                                    <h1 className="text-2xl font-bold text-white mb-2 font-display">PoincarÃ©'s Discovery</h1>
                                    <p className="text-slate-300 text-sm leading-relaxed">
                                        Henri PoincarÃ© found that adding just one more body (the 3-Body Problem) created <strong>Chaos</strong>. A butterfly flapping its wings could change the fate of solar systems. The clockwork was shattered.
                                    </p>
                                </div>
                                <div className="border-l-4 border-cyan-500 pl-4">
                                    <h3 className="text-cyan-500 font-bold text-xs uppercase tracking-widest mb-1 font-display">COMPUTATION</h3>
                                    <h1 className="text-2xl font-bold text-white mb-2 font-display">The Euler Error</h1>
                                    <p className="text-slate-300 text-sm leading-relaxed">
                                        Real time is continuous. Computer time is discrete steps (<Latex tex="\Delta t" />). If we use straight lines for orbits, planets spiral out! We must use <strong>Symplectic Integrators</strong> to correct this.
                                    </p>
                                </div>
                            </div>
                        )}

                        {tab === 'lab' && (
                            <div className="space-y-6">
                                <div>
                                    <div className="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-2">Scenario</div>
                                    <div className="grid grid-cols-2 gap-2">
                                        {Object.values(SCENARIOS).map(s => (
                                            <button key={s.id} onClick={() => loadScenario(s.id)} className={`p-2 rounded border text-left transition ${config.id===s.id ? 'bg-cyan-500/20 border-cyan-500 text-cyan-200' : 'bg-slate-800 border-slate-700 text-slate-400 hover:border-slate-500'}`}>
                                                <div className="text-[9px] font-bold font-display uppercase opacity-70">{s.id}</div>
                                                <div className="text-xs font-bold truncate">{s.name}</div>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                                <div className="glass-card p-4 border-l-2 border-cyan-500">
                                    <div className="text-[10px] font-bold text-cyan-500 uppercase tracking-wider mb-3">Settings</div>
                                    <ParamInput label="Time Step" val={dtOverride || config.dt} set={setDtOverride} step="0.001" />
                                    <div className="py-2 border-t border-white/5 space-y-2">
                                        <div className="flex justify-between text-xs text-slate-400">
                                            <span>Trail: {infiniteTrail ? 'âˆž' : trailLen}</span>
                                            <button onClick={()=>setInfiniteTrail(!infiniteTrail)} className={`text-[9px] px-2 rounded ${infiniteTrail?'bg-cyan-500 text-white':'bg-slate-700'}`}>{infiniteTrail?'Infinite':'Limit'}</button>
                                        </div>
                                        {!infiniteTrail && <input type="range" min="100" max="5000" step="100" value={trailLen} onChange={e=>setTrailLen(parseInt(e.target.value))} className="w-full h-1 bg-slate-700 rounded-lg accent-cyan-500 appearance-none" />}
                                    </div>
                                    {config.kernel === 'ode' && (
                                        <div className="mt-4 pt-4 border-t border-white/10 space-y-1">
                                            <div className="text-[10px] font-bold text-yellow-500 uppercase mb-2">Parameters</div>
                                            {Object.keys(config.vars).map(k => {
                                                if(config.eqs[k] === "0") return <ParamInput key={k} label={k.toUpperCase()} val={stateRef.current[k]} set={v => { stateRef.current[k] = v; setConfig({...config}); }} />;
                                                return null;
                                            })}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {tab === 'equation' && (
                            <div className="space-y-4">
                                {config.kernel === 'ode' ? (
                                    <div className="glass-card p-4 border border-pink-500/30">
                                        <div className="text-[10px] font-bold text-pink-500 uppercase tracking-wider mb-2">Edit Equations (JS)</div>
                                        {Object.keys(config.eqs).map(v => {
                                            if(config.eqs[v] !== "0") return (
                                                <div key={v} className="flex items-center gap-2 mb-2">
                                                    <span className="text-xs font-mono text-pink-400 w-12">d{v}' =</span>
                                                    <input value={config.eqs[v]} onChange={(e) => { const newEqs = {...config.eqs, [v]: e.target.value}; setConfig({...config, eqs: newEqs}); compileODE(config.vars, newEqs); }} className="flex-1 bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs font-mono text-white focus:border-pink-500 outline-none" />
                                                </div>
                                            );
                                            return null;
                                        })}
                                    </div>
                                ) : (
                                    <div className="glass-card p-4 border border-cyan-500/30">
                                        <div className="text-[10px] font-bold text-cyan-500 uppercase tracking-wider mb-2">Force Law</div>
                                        <EqInput label="F(r)" sub="F=" val={config.eqStr} set={v=>{ setConfig({...config, eqStr:v}); try { forceFuncRef.current = new Function('m1', 'm2', 'r', 'G', `return ${parseEq(v)}`); } catch(e){} }} color="border-cyan-500" />
                                    </div>
                                )}
                            </div>
                        )}

                        {tab === 'graph' && (
                            <div className="space-y-4">
                                {config.kernel === 'ode' ? (
                                    <>
                                        <GraphCard title="Phase Space (X vs V)" data={displayData} x={Object.keys(config.vars)[0]} y={Object.keys(config.vars)[1]} col="#22d3ee" />
                                        <GraphCard title="Time Series (X vs T)" data={displayData} x="t" y={Object.keys(config.vars)[0]} col="#fbbf24" />
                                    </>
                                ) : (
                                    <>
                                        <GraphCard title="Radial Distance" data={displayData} x="t" y="V" col="#ef4444" />
                                        <GraphCard title="Y-Coord" data={displayData} x="t" y="Y" col="#fbbf24" />
                                    </>
                                )}
                            </div>
                        )}

                        {tab === 'data' && (
                            <div className="h-full flex flex-col">
                                <div className="flex justify-between items-center mb-4">
                                    <ParamInput label="Decimals" val={precision} set={setPrecision} step="1" min="0" max="10" />
                                    <button onClick={generatePDF} className="bg-cyan-600 hover:bg-cyan-500 text-white text-xs font-bold px-4 py-2 rounded flex items-center gap-2 shadow-lg shadow-cyan-500/20"><Icons.Book /> Export Research Report</button>
                                </div>
                                <div className="flex-1 overflow-auto border border-white/10 rounded">
                                    {displayData.length > 0 ? (
                                        <table className="data-table">
                                            <thead><tr>{Object.keys(displayData[0]).map(h => <th key={h}>{h}</th>)}</tr></thead>
                                            <tbody>{displayData.slice().reverse().map((r, i) => (<tr key={i}>{Object.values(r).map((v, j) => <td key={j}>{typeof v === 'number' ? v.toFixed(precision) : v}</td>)}</tr>))}</tbody>
                                        </table>
                                    ) : <div className="text-center p-4 text-slate-500 italic">No Data</div>}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            )}
        </div>
    );
};
// --- 2. EMSOLVER (Electromagnetism: Maxwell & Lorentz) ---
const EMSolver = () => {
    const vibrate = useHaptics();
    const toast = useToast();
    const { btnSize, gap, text } = useUIAdaptation();
    
    const PRESETS = { 
        cyclotron: { name: "Cyclotron Motion", Ex: "0", Ey: "0", Ez: "0", Bx: "0", By: "0", Bz: "1", q: 1, m: 1 }, 
        drift: { name: "E x B Drift", Ex: "0", Ey: "1", Ez: "0", Bx: "0", By: "0", Bz: "1", q: 1, m: 1 }, 
        wave: { name: "EM Wave Field", Ex: "cos(t-z)", Ey: "0", Ez: "0", Bx: "0", By: "cos(t-z)", Bz: "0", q: 1, m: 1 } 
    };

    const [fullScreen, setFullScreen] = useState(false); 
    const [tab, setTab] = useState('textbook'); 
    const [playing, setPlaying] = useState(true); 
    const [fields, setFields] = useLocalStorage('em_fields', PRESETS.cyclotron); 
    const [dt, setDt] = useState(0.02);
    const [precision, setPrecision] = useState(4);
    
    // View Settings
    const [showTrails, setShowTrails] = useState(true);
    const [showAxes, setShowAxes] = useState(false);
    
    // Physics State
    const historyRef = useRef([]); 
    const [displayData, setDisplayData] = useState([]); 
    const bodiesRef = useRef([{ x: 0, y: 0, z: 0, vx: 2, vy: 0, vz: 0, Ex:0, Ey:0, Ez:0, Bx:0, By:0, Bz:0, Fx:0, Fy:0, Fz:0 }]); 
    const timeRef = useRef(0); 
    const fieldFuncRef = useRef(null); 
    const [stats, setStats] = useState({v: 0, f: 0}); 
    
    const canvasRef = useRef(null);
    const { recording, startRecording, stopRecording } = useCanvasRecorder(canvasRef);

    useEffect(() => { 
        try { 
            fieldFuncRef.current = new Function('x','y','z','t', `return { Ex: ${parseEq(fields.Ex)}, Ey: ${parseEq(fields.Ey)}, Ez: ${parseEq(fields.Ez)}, Bx: ${parseEq(fields.Bx)}, By: ${parseEq(fields.By)}, Bz: ${parseEq(fields.Bz)} };`); 
        } catch(e) { } 
    }, [fields]);

    const loadPreset = (key) => { 
        const p = PRESETS[key]; 
        setFields(p); 
        bodiesRef.current = [{ x:0,y:0,z:0,vx:2,vy:0,vz:0,Ex:0,Ey:0,Ez:0,Bx:0,By:0,Bz:0,Fx:0,Fy:0,Fz:0 }]; 
        timeRef.current = 0; 
        historyRef.current = []; 
        setDisplayData([]); 
        vibrate(); 
        if(toast) toast(`Loaded: ${p.name}`); 
    };
    
    useEffect(() => { 
        let frameId; 
        const loop = () => { 
            if (!playing || !fieldFuncRef.current) return; 
            const b = bodiesRef.current[0]; 
            const t = timeRef.current; 
            const calc = fieldFuncRef.current; 
            const {q,m} = fields; 

            // RK4 Integrator for Lorentz Force
            const getAccel = (x, y, z, vx, vy, vz, t) => { 
                const f = calc(x, y, z, t); 
                return { 
                    ax: (q/m)*(f.Ex + vy*f.Bz - vz*f.By), 
                    ay: (q/m)*(f.Ey + vz*f.Bx - vx*f.Bz), 
                    az: (q/m)*(f.Ez + vx*f.By - vy*f.Bx), 
                    f 
                }; 
            }; 

            const k1 = getAccel(b.x, b.y, b.z, b.vx, b.vy, b.vz, t); 
            const k2 = getAccel(b.x+b.vx*0.5*dt, b.y+b.vy*0.5*dt, b.z+b.vz*0.5*dt, b.vx+k1.ax*0.5*dt, b.vy+k1.ay*0.5*dt, b.vz+k1.az*0.5*dt, t+0.5*dt); 
            const k3 = getAccel(b.x+b.vx*0.5*dt, b.y+b.vy*0.5*dt, b.z+b.vz*0.5*dt, b.vx+k2.ax*0.5*dt, b.vy+k2.ay*0.5*dt, b.vz+k2.az*0.5*dt, t+0.5*dt); 
            const k4 = getAccel(b.x+b.vx*dt, b.y+b.vy*dt, b.z+b.vz*dt, b.vx+k3.ax*dt, b.vy+k3.ay*dt, b.vz+k3.az*dt, t+dt); 

            const nx = b.x + (dt/6)*(b.vx + 2*(b.vx+k1.ax*0.5*dt) + 2*(b.vx+k2.ax*0.5*dt) + (b.vx+k3.ax*dt)); 
            const nvx = b.vx + (dt/6)*(k1.ax + 2*k2.ax + 2*k3.ax + k4.ax); 
            const nvy = b.vy + (dt/6)*(k1.ay + 2*k2.ay + 2*k3.ay + k4.ay); 
            const nvz = b.vz + (dt/6)*(k1.az + 2*k2.az + 2*k3.az + k4.az); 
            const ny = b.y + b.vy*dt; 
            const nz = b.z + b.vz*dt; 
            
            const f = calc(nx, ny, nz, t+dt); 
            const newBody = { x:nx, y:ny, z:nz, vx:nvx, vy:nvy, vz:nvz, ...f, Fx:k4.ax*m, Fy:k4.ay*m, Fz:k4.az*m }; 
            
            bodiesRef.current = [newBody]; 
            timeRef.current += dt; 
            historyRef.current.push(newBody); 
            if (historyRef.current.length > 1500) historyRef.current.shift(); 
            
            if(Math.random() > 0.8) setStats({v: Math.sqrt(nvx**2+nvy**2+nvz**2), f: Math.sqrt(newBody.Fx**2+newBody.Fy**2+newBody.Fz**2)});
            frameId = requestAnimationFrame(loop); 
        }; 
        if(playing) loop(); return () => cancelAnimationFrame(frameId); 
    }, [playing, fields, dt]);

    // Data Sampling
    useEffect(() => { 
        const id = setInterval(() => { 
            if(playing && historyRef.current.length > 0) { 
                const last = historyRef.current[historyRef.current.length-1]; 
                setDisplayData(prev => { 
                    const nu = [...prev, { t: timeRef.current, ...last }]; 
                    if(nu.length > 500) return nu.slice(-500); 
                    return nu; 
                }); 
            } 
        }, 200); 
        return () => clearInterval(id); 
    }, [playing]);
    
    const draw = (ctx, project, w, h) => { 
        const hist = historyRef.current; 
        
        // Draw Field Grid (if enabled)
        if(fieldFuncRef.current && showAxes) {
            ctx.globalAlpha = 0.1; ctx.strokeStyle = '#475569';
            for(let x=-20; x<=20; x+=10) { 
                for(let y=-20; y<=20; y+=10) { 
                    const p = project(x,y,0); 
                    try { 
                        const f = fieldFuncRef.current(x,y,0,timeRef.current); 
                        if(Math.abs(f.Bz) > 0.1) { ctx.beginPath(); ctx.arc(p.x, p.y, 2, 0, 7); ctx.stroke(); } 
                    } catch(e){} 
                } 
            }
            ctx.globalAlpha = 1.0;
        }

        // Draw Trails
        if (hist.length > 1 && showTrails) { 
            ctx.beginPath(); ctx.strokeStyle = '#a855f7'; ctx.lineWidth = 2; ctx.shadowBlur = 10; ctx.shadowColor = '#a855f7'; ctx.globalAlpha = 0.6; 
            for(let i=0; i<hist.length; i+=2) { 
                const p = project(hist[i].x, hist[i].y, hist[i].z); 
                if (i===0) ctx.moveTo(p.x, p.y); else ctx.lineTo(p.x, p.y); 
            } 
            ctx.stroke(); ctx.shadowBlur = 0; ctx.globalAlpha = 1.0; 
        } 
        
        // Draw Particle
        const b = bodiesRef.current[0]; 
        const p = project(b.x, b.y, b.z); 
        const rad = Math.max(2, 6 * (p.s/20)); 
        ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(p.x, p.y, rad, 0, 7); ctx.fill(); 
        
        // Draw Force Vectors
        const dv = (vx,vy,vz,c) => { 
            const e = project(b.x+vx*0.5, b.y+vy*0.5, b.z+vz*0.5); 
            ctx.beginPath(); ctx.strokeStyle = c; ctx.lineWidth = 2; ctx.moveTo(p.x, p.y); ctx.lineTo(e.x, e.y); ctx.stroke(); 
        }; 
        dv(b.Ex,b.Ey,b.Ez,'#fbbf24'); // Electric Field Vector
        dv(b.Bx,b.By,b.Bz,'#22d3ee'); // Magnetic Field Vector
        dv(b.Fx,b.Fy,b.Fz,'#ef4444'); // Net Force Vector
    };
    
    return ( 
        <div className={`flex flex-col h-[calc(100dvh-60px)] -m-4 relative ${fullScreen ? 'fixed inset-0 z-50 m-0 bg-slate-950' : ''}`}> 
            <div className={`relative transition-all duration-500 bg-slate-900 overflow-hidden shadow-xl z-20 ${fullScreen ? 'absolute inset-0 h-full' : 'h-[35%] shrink-0'}`}> 
                <SimCanvas draw={draw} initZoom={20} showAxes={showAxes} onInitRecorder={(ref) => canvasRef.current = ref.current} /> 
                <div className={`absolute top-4 right-4 flex items-center ${gap}`}> 
                    <button onClick={recording ? stopRecording : startRecording} className={`${btnSize} rounded-full backdrop-blur border border-white/10 ${recording ? 'bg-red-500/20 text-red-500 animate-pulse' : 'bg-slate-800/80 text-white'}`}>{recording ? <Icons.StopRec /> : <Icons.Record />}</button> 
                    <button onClick={() => { bodiesRef.current=[{x:0,y:0,z:0,vx:2,vy:0,vz:0,Ex:0,Ey:0,Ez:0,Bx:0,By:0,Bz:0,Fx:0,Fy:0,Fz:0}]; timeRef.current=0; historyRef.current=[]; setDisplayData([]); vibrate(); }} className={`${btnSize} rounded-full bg-slate-800/80 text-slate-400 hover:text-white backdrop-blur border border-white/10`}><Icons.Reset /></button> 
                    <button onClick={() => {setPlaying(!playing); vibrate();}} className={`${btnSize} rounded-full bg-blue-600/90 text-white shadow-lg shadow-blue-500/50 backdrop-blur`}>{playing ? <Icons.Pause /> : <Icons.Play />}</button> 
                    <button onClick={()=>setFullScreen(!fullScreen)} className={`${btnSize} rounded-full bg-slate-800/80 text-slate-400 hover:text-white backdrop-blur border border-white/10`}>{fullScreen ? <Icons.Shrink /> : <Icons.Expand />}</button> 
                </div> 
                <div className="absolute bottom-4 left-4 text-[10px] font-mono text-slate-400 pointer-events-none"> 
                    <span className="text-yellow-400 font-bold">|v|: {stats.v.toFixed(precision)}</span> | <span className="text-red-400 font-bold">F: {stats.f.toFixed(precision)}</span> 
                </div> 
            </div> 

            {!fullScreen && ( 
                <div className="flex-1 flex flex-col glass-panel overflow-hidden border-t-0"> 
                    <div className="flex border-b border-white/10 shrink-0 bg-slate-900/50"> 
                        {['story', 'textbook', 'lab', 'table', 'graph'].map(id => (<button key={id} onClick={() => setTab(id)} className={`flex-1 py-3 text-[10px] font-bold uppercase tracking-widest transition font-display ${tab === id ? 'text-cyan-400 bg-white/5 border-b-2 border-cyan-500' : 'text-slate-500 hover:text-slate-300'}`}>{id}</button>))} 
                    </div> 
                    <div className="flex-1 overflow-hidden relative bg-slate-900/80"> 
                        {tab === 'story' && (
                            <div className="h-full overflow-y-auto scroller p-6 space-y-8 pb-20">
                                <div className="animate-in fade-in slide-in-from-bottom-4 duration-700">
                                    <h3 className="text-violet-500 font-bold text-xs uppercase tracking-widest mb-2 font-display">1865: THE SOURCE CODE</h3>
                                    <h1 className="text-3xl font-bold text-white mb-4 font-display">Electromagnetism</h1>
                                    <p className="text-slate-300 text-sm leading-7">Before the 19th century, electricity and magnetism were seen as separate novelties. <strong>James Clerk Maxwell</strong> unified them with four elegant equations. He showed that changing electric fields create magnetic fields, and vice versa.</p>
                                    <div className="glass-card p-4 rounded-xl border border-white/10 shadow-lg my-6"> 
                                        <h4 className="text-white font-bold text-sm font-display mb-2">Lorentz Force Law</h4> 
                                        <div className="font-mono text-violet-300 text-xs mb-2"><Latex tex="\vec{F} = q(\vec{E} + \vec{v} \times \vec{B})" /></div> 
                                        <p className="text-slate-300 text-xs leading-5"> This simulation solves the Lorentz Force Law in real-time. The particle reads the fields at its location and updates its velocity instantly. </p> 
                                    </div>
                                </div>
                            </div>
                        )}
                        {tab === 'textbook' && (
                            <div className="h-full overflow-y-auto scroller p-4 pb-20">
                                <div className="paper-bg text-sm rounded-sm mb-4 shadow-xl">
                                    <h3 className="text-black font-bold text-xl mb-4 border-b border-black/10 pb-2">Maxwell's Equations</h3>
                                    <p><strong>1. Gauss's Law</strong></p>
                                    <div className="my-2 text-center text-xs"><Latex tex="\nabla \cdot E = \frac{\rho}{\epsilon_0}" dark={false} /></div>
                                    <p>Electric charge produces an electric field.</p>
                                    <p><strong>2. Gauss's Law for Magnetism</strong></p>
                                    <div className="my-2 text-center text-xs"><Latex tex="\nabla \cdot B = 0" dark={false} /></div>
                                    <p>There are no magnetic monopoles.</p>
                                    <p><strong>3. Faraday's Law</strong></p>
                                    <div className="my-2 text-center text-xs"><Latex tex="\nabla \times E = -\frac{\partial B}{\partial t}" dark={false} /></div>
                                    <p>A changing magnetic field induces an electric field.</p>
                                    <p><strong>4. Ampere-Maxwell Law</strong></p>
                                    <div className="my-2 text-center text-xs"><Latex tex="\nabla \times B = \mu_0 J + \mu_0 \epsilon_0 \frac{\partial E}{\partial t}" dark={false} /></div>
                                    <p>Moving charges and changing E-fields create B-fields.</p>
                                </div>
                            </div>
                        )}
                        {tab === 'lab' && ( 
                            <div className="h-full overflow-y-auto p-4 space-y-4 scroller"> 
                                <div className="flex gap-2 overflow-x-auto pb-2 no-scrollbar">{Object.entries(PRESETS).map(([k, v]) => (<button key={k} onClick={() => loadPreset(k)} className="shrink-0 px-3 py-1 rounded border border-slate-700 text-[10px] font-bold text-slate-400 hover:bg-violet-900/50 hover:text-violet-300 hover:border-violet-500 transition font-display">{v.name}</button>))}</div> 
                                <div className="glass-card p-4 space-y-3 border-l-2 border-yellow-500">
                                    <div className="text-[10px] font-bold text-yellow-500 uppercase tracking-wider font-display">System Settings</div>
                                    <ParamInput label="Time Step (dt)" val={dt} set={setDt} step="0.001" unit="s" />
                                    <div className="grid grid-cols-2 gap-2 pt-2 border-t border-white/5">
                                        <button onClick={()=>setShowTrails(!showTrails)} className={`flex items-center justify-between px-2 py-1 rounded text-xs ${showTrails ? 'bg-violet-500/20 text-violet-300' : 'bg-slate-800 text-slate-500'}`}><span>Trails</span><Icons.Trail /></button>
                                        <button onClick={()=>setShowAxes(!showAxes)} className={`flex items-center justify-between px-2 py-1 rounded text-xs ${showAxes ? 'bg-violet-500/20 text-violet-300' : 'bg-slate-800 text-slate-500'}`}><span>Field Grid</span><Icons.Axes /></button>
                                    </div>
                                </div>
                                <div className="grid grid-cols-2 gap-3"> 
                                    <div className="space-y-2"><div className="text-[10px] font-bold text-yellow-500 uppercase tracking-wider">Electric (E)</div><EqInput label="Ex" val={fields.Ex} set={v=>setFields({...fields,Ex:v})} color="border-yellow-500"/><EqInput label="Ey" val={fields.Ey} set={v=>setFields({...fields,Ey:v})} color="border-yellow-500"/><EqInput label="Ez" val={fields.Ez} set={v=>setFields({...fields,Ez:v})} color="border-yellow-500"/></div> 
                                    <div className="space-y-2"><div className="text-[10px] font-bold text-cyan-500 uppercase tracking-wider">Magnetic (B)</div><EqInput label="Bx" val={fields.Bx} set={v=>setFields({...fields,Bx:v})} color="border-cyan-500"/><EqInput label="By" val={fields.By} set={v=>setFields({...fields,By:v})} color="border-cyan-500"/><EqInput label="Bz" val={fields.Bz} set={v=>setFields({...fields,Bz:v})} color="border-cyan-500"/></div> 
                                </div> 
                            </div> 
                        )} 
                        {tab === 'table' && ( 
                            <div className="h-full flex flex-col"> 
                                <div className="p-2 flex justify-between border-b border-white/10"><span className="text-[10px] text-slate-500 pt-1 font-display uppercase">Real-time Data</span><button onClick={()=>{const doc=new jspdf.jsPDF();doc.autoTable({head:[['T','X','Y','Vx','Vy']],body:displayData.map(d=>[d.t.toFixed(precision),d.x.toFixed(precision),d.y.toFixed(precision),d.vx.toFixed(precision),d.vy.toFixed(precision)])});doc.save('em_data.pdf')}} className="bg-slate-800 text-cyan-400 text-[10px] px-3 py-1 rounded border border-slate-700 hover:bg-cyan-900">EXPORT PDF</button></div> 
                                <div className="flex-1 overflow-auto scroller">
                                    {displayData.length > 0 ? (
                                        <table className="data-table">
                                            <thead><tr><th>T</th><th>X</th><th>Y</th><th>Vx</th><th>Vy</th></tr></thead>
                                            <tbody>{displayData.slice().reverse().map((r, i) => (<tr key={i}><td className="text-violet-400 font-bold">{r.t.toFixed(precision)}</td><td>{r.x.toFixed(precision)}</td><td>{r.y.toFixed(precision)}</td><td>{r.vx.toFixed(precision)}</td><td>{r.vy.toFixed(precision)}</td></tr>))}</tbody>
                                        </table>
                                    ) : (
                                        <div className="text-slate-500 italic p-4 text-center">Collecting data points...</div>
                                    )}
                                </div> 
                            </div> 
                        )} 
                        {tab === 'graph' && (<div className="h-full overflow-y-auto p-4 space-y-4 scroller"><div className="grid grid-cols-2 gap-3"><GraphCard title="Pos X-Y" data={displayData} x="x" y="y" col="#fbbf24" /><GraphCard title="Phase Vx-Vy" data={displayData} x="vx" y="vy" col="#22d3ee" /></div></div>)} 
                    </div> 
                </div> 
            )} 
        </div> 
    );
};

// --- 3. THERMOSOLVER (Thermodynamics & Statistical Mechanics) ---
const ThermoSolver = () => {
    const vibrate = useHaptics();
    const toast = useToast();
    const { btnSize, gap, text } = useUIAdaptation();
    
    const PRESETS = { 
        zero: { name: "Zeroth Law (Mixing)", force: "0", setup: "mixing" }, 
        first: { name: "First Law (Work)", force: "0", setup: "work" }, 
        second: { name: "Second Law (Entropy)", force: "0", setup: "entropy" }, 
        real: { name: "Real Gas (VDW)", force: "400*((1/r)**12 - (1/r)**6)", setup: "mixing" } // Lennard-Jones
    };
    const [fullScreen, setFullScreen] = useState(false); 
    const [tab, setTab] = useState('story'); 
    const [playing, setPlaying] = useState(true);
    const [config, setConfig] = useLocalStorage('thermo_cfg', { N: 150, force: "0", heat: 1.0, volume: 1.0 });
    const [precision, setPrecision] = useState(2);
    
    const bodiesRef = useRef([]); 
    const statsRef = useRef({ P:0, T:0, V:0, S:0 }); 
    const timeRef = useRef(0);
    const [displayData, setDisplayData] = useState([]); 
    const funcRef = useRef(null);
    
    const canvasRef = useRef(null);
    const { recording, startRecording, stopRecording } = useCanvasRecorder(canvasRef);
    
    const init = (mode) => {
        let arr = []; const N = config.N;
        for(let i=0; i<N; i++) {
            let x, y, z, vx, vy, vz, color;
            // Setup Initial Conditions
            if(mode === 'mixing') { 
                if(i < N/2) { x=Math.random()*40+5; y=Math.random()*40+5; z=Math.random()*40+5; vx=(Math.random()-0.5)*4; vy=(Math.random()-0.5)*4; vz=(Math.random()-0.5)*4; color='#ef4444'; } 
                else { x=Math.random()*40+55; y=Math.random()*40+5; z=Math.random()*40+5; vx=(Math.random()-0.5)*1; vy=(Math.random()-0.5)*1; vz=(Math.random()-0.5)*1; color='#3b82f6'; } 
            } 
            else if (mode === 'work') { x=Math.random()*90+5; y=Math.random()*40+5; z=Math.random()*40+5; vx=(Math.random()-0.5)*3; vy=(Math.random()-0.5)*3; vz=(Math.random()-0.5)*3; color='#fbbf24'; } 
            else { x=Math.random()*20+5; y=Math.random()*20+5; z=Math.random()*20+5; vx=(Math.random()-0.5)*5; vy=(Math.random()-0.5)*5; vz=(Math.random()-0.5)*5; color='#10b981'; }
            arr.push({ x, y, z, vx, vy, vz, color });
        }
        bodiesRef.current = arr; timeRef.current = 0; setDisplayData([]); vibrate();
        if(toast) toast("Thermodynamic System Reset");
    };
    
    useEffect(() => init(PRESETS.zero.setup), []);
    
    // Physics Engine
    useEffect(() => {
        if(!playing) return;
        try { funcRef.current = new Function('r', `return ${parseEq(config.force)}`); } catch(e) { return; }
        let frame;
        const loop = () => {
            const dt = 0.1; const boxW = 100 * config.volume; const boxH = 50; const boxD = 50;
            let P_impulse = 0; let KE = 0; 
            const forceFunc = funcRef.current;
            const bodies = bodiesRef.current;
            
            // Particle Interactions (Simplified O(N^2) for demo)
            if(config.force !== "0" && forceFunc) { 
                for(let i=0; i<bodies.length; i++){ 
                    for(let j=i+1; j<bodies.length; j++){ 
                        const b1 = bodies[i]; const b2 = bodies[j]; 
                        const dx = b2.x - b1.x; const dy = b2.y - b1.y; const dz = b2.z - b1.z; 
                        const r2 = dx*dx + dy*dy + dz*dz; 
                        if(r2 < 100 && r2 > 0.5) { // Cutoff range
                            const r = Math.sqrt(r2); 
                            const f = forceFunc(r); 
                            const fx = f * dx/r; const fy = f * dy/r; const fz = f * dz/r; 
                            b1.vx -= fx*dt; b1.vy -= fy*dt; b1.vz -= fz*dt; 
                            b2.vx += fx*dt; b2.vy += fy*dt; b2.vz += fz*dt; 
                        } 
                    } 
                } 
            }
            
            // Movement & Wall Collisions
            bodies.forEach(b => { 
                b.x += b.vx * dt; b.y += b.vy * dt; b.z += b.vz * dt; 
                
                // Thermostat (Heat Injection)
                if(Math.random() < 0.02) { 
                    const heatFactor = config.heat;
                    b.vx += (Math.random()-0.5)*heatFactor; 
                    b.vy += (Math.random()-0.5)*heatFactor; 
                    b.vz += (Math.random()-0.5)*heatFactor; 
                } 
                
                // Wall Bounces & Pressure Calculation
                if(b.x < 0) { b.x = 0; b.vx *= -1; P_impulse += Math.abs(b.vx); } 
                if(b.x > boxW) { b.x = boxW; b.vx *= -1; P_impulse += Math.abs(b.vx); } 
                if(b.y < 0) { b.y = 0; b.vy *= -1; P_impulse += Math.abs(b.vy); } 
                if(b.y > boxH) { b.y = boxH; b.vy *= -1; P_impulse += Math.abs(b.vy); } 
                if(b.z < 0) { b.z = 0; b.vz *= -1; P_impulse += Math.abs(b.vz); } 
                if(b.z > boxD) { b.z = boxD; b.vz *= -1; P_impulse += Math.abs(b.vz); } 
                
                KE += 0.5 * (b.vx**2 + b.vy**2 + b.vz**2); 
                
                // Color by speed
                const speed = Math.sqrt(b.vx**2 + b.vy**2 + b.vz**2); 
                b.color = speed > 4 ? '#ef4444' : speed > 2 ? '#fbbf24' : '#3b82f6'; 
            });
            
            timeRef.current += dt; 
            
            // Update Stats (averaged)
            if(Math.random() > 0.8) { 
                const newP = P_impulse / (dt * (2*(boxW*boxH + boxW*boxD + boxH*boxD))); 
                const newT = KE / bodies.length;
                statsRef.current.P = statsRef.current.P * 0.9 + newP * 0.1; // Smoothing
                statsRef.current.T = statsRef.current.T * 0.9 + newT * 0.1;
                statsRef.current.V = boxW * boxH * boxD; 
                // Boltzmann Entropy Approx S ~ ln(V) + 1.5 ln(T)
                statsRef.current.S = Math.log(Math.max(1, statsRef.current.V)) + 1.5 * Math.log(Math.max(1, statsRef.current.T)); 
            } 
            frame = requestAnimationFrame(loop);
        };
        loop(); return () => cancelAnimationFrame(frame);
    }, [playing, config]);

    // Data Logging
    useEffect(() => { 
        const id = setInterval(() => { 
            if(playing) { 
                const s = statsRef.current; 
                setDisplayData(p => { 
                    const n = [...p, { t: timeRef.current, P: s.P, V: s.V, T: s.T, S: s.S }]; 
                    return n.length > 300 ? n.slice(-300) : n; 
                }); 
            } 
        }, 250); 
        return () => clearInterval(id); 
    }, [playing]);
    
    const draw = (ctx, project, w, h) => {
        const boxW = 100*config.volume; const boxH = 50; const boxD = 50;
        // Draw Box Edges
        const corners = [ [0,0,0], [boxW,0,0], [boxW,boxH,0], [0,boxH,0], [0,0,boxD], [boxW,0,boxD], [boxW,boxH,boxD], [0,boxH,boxD] ]
            .map(c => project(c[0]-boxW/2, c[1]-boxH/2, c[2]-boxD/2));
        
        ctx.strokeStyle = '#64748b'; ctx.lineWidth = 1; 
        const edges = [[0,1],[1,2],[2,3],[3,0], [4,5],[5,6],[6,7],[7,4], [0,4],[1,5],[2,6],[3,7]]; 
        edges.forEach(e => { ctx.beginPath(); ctx.moveTo(corners[e[0]].x, corners[e[0]].y); ctx.lineTo(corners[e[1]].x, corners[e[1]].y); ctx.stroke(); });
        
        // Draw Particles
        bodiesRef.current.forEach(b => { 
            const p = project(b.x-boxW/2, b.y-boxH/2, b.z-boxD/2); 
            ctx.fillStyle = b.color; 
            ctx.beginPath(); ctx.arc(p.x, p.y, Math.max(1.5, 4*(p.s/20)), 0, 7); ctx.fill(); 
        });
    };
    
    // --- DYNAMIC TABLE RENDERER ---
    const renderTable = () => {
        if(displayData.length === 0) return <div className="text-slate-500 text-xs p-4 italic text-center">Initializing sensors...</div>;
        const headers = Object.keys(displayData[0]);
        return (
            <table className="data-table">
                <thead><tr>{headers.map(h => <th key={h}>{h.toUpperCase()}</th>)}</tr></thead>
                <tbody>
                    {displayData.slice().reverse().map((r, i) => (
                        <tr key={i}>
                            {headers.map(h => (
                                <td key={h} className={h==='t'?'text-amber-400 font-bold':''}>
                                    {typeof r[h] === 'number' ? r[h].toFixed(precision) : r[h]}
                                </td>
                            ))}
                        </tr>
                    ))}
                </tbody>
            </table>
        );
    };
    
    return ( 
        <div className={`flex flex-col h-[calc(100dvh-60px)] -m-4 relative ${fullScreen ? 'fixed inset-0 z-50 m-0 bg-slate-950' : ''}`}> 
            <div className={`relative transition-all duration-500 bg-slate-900 overflow-hidden shadow-xl z-20 ${fullScreen ? 'absolute inset-0 h-full' : 'h-[35%] shrink-0'}`}> 
                <SimCanvas draw={draw} initZoom={15} onInitRecorder={(ref) => canvasRef.current = ref.current} /> 
                <div className={`absolute top-4 right-4 flex items-center ${gap}`}> 
                    <button onClick={recording ? stopRecording : startRecording} className={`${btnSize} rounded-full backdrop-blur border border-white/10 ${recording ? 'bg-red-500/20 text-red-500 animate-pulse' : 'bg-slate-800/80 text-white'}`}>{recording ? <Icons.StopRec /> : <Icons.Record />}</button> 
                    <button onClick={() => init('mixing')} className={`${btnSize} rounded-full bg-slate-800/80 text-slate-400 hover:text-white backdrop-blur border border-white/10`}><Icons.Reset /></button> 
                    <button onClick={() => {setPlaying(!playing); vibrate();}} className={`${btnSize} rounded-full bg-blue-600/90 text-white shadow-lg shadow-blue-500/50 backdrop-blur`}>{playing ? <Icons.Pause /> : <Icons.Play />}</button> 
                    <button onClick={()=>setFullScreen(!fullScreen)} className={`${btnSize} rounded-full bg-slate-800/80 text-slate-400 hover:text-white backdrop-blur border border-white/10`}>{fullScreen ? <Icons.Shrink /> : <Icons.Expand />}</button> 
                </div> 
                <div className="absolute bottom-4 left-4 text-[10px] font-mono text-slate-400 flex gap-4 font-bold pointer-events-none"> 
                    <span className="text-amber-400">P: {statsRef.current.P.toFixed(3)}</span><span className="text-red-400">T: {statsRef.current.T.toFixed(precision)}</span><span className="text-blue-400">S: {statsRef.current.S.toFixed(precision)}</span> 
                </div> 
            </div> 

            {!fullScreen && ( 
                <div className="flex-1 flex flex-col glass-panel overflow-hidden border-t-0"> 
                    <div className="flex border-b border-white/10 shrink-0 bg-slate-900/50"> 
                        {['story', 'textbook', 'lab', 'table', 'graph'].map(id => (<button key={id} onClick={() => setTab(id)} className={`flex-1 py-3 text-[10px] font-bold uppercase tracking-widest transition font-display ${tab === id ? 'text-amber-400 bg-white/5 border-b-2 border-amber-500' : 'text-slate-500 hover:text-slate-300'}`}>{id}</button>))} 
                    </div> 
                    <div className="flex-1 overflow-hidden relative bg-slate-900/80"> 
                        {tab === 'story' && (
                            <div className="h-full overflow-y-auto scroller p-6 space-y-8 pb-20">
                                <div className="animate-in fade-in slide-in-from-bottom-4 duration-700">
                                    <h3 className="text-amber-500 font-bold text-xs uppercase tracking-widest mb-2 font-display">1877: THE ARROW OF TIME</h3>
                                    <h1 className="text-3xl font-bold text-white mb-4 font-display">Order to Chaos</h1>
                                    <p className="text-slate-300 text-sm leading-7">Why does a dropped egg break but never un-break? Newton's laws work backward in time just as well as forward. Yet, life flows in only one direction.</p>
                                    <div className="border-l-2 border-amber-500/30 pl-4 py-2 my-6"> 
                                        <p className="text-slate-400 text-xs italic mb-2">"Ludwig Boltzmann"</p> 
                                        <p className="text-slate-300 text-sm leading-6"> Boltzmann found the answer in the chaos of atoms. He argued that disorder is simply more probable than order. </p> 
                                    </div>
                                    <h4 className="text-white font-bold text-sm font-display mb-2">Entropy as Information</h4>
                                    <p className="text-slate-300 text-sm leading-7">Boltzmann's insight was that "heat" is just the kinetic energy of atoms. High entropy means we have very little information about where any specific atom is (disorder). Low entropy means the atoms are organized.</p>
                                </div>
                            </div>
                        )}
                        {tab === 'textbook' && (
                            <div className="h-full overflow-y-auto scroller p-4 pb-20">
                                <div className="paper-bg text-sm rounded-sm mb-4 shadow-xl">
                                    <h3 className="text-black font-bold text-xl mb-4 border-b border-black/10 pb-2">Thermodynamics</h3>
                                    <p><strong>1. Ideal Gas Law</strong></p>
                                    <div className="my-2 text-center"><Latex tex="PV = N k_B T" dark={false} /></div>
                                    <p><strong>2. Boltzmann's Entropy</strong></p>
                                    <div className="my-2 text-center"><Latex tex="S = k_B \ln \Omega" dark={false} /></div>
                                    <p><strong>3. Equipartition Theorem</strong></p>
                                    <div className="my-2 text-center"><Latex tex="U = \frac{f}{2} N k_B T" dark={false} /></div>
                                </div>
                            </div>
                        )}
                        {tab === 'lab' && ( 
                            <div className="h-full overflow-y-auto p-4 space-y-4 scroller"> 
                                <div className="flex gap-2 overflow-x-auto pb-2 no-scrollbar">{Object.entries(PRESETS).map(([k, v]) => (<button key={k} onClick={() => { setConfig({...config, force:v.force}); init(v.setup); }} className="shrink-0 px-3 py-1 rounded border border-slate-700 text-[10px] font-bold text-slate-400 hover:bg-amber-900/50 hover:text-amber-300 hover:border-amber-500 transition font-display">{v.name}</button>))}</div> 
                                <div className="glass-card p-4 space-y-3 border-l-2 border-amber-500">
                                    <div className="text-[10px] font-bold text-amber-500 uppercase tracking-wider font-display">System Settings</div>
                                    <ParamInput label="Precision" val={precision} set={setPrecision} step="1" unit="d" />
                                </div>
                                <div className="grid gap-4"> 
                                    <div className="space-y-2"><div className="text-[10px] font-bold text-orange-500 uppercase tracking-widest font-display">Process Control</div> 
                                    <div className="glass-card p-3 rounded flex flex-col gap-2"> 
                                        <div className="flex justify-between text-xs text-slate-400"><span>Heat Injection (T)</span><span className="font-mono text-orange-400">{config.heat}</span></div> 
                                        <input type="range" min="0" max="2" step="0.1" value={config.heat} onChange={e=>setConfig({...config, heat:parseFloat(e.target.value)})} className="w-full h-1 bg-orange-900/50 rounded appearance-none accent-orange-500 cursor-pointer" /> 
                                        <div className="flex justify-between text-xs text-slate-400 mt-2"><span>Volume (V)</span><span className="font-mono text-blue-400">{config.volume}</span></div> 
                                        <input type="range" min="0.3" max="1" step="0.1" value={config.volume} onChange={e=>setConfig({...config, volume:parseFloat(e.target.value)})} className="w-full h-1 bg-blue-900/50 rounded appearance-none accent-blue-500 cursor-pointer" /> 
                                    </div> 
                                    </div> <EqInput label="Interaction Potential F(r)" sub="F(r) =" val={config.force} set={v=>setConfig({...config, force:v})} color="border-emerald-500" /> 
                                </div> 
                            </div> 
                        )} 
                        {tab === 'table' && ( 
                            <div className="h-full flex flex-col"> 
                                <div className="p-2 flex justify-between border-b border-white/10"><span className="text-[10px] text-slate-500 pt-1 font-display uppercase">Thermodynamic State</span><button onClick={()=>{const doc=new jspdf.jsPDF();doc.autoTable({head:[Object.keys(displayData[0]||{})], body:displayData.map(Object.values)});doc.save('thermo_data.pdf')}} className="bg-slate-800 text-amber-400 text-[10px] px-3 py-1 rounded border border-slate-700 hover:bg-amber-900">EXPORT PDF</button></div> 
                                <div className="flex-1 overflow-auto scroller">{renderTable()}</div> 
                            </div> 
                        )} 
                        {tab === 'graph' && (<div className="h-full overflow-y-auto p-4 space-y-4 scroller"><div className="grid grid-cols-2 gap-3"><GraphCard title="PV Diagram" data={displayData} x="V" y="P" col="#fbbf24" /><GraphCard title="Entropy vs Time" data={displayData} x="t" y="S" col="#10b981" /></div></div>)} 
                    </div> 
                </div> 
            )} 
        </div> 
    );
};
// --- 4. WAVESOLVER (1D String, Sound, Light & 2D Ripple Tank) ---
const WaveSolver = () => {
    const vibrate = useHaptics();
    const toast = useToast();
    const { btnSize, gap, text } = useUIAdaptation();
    
    const PRESETS = { 
        string: { name: "String (1D)", type: 'trans', eq: "3 * sin(x - 2*t)", mode: '1d' }, 
        sound: { name: "Sound (1D)", type: 'long', eq: "3 * cos(x - 3*t)", mode: '1d' }, 
        light: { name: "Light (EM)", type: 'light', eq: "3 * sin(x - 4*t)", mode: '1d' }, 
        ripple: { name: "Ripple Tank (2D)", type: '2d', eq: "0", mode: '2d' } 
    };

    const [fullScreen, setFullScreen] = useState(false); 
    const [tab, setTab] = useState('story'); 
    const [playing, setPlaying] = useState(true);
    const [config, setConfig] = useLocalStorage('wave_cfg', PRESETS.string); 
    const [eqStr, setEqStr] = useState(PRESETS.string.eq);
    const [precision, setPrecision] = useState(3);
    
    const timeRef = useRef(0); 
    const funcRef = useRef(null); 
    const [displayData, setDisplayData] = useState([]);
    
    // 2D Wave Grid Refs
    const gridRef = useRef({ curr: [], prev: [], size: 60 });
    const canvasRef = useRef(null);
    const { recording, startRecording, stopRecording } = useCanvasRecorder(canvasRef);
    
    // Compile Equation
    useEffect(() => { 
        if(config.mode === '1d') {
            try { funcRef.current = new Function('x','t', `return ${parseEq(eqStr)}`); } catch(e) {} 
        }
    }, [eqStr, config.mode]);
    
    // Initialize 2D Grid
    const initGrid = () => {
        const size = 60; 
        const curr = []; const prev = [];
        for(let i=0; i<size; i++) { 
            curr[i] = new Float32Array(size); 
            prev[i] = new Float32Array(size); 
        }
        gridRef.current = { curr, prev, size };
        if(toast && config.mode === '2d') toast("Ripple Tank Reset");
    };

    useEffect(() => { if(config.mode === '2d') initGrid(); }, [config.mode]);

    // Physics Loop
    useEffect(() => { 
        if(!playing) return; 
        let frame; 
        const loop = () => { 
            timeRef.current += 0.05; 
            
            // 1D Logic
            if(config.mode === '1d' && funcRef.current && Math.random() > 0.8) { 
                try {
                    const y0 = funcRef.current(0, timeRef.current); 
                    setDisplayData(p => { 
                        const n = [...p, { t: timeRef.current, y: y0 }]; 
                        return n.length > 500 ? n.slice(-500) : n; 
                    }); 
                } catch(e) {}
            } 
            // 2D Logic (Wave Equation FDTD)
            else if (config.mode === '2d') {
                const { curr, prev, size } = gridRef.current;
                const damping = 0.99;
                for(let i=1; i<size-1; i++) {
                    for(let j=1; j<size-1; j++) {
                        const val = (curr[i-1][j] + curr[i+1][j] + curr[i][j-1] + curr[i][j+1]) / 2 - prev[i][j];
                        prev[i][j] = curr[i][j];
                        curr[i][j] = val * damping;
                    }
                }
                // Source oscillator in center
                curr[size/2][size/2] = Math.sin(timeRef.current * 2) * 5; 
            }
            frame = requestAnimationFrame(loop); 
        }; 
        loop(); return () => cancelAnimationFrame(frame); 
    }, [playing, config.mode]);
    
    // Interaction (Ripple Tank)
    const interact = (x, y, w, h) => {
        if(config.mode !== '2d') return;
        const { curr, size } = gridRef.current;
        const gx = Math.floor((x/w)*size); 
        const gy = Math.floor((y/h)*size);
        if(gx > 1 && gx < size-1 && gy > 1 && gy < size-1) { 
            curr[gx][gy] = 50; // Touch impact
            vibrate(5); 
        }
    };

    const draw = (ctx, project, w, h) => {
        const t = timeRef.current; 
        
        // 2D Draw
        if(config.mode === '2d') {
            const { curr, size } = gridRef.current;
            const cellW = w / size; const cellH = h / size;
            for(let i=0; i<size; i++) {
                for(let j=0; j<size; j++) {
                    const val = curr[i][j];
                    // Map amplitude to Blue intensity
                    const intensity = Math.min(255, Math.max(0, 10 + Math.abs(val) * 20));
                    ctx.fillStyle = `rgb(${intensity*0.1}, ${intensity*0.5}, ${intensity})`;
                    ctx.fillRect(i*cellW, j*cellH, cellW+0.5, cellH+0.5);
                }
            }
            return;
        }

        // 1D Draw
        const f = funcRef.current; if(!f) return;
        
        // Axis
        const start = project(-20, 0, 0); const end = project(20, 0, 0); 
        ctx.beginPath(); ctx.strokeStyle = '#475569'; ctx.moveTo(start.x, start.y); ctx.lineTo(end.x, end.y); ctx.stroke();
        
        // Calculate Points
        const points = []; 
        for(let x = -15; x <= 15; x += 0.5) { 
            points.push({x, y: f(x, t)}); 
        }

        if(config.type === 'trans') { 
            // Transverse Wave
            ctx.beginPath(); ctx.strokeStyle = '#ec4899'; ctx.lineWidth = 2; ctx.shadowBlur = 10; ctx.shadowColor = '#ec4899'; 
            points.forEach((pt, i) => { 
                const p = project(pt.x, pt.y, 0); 
                if(i===0) ctx.moveTo(p.x, p.y); else ctx.lineTo(p.x, p.y); 
                // Particle Visualization
                ctx.fillStyle = '#fbcfe8'; ctx.beginPath(); ctx.arc(p.x, p.y, 2, 0, 7); ctx.fill(); 
            }); 
            ctx.stroke(); ctx.shadowBlur = 0; 
        } 
        else if (config.type === 'long') { 
            // Longitudinal Wave
            points.forEach(pt => { 
                const dx = pt.y * 0.3; // Displacement in X
                const p = project(pt.x + dx, 0, 0); 
                const top = project(pt.x + dx, 2, 0); 
                const bot = project(pt.x + dx, -2, 0); 
                
                // Draw compression lines
                ctx.beginPath(); ctx.strokeStyle = `rgba(236, 72, 153, ${0.3 + Math.abs(pt.y)*0.2})`; 
                ctx.moveTo(top.x, top.y); ctx.lineTo(bot.x, bot.y); ctx.stroke(); 
                
                // Draw particles
                ctx.fillStyle = '#ec4899'; ctx.beginPath(); ctx.arc(p.x, p.y, Math.max(1, 4-Math.abs(dx)), 0, 7); ctx.fill(); 
            }); 
        }
        else if (config.type === 'light') { 
            // EM Wave (E and B fields orthogonal)
            ctx.beginPath(); ctx.strokeStyle = '#fbbf24'; ctx.lineWidth = 2; ctx.shadowBlur = 8; ctx.shadowColor = '#fbbf24'; 
            points.forEach((pt, i) => { 
                const p = project(pt.x, pt.y, 0); 
                if(i===0) ctx.moveTo(p.x, p.y); else ctx.lineTo(p.x, p.y); 
            }); 
            ctx.stroke(); 
            
            ctx.beginPath(); ctx.strokeStyle = '#22d3ee'; ctx.lineWidth = 2; ctx.shadowBlur = 8; ctx.shadowColor = '#22d3ee'; 
            points.forEach((pt, i) => { 
                const p = project(pt.x, 0, pt.y); // B field in Z
                if(i===0) ctx.moveTo(p.x, p.y); else ctx.lineTo(p.x, p.y); 
            }); 
            ctx.stroke(); ctx.shadowBlur = 0; 
        }
    };
    
    // --- DYNAMIC TABLE RENDERER ---
    const renderTable = () => {
        if(displayData.length === 0) return <div className="text-slate-500 italic p-4 text-center">Awaiting wave data...</div>;
        const headers = Object.keys(displayData[0]);
        return (
            <table className="data-table">
                <thead><tr>{headers.map(h => <th key={h}>{h.toUpperCase()}</th>)}</tr></thead>
                <tbody>
                    {displayData.slice().reverse().map((r, i) => (
                        <tr key={i}>
                            {headers.map(h => <td key={h} className={h==='t'?'text-pink-400 font-bold':''}>{typeof r[h]==='number'?r[h].toFixed(precision):r[h]}</td>)}
                        </tr>
                    ))}
                </tbody>
            </table>
        );
    };
    
    return ( 
        <div className={`flex flex-col h-[calc(100dvh-60px)] -m-4 relative ${fullScreen ? 'fixed inset-0 z-50 m-0 bg-slate-950' : ''}`}> 
            <div className={`relative transition-all duration-500 bg-slate-900 overflow-hidden shadow-xl z-20 ${fullScreen ? 'absolute inset-0 h-full' : 'h-[35%] shrink-0'}`}> 
                <SimCanvas draw={draw} initZoom={25} interact={interact} onInitRecorder={(ref) => canvasRef.current = ref.current} /> 
                <div className={`absolute top-4 right-4 flex items-center ${gap}`}> 
                    <button onClick={recording ? stopRecording : startRecording} className={`${btnSize} rounded-full backdrop-blur border border-white/10 ${recording ? 'bg-red-500/20 text-red-500 animate-pulse' : 'bg-slate-800/80 text-white'}`}>{recording ? <Icons.StopRec /> : <Icons.Record />}</button> 
                    <button onClick={() => { timeRef.current=0; setDisplayData([]); vibrate(); }} className={`${btnSize} rounded-full bg-slate-800/80 text-slate-400 hover:text-white backdrop-blur border border-white/10`}><Icons.Reset /></button> 
                    <button onClick={() => {setPlaying(!playing); vibrate();}} className={`${btnSize} rounded-full bg-blue-600/90 text-white shadow-lg shadow-blue-500/50 backdrop-blur`}>{playing ? <Icons.Pause /> : <Icons.Play />}</button> 
                    <button onClick={()=>setFullScreen(!fullScreen)} className={`${btnSize} rounded-full bg-slate-800/80 text-slate-400 hover:text-white backdrop-blur border border-white/10`}>{fullScreen ? <Icons.Shrink /> : <Icons.Expand />}</button> 
                </div> 
                <div className="absolute bottom-4 left-4 text-[10px] font-mono text-slate-400 pointer-events-none"> 
                    <span className="text-pink-400 font-bold">{config.name}</span> | <span className="text-slate-500">{config.mode==='2d' ? 'Touch to Ripple' : 'y(x,t)'}</span> 
                </div> 
            </div> 

            {!fullScreen && ( 
                <div className="flex-1 flex flex-col glass-panel overflow-hidden border-t-0"> 
                    <div className="flex border-b border-white/10 shrink-0 bg-slate-900/50"> 
                        {['story', 'textbook', 'sim', 'table', 'graph'].map(id => (<button key={id} onClick={() => setTab(id)} className={`flex-1 py-3 text-[10px] font-bold uppercase tracking-widest transition font-display ${tab === id ? 'text-pink-400 bg-white/5 border-b-2 border-pink-500' : 'text-slate-500 hover:text-slate-300'}`}>{id}</button>))} 
                    </div> 
                    <div className="flex-1 overflow-hidden relative"> 
                        {tab === 'story' && (
                            <div className="h-full overflow-y-auto scroller p-6 space-y-8 pb-20">
                                <div className="animate-in fade-in slide-in-from-bottom-4 duration-700">
                                    <h3 className="text-pink-500 font-bold text-xs uppercase tracking-widest mb-2 font-display">1801: THE RIPPLE EFFECT</h3>
                                    <h1 className="text-3xl font-bold text-white mb-4 font-display">Particle or Wave?</h1>
                                    <p className="text-slate-300 text-sm leading-7">Newton said light was a particle. Thomas Young disagreed. In 1801, Young fired light through two narrow slits and saw something impossible for particles: <strong>Interference</strong>.</p>
                                    <div className="glass-card p-4 rounded-xl border border-white/10 shadow-lg my-6"> 
                                        <h4 className="text-white font-bold text-sm font-display mb-2">The Wave Equation</h4> 
                                        <div className="text-pink-300 font-mono text-xs mb-2"><Latex tex="\frac{\partial^2 y}{\partial t^2} = v^2 \nabla^2 y" /></div> 
                                        <p className="text-slate-300 text-xs leading-5"> From the pluck of a guitar string to the colors of a soap bubble, the Wave Equation describes it all. </p> 
                                    </div>
                                </div>
                            </div>
                        )}
                        {tab === 'textbook' && (
                            <div className="h-full overflow-y-auto scroller p-4 pb-20">
                                <div className="paper-bg text-sm rounded-sm mb-4 shadow-xl">
                                    <h3 className="text-black font-bold text-xl mb-4 border-b border-black/10 pb-2">Wave Mechanics</h3>
                                    <p><strong>1. The Wave Equation</strong></p>
                                    <div className="my-2 text-center"><Latex tex="\frac{\partial^2 y}{\partial t^2} = v^2 \frac{\partial^2 y}{\partial x^2}" dark={false} /></div>
                                    <p><strong>2. Harmonic Solution</strong></p>
                                    <div className="my-2 text-center"><Latex tex="y(x,t) = A \sin(kx - \omega t)" dark={false} /></div>
                                    <p><strong>3. Phase Velocity</strong></p>
                                    <div className="my-2 text-center"><Latex tex="v = \lambda f" dark={false} /></div>
                                </div>
                            </div>
                        )}
                        {tab === 'sim' && ( 
                            <div className="h-full overflow-y-auto p-4 space-y-4 scroller"> 
                                <div className="flex gap-2 overflow-x-auto pb-2 no-scrollbar">{Object.entries(PRESETS).map(([k, v]) => (<button key={k} onClick={() => { setConfig(v); setEqStr(v.eq); vibrate(); }} className="shrink-0 px-3 py-1 rounded border border-slate-700 text-[10px] font-bold text-slate-400 hover:bg-pink-900/50 hover:text-pink-300 hover:border-pink-500 transition font-display">{v.name}</button>))}</div> 
                                {config.mode === '1d' ? ( <EqInput label="Wave Function y(x,t)" sub="y =" val={eqStr} set={setEqStr} color="border-pink-500" /> ) : ( <div className="p-4 text-center text-xs text-slate-400 italic glass-card rounded"> Touch/Click the simulation area to create ripples. </div> )}
                                <div className="glass-card p-4 space-y-3 border-l-2 border-pink-500">
                                    <div className="text-[10px] font-bold text-pink-500 uppercase tracking-wider font-display">Display Settings</div>
                                    <ParamInput label="Precision" val={precision} set={setPrecision} step="1" unit="d" />
                                </div>
                            </div> 
                        )} 
                        {tab === 'table' && ( 
                            <div className="h-full flex flex-col"> 
                                <div className="p-2 flex justify-between border-b border-white/10"><span className="text-[10px] text-slate-500 pt-1 font-display uppercase">Source Displacement (x=0)</span><button onClick={()=>{const doc=new jspdf.jsPDF();doc.autoTable({head:[Object.keys(displayData[0]||{})], body:displayData.map(Object.values)});doc.save('wave_data.pdf')}} className="bg-slate-800 text-pink-400 text-[10px] px-3 py-1 rounded border border-slate-700 hover:bg-pink-900">EXPORT PDF</button></div> 
                                <div className="flex-1 overflow-auto scroller">{renderTable()}</div> 
                            </div> 
                        )} 
                        {tab === 'graph' && (<div className="h-full overflow-y-auto p-4 space-y-4 scroller"><GraphCard title="Source Oscillation (y vs t at x=0)" data={displayData} x="t" y="y" col="#ec4899" /></div>)} 
                    </div> 
                </div> 
            )} 
        </div> 
    );
};

// --- 5. QUANTUM SOLVER (SchrÃ¶dinger Equation) ---
const QuantumSolver = () => {
    const vibrate = useHaptics();
    const toast = useToast();
    const { btnSize, gap, text } = useUIAdaptation();
    const PRESETS = {
        well: { name: "Infinite Well", potType: "well", height: 1000, desc: "Particle trapped in box" },
        harmonic: { name: "Harmonic Osc.", potType: "harmonic", height: 0.5, desc: "Quantum Oscillator" },
        barrier: { name: "Tunneling", potType: "barrier", height: 25, desc: "Quantum Tunneling" }
    };

    const [fullScreen, setFullScreen] = useState(false);
    const [tab, setTab] = useState('story');
    const [playing, setPlaying] = useState(true);
    const [preset, setPreset] = useState('well');
    
    const [params, setParams] = useState({ height: 1000, width: 10, mass: 1 });
    const [displayData, setDisplayData] = useState([]);
    const [precision, setPrecision] = useState(3);

    const gridRef = useRef({ re: [], im: [], V: [], size: 100 });
    const timeRef = useRef(0);
    const canvasRef = useRef(null);
    const { recording, startRecording, stopRecording } = useCanvasRecorder(canvasRef);
    
    // Init Wavefunction (Gaussian Packet)
    const init = (key) => {
        const p = PRESETS[key];
        const size = 100;
        const re = new Float32Array(size);
        const im = new Float32Array(size);
        const V = new Float32Array(size);
        
        setParams(prev => ({ ...prev, height: p.height })); 

        for(let i=0; i<size; i++) {
            const x = (i - size/2) * 0.1;
            const x0 = key === 'barrier' ? -3 : 0; // Shift start for tunneling
            const env = Math.exp(-Math.pow(x-x0, 2));
            const k = key === 'barrier' ? 5 : 0; // Momentum
            re[i] = env * Math.cos(k*x);
            im[i] = env * Math.sin(k*x);
        }
        gridRef.current = { re, im, V, size };
        timeRef.current = 0;
        updatePotential(key, p.height);
        setDisplayData([]);
        if(toast) toast(`Preset Loaded: ${p.name}`);
    };

    const updatePotential = (key, hVal) => {
        const { V, size } = gridRef.current;
        const width = params.width; 
        for(let i=0; i<size; i++) {
            const x = (i - size/2) * 0.1;
            let val = 0;
            if (key === 'harmonic') val = hVal * x * x; 
            else if (key === 'barrier') { if (Math.abs(x - 2) < width/20) val = hVal; }
            else if (key === 'well') { if (Math.abs(x) > width/2) val = hVal; }
            V[i] = val;
        }
    };

    useEffect(() => init(preset), [preset]);
    useEffect(() => updatePotential(preset, params.height), [params.height, params.width]);

    // SchrÃ¶dinger Integration
    useEffect(() => {
        if (!playing) return;
        let frame;
        const loop = () => {
            const { re, im, V, size } = gridRef.current;
            const dt = 0.005 / params.mass; 
            const dx = 0.1;
            const idx2 = 1 / (dx*dx);
            
            const nextRe = new Float32Array(size);
            const nextIm = new Float32Array(size);
            
            let probSum = 0; let centerOfMass = 0;

            // Simple Finite Difference (Real-Time approximation)
            for(let i=1; i<size-1; i++) {
                const lapRe = (re[i+1] - 2*re[i] + re[i-1]) * idx2;
                const lapIm = (im[i+1] - 2*im[i] + im[i-1]) * idx2;
                
                // H = -0.5*Laplacian + V
                const H_re = -0.5 * lapRe + V[i] * re[i];
                const H_im = -0.5 * lapIm + V[i] * im[i];
                
                // dPsi/dt = -i H Psi
                nextRe[i] = re[i] + H_im * dt;
                nextIm[i] = im[i] - H_re * dt;
                
                const prob = nextRe[i]**2 + nextIm[i]**2;
                probSum += prob; 
                centerOfMass += i * prob;
            }
            
            // Boundary Conditions (Hard Walls)
            nextRe[0]=0; nextRe[size-1]=0; nextIm[0]=0; nextIm[size-1]=0;
            
            gridRef.current.re = nextRe; 
            gridRef.current.im = nextIm;
            timeRef.current += dt;

            // Stats Logging
            if (Math.random() > 0.95) {
                setDisplayData(prev => {
                    const nu = [...prev, { 
                        t: timeRef.current, 
                        prob: probSum, 
                        com: probSum > 0 ? (centerOfMass/probSum - size/2)*0.1 : 0 
                    }];
                    return nu.slice(-100);
                });
            }
            frame = requestAnimationFrame(loop);
        };
        loop(); return () => cancelAnimationFrame(frame);
    }, [playing, params.mass]);

    const draw = (ctx, project, w, h) => {
        const { re, im, V, size } = gridRef.current;
        const scaleX = w / size;
        const centerY = h/2;
        
        // Draw Potential V(x)
        ctx.beginPath(); ctx.strokeStyle = '#334155'; ctx.lineWidth = 2;
        for(let i=0; i<size; i++) { 
            const y = centerY + 50 - Math.min(100, V[i] * 5); 
            if(i===0) ctx.moveTo(i*scaleX, y); else ctx.lineTo(i*scaleX, y); 
        }
        ctx.stroke();

        // Draw Probability Density |Psi|^2
        ctx.beginPath(); ctx.strokeStyle = '#22d3ee'; ctx.lineWidth = 3; ctx.shadowBlur = 15; ctx.shadowColor = '#22d3ee';
        for(let i=0; i<size; i++) { 
            const prob = (re[i]*re[i] + im[i]*im[i]); 
            const y = centerY + 50 - prob * 150; 
            if(i===0) ctx.moveTo(i*scaleX, y); else ctx.lineTo(i*scaleX, y); 
        }
        ctx.stroke(); ctx.shadowBlur = 0;
        
        // Draw Real Part (Phase)
        ctx.beginPath(); ctx.strokeStyle = 'rgba(236, 72, 153, 0.4)'; ctx.lineWidth = 1;
        for(let i=0; i<size; i++) { 
            const y = centerY + 50 - re[i] * 50; 
            if(i===0) ctx.moveTo(i*scaleX, y); else ctx.lineTo(i*scaleX, y); 
        }
        ctx.stroke();
    };

    const renderTable = () => {
        if(displayData.length === 0) return <div className={`text-slate-500 italic p-4 text-center ${text}`}>Calculating wavefunction...</div>;
        const headers = Object.keys(displayData[0]);
        return (
            <table className="data-table">
                <thead><tr>{headers.map(h => <th key={h}>{h.toUpperCase()}</th>)}</tr></thead>
                <tbody>
                    {displayData.slice().reverse().map((r, i) => (
                        <tr key={i}>
                            {headers.map(h => <td key={h} className={h==='t'?'text-cyan-400 font-bold':''}>{typeof r[h]==='number'?r[h].toFixed(precision):r[h]}</td>)}
                        </tr>
                    ))}
                </tbody>
            </table>
        );
    };

    return ( 
        <div className={`flex flex-col h-[calc(100dvh-60px)] -m-4 relative ${fullScreen ? 'fixed inset-0 z-50 m-0 bg-slate-950' : ''}`}> 
            <div className={`relative transition-all duration-500 bg-slate-900 overflow-hidden shadow-xl z-20 ${fullScreen ? 'absolute inset-0 h-full' : 'h-[35%] shrink-0'}`}> 
                <SimCanvas draw={draw} initZoom={1} onInitRecorder={(ref) => canvasRef.current = ref.current} /> 
                <div className={`absolute top-4 right-4 flex items-center ${gap}`}>
                    <button onClick={recording ? stopRecording : startRecording} className={`${btnSize} rounded-full backdrop-blur border border-white/10 ${recording ? 'bg-red-500/20 text-red-500 animate-pulse' : 'bg-slate-800/80 text-white'}`}>{recording ? <Icons.StopRec /> : <Icons.Record />}</button>
                    <button onClick={() => {init(preset); vibrate();}} className={`${btnSize} rounded-full bg-slate-800/80 text-slate-400 hover:text-white backdrop-blur border border-white/10`}><Icons.Reset /></button>
                    <button onClick={() => {setPlaying(!playing); vibrate();}} className={`${btnSize} rounded-full bg-blue-600/90 text-white shadow-lg shadow-blue-500/50 backdrop-blur`}>{playing ? <Icons.Pause /> : <Icons.Play />}</button>
                    <button onClick={()=>setFullScreen(!fullScreen)} className={`${btnSize} rounded-full bg-slate-800/80 text-slate-400 hover:text-white backdrop-blur border border-white/10`}>{fullScreen ? <Icons.Shrink /> : <Icons.Expand />}</button>
                </div>
                <div className="absolute bottom-4 left-4 text-[10px] font-mono text-slate-400 pointer-events-none">
                    <span className="text-cyan-400 font-bold">|Î¨|Â² Probability</span> | <span className="text-pink-400/60">Re(Î¨) Phase</span>
                </div>
            </div>
            {!fullScreen && ( 
                <div className="flex-1 flex flex-col glass-panel overflow-hidden border-t-0"> 
                    <div className="flex border-b border-white/10 shrink-0 bg-slate-900/50"> 
                        {['story', 'lab', 'table', 'textbook'].map(id => (<button key={id} onClick={() => setTab(id)} className={`flex-1 py-3 text-[10px] font-bold uppercase tracking-widest transition font-display ${tab === id ? 'text-cyan-400 bg-white/5 border-b-2 border-cyan-500' : 'text-slate-500 hover:text-slate-300'}`}>{id}</button>))} 
                    </div> 
                    <div className="flex-1 overflow-hidden relative">
                        {tab === 'story' && (
                            <div className="h-full overflow-y-auto scroller p-6 space-y-8 pb-20">
                                <div className="animate-in fade-in slide-in-from-bottom-4 duration-700">
                                    <h3 className="text-cyan-500 font-bold text-xs uppercase tracking-widest mb-2 font-display">1926: THE PROBABILITY WAVE</h3>
                                    <h1 className="text-3xl font-bold text-white mb-4 font-display">SchrÃ¶dinger's Equation</h1>
                                    <p className="text-slate-300 text-sm leading-7">In the 1920s, physicists were baffled. Electrons seemed to be in two places at once. <strong>Erwin SchrÃ¶dinger</strong> proposed a radical idea: particles are actually waves. But unlike water waves, these are waves of <em>probability</em>.</p>
                                    <div className="glass-card p-4 rounded-xl border border-white/10 shadow-lg my-6"> 
                                        <div className="text-cyan-300 font-mono text-xs mb-2 text-center"><Latex tex="i\hbar \frac{\partial \Psi}{\partial t} = \hat{H} \Psi" /></div> 
                                        <p className="text-slate-300 text-xs leading-5 text-center mt-2"> "Energy determines how the wavefunction rotates in the complex plane." </p> 
                                    </div>
                                    <h3 className="text-white font-bold text-lg mb-2 mt-6 border-b border-white/10 pb-1 font-display">Quantum Tunneling</h3>
                                    <p className="text-slate-300 text-sm leading-7">In the classical world, a ball cannot roll over a hill if it doesn't have enough energy. In the quantum world, the wavefunction can "leak" through the barrier, allowing the particle to appear on the other side. This is how the sun burns and how microchips work.</p>
                                </div>
                            </div>
                        )}
                        {tab === 'textbook' && (
                            <div className="h-full overflow-y-auto scroller p-4 pb-20">
                                <div className="paper-bg text-sm rounded-sm mb-4 shadow-xl">
                                    <h3 className="text-black font-bold text-xl mb-4 border-b border-black/10 pb-2">Quantum Mechanics</h3>
                                    <p><strong>1. Time-Dependent SchrÃ¶dinger Equation</strong></p>
                                    <div className="my-2 text-center"><Latex tex="i\hbar \frac{\partial}{\partial t} \Psi(x,t) = \left[ -\frac{\hbar^2}{2m}\frac{\partial^2}{\partial x^2} + V(x) \right] \Psi(x,t)" dark={false} /></div>
                                    
                                    <p><strong>2. The Born Rule</strong></p>
                                    <div className="my-2 text-center"><Latex tex="P(x) = |\Psi(x)|^2 = \Psi^* \Psi" dark={false} /></div>
                                    
                                    <p><strong>3. Expectation Value</strong></p>
                                    <div className="my-2 text-center"><Latex tex="\langle x \rangle = \int_{-\infty}^{\infty} \Psi^* x \Psi \, dx" dark={false} /></div>
                                </div>
                            </div>
                        )}
                        {tab === 'lab' && (
                            <div className="h-full overflow-y-auto p-4 space-y-4 scroller">
                                <div className="flex gap-2 overflow-x-auto pb-2 no-scrollbar">{Object.entries(PRESETS).map(([k, v]) => (<button key={k} onClick={() => { setPreset(k); vibrate(); }} className="shrink-0 px-3 py-1 rounded border border-slate-700 text-[10px] font-bold text-slate-400 hover:bg-cyan-900/50 hover:text-cyan-300 hover:border-cyan-500 transition font-display">{v.name}</button>))}</div>
                                <div className="glass-card p-4 space-y-3 border-l-2 border-cyan-500">
                                    <div className="text-[10px] font-bold text-cyan-500 uppercase tracking-wider font-display">Parameters</div>
                                    <ParamInput label="Potential Height (Vâ‚€)" val={params.height} set={v => setParams(p => ({...p, height: v}))} step="10" min="0" max="2000" />
                                    <ParamInput label="Potential Width/Shape" val={params.width} set={v => setParams(p => ({...p, width: v}))} step="1" min="1" max="50" />
                                    <ParamInput label="Particle Mass (m)" val={params.mass} set={v => setParams(p => ({...p, mass: v}))} step="0.1" min="0.1" max="5" />
                                </div>
                            </div>
                        )}
                        {tab === 'table' && ( 
                            <div className="h-full flex flex-col"> 
                                <div className="p-2 flex justify-between border-b border-white/10"><span className="text-[10px] text-slate-500 pt-1 font-display uppercase">Wavefunction Data</span><button onClick={()=>{const doc=new jspdf.jsPDF();doc.autoTable({head:[['Time','Prob Sum','Expectation X']],body:displayData.map(d=>[d.t.toFixed(precision),d.prob.toFixed(precision),d.com.toFixed(precision)])});doc.save('quantum_data.pdf')}} className="bg-slate-800 text-cyan-400 text-[10px] px-3 py-1 rounded border border-slate-700 hover:bg-cyan-900">EXPORT PDF</button></div> 
                                <div className="flex-1 overflow-auto scroller">{renderTable()}</div> 
                            </div> 
                        )}
                    </div>
                </div>
            )}
        </div>
    );
};

// --- 6. RAY OPTICS SOLVER (V10: IMMERSIVE LAB PORT) ---

// --- A. PHYSICS CORE ---
const solveOptics = (el, sourceX) => {
    const u_abs = Math.abs(el.x - sourceX);
    let res = { u: u_abs.toFixed(1), v: '-', m: '-', nature: '-', f: el.f };

    if (el.type === 'prism') {
        const n = el.n || 1.5; const A = 60;
        const deviation = ((n - 1) * A).toFixed(1);
        res.nature = `Dispersive (n=${n})`; res.formula = `Î´ â‰ˆ (n-1)A = ${deviation}Â°`;
        return res;
    }
    if (el.type === 'slab') {
        const n = el.n || 1.5; const t = el.h;
        res.nature = `Refractive (n=${n})`; res.formula = `d â‰ˆ t(1 - 1/n)`;
        return res;
    }
    if(['blocker', 'screen', 'beamsplitter'].includes(el.type)) {
        res.nature = el.type === 'beamsplitter' ? 'Split 50/50' : 'Absorptive';
        res.formula = el.type === 'beamsplitter' ? 'I_t = I_r = 50%' : '-';
        return res;
    }

    let v = Infinity; let m = 1;
    let f_calc = el.f;
    if (el.type === 'lens' && el.n) { f_calc = el.f * (0.5 / (el.n - 1)); }
    res.f = f_calc;

    if(el.type === 'lens') {
        if (u_abs === 0) { v = 0; }
        else { const val = (1/f_calc) - (1/u_abs); if(Math.abs(val) < 0.0001) v = Infinity; else v = 1/val; }
        res.nature = v > 0 ? 'Real' : 'Virtual'; m = v / u_abs; res.formula = "1/f = 1/v - 1/u";
    } else if (el.type === 'mirror') {
        const val = (1/el.f) - (1/u_abs);
        if(Math.abs(val) < 0.0001) v = Infinity; else v = 1/val;
        res.nature = v > 0 ? 'Real' : 'Virtual'; m = -(v / u_abs); res.formula = "1/f = 1/v + 1/u";
    }
    res.v = v === Infinity ? 'Inf' : v.toFixed(1);
    res.m = m === Infinity ? 'Inf' : Math.abs(m).toFixed(2);
    if(v === Infinity) res.nature = 'Parallel';
    return res;
};

const calculateOpticsData = (elements) => {
    const sorted = elements.filter(e => e.type !== 'source').sort((a,b) => a.x - b.x);
    const source = elements.find(e => e.type === 'source');
    if(!source) return [];
    let currentPos = source.x;
    return sorted.map(el => {
        const res = solveOptics(el, currentPos);
        if(res.v !== 'Inf' && res.v !== '-' && !isNaN(parseFloat(res.v))) currentPos = el.x + parseFloat(res.v);
        else if (['lens','mirror'].includes(el.type)) currentPos = -Infinity;
        else currentPos = el.x;
        return { id: el.id, name: el.label || el.type, ...res, f: res.f ? Math.round(res.f) : '-' };
    });
};

const getWavelengthFactor = (color) => {
    if(color === '#ef4444') return 0.95; if(color === '#22c55e') return 1.0; 
    if(color === '#3b82f6') return 1.05; if(color === '#a855f7') return 1.08; 
    if(color === '#ffffff') return [0.95, 1.0, 1.05]; return 1.0;
};

const traceRays = (elements) => {
    const sources = elements.filter(e => e.type === 'source');
    if(sources.length === 0) return { rays: [], virtualRays: [] };
    const optics = elements.filter(e => e.type !== 'source').sort((a,b) => a.x - b.x);
    let finalRays = []; let virtualRays = []; let rayQueue = [];

    sources.forEach(source => {
        const numRays = source.beam ? 9 : 15;
        for(let i=0; i<numRays; i++) {
            let y, ang;
            if(source.beam) { y = source.y + (i - (numRays-1)/2) * (source.h/numRays * 1.5); ang = 0; } 
            else { y = source.y; ang = (i - (numRays-1)/2) * 0.08; }
            rayQueue.push({ 
                path: [{x: source.x, y: y, z: 0}], angle: ang, active: true, 
                color: source.color || '#fbbf24', intensity: 1.0, direction: 1, 
                wavelengthFactor: getWavelengthFactor(source.color || '#fbbf24')
            });
        }
    });

    const MAX_STEPS = 600; let stepsProcessed = 0;
    while(rayQueue.length > 0 && stepsProcessed < MAX_STEPS) {
        let ray = rayQueue.shift(); stepsProcessed++;
        let currPos = { ...ray.path[ray.path.length-1] };
        let currAngle = ray.angle; let direction = ray.direction;
        let closestEl = null; let closestDist = Infinity;

        optics.forEach(el => {
            const dx = el.x - currPos.x;
            if(direction === 1 && dx > 0.1 && dx < closestDist) { closestDist = dx; closestEl = el; } 
            else if (direction === -1 && dx < -0.1 && Math.abs(dx) < closestDist) { closestDist = Math.abs(dx); closestEl = el; }
        });

        if(!closestEl) {
            ray.path.push({ x: currPos.x + (direction * 2000), y: currPos.y + (direction * 2000 * Math.tan(currAngle)), z:0 });
            finalRays.push(ray); continue;
        }

        const dx = closestEl.x - currPos.x; const dy = Math.tan(currAngle) * dx; const hitY = currPos.y + dy;
        if(Math.abs(hitY) > closestEl.h/2) {
                ray.path.push({ x: closestEl.x + (direction * 0.2), y: hitY + (Math.tan(currAngle)*0.2*direction), z:0 });
                rayQueue.push(ray); continue; 
        }

        ray.path.push({ x: closestEl.x, y: hitY, z: 0 });
        let elF = (closestEl.f === null || closestEl.f === undefined) ? Infinity : closestEl.f;
        if(closestEl.type === 'lens' && closestEl.n) elF = closestEl.f * (0.5 / (closestEl.n - 1));

        if (closestEl.type === 'prism') {
            const n = closestEl.n || 1.5;
            let factors = Array.isArray(ray.wavelengthFactor) ? ray.wavelengthFactor : [ray.wavelengthFactor];
            factors.forEach((factor, idx) => {
                const deviation = 0.3 * factor * ((n - 1) / 0.5) * (direction); 
                let newColor = ray.color;
                if(Array.isArray(ray.wavelengthFactor)) { if(idx===0) newColor='#ef4444'; if(idx===1) newColor='#22c55e'; if(idx===2) newColor='#3b82f6'; }
                rayQueue.push({ ...ray, path: [{x: closestEl.x, y: hitY, z:0}], angle: currAngle + (direction===1?deviation:-deviation), direction: direction, color: newColor, wavelengthFactor: factor });
            });
            if(!Array.isArray(ray.wavelengthFactor)) finalRays.push(ray);
        } else if (closestEl.type === 'slab') {
            const n = closestEl.n || 1.5; const shiftY = 5 * (n-1) * Math.sin(currAngle + Math.PI/4); 
            rayQueue.push({ ...ray, path: [{x: closestEl.x, y: hitY + shiftY, z:0}], angle: currAngle, direction: direction });
            finalRays.push(ray);
        } else if(closestEl.type === 'lens') {
            const factors = Array.isArray(ray.wavelengthFactor) ? ray.wavelengthFactor : [ray.wavelengthFactor];
            factors.forEach((factor) => {
                const f_eff = elF / (typeof factor === 'number' ? factor : 1);
                const newSlope = Math.tan(currAngle) - (hitY / f_eff);
                const newAngle = Math.atan(newSlope);
                if(elF < 0 || Math.abs(hitY) > 10) virtualRays.push({ path: [{x: closestEl.x, y: hitY}, {x: closestEl.x - 500, y: hitY - 500*newSlope}], color: ray.color, alpha: 0.1 });
                rayQueue.push({ ...ray, path: [{x: closestEl.x, y: hitY, z:0}], angle: newAngle, direction: direction, wavelengthFactor: factor });
            });
            finalRays.push(ray);
        } else if (closestEl.type === 'mirror') {
            const R = elF * 2; const normalAng = (elF === Infinity || Math.abs(elF) > 900) ? 0 : Math.asin(-hitY / R);
            let trueInAngle = (direction === 1) ? currAngle : Math.PI - currAngle;
            let trueOutAngle = 2*normalAng - trueInAngle + Math.PI;
            virtualRays.push({ path: [{x: closestEl.x, y: hitY}, {x: closestEl.x + (direction * -500), y: hitY + (-500 * Math.tan(trueOutAngle))}], color: ray.color, alpha: 0.1 });
            rayQueue.push({ ...ray, path: [{x: closestEl.x, y: hitY, z:0}], angle: trueOutAngle, direction: direction * -1 });
            finalRays.push(ray);
        } else if (closestEl.type === 'beamsplitter') {
            rayQueue.push({ ...ray, path: [{x: closestEl.x, y: hitY, z:0}], angle: currAngle, direction: direction, intensity: ray.intensity * 0.5, id: ray.id + '_t' });
            let trueInAngle = (direction === 1) ? currAngle : Math.PI - currAngle;
            let trueOutAngle = 0 - trueInAngle + Math.PI;
            rayQueue.push({ path: [{x: closestEl.x, y: hitY, z:0}], angle: trueOutAngle, direction: direction * -1, active: true, color: ray.color, intensity: ray.intensity * 0.5, id: ray.id + '_r' });
            finalRays.push(ray);
        } else if (closestEl.type === 'blocker' || closestEl.type === 'screen') { finalRays.push(ray); }
    }
    return { rays: finalRays, virtualRays: virtualRays };
};

// --- B. CANVAS COMPONENT (V11: ZOOM ENABLED) ---
const OpticsCanvas = ({ elements, setElements, rays, camera, setCamera, is2D, selectedId, setSelectedId, environment, toolMode, setToolMode, onInitRecorder }) => {
    const canvasRef = useRef(null);
    const gesture = useRef({ active: false, startX: 0, startY: 0, startDist: 0, startZoom: 1, mode: '' });
    const toolRef = useRef({ p1: null, p2: null, p3: null, isDragging: false });
    
    useEffect(() => { if(onInitRecorder && canvasRef.current) onInitRecorder(canvasRef); }, [onInitRecorder]);

    // ... (Colors and Project function remain identical to previous, included here for completeness)
    const colors = useMemo(() => {
        if(environment === 'blueprint') return { bg: '#1e3a8a', grid: 'rgba(255,255,255,0.1)', axis: 'rgba(255,255,255,0.3)', text: '#93c5fd' };
        if(environment === 'matrix') return { bg: '#001100', grid: 'rgba(0,255,0,0.1)', axis: 'rgba(0,255,0,0.3)', text: '#4ade80' };
        return { bg: '#050505', grid: '#222', axis: '#666', text: '#fbbf24' };
    }, [environment]);

    const project = useCallback((x, y, z, w, h) => {
        const radY = camera.yaw; const radP = camera.pitch;
        const x1 = x * Math.cos(radY) - z * Math.sin(radY); const z1 = x * Math.sin(radY) + z * Math.cos(radY);
        const y2 = y * Math.cos(radP) - z1 * Math.sin(radP); const z2 = y * Math.sin(radP) + z1 * Math.cos(radP);
        const fov = 1000; const scale = (fov / (fov + z2)) * camera.zoom;
        return { x: w/2 + x1 * scale + camera.panX, y: h/2 + y2 * scale + camera.panY, scale: scale, zIndex: z2 };
    }, [camera]);

    const unproject = (screenX, screenY, w, h) => {
            if(is2D) { const fov=1000; const z2=0; const scale=(fov/(fov+z2))*camera.zoom; return { x: (screenX-w/2-camera.panX)/scale, y: (screenY-h/2-camera.panY)/scale }; }
            return { x: 0, y: 0 }; 
    };

    // --- ZOOM HANDLER ---
    useEffect(() => {
        const el = canvasRef.current; if(!el) return;
        const handleWheel = (e) => {
            e.preventDefault();
            const delta = -Math.sign(e.deltaY) * 0.1;
            setCamera(prev => ({ ...prev, zoom: Math.max(0.1, Math.min(5, prev.zoom * (1 + delta))) }));
        };
        el.addEventListener('wheel', handleWheel, { passive: false });
        return () => el.removeEventListener('wheel', handleWheel);
    }, [setCamera]);

    useEffect(() => {
        const ctx = canvasRef.current.getContext('2d');
        let frame;
        const render = () => {
            if (!canvasRef.current) return;
            const { width, height } = canvasRef.current.getBoundingClientRect();
            canvasRef.current.width = width; canvasRef.current.height = height;
            ctx.fillStyle = colors.bg; ctx.fillRect(0,0,width,height);
            
            // Grid
            const range = 2000;
            for(let i=-range; i<=range; i+=100) {
                 const s = project(i, 120, -100, width, height); const e = project(i, 120, 100, width, height);
                 if(s.scale>0){ ctx.beginPath(); ctx.strokeStyle=i===0?colors.axis:colors.grid; ctx.moveTo(s.x, s.y); ctx.lineTo(e.x,e.y); ctx.stroke(); }
            }
            const sAxis = project(-range, 120, 0, width, height); const eAxis = project(range, 120, 0, width, height);
            ctx.beginPath(); ctx.strokeStyle = colors.axis; ctx.moveTo(sAxis.x, sAxis.y); ctx.lineTo(eAxis.x, eAxis.y); ctx.stroke();

            // Rays
            ctx.globalCompositeOperation = 'screen';
            rays.rays.forEach(r => {
                    for(let i=0; i<r.path.length-1; i++) {
                        const p1 = r.path[i]; const p2 = r.path[i+1];
                        const s = project(p1.x, p1.y, 0, width, height); const e = project(p2.x, p2.y, 0, width, height);
                        if (s.scale <= 0 || e.scale <= 0) continue;
                        ctx.beginPath(); ctx.strokeStyle = r.color; ctx.lineWidth = 2 * s.scale; ctx.shadowBlur = 10; ctx.shadowColor = r.color; ctx.moveTo(s.x, s.y); ctx.lineTo(e.x, e.y); ctx.stroke();
                    }
            });
            ctx.shadowBlur = 0; ctx.globalCompositeOperation = 'source-over';
            rays.virtualRays.forEach(r => {
                    const s = project(r.path[0].x, r.path[0].y, 0, width, height); const e = project(r.path[1].x, r.path[1].y, 0, width, height);
                    if(s.scale > 0 && e.scale > 0) { ctx.beginPath(); ctx.strokeStyle = r.color; ctx.lineWidth = 1 * s.scale; ctx.setLineDash([5*s.scale, 5*s.scale]); ctx.globalAlpha = r.alpha; ctx.moveTo(s.x, s.y); ctx.lineTo(e.x, e.y); ctx.stroke(); }
            });
            ctx.setLineDash([]); ctx.globalAlpha = 1.0;

            // Elements
            const sortedElements = elements.map(el => { const proj = project(el.x, el.y, 0, width, height); return { el, proj }; }).sort((a,b) => b.proj.zIndex - a.proj.zIndex);
            sortedElements.forEach(item => {
                const { el, proj } = item; if(proj.scale <= 0) return;
                const c = proj; const r = (el.h/2) * c.scale; const isSelected = el.id === selectedId;
                const base = project(el.x, 120, 0, width, height);
                if (base.scale > 0) { ctx.strokeStyle = isSelected ? colors.text : '#333'; ctx.lineWidth = isSelected ? 3 : 2; ctx.beginPath(); ctx.moveTo(c.x, c.y); ctx.lineTo(base.x, base.y); ctx.stroke(); }
                ctx.save(); ctx.translate(c.x, c.y); if(isSelected) { ctx.shadowBlur = 15; ctx.shadowColor = colors.text; }
                
                if(el.type === 'source') { 
                    ctx.fillStyle = el.color; ctx.beginPath(); ctx.arc(0,0,Math.abs(10*c.scale),0,Math.PI*2); ctx.fill(); 
                    ctx.fillStyle = '#222'; ctx.fillRect(-15*c.scale, -10*c.scale, 30*c.scale, 20*c.scale); 
                } else if (el.type === 'lens') { 
                    const squeeze = Math.abs(Math.cos(camera.yaw));
                    ctx.fillStyle = environment==='blueprint' ? 'rgba(147, 197, 253, 0.2)' : 'rgba(125, 211, 252, 0.15)'; 
                    ctx.strokeStyle = isSelected ? colors.text : '#38bdf8'; ctx.lineWidth = 1.5; ctx.beginPath(); 
                    if (el.f < 0) { ctx.moveTo(-3*c.scale, -r); ctx.lineTo(3*c.scale, -r); ctx.lineTo(0, 0); ctx.lineTo(3*c.scale, r); ctx.lineTo(-3*c.scale, r); ctx.lineTo(0,0); ctx.closePath(); ctx.fill(); ctx.stroke(); } 
                    else { ctx.ellipse(0,0, Math.abs(6*c.scale*squeeze), Math.abs(r), 0,0,Math.PI*2); ctx.fill(); ctx.stroke(); }
                } else if (el.type === 'mirror') {
                    const squeeze = Math.abs(Math.cos(camera.yaw)); ctx.fillStyle = '#444'; ctx.strokeStyle = isSelected ? colors.text : '#fff'; ctx.lineWidth = 2; ctx.beginPath(); ctx.ellipse(0,0, Math.abs(4*c.scale*squeeze), Math.abs(r), 0,0,Math.PI*2); ctx.fill(); ctx.stroke(); ctx.strokeStyle = '#666'; ctx.lineWidth = 1; for(let k=-r; k<r; k+=5*c.scale) { ctx.beginPath(); ctx.moveTo(4*c.scale*squeeze, k); ctx.lineTo(8*c.scale*squeeze, k+4); ctx.stroke(); }
                } else if (el.type === 'prism') {
                    ctx.fillStyle = 'rgba(255,255,255,0.1)'; ctx.strokeStyle = isSelected ? colors.text : '#fff'; ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(-15*c.scale, r); ctx.lineTo(15*c.scale, r); ctx.lineTo(0, -r); ctx.closePath(); ctx.fill(); ctx.stroke();
                } else if (el.type === 'slab') { ctx.fillStyle = 'rgba(200,230,255,0.2)'; ctx.strokeStyle = isSelected ? colors.text : '#88ccff'; ctx.lineWidth = 1; ctx.fillRect(-15*c.scale, -r, 30*c.scale, r*2); ctx.strokeRect(-15*c.scale, -r, 30*c.scale, r*2);
                } else if (el.type === 'beamsplitter') { const squeeze = Math.abs(Math.cos(camera.yaw)); ctx.fillStyle = 'rgba(255, 255, 255, 0.05)'; ctx.strokeStyle = isSelected ? colors.text : '#a855f7'; ctx.lineWidth = 2; ctx.beginPath(); ctx.setLineDash([4,4]); ctx.ellipse(0,0, Math.abs(4*c.scale*squeeze), Math.abs(r), 0,0,Math.PI*2); ctx.fill(); ctx.stroke(); ctx.setLineDash([]); ctx.beginPath(); ctx.moveTo(0,-r); ctx.lineTo(0,r); ctx.strokeStyle = 'rgba(255,255,255,0.3)'; ctx.stroke();
                } else if (el.type === 'blocker') { ctx.fillStyle = '#111'; ctx.strokeStyle = isSelected ? colors.text : '#666'; ctx.fillRect(-2*c.scale, -r, 4*c.scale, r*2); ctx.strokeRect(-2*c.scale, -r, 4*c.scale, r*2);
                } else if (el.type === 'screen') { ctx.fillStyle = 'rgba(255,255,255,0.1)'; ctx.strokeStyle = isSelected ? colors.text : '#888'; ctx.lineWidth = 2; const wS = 60 * c.scale; const hS = r * 2; ctx.beginPath(); ctx.moveTo(0, -hS/2); ctx.lineTo(wS*Math.sin(camera.yaw), -hS/2); ctx.lineTo(wS*Math.sin(camera.yaw), hS/2); ctx.lineTo(0, hS/2); ctx.closePath(); ctx.fill(); ctx.stroke(); }
                if(isSelected && el.f && Math.abs(el.f) !== Infinity) { ctx.restore(); const f1 = project(el.x - el.f, 0, 0, width, height); const f2 = project(el.x + el.f, 0, 0, width, height); ctx.fillStyle = colors.text; [f1, f2].forEach(p => { if(p.scale > 0) { ctx.beginPath(); ctx.arc(p.x, p.y, 3, 0, Math.PI*2); ctx.fill(); ctx.font = '10px Inter'; ctx.fillStyle = colors.text; ctx.fillText('F', p.x-3, p.y-5); } }); ctx.save(); }
                ctx.restore();
            });

            // Tools (Ruler/Protractor) - same as before
            if(toolMode !== 'none' && toolRef.current.p1) {
                const p1 = toolRef.current.p1; const p2 = toolRef.current.p2 || p1; const p3 = toolRef.current.p3;
                const s1 = project(p1.x, p1.y, 0, width, height); const s2 = project(p2.x, p2.y, 0, width, height);
                ctx.strokeStyle = '#ef4444'; ctx.lineWidth = 2; ctx.setLineDash([5,5]); ctx.beginPath(); ctx.moveTo(s1.x, s1.y); ctx.lineTo(s2.x, s2.y); ctx.stroke();
                ctx.fillStyle = '#ef4444'; ctx.beginPath(); ctx.arc(s1.x, s1.y, 4, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(s2.x, s2.y, 4, 0, Math.PI*2); ctx.fill();
                if (toolMode === 'ruler') {
                    const dist = Math.hypot(p2.x - p1.x, p2.y - p1.y).toFixed(1);
                    ctx.fillStyle = '#fff'; ctx.font = 'bold 12px Inter'; ctx.fillText(`${dist} px`, (s1.x+s2.x)/2 + 10, (s1.y+s2.y)/2 - 10);
                } else if (toolMode === 'protractor') {
                    if (p3) {
                        const s3 = project(p3.x, p3.y, 0, width, height);
                        ctx.beginPath(); ctx.moveTo(s2.x, s2.y); ctx.lineTo(s3.x, s3.y); ctx.stroke();
                        const a1 = Math.atan2(p1.y - p2.y, p1.x - p2.x); const a2 = Math.atan2(p3.y - p2.y, p3.x - p2.x);
                        let angDeg = Math.abs((a1 - a2) * 180 / Math.PI); if (angDeg > 180) angDeg = 360 - angDeg;
                        ctx.fillStyle = '#fff'; ctx.font = 'bold 14px Inter'; ctx.fillText(`${angDeg.toFixed(1)}Â°`, s2.x + 15, s2.y - 15);
                    }
                }
                ctx.setLineDash([]);
            }
            frame = requestAnimationFrame(render);
        };
        render(); return () => cancelAnimationFrame(frame);
    }, [elements, rays, camera, selectedId, project, colors, environment, toolMode]);

    const handleStart = (e) => {
        const t = e.touches ? e.touches[0] : e;
        const rect = canvasRef.current.getBoundingClientRect();
        const mouseX = t.clientX - rect.left; const mouseY = t.clientY - rect.top;
        if(toolMode !== 'none' && is2D) {
            const worldPos = unproject(mouseX, mouseY, rect.width, rect.height);
            if (toolMode === 'ruler') toolRef.current = { p1: {x: worldPos.x, y: worldPos.y}, p2: {x: worldPos.x, y: worldPos.y}, p3: null, isDragging: true };
            else if (toolMode === 'protractor') { if (!toolRef.current.p1 || toolRef.current.p3) toolRef.current = { p1: {x: worldPos.x, y: worldPos.y}, p2: {x: worldPos.x, y: worldPos.y}, p3: null, isDragging: true }; else toolRef.current.p3 = {x: worldPos.x, y: worldPos.y}; }
            return;
        }
        let closest = null; let minDist = 30;
        elements.forEach(el => { const proj = project(el.x, el.y, 0, rect.width, rect.height); if(proj.scale > 0) { const d = Math.hypot(proj.x - mouseX, proj.y - mouseY); if(d < minDist) { minDist = d; closest = el; } } });
        if(closest) { setSelectedId(closest.id); gesture.current = { active: true, mode: 'drag', dragId: closest.id, lastX: mouseX }; } 
        else {
            if (e.touches && e.touches.length === 2) { 
                const d = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY); 
                gesture.current = { active: true, mode: 'zoom', startDist: d, startZoom: camera.zoom }; 
            } 
            else gesture.current = { active: true, mode: 'rotate', startX: t.clientX, startY: t.clientY };
        }
    };

    const handleMove = (e) => {
        const t = e.touches ? e.touches[0] : e;
        const rect = canvasRef.current.getBoundingClientRect();
        const mouseX = t.clientX - rect.left; const mouseY = t.clientY - rect.top;
        if (toolMode !== 'none' && is2D && toolRef.current.isDragging) {
            const worldPos = unproject(mouseX, mouseY, rect.width, rect.height);
            toolRef.current.p2 = {x: worldPos.x, y: worldPos.y}; return;
        }
        if(!gesture.current.active) return;
        if(gesture.current.mode === 'drag') {
            const proj0 = project(0,0,0, rect.width, rect.height); const proj100 = project(100,0,0, rect.width, rect.height);
            const scaleX = (proj100.x - proj0.x) / 100; const dxWorld = (mouseX - gesture.current.lastX) / (scaleX || 1);
            setElements(prev => prev.map(el => el.id === gesture.current.dragId ? { ...el, x: el.x + dxWorld } : el)); gesture.current.lastX = mouseX;
        } else if(gesture.current.mode === 'rotate' && !is2D) {
            setCamera(prev => ({ ...prev, yaw: prev.yaw + (t.clientX - gesture.current.startX) * 0.005, pitch: Math.max(-1.5, Math.min(1.5, prev.pitch + (t.clientY - gesture.current.startY) * 0.005)) }));
            gesture.current.startX = t.clientX; gesture.current.startY = t.clientY;
        } else if (gesture.current.mode === 'rotate' && is2D) {
            setCamera(prev => ({ ...prev, panX: prev.panX + (t.clientX - gesture.current.startX) })); gesture.current.startX = t.clientX;
        } else if (gesture.current.mode === 'zoom' && e.touches && e.touches.length === 2) {
             const dist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
             const scale = dist / gesture.current.startDist;
             setCamera(prev => ({ ...prev, zoom: gesture.current.startZoom * scale }));
        }
    };

    return <div className="w-full h-full relative cursor-crosshair"><canvas ref={canvasRef} className="w-full h-full block touch-none" onMouseDown={handleStart} onMouseMove={handleMove} onMouseUp={()=>{gesture.current.active=false; toolRef.current.isDragging=false;}} onTouchStart={handleStart} onTouchMove={handleMove} onTouchEnd={()=>{gesture.current.active=false;}} onClick={(e)=>{if(toolMode==='protractor'&&toolRef.current.p2&&!toolRef.current.p3&&is2D){const r=canvasRef.current.getBoundingClientRect();const w=unproject(e.clientX-r.left,e.clientY-r.top,r.width,r.height);toolRef.current.p3={x:w.x,y:w.y};}}} /></div>;
};

// --- C. MAIN COMPONENT REPLACEMENT ---
const RayOpticsSolver = () => {
    const vibrate = useHaptics();
    const { btnSize, gap } = useUIAdaptation();
    const [fullScreen, setFullScreen] = useState(false);
    
    // Core V10 State
    const [elements, setElements] = useState([]);
    const [camera, setCamera] = useState({ yaw: 0.5, pitch: -0.2, zoom: 0.8, panX: 0, panY: 0 });
    const [is2D, setIs2D] = useState(false);
    const [environment, setEnvironment] = useState('lab');
    const [toolMode, setToolMode] = useState('none');
    const [selectedId, setSelectedId] = useState(null);
    const [tab, setTab] = useState('lab');
    const [dataLog, setDataLog] = useState([]);

    const canvasRef = useRef(null);
    const { recording, startRecording, stopRecording } = useCanvasRecorder(canvasRef);
    const rays = useMemo(() => traceRays(elements), [elements]);

    useEffect(() => setDataLog(calculateOpticsData(elements)), [elements]);
    useEffect(() => loadPreset('single_convex'), []);

    const loadPreset = (type) => {
        const baseS = { id:1, type:'source', x:-400, y:0, h:40, beam:false, color:'#fbbf24' };
        let newEls = [];
        if(type === 'single_convex') newEls = [ {...baseS, beam:true, h:80}, {id:2, type:'lens', f:100, x:0, y:0, h:120, label:'Convex Lens', n:1.5} ];
        else if(type === 'single_concave') newEls = [ {...baseS, beam:true, h:80}, {id:2, type:'lens', f:-100, x:0, y:0, h:120, label:'Concave Lens', n:1.5} ];
        else if(type === 'mirror_concave') newEls = [ {...baseS, beam:true, h:80}, {id:2, type:'mirror', f:150, x:0, y:0, h:120, label:'Concave Mirror'} ];
        else if(type === 'mirror_convex') newEls = [ {...baseS, beam:true, h:80}, {id:2, type:'mirror', f:-150, x:0, y:0, h:120, label:'Convex Mirror'} ];
        else if(type === 'prism_dispersion') newEls = [ {id:1, type:'source', x:-400, y:0, h:20, beam:false, color:'#ffffff'}, {id:2, type:'prism', x:0, y:0, h:100, label:'Glass Prism', n:1.5} ];
        else if(type === 'slab_refraction') newEls = [ {id:1, type:'source', x:-400, y:20, h:20, beam:false, color:'#3b82f6'}, {id:2, type:'slab', x:0, y:0, h:100, label:'Glass Slab', n:1.5} ];
        else if(type === 'telescope') newEls = [ {...baseS, beam:true, h:120, x:-600, color:'#a855f7'}, {id:2, type:'lens', f:200, x:-200, y:0, h:150, label:'Objective'}, {id:3, type:'lens', f:50, x:50, y:0, h:60, label:'Eyepiece'} ];
        else if(type === 'microscope') newEls = [ {...baseS, beam:true, h:20, x:-250, color:'#22c55e'}, {id:2, type:'lens', f:20, x:-200, y:0, h:40, label:'Objective'}, {id:3, type:'lens', f:80, x:0, y:0, h:120, label:'Eyepiece'} ];
        else if(type === 'interferometer') newEls = [ {id:1, type:'source', x:-500, y:0, h:20, beam:false, color:'#ef4444'}, {id:2, type:'lens', f:100, x:-300, y:0, h:100, label:'Collimator'}, {id:3, type:'beamsplitter', x:0, y:0, h:100, label:'Splitter'}, {id:4, type:'mirror', f:Infinity, x:200, y:0, h:100, label:'Mirror 1'}, {id:5, type:'mirror', f:Infinity, x:-200, y:0, h:100, label:'Mirror 2'} ];
        setElements(newEls); setSelectedId(newEls[1]?.id || newEls[0]?.id); vibrate();
    };

    const addElement = (type) => { const id = Date.now(); const newEl = { id, type, x: 100, y: 0, h: type==='source'?40:100, f: type==='lens'?100:(type==='mirror'||type==='beamsplitter'?Infinity:0), n: 1.5, label: type }; if(type === 'source') newEl.color = '#fbbf24'; setElements(p => [...p, newEl]); setSelectedId(id); };
    const removeElement = (id) => { setElements(p => p.filter(e => e.id !== id)); setSelectedId(null); };

    return (
        <div className={`flex flex-col h-[calc(100dvh-60px)] -m-4 relative ${fullScreen ? 'fixed inset-0 z-50 m-0 bg-slate-950' : ''}`}>
             <div className={`relative transition-all duration-500 bg-slate-900 overflow-hidden shadow-xl z-20 ${fullScreen ? 'absolute inset-0 h-full' : 'h-[60%] shrink-0'} theme-${environment}`}>
                <OpticsCanvas 
                    elements={elements} setElements={setElements} rays={rays} camera={camera} setCamera={setCamera}
                    is2D={is2D} selectedId={selectedId} setSelectedId={setSelectedId} environment={environment} toolMode={toolMode} setToolMode={setToolMode}
                    onInitRecorder={(ref) => canvasRef.current = ref.current}
                />
                <div className={`absolute top-4 right-4 flex flex-col items-end gap-2 pointer-events-none`}>
                    <div className={`pointer-events-auto flex items-center ${gap}`}>
                        <button onClick={recording ? stopRecording : startRecording} className={`${btnSize} rounded-full backdrop-blur border border-white/10 ${recording ? 'bg-red-500/20 text-red-500 animate-pulse' : 'bg-slate-800/80 text-white'}`}>{recording ? <i className="fas fa-stop"></i> : <i className="fas fa-circle"></i>}</button>
                        <button onClick={()=>setFullScreen(!fullScreen)} className={`${btnSize} rounded-full bg-slate-800/80 text-slate-400 hover:text-white backdrop-blur border border-white/10`}>{fullScreen ? <i className="fas fa-compress"></i> : <i className="fas fa-expand"></i>}</button>
                    </div>
                    <div className="pointer-events-auto flex gap-1 mt-2">
                         <button onClick={()=>{setToolMode(toolMode==='ruler'?'none':'ruler'); vibrate();}} disabled={!is2D} className={`p-2 rounded-full text-xs font-bold ${toolMode==='ruler'?'bg-yellow-500 text-black':'bg-black/40 text-white'} border border-white/10 ${!is2D?'opacity-50':''}`} title="Ruler"><i className="fas fa-ruler-horizontal"></i></button>
                         <button onClick={()=>{setToolMode(toolMode==='protractor'?'none':'protractor'); vibrate();}} disabled={!is2D} className={`p-2 rounded-full text-xs font-bold ${toolMode==='protractor'?'bg-yellow-500 text-black':'bg-black/40 text-white'} border border-white/10 ${!is2D?'opacity-50':''}`} title="Angle"><i className="fas fa-drafting-compass"></i></button>
                         <button onClick={()=>{if(!is2D){setCamera({yaw:0,pitch:0,zoom:0.9,panX:0,panY:0});setIs2D(true);}else{setCamera({yaw:0.5,pitch:-0.2,zoom:0.8,panX:0,panY:0});setIs2D(false);setToolMode('none');} vibrate();}} className="p-2 rounded-full text-xs font-bold text-yellow-400 border border-yellow-500/50 bg-black/40 w-10">{is2D ? "3D" : "2D"}</button>
                    </div>
                     <div className="pointer-events-auto flex gap-1 bg-black/40 p-1 rounded-full backdrop-blur-md border border-white/10">
                        {['lab', 'blueprint', 'matrix'].map(t => <button key={t} onClick={()=>setEnvironment(t)} className={`w-4 h-4 rounded-full border ${environment===t?'bg-slate-700 border-white':'border-transparent opacity-50'}`} title={t}></button>)}
                    </div>
                </div>
                
                {/* PRESETS PANEL */}
                <div className="absolute top-4 left-4 pointer-events-none w-48">
                    <div className="pointer-events-auto glass-panel p-2 rounded shadow-xl flex flex-col gap-2 max-h-[50vh] overflow-y-auto custom-scrollbar">
                        <span className="text-[9px] text-slate-500 font-bold uppercase tracking-wider">Load Setup</span>
                        <div className="grid grid-cols-2 gap-1">
                            {['single_convex','single_concave','mirror_concave','mirror_convex','prism_dispersion','slab_refraction','telescope','interferometer'].map(p => (
                                <button key={p} onClick={()=>loadPreset(p)} className="bg-white/5 hover:bg-white/10 py-1 text-[9px] rounded text-slate-300 truncate border border-white/5">{p.replace('_',' ')}</button>
                            ))}
                        </div>
                    </div>
                </div>
                
                {/* TOOLBAR */}
                <div className="absolute bottom-6 left-1/2 -translate-x-1/2 z-10 flex items-center gap-2 glass-panel p-1 rounded-full px-2 shadow-2xl">
                     {['lens','mirror','prism','slab','beamsplitter','blocker','screen','source'].map(t => (
                         <button key={t} onClick={()=>addElement(t)} className="w-8 h-8 rounded-full flex items-center justify-center text-slate-300 hover:text-white hover:bg-white/10 transition"><i className={`fas fa-${t==='source'?'lightbulb':(t==='lens'?'record-vinyl':(t==='mirror'?'moon':(t==='prism'?'caret-up':(t==='beamsplitter'?'columns':'square'))))}`}></i></button>
                     ))}
                </div>
            </div>

            {!fullScreen && (
                <div className="flex-1 flex flex-col glass-panel overflow-hidden border-t-0">
                    <div className="flex border-b border-white/10 shrink-0 bg-slate-900/50">
                        {['story', 'textbook', 'lab', 'data'].map(id => (
                            <button key={id} onClick={()=>setTab(id)} className={`flex-1 py-3 text-[10px] font-bold uppercase tracking-widest transition font-display ${tab===id?'text-yellow-400 bg-white/5 border-b-2 border-yellow-500':'text-slate-500 hover:text-slate-300'}`}>{id}</button>
                        ))}
                    </div>
                    <div className="flex-1 overflow-y-auto scroller relative">
                        {tab === 'story' && (
                            <div className="p-6 space-y-8 pb-20 animate-in fade-in duration-700">
                                <h3 className="text-yellow-500 font-bold text-xs uppercase tracking-widest mb-4 font-display">1021 AD: THE DARK ROOM</h3>
                                <h1 className="text-3xl font-bold text-white mb-4 font-display">Alhazen's Insight</h1>
                                <p className="text-slate-300 text-sm leading-7">
                                    For centuries, Greeks believed our eyes shot out laser-beams to touch objects (Emission Theory). Then came <strong>Ibn al-Haytham (Alhazen)</strong>. He sat in a dark room with a tiny hole in the wall. He saw an upside-down image of the outside world projected onto the opposite wall.                                 </p>
                                <p className="text-slate-300 text-sm leading-7 mt-4">
                                    He realized light travels in straight lines from the object to the eye. He invented the <strong>Camera Obscura</strong> and laid the foundation for all modern optics.
                                </p>
                                <div className="glass-card p-4 border border-white/20 mt-6 bg-yellow-900/10">
                                    <h4 className="text-yellow-400 font-bold font-display mb-2">Fermat's Principle (1662)</h4>
                                    <p className="text-slate-300 text-xs leading-5">
                                        Later, Pierre de Fermat refined this: "Light takes the path that requires the least time." This single sentence explains why light bends (refracts) when entering glassâ€”it's taking a "shortcut" through the slower medium.
                                    </p>
                                </div>
                            </div>
                        )}
                        {tab === 'textbook' && (
                            <div className="p-4 pb-20">
                                <div className="paper-bg text-sm rounded-sm mb-4 shadow-xl">
                                    <h3 className="text-black font-bold text-xl mb-4 border-b border-black/10 pb-2">Geometrical Optics</h3>
                                    <p><strong>1. Snell's Law (Refraction)</strong></p>
                                    <div className="my-2 text-center"><Latex tex="n_1 \sin \theta_1 = n_2 \sin \theta_2" dark={false} /></div>
                                    <p>Determines how much light bends at an interface.</p>
                                    
                                    <p className="mt-4"><strong>2. Lens Maker's Formula</strong></p>
                                    <div className="my-2 text-center"><Latex tex="\frac{1}{f} = (n-1)\left(\frac{1}{R_1} - \frac{1}{R_2}\right)" dark={false} /></div>
                                    
                                    <p className="mt-4"><strong>3. Mirror Equation</strong></p>
                                    <div className="my-2 text-center"><Latex tex="\frac{1}{f} = \frac{1}{v} + \frac{1}{u}" dark={false} /></div>
                                    <ul className="list-disc pl-5 mt-2 space-y-1 text-xs">
                                        <li><strong>u:</strong> Object distance (negative if real)</li>
                                        <li><strong>v:</strong> Image distance</li>
                                        <li><strong>f:</strong> Focal length (Positive for Convex Lens/Concave Mirror)</li>
                                    </ul>
                                </div>
                            </div>
                        )}
                        {tab === 'lab' && selectedId && (
                            <div className="p-4 space-y-4">
                                {(() => {
                                    const el = elements.find(e => e.id === selectedId);
                                    if(!el) return null;
                                    const idx = elements.findIndex(e => e.id === selectedId);
                                    const physics = solveOptics(el, elements.find(e=>e.type==='source')?.x||0);
                                    return (
                                        <div className="grid grid-cols-2 gap-4">
                                            <div className="col-span-2 flex justify-between items-center border-b border-white/10 pb-2">
                                                <span className="text-yellow-400 font-bold uppercase">{el.type} Properties</span>
                                                <button onClick={()=>removeElement(el.id)} className="text-red-400 text-xs px-2 py-1 border border-red-500/50 rounded hover:bg-red-900/20"><i className="fas fa-trash"></i> Delete</button>
                                            </div>
                                            <div className="col-span-1 space-y-2">
                                                <ParamInput label="Position X" val={el.x} set={v=>{const n=[...elements];n[idx].x=v;setElements(n)}} step="1" min="-800" max="800"/>
                                                {(el.type==='lens'||el.type==='mirror') && <ParamInput label="Focal Length (f)" val={el.f} set={v=>{const n=[...elements];n[idx].f=v;setElements(n)}} step="5" min="-300" max="300"/>}
                                                {(el.type==='lens'||el.type==='prism'||el.type==='slab') && <ParamInput label="Refractive Index (n)" val={el.n} set={v=>{const n=[...elements];n[idx].n=v;setElements(n)}} step="0.01" min="1" max="3"/>}
                                            </div>
                                            <div className="col-span-1 bg-white/5 p-3 rounded border border-white/10 flex flex-col justify-center">
                                                <div className="text-[10px] font-bold text-slate-500 mb-1">RAY TRACING DATA</div>
                                                <div className="text-xs font-mono space-y-1">
                                                    <div className="flex justify-between border-b border-white/5 pb-1"><span className="text-slate-400">Eq:</span><span className="text-white text-[9px]">{physics.formula}</span></div>
                                                    {(el.type==='lens'||el.type==='mirror') && <>
                                                        <div className="flex justify-between"><span className="text-slate-400">Obj (u)</span><span>{physics.u}</span></div>
                                                        <div className="flex justify-between"><span className="text-slate-400">Img (v)</span><span className={physics.nature==='Real'?'text-green-400':'text-purple-400'}>{physics.v}</span></div>
                                                        <div className="flex justify-between"><span className="text-slate-400">Mag (m)</span><span>{physics.m}x</span></div>
                                                    </>}
                                                </div>
                                            </div>
                                            {el.type==='source' && <div className="col-span-2 flex gap-2 justify-center border-t border-white/10 pt-2">{['#fbbf24', '#ef4444', '#22c55e', '#3b82f6', '#ffffff'].map(c=><button key={c} onClick={()=>{const n=[...elements];n[idx].color=c;setElements(n)}} className={`w-6 h-6 rounded-full border ${el.color===c?'border-white':'border-transparent'} shadow-lg`} style={{backgroundColor:c}}/>)}</div>}
                                        </div>
                                    );
                                })()}
                            </div>
                        )}
                        {tab === 'lab' && !selectedId && <div className="text-center text-slate-500 italic mt-10 p-4">Select an optical element on the board to configure its parameters.</div>}
                        {tab === 'data' && (
                            <div className="p-4">
                                <table className="data-table">
                                    <thead><tr><th>Element</th><th>u</th><th>f</th><th>v</th><th>Mag</th><th>Nature</th></tr></thead>
                                    <tbody>{dataLog.map((r,i)=><tr key={i}><td className="text-yellow-400 font-bold">{r.name}</td><td>{r.u}</td><td>{r.f}</td><td>{r.v}</td><td>{r.m}</td><td className={r.nature==='Real'?'text-green-400':(r.nature==='Virtual'?'text-purple-400':'text-slate-400')}>{r.nature}</td></tr>)}</tbody>
                                </table>
                            </div>
                        )}
                    </div>
                </div>
            )}
        </div>
    );
};
// --- 7. RELATIVITY SOLVER (Pro Edition: Vectors, Parallax & Special Relativity) ---
const RelativitySolver = () => {
    const [fullScreen, setFullScreen] = useState(false); 
    const [tab, setTab] = useState('story'); 
    
    // Simulation State
    // Modes: 'vector' (Rain-Man/Aberration), 'parallax' (Depth), 'dilation' (Time), 'contraction' (Length)
    const [simMode, setSimMode] = useState('vector'); 
    const [velocity, setVelocity] = useState(0); // 0 to 100 (representing 0 to c)
    const [rainAngle, setRainAngle] = useState(0); // Angle of falling object (for general vector addition)
    
    // Physics Refs
    const timeRef = useRef(0);
    const canvasRef = useRef(null);
    const { recording, startRecording, stopRecording } = useCanvasRecorder(canvasRef);
    const { btnSize, gap } = useUIAdaptation();
    const vibrate = useHaptics();

    // Animation Loop
    useEffect(() => { 
        let frame; 
        const loop = () => { 
            timeRef.current += 1; 
            frame = requestAnimationFrame(loop); 
        }; 
        loop(); return () => cancelAnimationFrame(frame); 
    }, []);
    
    // Helper: Draw Arrow
    const drawArrow = (ctx, x1, y1, x2, y2, color, label) => {
        const headlen = 10; 
        const dx = x2 - x1; const dy = y2 - y1;
        const angle = Math.atan2(dy, dx);
        ctx.strokeStyle = color; ctx.lineWidth = 2; ctx.fillStyle = color;
        
        ctx.beginPath(); ctx.moveTo(x1, y1); ctx.lineTo(x2, y2); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(x2, y2);
        ctx.lineTo(x2 - headlen * Math.cos(angle - Math.PI / 6), y2 - headlen * Math.sin(angle - Math.PI / 6));
        ctx.lineTo(x2 - headlen * Math.cos(angle + Math.PI / 6), y2 - headlen * Math.sin(angle + Math.PI / 6));
        ctx.lineTo(x2, y2); ctx.fill();
        
        if(label) {
            ctx.font = 'bold 12px JetBrains Mono'; ctx.fillText(label, (x1+x2)/2 + 10, (y1+y2)/2 - 10);
        }
    };

    const draw = (ctx, project, w, h) => {
        const t = timeRef.current; 
        const cx = w/2; const cy = h/2;
        const vRatio = velocity / 100; // v/c or v/v_rain
        const gamma = 1 / Math.sqrt(1 - vRatio*vRatio || 0.001); 

        // Background (Deep Space / Night)
        const grad = ctx.createLinearGradient(0, 0, 0, h);
        grad.addColorStop(0, '#020617'); grad.addColorStop(1, '#172554');
        ctx.fillStyle = grad; ctx.fillRect(0, 0, w, h);

        // ====================================================
        // MODE 1: VECTOR ANALYSIS (Rain-Man / Aberration)
        // ====================================================
        if (simMode === 'vector') {
            // Context: JEE "Rain-Man" Problem.
            // v_r = velocity of rain (downwards)
            // v_m = velocity of man/earth (horizontal)
            // v_rm = v_r - v_m (Relative velocity vector)
            
            const scale = 1.5;
            const vr_mag = 100; // Fixed magnitude for rain/light
            const vm_mag = velocity * 2; // Man's velocity
            
            // 1. World Rendering (Rain/Light falling)
            ctx.save();
            // Draw Rain/Stars
            ctx.strokeStyle = 'rgba(148, 163, 184, 0.3)'; ctx.lineWidth = 1;
            const slant = Math.atan2(vm_mag, vr_mag); // The apparent angle theta
            
            for(let i=0; i<80; i++) {
                const depth = (i%3)+1;
                const speed = 10 * depth;
                // Rain falls down, but shifts left relative to observer
                const x = (Math.random() * w + t * speed * Math.tan(slant) * -1) % w; 
                const y = (t * speed + Math.random() * h) % h;
                
                // Draw Streak
                const len = 20 * depth;
                // If velocity > 0, we tilt the rain (Apparent view)
                // Actually, in the frame of the moving observer, the rain tilts.
                ctx.beginPath();
                ctx.moveTo(x, y);
                ctx.lineTo(x - Math.sin(slant)*len, y + Math.cos(slant)*len);
                ctx.stroke();
            }

            // 2. The Vector Triangle (HUD overlay)
            // Positioned at center
            const originX = cx - 50; const originY = cy + 50;
            
            // Vector V_rain (Absolute)
            // Starts high, points down
            const vr_x = 0; const vr_y = vr_mag; 
            
            // Vector V_man (Absolute)
            // Horizontal
            const vm_x = vm_mag; const vm_y = 0;

            // DRAW VECTORS
            // V_rain (Down)
            drawArrow(ctx, originX, originY - vr_mag, originX, originY, '#fbbf24', 'v_rain (c)');
            
            // -V_man (Left) - Because v_rel = v_r + (-v_m)
            if (velocity > 0) {
                drawArrow(ctx, originX, originY - vr_mag, originX - vm_mag, originY - vr_mag, '#ef4444', '-v_man');
                
                // Resultant V_rel (The diagonal)
                ctx.setLineDash([5, 5]);
                drawArrow(ctx, originX - vm_mag, originY - vr_mag, originX, originY, '#22d3ee', 'v_rel');
                ctx.setLineDash([]);
                
                // Angle Arc
                ctx.beginPath();
                ctx.strokeStyle = '#fff'; ctx.lineWidth = 1;
                ctx.arc(originX, originY, 30, -Math.PI/2, -Math.PI/2 - slant, true);
                ctx.stroke();
                ctx.fillStyle = '#fff';
                ctx.fillText(`Î¸`, originX - 10, originY - 40);
            }

            // The Observer (Man with Umbrella / Telescope)
            const obsX = cx; const obsY = h - 50;
            
            // Telescope Body
            ctx.translate(obsX, obsY);
            ctx.rotate(slant); // Tilt telescope to match v_rel
            ctx.fillStyle = '#38bdf8'; 
            ctx.shadowBlur = 15; ctx.shadowColor = '#0ea5e9';
            ctx.fillRect(-5, -60, 10, 60); // Tube
            ctx.beginPath(); ctx.arc(0, 0, 8, 0, Math.PI*2); ctx.fill(); // Base
            ctx.shadowBlur = 0;
            ctx.rotate(-slant);
            ctx.translate(-obsX, -obsY);

            // Floor moving (to show speed)
            ctx.fillStyle = '#1e293b';
            const gridOffset = (t * vm_mag * 0.5) % 50;
            ctx.fillRect(0, h-40, w, 40);
            ctx.strokeStyle = '#334155';
            for(let g=0; g<w+50; g+=50) {
                ctx.beginPath(); ctx.moveTo(g - gridOffset, h-40); ctx.lineTo(g - gridOffset - 20, h); ctx.stroke();
            }

            // Equation HUD
            ctx.fillStyle = 'rgba(15, 23, 42, 0.8)'; ctx.fillRect(10, 10, 160, 70);
            ctx.strokeStyle = '#22d3ee'; ctx.strokeRect(10, 10, 160, 70);
            ctx.fillStyle = '#fff'; ctx.font = '12px monospace';
            ctx.fillText(`v_man = ${vm_mag.toFixed(0)}`, 20, 30);
            ctx.fillText(`v_rain = ${vr_mag}`, 20, 45);
            ctx.fillStyle = '#fbbf24';
            ctx.fillText(`tan(Î¸) = v_m / v_r`, 20, 60);
            ctx.fillText(`Î¸ = ${(slant * 180/Math.PI).toFixed(1)}Â°`, 20, 75);
            ctx.restore();
        }

        // ====================================================
        // MODE 2: IMMERSIVE PARALLAX
        // ====================================================
        else if (simMode === 'parallax') {
            const speedFactor = velocity * 0.2;
            
            // Layer 1: Distant Stars (Static/Very Slow)
            ctx.fillStyle = '#fff';
            for(let i=0; i<100; i++) {
                const x = (i*137 + t * speedFactor * 0.01) % w;
                const y = (i*63) % (h/2); // Top half only
                const size = Math.random() * 1.5;
                ctx.globalAlpha = Math.random() * 0.5 + 0.5;
                ctx.beginPath(); ctx.arc(x, y, size, 0, 7); ctx.fill();
            }
            ctx.globalAlpha = 1.0;

            // Layer 2: Mountains (Slow)
            ctx.fillStyle = '#0f172a'; // Dark silhouette
            ctx.beginPath();
            ctx.moveTo(0, h);
            for(let i=0; i<=w; i+=10) {
                const noise = Math.sin(i * 0.01) * 20 + Math.cos(i * 0.03) * 30;
                // Move mountains left
                const mx = (i - t * speedFactor * 0.1) % w;
                const my = h/2 + 50 - noise;
                // Handle wrap-around drawing simply by drawing twice width or modulo logic
                // Simple viz approximation:
                ctx.lineTo(i, h/2 + 50 - Math.sin((i + t*speedFactor*0.1)*0.01)*50);
            }
            ctx.lineTo(w, h); ctx.lineTo(0, h); ctx.fill();

            // Layer 3: Trees/Objects (Medium)
            ctx.fillStyle = '#064e3b';
            for(let i=0; i<15; i++) {
                const rawX = (i * 100 - t * speedFactor * 1.5);
                const x = (rawX % (w + 50));
                const finalX = x < -50 ? w + x : x;
                
                // Draw Tree
                const scale = 0.8;
                ctx.fillRect(finalX, h-100, 10*scale, 60*scale); // Trunk
                ctx.beginPath(); ctx.arc(finalX+5*scale, h-100, 25*scale, 0, Math.PI*2); ctx.fill();
            }

            // Layer 4: Foreground/Tracks (Fast)
            const trackW = 40;
            const trackOffset = (t * speedFactor * 5) % trackW;
            ctx.fillStyle = '#334155'; ctx.fillRect(0, h-20, w, 20);
            ctx.fillStyle = '#1e293b';
            for(let i=-trackW; i<w; i+=trackW) {
                ctx.fillRect(i - trackOffset, h-20, 10, 20);
            }

            // HUD
            ctx.fillStyle = '#fff'; ctx.font = 'bold 16px Rajdhani';
            ctx.shadowBlur = 4; ctx.shadowColor = '#000';
            ctx.fillText("PARALLAX EFFECT", 20, 40);
            ctx.font = '12px monospace';
            ctx.fillText("Near objects shift faster than far objects.", 20, 60);
            ctx.fillText(`v_observer = ${speedFactor.toFixed(1)}`, 20, 75);
            ctx.shadowBlur = 0;
        }

        // ====================================================
        // MODE 3: TIME DILATION (The Light Clock)
        // ====================================================
        else if (simMode === 'dilation') {
            const shipW = 160; const shipH = 80;
            
            // Star Streak Effect (Background)
            ctx.strokeStyle = 'rgba(255,255,255,0.1)'; ctx.lineWidth = 1;
            for(let i=0; i<30; i++) {
                const sx = (Math.random()*w - t * velocity * 0.5) % w;
                const sy = Math.random()*h;
                const len = velocity * 0.5;
                ctx.beginPath(); ctx.moveTo(sx, sy); ctx.lineTo(sx - len, sy); ctx.stroke();
            }

            // Draw Mirrors
            const topY = cy - 60; const botY = cy + 60;
            ctx.fillStyle = '#475569';
            ctx.fillRect(cx - 40, topY, 80, 6);
            ctx.fillRect(cx - 40, botY, 80, 6);
            
            // Draw Photon Path
            // Total distance D = c * t (vertical)
            // Moving distance D' = sqrt( (vt)^2 + (ct)^2 )
            const dist = 120; // L0
            const c_viz = 4; // visual speed of light
            
            // The photon bounces up and down.
            // Horizontal position moves with velocity.
            // We visualize the "Trailing Path" to show the sawtooth.
            
            const period = (2 * dist) / c_viz; // Time for one up-down
            const dilatedPeriod = period * gamma;
            
            const phase = (t % dilatedPeriod) / dilatedPeriod;
            
            // Calculate Y
            let py = 0;
            if (phase < 0.5) py = botY - (phase * 2) * dist; // Up
            else py = topY + ((phase - 0.5) * 2) * dist; // Down
            
            // Calculate X (Photon stays with ship center in Ship Frame, but we draw trails)
            const px = cx; 
            
            // Draw Photon
            ctx.shadowBlur = 15; ctx.shadowColor = '#facc15'; 
            ctx.fillStyle = '#fff';
            ctx.beginPath(); ctx.arc(px, py, 5, 0, 7); ctx.fill();
            ctx.shadowBlur = 0;

            // Draw Sawtooth Trail
            ctx.beginPath(); ctx.strokeStyle = 'rgba(250, 204, 21, 0.5)'; ctx.lineWidth = 2;
            ctx.moveTo(px, py);
            
            // Trace back in time
            for(let dt=0; dt<200; dt+=2) {
                const histT = t - dt; 
                if(histT < 0) break;
                
                const hPhase = (histT % dilatedPeriod) / dilatedPeriod;
                let hy = 0;
                if (hPhase < 0.5) hy = botY - (hPhase * 2) * dist;
                else hy = topY + ((hPhase - 0.5) * 2) * dist;
                
                // Key: Move x backwards based on ship velocity
                const hx = px - (dt * vRatio * c_viz); 
                
                ctx.lineTo(hx, hy);
            }
            ctx.stroke();

            // Info HUD
            ctx.fillStyle = '#fff'; ctx.textAlign = 'left';
            ctx.font = 'bold 12px Rajdhani';
            ctx.fillText(`LORENTZ FACTOR (Î³): ${gamma.toFixed(3)}`, 20, h-40);
            ctx.fillText(`Proper Time: 1.00s`, 20, h-25);
            ctx.fillText(`Observed Time: ${gamma.toFixed(2)}s`, 20, h-10);
        }

        // ====================================================
        // MODE 4: LENGTH CONTRACTION
        // ====================================================
        else if (simMode === 'contraction') {
            // Space Grid
            ctx.strokeStyle = '#1e293b'; ctx.lineWidth = 1;
            const gridSpacing = 50;
            const shift = (t * velocity * 0.1) % gridSpacing;
            
            ctx.beginPath();
            // Vertical lines moving left
            for(let x=0; x<=w; x+=gridSpacing) {
                const gx = x - shift;
                ctx.moveTo(gx, 0); ctx.lineTo(gx, h);
            }
            ctx.stroke();
            
            // The Rocket
            const L0 = 200; // Proper length
            const L = L0 / gamma; // Contracted length
            
            ctx.translate(cx, cy);
            
            // Glow Engine
            const flicker = Math.random() * 0.2 + 0.8;
            ctx.shadowBlur = 20 * flicker; ctx.shadowColor = '#3b82f6';
            
            // Hull
            ctx.fillStyle = '#e2e8f0';
            ctx.beginPath();
            ctx.moveTo(-L/2, -20);
            ctx.lineTo(L/2, -20);
            ctx.lineTo(L/2 + 30, 0); // Nose
            ctx.lineTo(L/2, 20);
            ctx.lineTo(-L/2, 20);
            ctx.closePath();
            ctx.fill();
            
            // Detail Lines
            ctx.strokeStyle = '#94a3b8'; ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(-L/2 + 10, -20); ctx.lineTo(-L/2 + 10, 20);
            ctx.moveTo(0, -20); ctx.lineTo(0, 20);
            ctx.stroke();
            
            // Engine Flames
            ctx.fillStyle = '#f59e0b';
            ctx.beginPath();
            ctx.moveTo(-L/2, -10);
            ctx.lineTo(-L/2 - 40 * flicker, 0);
            ctx.lineTo(-L/2, 10);
            ctx.fill();
            
            ctx.shadowBlur = 0;
            ctx.translate(-cx, -cy);
            
            // Measurement Lines
            ctx.strokeStyle = '#fff'; ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(cx - L/2, cy + 40); ctx.lineTo(cx + L/2, cy + 40); // Horizontal
            ctx.moveTo(cx - L/2, cy + 35); ctx.lineTo(cx - L/2, cy + 45); // Cap L
            ctx.moveTo(cx + L/2, cy + 35); ctx.lineTo(cx + L/2, cy + 45); // Cap R
            ctx.stroke();
            
            ctx.fillStyle = '#fff'; ctx.textAlign = 'center'; ctx.font = '12px monospace';
            ctx.fillText(`L = ${(L/L0 * 100).toFixed(0)}m`, cx, cy + 55);
            
            ctx.textAlign = 'left';
            ctx.fillText(`Rest Length Lâ‚€: 100m`, 20, h-25);
            ctx.fillText(`Velocity: ${(vRatio*100).toFixed(0)}% c`, 20, h-10);
        }
    };

    return ( 
        <div className={`flex flex-col h-[calc(100dvh-60px)] -m-4 relative ${fullScreen ? 'fixed inset-0 z-50 m-0 bg-slate-950' : ''}`}> 
            <div className={`relative transition-all duration-500 bg-slate-900 overflow-hidden shadow-xl z-20 ${fullScreen ? 'absolute inset-0 h-full' : 'h-[55%] shrink-0'}`}> 
                <SimCanvas draw={draw} initZoom={1} onInitRecorder={(ref) => canvasRef.current = ref.current} /> 
                
                {/* HUD Controls */}
                <div className={`absolute top-4 right-4 flex items-center ${gap}`}> 
                    <button onClick={recording ? stopRecording : startRecording} className={`${btnSize} rounded-full backdrop-blur border border-white/10 ${recording ? 'bg-red-500/20 text-red-500 animate-pulse' : 'bg-slate-800/80 text-white'}`}>{recording ? <Icons.StopRec /> : <Icons.Record />}</button>
                    <button onClick={()=>setFullScreen(!fullScreen)} className={`${btnSize} rounded-full bg-slate-800/80 text-slate-400 hover:text-white backdrop-blur border border-white/10`}>{fullScreen ? <Icons.Shrink /> : <Icons.Expand />}</button> 
                </div> 

                {/* Simulation Mode Switcher */}
                <div className="absolute bottom-2 left-2 right-2 flex gap-2 overflow-x-auto no-scrollbar pb-2">
                    {[
                        {id: 'vector', label: 'Vectors (Rain-Man)', icon: 'ðŸ“'},
                        {id: 'parallax', label: 'Immersive Parallax', icon: 'â›°ï¸'},
                        {id: 'dilation', label: 'Time Dilation', icon: 'â³'},
                        {id: 'contraction', label: 'Length Contr.', icon: 'ðŸ“'}
                    ].map(m => (
                        <button 
                            key={m.id} 
                            onClick={() => { setSimMode(m.id); vibrate(); }}
                            className={`flex-1 min-w-[100px] py-2 rounded-lg text-[9px] font-bold uppercase tracking-wider backdrop-blur transition border ${simMode === m.id ? 'bg-cyan-500/30 border-cyan-500 text-white shadow-[0_0_10px_rgba(6,182,212,0.3)]' : 'bg-slate-900/60 border-white/10 text-slate-400 hover:bg-slate-800'}`}
                        >
                            <div className="text-xl mb-1">{m.icon}</div>{m.label}
                        </button>
                    ))}
                </div>
            </div> 

            {!fullScreen && ( 
                <div className="flex-1 flex flex-col glass-panel overflow-hidden border-t-0"> 
                    <div className="flex border-b border-white/10 shrink-0 bg-slate-900/50"> 
                        {['story', 'textbook', 'lab'].map(id => (<button key={id} onClick={() => setTab(id)} className={`flex-1 py-3 text-[10px] font-bold uppercase tracking-widest transition font-display ${tab === id ? 'text-cyan-400 bg-white/5 border-b-2 border-cyan-500' : 'text-slate-500 hover:text-slate-300'}`}>{id}</button>))}
                    </div>
                    <div className="flex-1 overflow-y-auto scroller relative"> 
                        {tab === 'story' && ( 
                            <div className="p-6 space-y-8 pb-20">
                                <div className="animate-in fade-in slide-in-from-bottom-4 duration-700"> 
                                    {/* HINDI STORY RETAINED EXACTLY */}
                                    <h3 className="text-cyan-500 font-bold text-xs uppercase tracking-widest mb-4 font-display">1725: THE RAIN OF LIGHT</h3>
                                    <div className="hindi-text text-slate-200 space-y-6">
                                        <p>
                                            à¤¯à¤¹ à¤•à¤¥à¤¾ à¤¡à¥à¤°à¥ˆà¤—à¤¨ à¤•à¥‡ à¤¸à¤¿à¤° à¤ªà¤° à¤¸à¥à¤¥à¤¿à¤¤ à¤à¤• à¤¤à¤¾à¤°à¥‡, <span className="hindi-highlight">'à¤—à¤¾à¤®à¤¾ à¤¡à¥à¤°à¥ˆà¤•à¥‹à¤¨à¤¿à¤¸'</span> à¤•à¥€ à¤¹à¥ˆ, à¤”à¤° à¤‰à¤¸à¤¸à¥‡ à¤­à¥€ à¤…à¤§à¤¿à¤• à¤¯à¤¹ à¤•à¤¥à¤¾ à¤®à¤¨à¥à¤·à¥à¤¯ à¤•à¥€ à¤‰à¤¸ à¤¦à¥ƒà¤·à¥à¤Ÿà¤¿ à¤•à¥€ à¤¹à¥ˆ à¤œà¥‹ à¤¸à¤¤à¥à¤¯ à¤•à¥‹ à¤–à¥‹à¤œà¤¨à¤¾ à¤šà¤¾à¤¹à¤¤à¥€ à¤¹à¥ˆà¥¤
                                        </p>
                                        <p>
                                            à¤µà¤°à¥à¤· 1669 à¤®à¥‡à¤‚ <span className="text-cyan-400 font-bold">à¤°à¥‰à¤¬à¤°à¥à¤Ÿ à¤¹à¥à¤•</span> à¤¨à¥‡ à¤…à¤ªà¤¨à¥€ à¤¦à¥‚à¤°à¤¬à¥€à¤¨ à¤‡à¤¸ à¤¤à¤¾à¤°à¥‡ à¤ªà¤° à¤¸à¤¾à¤§à¥€à¥¤ à¤µà¤¹ à¤•à¥‹à¤ªà¤°à¤¨à¤¿à¤•à¤¸ à¤•à¥‡ à¤¸à¤¿à¤¦à¥à¤§à¤¾à¤‚à¤¤â€”à¤•à¤¿ à¤ªà¥ƒà¤¥à¥à¤µà¥€ à¤¸à¥‚à¤°à¥à¤¯ à¤•à¤¾ à¤šà¤•à¥à¤•à¤° à¤²à¤—à¤¾à¤¤à¥€ à¤¹à¥ˆâ€”à¤•à¤¾ à¤ªà¥à¤°à¤®à¤¾à¤£ à¤–à¥‹à¤œ à¤°à¤¹à¤¾ à¤¥à¤¾à¥¤ à¤‰à¤¸à¥‡ à¤¤à¤¾à¤°à¥‡ à¤•à¥€ à¤¸à¥à¤¥à¤¿à¤¤à¤¿ à¤®à¥‡à¤‚ à¤à¤• à¤¬à¤¡à¤¼à¤¾ à¤¬à¤¦à¤²à¤¾à¤µ à¤¦à¤¿à¤–à¤¾à¥¤ à¤¹à¥à¤• à¤¨à¥‡ à¤‰à¤¸à¥‡ <span className="hindi-highlight">'à¤ªà¥…à¤°à¤²à¥…à¤•à¥à¤¸' (Parallax/à¤¦à¥ƒà¤·à¥à¤Ÿà¤¿-à¤­à¥‡à¤¦)</span> à¤®à¤¾à¤¨ à¤²à¤¿à¤¯à¤¾à¥¤
                                        </p>
                                        <p>
                                            à¤ªà¥…à¤°à¤²à¥…à¤•à¥à¤¸ à¤¦à¥‚à¤°à¥€ à¤•à¤¾ à¤–à¥‡à¤² à¤¹à¥ˆà¥¤ à¤œà¥ˆà¤¸à¥‡ à¤Ÿà¥à¤°à¥‡à¤¨ à¤®à¥‡à¤‚ à¤šà¤²à¤¤à¥‡ à¤¹à¥à¤ à¤ªà¤¾à¤¸ à¤•à¥‡ à¤ªà¥‡à¤¡à¤¼ à¤¤à¥‡à¤œà¤¼à¥€ à¤¸à¥‡ à¤ªà¥€à¤›à¥‡ à¤­à¤¾à¤—à¤¤à¥‡ à¤¦à¤¿à¤–à¤¤à¥‡ à¤¹à¥ˆà¤‚, à¤²à¥‡à¤•à¤¿à¤¨ à¤¦à¥‚à¤° à¤•à¤¾ à¤ªà¤¹à¤¾à¤¡à¤¼ à¤¸à¥à¤¥à¤¿à¤° à¤¯à¤¾ à¤¬à¤¹à¥à¤¤ à¤§à¥€à¤®à¤¾ à¤²à¤—à¤¤à¤¾ à¤¹à¥ˆà¥¤ à¤µà¥ˆà¤¸à¥‡ à¤¹à¥€ à¤ªà¥ƒà¤¥à¥à¤µà¥€ à¤•à¥‡ à¤˜à¥‚à¤®à¤¨à¥‡ à¤ªà¤° à¤ªà¤¾à¤¸ à¤•à¥‡ à¤¤à¤¾à¤°à¥‡ à¤•à¥€ à¤œà¤—à¤¹ à¤¬à¤¦à¤²à¤¨à¥€ à¤šà¤¾à¤¹à¤¿à¤à¥¤
                                        </p>
                                        <p>
                                            à¤œà¤¬ à¤¤à¥à¤® à¤¯à¤¾à¤¤à¥à¤°à¤¾ à¤®à¥‡à¤‚ à¤¹à¥‹, à¤¤à¥‹ à¤•à¥à¤¯à¤¾ à¤•à¥‡à¤µà¤² à¤¬à¤¾à¤¹à¤° à¤•à¤¾ à¤¦à¥ƒà¤¶à¥à¤¯ à¤¬à¤¦à¤²à¤¤à¤¾ à¤¹à¥ˆ? à¤¨à¤¹à¥€à¤‚, à¤¤à¥à¤®à¥à¤¹à¤¾à¤°à¤¾ à¤ªà¥‚à¤°à¤¾ à¤…à¤¸à¥à¤¤à¤¿à¤¤à¥à¤µ à¤à¤• à¤¸à¤¾à¤ªà¥‡à¤•à¥à¤·à¤¤à¤¾ à¤®à¥‡à¤‚ à¤¹à¥‹à¤¤à¤¾ à¤¹à¥ˆà¥¤ à¤œà¥‹ à¤¸à¥à¤Ÿà¥‡à¤¶à¤¨ à¤…à¤­à¥€ à¤­à¤µà¤¿à¤·à¥à¤¯ à¤®à¥‡à¤‚ à¤¥à¤¾, à¤µà¤¹ à¤µà¤°à¥à¤¤à¤®à¤¾à¤¨ à¤¬à¤¨à¤¤à¤¾ à¤¹à¥ˆ à¤”à¤° à¤ªà¤² à¤­à¤° à¤®à¥‡à¤‚ à¤…à¤¤à¥€à¤¤ à¤¹à¥‹ à¤œà¤¾à¤¤à¤¾ à¤¹à¥ˆà¥¤ à¤ªà¤¾à¤¸ à¤•à¥€ à¤à¥‹à¤ªà¤¡à¤¼à¥€ à¤à¤• à¤à¤Ÿà¤•à¥‡ à¤®à¥‡à¤‚ à¤“à¤à¤² à¤¹à¥‹ à¤œà¤¾à¤¤à¥€ à¤¹à¥ˆ, à¤¦à¥‚à¤° à¤•à¤¾ à¤ªà¤¹à¤¾à¤¡à¤¼ à¤˜à¤‚à¤Ÿà¥‹à¤‚ à¤¤à¤• à¤¸à¤¾à¤¥ à¤šà¤²à¤¤à¤¾ à¤¹à¥ˆà¥¤
                                        </p>
                                        <p>
                                            à¤¹à¤® à¤¸à¤¬ à¤…à¤ªà¤¨à¥‡-à¤…à¤ªà¤¨à¥‡ 'à¤ªà¥…à¤°à¤²à¥…à¤•à¥à¤¸' à¤¸à¥‡ à¤¦à¥à¤¨à¤¿à¤¯à¤¾ à¤•à¥‹ à¤¦à¥‡à¤– à¤°à¤¹à¥‡ à¤¹à¥ˆà¤‚ à¤”à¤° à¤¸à¥‹à¤š à¤°à¤¹à¥‡ à¤¹à¥ˆà¤‚ à¤•à¤¿ à¤¹à¤® à¤¸à¤¤à¥à¤¯ à¤¦à¥‡à¤– à¤°à¤¹à¥‡ à¤¹à¥ˆà¤‚à¥¤ à¤¹à¤® à¤¸à¤¤à¥à¤¯ à¤¨à¤¹à¥€à¤‚, à¤•à¥‡à¤µà¤² à¤à¤• à¤¸à¤¾à¤ªà¥‡à¤•à¥à¤· à¤•à¥‹à¤£ à¤¦à¥‡à¤– à¤°à¤¹à¥‡ à¤¹à¥ˆà¤‚à¥¤
                                        </p>
                                        <p>
                                            à¤ªà¥ƒà¤¥à¥à¤µà¥€ à¤…à¤ªà¤¨à¥€ à¤•à¤•à¥à¤·à¤¾ à¤®à¥‡à¤‚ à¤œà¤¬ à¤à¤• à¤›à¥‹à¤° à¤¸à¥‡ à¤¦à¥‚à¤¸à¤°à¥‡ à¤›à¥‹à¤° (à¤›à¤¹ à¤®à¤¹à¥€à¤¨à¥‡ à¤•à¤¾ à¤…à¤‚à¤¤à¤°) à¤ªà¤° à¤œà¤¾à¤¤à¥€ à¤¹à¥ˆ, à¤¤à¥‹ à¤ªà¤¾à¤¸ à¤•à¥‡ à¤¤à¤¾à¤°à¥‡ à¤•à¥€ à¤ªà¥ƒà¤·à¥à¤ à¤­à¥‚à¤®à¤¿ à¤¬à¤¦à¤²à¤¨à¥€ à¤šà¤¾à¤¹à¤¿à¤à¥¤ à¤ªà¥ƒà¤¥à¥à¤µà¥€ à¤­à¥€ à¤¤à¥‹ à¤¸à¥‚à¤°à¤œ à¤•à¥‡ à¤šà¤¾à¤°à¥‹à¤‚ à¤“à¤° à¤à¤• à¤¯à¤¾à¤¤à¥à¤°à¤¾ à¤ªà¤° à¤¹à¥ˆà¥¤ à¤‡à¤¸ à¤¯à¤¾à¤¤à¥à¤°à¤¾ à¤®à¥‡à¤‚ à¤œà¤¬ à¤µà¤¹ à¤à¤• à¤“à¤° à¤¹à¥‹à¤¤à¥€ à¤¹à¥ˆ, à¤¤à¥‹ à¤ªà¤¾à¤¸ à¤•à¥‡ à¤¤à¤¾à¤°à¥‡ à¤•à¥€ à¤¸à¥à¤¥à¤¿à¤¤à¤¿ à¤•à¤¹à¥€à¤‚ à¤”à¤° à¤¦à¤¿à¤–à¤¤à¥€ à¤¹à¥ˆ; à¤”à¤° à¤›à¤¹ à¤®à¤¹à¥€à¤¨à¥‡ à¤¬à¤¾à¤¦ à¤œà¤¬ à¤¦à¥‚à¤¸à¤°à¥€ à¤“à¤° à¤ªà¤¹à¥à¤à¤šà¤¤à¥€ à¤¹à¥ˆ, à¤¤à¥‹ à¤¤à¤¾à¤°à¥‡ à¤•à¥€ à¤¸à¥à¤¥à¤¿à¤¤à¤¿ à¤¥à¥‹à¤¡à¤¼à¥€ à¤¬à¤¦à¤²à¥€ à¤¹à¥à¤ˆ à¤¦à¤¿à¤–à¤¤à¥€ à¤¹à¥ˆà¥¤ à¤¯à¤¹ à¤¬à¤¦à¤²à¤¾à¤µ à¤¹à¥€ à¤ªà¥…à¤°à¤²à¥…à¤•à¥à¤¸ à¤¹à¥ˆà¥¤ à¤”à¤° à¤¯à¤¹ à¤¤à¤¾à¤°à¥‡ à¤•à¥€ à¤¦à¥‚à¤°à¥€ à¤ªà¤° à¤¨à¤¿à¤°à¥à¤­à¤° à¤•à¤°à¤¤à¤¾ à¤¹à¥ˆ - à¤¤à¤¾à¤°à¤¾ à¤œà¤¿à¤¤à¤¨à¤¾ à¤ªà¤¾à¤¸, à¤¬à¤¦à¤²à¤¾à¤µ à¤‰à¤¤à¤¨à¤¾ à¤œà¥à¤¯à¤¾à¤¦à¤¾à¥¤
                                        </p>
                                        <p className="border-l-2 border-red-500 pl-3 italic text-slate-400">
                                            à¤¹à¥à¤• à¤¨à¥‡ à¤œà¥‹ à¤¦à¥‡à¤–à¤¾ à¤µà¤¹ à¤ªà¥…à¤°à¤²à¥…à¤•à¥à¤¸ à¤¨à¤¹à¥€à¤‚ à¤¥à¤¾, à¤²à¥‡à¤•à¤¿à¤¨ à¤‰à¤¨à¥à¤¹à¥‹à¤‚à¤¨à¥‡ à¤‡à¤¸à¥‡ à¤…à¤ªà¤¨à¥‡ à¤¸à¤¿à¤¦à¥à¤§à¤¾à¤‚à¤¤ à¤•à¥€ à¤ªà¥à¤·à¥à¤Ÿà¤¿ à¤®à¤¾à¤¨ à¤²à¤¿à¤¯à¤¾à¥¤
                                        </p>
                                        <p>
                                            à¤•à¤°à¥€à¤¬ à¤¸à¤¾à¤  à¤¸à¤¾à¤² à¤¬à¤¾à¤¦, 1725 à¤®à¥‡à¤‚, à¤à¤• à¤”à¤° à¤–à¥‹à¤œà¥€ à¤†à¤¯à¤¾ - <span className="text-cyan-400 font-bold">à¤¬à¥à¤°à¥ˆà¤¡à¤²à¥€</span>à¥¤ à¤‰à¤¸à¤¨à¥‡ à¤­à¥€ à¤‰à¤¸à¥€ à¤¤à¤¾à¤°à¥‡ à¤•à¥‹ à¤¦à¥‡à¤–à¤¾à¥¤ à¤‰à¤¸à¤¨à¥‡ à¤­à¥€ à¤¤à¤¾à¤°à¥‡ à¤•à¥€ à¤¸à¥à¤¥à¤¿à¤¤à¤¿ à¤®à¥‡à¤‚ à¤¬à¤¦à¤²à¤¾à¤µ à¤¦à¥‡à¤–à¤¾, à¤²à¤—à¤­à¤— à¤‰à¤¤à¤¨à¤¾ à¤¹à¥€à¥¤ à¤ªà¤° à¤µà¤¹ à¤¹à¥à¤• à¤•à¥€ à¤¤à¤°à¤¹ à¤¨à¤¿à¤·à¥à¤•à¤°à¥à¤· à¤ªà¤° à¤¨à¤¹à¥€à¤‚ à¤•à¥‚à¤¦à¤¾à¥¤
                                        </p>
                                        <p>
                                            à¤‰à¤¸à¤¨à¥‡ à¤ªà¤¾à¤¯à¤¾ à¤•à¤¿ à¤¤à¤¾à¤°à¥‡ à¤•à¤¾ à¤¯à¤¹ à¤à¥à¤•à¤¾à¤µ à¤¤à¤¬ à¤¸à¤¬à¤¸à¥‡ à¤œà¥à¤¯à¤¾à¤¦à¤¾ à¤¨à¤¹à¥€à¤‚ à¤¥à¤¾ à¤œà¤¬ à¤ªà¥ƒà¤¥à¥à¤µà¥€ à¤…à¤ªà¤¨à¥€ à¤¯à¤¾à¤¤à¥à¤°à¤¾ à¤®à¥‡à¤‚ à¤¤à¤¾à¤°à¥‡ à¤•à¥‡ 'à¤¬à¤—à¤²' à¤¸à¥‡ à¤—à¥à¤œà¤¼à¤° à¤°à¤¹à¥€ à¤¥à¥€ (à¤œà¥ˆà¤¸à¤¾ à¤ªà¥…à¤°à¤²à¥…à¤•à¥à¤¸ à¤•à¥‡ à¤²à¤¿à¤ à¤¹à¥‹à¤¨à¤¾ à¤šà¤¾à¤¹à¤¿à¤)à¥¤ à¤¨à¤¹à¥€à¤‚! à¤¯à¤¹ à¤à¥à¤•à¤¾à¤µ à¤¤à¥‹ à¤¤à¤¬ à¤¸à¤¬à¤¸à¥‡ à¤œà¥à¤¯à¤¾à¤¦à¤¾ à¤¥à¤¾ à¤œà¤¬ à¤ªà¥ƒà¤¥à¥à¤µà¥€ à¤¸à¥€à¤§à¤¾ à¤¤à¤¾à¤°à¥‡ à¤•à¥€ 'à¤“à¤°' à¤œà¤¾ à¤°à¤¹à¥€ à¤¥à¥€ à¤¯à¤¾ à¤‰à¤¸à¤¸à¥‡ 'à¤¦à¥‚à¤°' à¤œà¤¾ à¤°à¤¹à¥€ à¤¥à¥€! à¤¯à¤¹ à¤ªà¥…à¤°à¤²à¥…à¤•à¥à¤¸ (à¤¦à¥‚à¤°à¥€ à¤•à¤¾ à¤ªà¥à¤°à¤­à¤¾à¤µ) à¤¨à¤¹à¥€à¤‚ à¤¹à¥‹ à¤¸à¤•à¤¤à¤¾ à¤¥à¤¾à¥¤
                                        </p>
                                        <p>
                                            à¤¬à¥à¤°à¥ˆà¤¡à¤²à¥€ à¤¨à¥‡ à¤ªà¤¹à¤šà¤¾à¤¨à¤¾ à¤•à¤¿ à¤¯à¤¹ à¤¦à¥‚à¤°à¥€ à¤•à¤¾ à¤¨à¤¹à¥€à¤‚, à¤—à¤¤à¤¿ à¤•à¤¾ à¤–à¥‡à¤² à¤¹à¥ˆà¥¤ à¤‰à¤¸à¤¨à¥‡ à¤‡à¤¸à¥‡ à¤¨à¤¾à¤® à¤¦à¤¿à¤¯à¤¾â€”<span className="hindi-highlight">'à¤à¤¬à¤°à¥‡à¤¶à¤¨' (Aberration/à¤ªà¤¥-à¤­à¥à¤°à¤®)</span>, à¤œà¥‹ à¤¦à¥‚à¤°à¥€ à¤•à¤¾ à¤¨à¤¹à¥€à¤‚, à¤¬à¤²à¥à¤•à¤¿ à¤—à¤¤à¤¿ à¤•à¤¾ à¤ªà¤°à¤¿à¤£à¤¾à¤® à¤¹à¥ˆà¥¤ à¤à¤• à¤à¤¸à¤¾ à¤à¥à¤•à¤¾à¤µ à¤œà¥‹ à¤¦à¥‚à¤°à¥€ à¤¸à¥‡ à¤¨à¤¹à¥€à¤‚, à¤¬à¤²à¥à¤•à¤¿ à¤ªà¥ƒà¤¥à¥à¤µà¥€ à¤•à¥€ à¤—à¤¤à¤¿ à¤¸à¥‡ à¤œà¤¨à¥à¤® à¤²à¥‡à¤¤à¤¾ à¤¹à¥ˆà¥¤
                                        </p>
                                        
                                        <h4 className="text-cyan-400 font-bold font-display mt-6 mb-2">à¤µà¤°à¥à¤·à¤¾ à¤”à¤° à¤—à¤¤à¤¿</h4>
                                        <p>
                                            à¤‡à¤¸à¥‡ à¤¸à¤®à¤à¤¨à¥‡ à¤•à¥‡ à¤²à¤¿à¤ à¤à¤• à¤µà¥à¤¯à¤¾à¤µà¤¹à¤¾à¤°à¤¿à¤• à¤‰à¤¦à¤¾à¤¹à¤°à¤£ à¤²à¥‡à¤‚: à¤®à¤¾à¤¨ à¤²à¥€à¤œà¤¿à¤ à¤¬à¤¾à¤°à¤¿à¤¶ à¤¸à¥€à¤§à¥€ à¤¨à¥€à¤šà¥‡ à¤—à¤¿à¤° à¤°à¤¹à¥€ à¤¹à¥ˆà¥¤ à¤¯à¤¦à¤¿ à¤†à¤ª à¤–à¤¡à¤¼à¥‡ à¤¹à¥ˆà¤‚, à¤¤à¥‹ à¤›à¤¾à¤¤à¤¾ à¤¸à¥€à¤§à¤¾ à¤°à¤–à¥‡à¤‚à¤—à¥‡à¥¤ à¤²à¥‡à¤•à¤¿à¤¨ à¤¯à¤¦à¤¿ à¤†à¤ª à¤¦à¥Œà¤¡à¤¼à¤¨à¥‡ à¤²à¤—à¥‡à¤‚, à¤¤à¥‹ à¤†à¤ªà¤•à¥‹ à¤›à¤¾à¤¤à¤¾ à¤†à¤—à¥‡ à¤à¥à¤•à¤¾à¤¨à¤¾ à¤ªà¤¡à¤¼à¥‡à¤—à¤¾, à¤•à¥à¤¯à¥‹à¤‚à¤•à¤¿ à¤†à¤ªà¤•à¥€ à¤—à¤¤à¤¿ à¤•à¥‡ à¤•à¤¾à¤°à¤£ à¤¬à¤¾à¤°à¤¿à¤¶ à¤¤à¤¿à¤°à¤›à¥€ à¤†à¤¤à¥€ à¤¹à¥à¤ˆ à¤ªà¥à¤°à¤¤à¥€à¤¤ à¤¹à¥‹à¤—à¥€à¥¤
                                        </p>
                                        <p>
                                            à¤¬à¤¾à¤°à¤¿à¤¶ à¤•à¥€ à¤¦à¤¿à¤¶à¤¾ à¤¨à¤¹à¥€à¤‚ à¤¬à¤¦à¤²à¥€, à¤¤à¥à¤®à¥à¤¹à¤¾à¤°à¥€ à¤—à¤¤à¤¿ à¤•à¥‡ à¤•à¤¾à¤°à¤£ à¤¤à¥à¤®à¥à¤¹à¥‡à¤‚ à¤‰à¤¸à¤•à¤¾ à¤ªà¤¥ à¤¬à¤¦à¤²à¤¾ à¤¹à¥à¤† à¤¦à¤¿à¤– à¤°à¤¹à¤¾ à¤¹à¥ˆà¥¤ à¤¬à¤¸ à¤¯à¤¹à¥€ à¤¹à¥ˆ à¤à¤¬à¤°à¥‡à¤¶à¤¨à¥¤ à¤ªà¥à¤°à¤•à¤¾à¤¶ à¤•à¥€ à¤•à¤¿à¤°à¤£à¥‡à¤‚ à¤¹à¥ˆà¤‚ à¤¬à¤¾à¤°à¤¿à¤¶ à¤•à¥€ à¤¬à¥‚à¤‚à¤¦à¥‡à¤‚, à¤”à¤° à¤¹à¤®à¤¾à¤°à¥€ à¤ªà¥ƒà¤¥à¥à¤µà¥€ à¤‰à¤¸ à¤ªà¥à¤°à¤•à¤¾à¤¶ à¤•à¥€ à¤¬à¤¾à¤°à¤¿à¤¶ à¤®à¥‡à¤‚ à¤¬à¤¹à¥à¤¤ à¤¤à¥‡à¤œà¤¼à¥€ à¤¸à¥‡ à¤¦à¥Œà¤¡à¤¼ à¤°à¤¹à¥€ à¤¹à¥ˆà¥¤ à¤‡à¤¸ à¤¦à¥Œà¤¡à¤¼ à¤•à¥‡ à¤•à¤¾à¤°à¤£ à¤¹à¤®à¥‡à¤‚ à¤¤à¤¾à¤°à¥‹à¤‚ à¤¸à¥‡ à¤†à¤¤à¤¾ à¤ªà¥à¤°à¤•à¤¾à¤¶ à¤¸à¥€à¤§à¤¾ à¤¨à¤¹à¥€à¤‚, à¤¥à¥‹à¤¡à¤¼à¤¾ à¤à¥à¤•à¤¾ à¤¹à¥à¤†, à¤¤à¤¿à¤°à¤›à¤¾ à¤†à¤¤à¤¾ à¤¹à¥à¤† à¤ªà¥à¤°à¤¤à¥€à¤¤ à¤¹à¥‹à¤¤à¤¾ à¤¹à¥ˆà¥¤ à¤¯à¤¹ à¤¤à¤¾à¤°à¥‡ à¤•à¥€ à¤¦à¥‚à¤°à¥€ à¤ªà¤° à¤¨à¤¿à¤°à¥à¤­à¤° à¤¨à¤¹à¥€à¤‚ à¤•à¤°à¤¤à¤¾, à¤¯à¤¹ à¤¤à¥‹ à¤¹à¤®à¤¾à¤°à¥€ à¤…à¤ªà¤¨à¥€ à¤—à¤¤à¤¿ à¤•à¤¾ à¤ªà¤°à¤¿à¤£à¤¾à¤® à¤¹à¥ˆà¥¤
                                        </p>
                                        <p>
                                            à¤ªà¥ƒà¤¥à¥à¤µà¥€ à¤•à¥€ à¤—à¤¤à¤¿ (v) à¤”à¤° à¤ªà¥à¤°à¤•à¤¾à¤¶ à¤•à¥€ à¤—à¤¤à¤¿ (c) à¤•à¥‡ à¤•à¤¾à¤°à¤£, à¤¸à¥€à¤§à¤¾ à¤†à¤¤à¤¾ à¤¹à¥à¤† à¤ªà¥à¤°à¤•à¤¾à¤¶ à¤¹à¤®à¥‡à¤‚ à¤¥à¥‹à¤¡à¤¼à¤¾ à¤à¥à¤•à¤¾ à¤¹à¥à¤† (à¤¤à¤¿à¤°à¤›à¤¾) à¤¦à¤¿à¤–à¤¾à¤ˆ à¤¦à¥‡à¤¤à¤¾ à¤¹à¥ˆà¥¤ à¤ªà¥à¤°à¤•à¤¾à¤¶ à¤•à¥€ à¤¬à¥‚à¤‚à¤¦à¥‡à¤‚ à¤Šà¤ªà¤° à¤¸à¥‡ à¤† à¤°à¤¹à¥€ à¤¹à¥ˆà¤‚, à¤¶à¤¾à¤‚à¤¤, à¤¸à¥€à¤§à¥€à¥¤ à¤”à¤° à¤ªà¥ƒà¤¥à¥à¤µà¥€ à¤…à¤ªà¤¨à¥€ à¤¨à¤¾à¤µ à¤ªà¤° à¤¸à¤µà¤¾à¤° à¤¹à¥‹à¤•à¤° à¤ªà¥à¤°à¤¤à¤¿ à¤¸à¥‡à¤•à¤‚à¤¡ à¤²à¤—à¤­à¤— 30 à¤•à¤¿à¤²à¥‹à¤®à¥€à¤Ÿà¤° à¤•à¥€ à¤—à¤¤à¤¿ à¤¸à¥‡ à¤‡à¤¸ à¤ªà¥à¤°à¤•à¤¾à¤¶-à¤µà¤°à¥à¤·à¤¾ à¤®à¥‡à¤‚ à¤¦à¥Œà¤¡à¤¼ à¤°à¤¹à¥€ à¤¹à¥ˆà¥¤
                                        </p>
                                        <p>
                                            à¤¸à¥‹à¤šà¥‹, à¤›à¤¹ à¤®à¤¹à¥€à¤¨à¥‡ à¤ªà¥ƒà¤¥à¥à¤µà¥€ à¤¸à¥‚à¤°à¥à¤¯ à¤•à¥‡ à¤šà¤¾à¤°à¥‹à¤‚ à¤“à¤° à¤˜à¥‚à¤®à¤¤à¥‡ à¤¹à¥à¤ à¤ªà¥à¤°à¤•à¤¾à¤¶ à¤•à¥€ à¤‰à¤¨ à¤¬à¥‚à¤‚à¤¦à¥‹à¤‚ à¤•à¥€ à¤“à¤° à¤¦à¥Œà¤¡à¤¼à¤¤à¥€ à¤¹à¥ˆà¥¤ à¤œà¥ˆà¤¸à¥‡ à¤¤à¥à¤® à¤¬à¤¾à¤°à¤¿à¤¶ à¤®à¥‡à¤‚ à¤†à¤—à¥‡ à¤•à¥€ à¤“à¤° à¤¦à¥Œà¤¡à¤¼à¥‹à¥¤ à¤¬à¤¾à¤°à¤¿à¤¶ à¤•à¤¹à¤¾à¤‚ à¤¸à¥‡ à¤†à¤¤à¥€ à¤¹à¥à¤ˆ à¤²à¤—à¥‡à¤—à¥€? à¤¸à¤¾à¤®à¤¨à¥‡ à¤¸à¥‡! à¤¤à¥à¤®à¥à¤¹à¥‡à¤‚ à¤›à¤¾à¤¤à¤¾ à¤†à¤—à¥‡ à¤à¥à¤•à¤¾à¤¨à¤¾ à¤ªà¤¡à¤¼à¥‡à¤—à¤¾à¥¤ à¤¤à¤¾à¤°à¥‡ à¤•à¤¾ à¤ªà¥à¤°à¤•à¤¾à¤¶ à¤¸à¤¾à¤®à¤¨à¥‡ à¤¸à¥‡ à¤†à¤¤à¤¾ à¤¹à¥à¤† à¤¦à¤¿à¤–à¥‡à¤—à¤¾, à¤…à¤ªà¤¨à¥€ à¤œà¤—à¤¹ à¤¸à¥‡ à¤¥à¥‹à¤¡à¤¼à¤¾ à¤†à¤—à¥‡à¥¤
                                        </p>
                                        <p>
                                            à¤”à¤° à¤«à¤¿à¤° à¤¬à¤¾à¤•à¥€ à¤›à¤¹ à¤®à¤¹à¥€à¤¨à¥‡ à¤ªà¥ƒà¤¥à¥à¤µà¥€ à¤˜à¥‚à¤®à¤•à¤° à¤‰à¤¨ à¤¬à¥‚à¤‚à¤¦à¥‹à¤‚ à¤¸à¥‡ à¤¦à¥‚à¤° à¤­à¤¾à¤—à¤¤à¥€ à¤¹à¥ˆà¥¤ à¤œà¥ˆà¤¸à¥‡ à¤¤à¥à¤® à¤¬à¤¾à¤°à¤¿à¤¶ à¤¸à¥‡ à¤¦à¥‚à¤° à¤­à¤¾à¤—à¥‹à¥¤ à¤…à¤¬ à¤¬à¤¾à¤°à¤¿à¤¶ à¤ªà¥€à¤›à¥‡ à¤¸à¥‡ à¤†à¤¤à¥€ à¤¹à¥à¤ˆ à¤²à¤—à¥‡à¤—à¥€à¥¤ à¤¤à¤¾à¤°à¥‡ à¤•à¤¾ à¤ªà¥à¤°à¤•à¤¾à¤¶ à¤ªà¥€à¤›à¥‡ à¤¸à¥‡ à¤†à¤¤à¤¾ à¤¹à¥à¤† à¤¦à¤¿à¤–à¥‡à¤—à¤¾, à¤…à¤ªà¤¨à¥€ à¤œà¤—à¤¹ à¤¸à¥‡ à¤¥à¥‹à¤¡à¤¼à¤¾ à¤ªà¥€à¤›à¥‡à¥¤
                                        </p>
                                        <p>
                                            à¤¬à¥à¤°à¥ˆà¤¡à¤²à¥€ à¤¨à¥‡ à¤‡à¤¸à¥€ à¤°à¤¹à¤¸à¥à¤¯ à¤•à¥‹ à¤ªà¤•à¤¡à¤¼à¤¾à¥¤ à¤‰à¤¸à¤¨à¥‡ à¤•à¤¹à¤¾, "à¤…à¤°à¥‡! à¤¤à¤¾à¤°à¥‡ à¤•à¤¾ à¤¸à¤¬à¤¸à¥‡ à¤¬à¤¡à¤¼à¤¾ à¤à¥à¤•à¤¾à¤µ à¤¤à¥‹ à¤¤à¤¬ à¤¹à¥‹à¤¤à¤¾ à¤¹à¥ˆ à¤œà¤¬ à¤¹à¤® à¤¯à¤¾ à¤¤à¥‹ à¤‰à¤¸à¤•à¥€ à¤›à¤¾à¤¤à¥€ à¤ªà¤° à¤šà¤¢à¤¼ à¤°à¤¹à¥‡ à¤¹à¥‹à¤¤à¥‡ à¤¹à¥ˆà¤‚ à¤¯à¤¾ à¤‰à¤¸à¤¸à¥‡ à¤ªà¥€à¤  à¤«à¥‡à¤°à¤•à¤° à¤­à¤¾à¤— à¤°à¤¹à¥‡ à¤¹à¥‹à¤¤à¥‡ à¤¹à¥ˆà¤‚! à¤¬à¤—à¤² à¤¸à¥‡ à¤¨à¤¿à¤•à¤²à¤¨à¥‡ à¤ªà¤° à¤¨à¤¹à¥€à¤‚à¥¤" à¤ªà¥…à¤°à¤²à¥…à¤•à¥à¤¸ à¤•à¤¾ à¤ªà¥‚à¤°à¤¾ à¤¸à¤¿à¤¦à¥à¤§à¤¾à¤‚à¤¤ à¤¯à¤¹à¤¾à¤‚ à¤—à¤¿à¤° à¤—à¤¯à¤¾à¥¤ à¤¯à¤¹ à¤¤à¤¾à¤°à¥‡ à¤•à¥€ à¤¦à¥‚à¤°à¥€ à¤•à¤¾ à¤¨à¤¹à¥€à¤‚, à¤¯à¤¹ à¤¤à¥‹ à¤ªà¥ƒà¤¥à¥à¤µà¥€ à¤•à¥€ à¤…à¤ªà¤¨à¥€ à¤¹à¥€ 'à¤šà¤¾à¤²' à¤•à¤¾ à¤§à¥‹à¤–à¤¾ à¤¥à¤¾à¥¤ à¤‡à¤¸ à¤¦à¥Œà¤¡à¤¼ à¤•à¥‡ à¤•à¤¾à¤°à¤£ à¤¤à¤¾à¤°à¥‡ à¤•à¤¾ à¤¸à¥€à¤§à¤¾ à¤ªà¥à¤°à¤•à¤¾à¤¶ à¤¹à¤®à¥‡à¤‚ à¤¤à¤¿à¤°à¤›à¤¾ à¤¦à¤¿à¤–à¤¤à¤¾ à¤¹à¥ˆà¥¤ à¤¯à¤¹ à¤¤à¤¾à¤°à¤¾ à¤¨à¤¹à¥€à¤‚, à¤¯à¤¹ à¤¹à¤®à¤¾à¤°à¥€ à¤…à¤ªà¤¨à¥€ à¤—à¤¤à¤¿ à¤¹à¥ˆ à¤œà¥‹ à¤¦à¥ƒà¤¶à¥à¤¯ à¤•à¥‹ à¤¬à¤¦à¤² à¤°à¤¹à¥€ à¤¹à¥ˆà¥¤
                                        </p>

                                        <h4 className="text-cyan-400 font-bold font-display mt-6 mb-2">à¤ªà¥à¤°à¤•à¤¾à¤¶ à¤•à¥€ à¤—à¤¤à¤¿ à¤”à¤° à¤…à¤¤à¥€à¤¤ à¤•à¤¾ à¤¦à¤°à¥à¤¶à¤¨</h4>
                                        <p>
                                            à¤¬à¥à¤°à¥ˆà¤¡à¤²à¥€ à¤¨à¥‡ à¤ªà¥ƒà¤¥à¥à¤µà¥€ à¤•à¥€ à¤—à¤¤à¤¿ (v) à¤”à¤° à¤ªà¥à¤°à¤•à¤¾à¤¶ à¤•à¥‡ à¤‡à¤¸ à¤à¥à¤•à¤¾à¤µ (c) à¤•à¥‡ à¤•à¥‹à¤£ à¤•à¥‹ à¤®à¤¾à¤ªà¤¾ à¤”à¤° à¤à¤• à¤•à¥à¤°à¤¾à¤‚à¤¤à¤¿à¤•à¤¾à¤°à¥€ à¤—à¤£à¤¨à¤¾ à¤•à¥€ à¤‰à¤¸à¤¨à¥‡ à¤¦à¥à¤¨à¤¿à¤¯à¤¾ à¤•à¥‹ à¤¬à¤¤à¤¾à¤¯à¤¾ à¤•à¤¿ à¤¸à¥‚à¤°à¥à¤¯ à¤•à¥€ à¤•à¤¿à¤°à¤£ à¤•à¥‹ à¤¹à¤® à¤¤à¤• à¤ªà¤¹à¥à¤à¤šà¤¨à¥‡ à¤®à¥‡à¤‚ 8 à¤®à¤¿à¤¨à¤Ÿ à¤”à¤° 12 à¤¸à¥‡à¤•à¤‚à¤¡ à¤²à¤—à¤¤à¥‡ à¤¹à¥ˆà¤‚à¥¤ à¤‡à¤¸ à¤—à¤£à¤¨à¤¾ à¤¸à¥‡ à¤à¤• à¤…à¤¦à¥à¤­à¥à¤¤ à¤¤à¤¥à¥à¤¯ à¤¸à¤¾à¤®à¤¨à¥‡ à¤†à¤¯à¤¾: à¤¸à¥‚à¤°à¥à¤¯ à¤¸à¥‡ à¤ªà¥ƒà¤¥à¥à¤µà¥€ à¤¤à¤• à¤ªà¥à¤°à¤•à¤¾à¤¶ à¤•à¥‹ à¤ªà¤¹à¥à¤à¤šà¤¨à¥‡ à¤®à¥‡à¤‚ 8 à¤®à¤¿à¤¨à¤Ÿ à¤”à¤° 12 à¤¸à¥‡à¤•à¤‚à¤¡ à¤²à¤—à¤¤à¥‡ à¤¹à¥ˆà¤‚à¥¤
                                        </p>
                                        <p>
                                            à¤µà¥ˆà¤œà¥à¤žà¤¾à¤¨à¤¿à¤• à¤¦à¥ƒà¤·à¥à¤Ÿà¤¿ à¤¸à¥‡ à¤‡à¤¸à¤•à¤¾ à¤…à¤°à¥à¤¥ à¤—à¤¹à¤°à¤¾ à¤¹à¥ˆ: à¤¹à¤® à¤œà¤¬ à¤­à¥€ à¤¸à¥‚à¤°à¥à¤¯ à¤•à¥‹ à¤¦à¥‡à¤–à¤¤à¥‡ à¤¹à¥ˆà¤‚, à¤¹à¤® à¤‰à¤¸à¥‡ à¤µà¤°à¥à¤¤à¤®à¤¾à¤¨ à¤®à¥‡à¤‚ à¤¨à¤¹à¥€à¤‚ à¤¦à¥‡à¤– à¤°à¤¹à¥‡ à¤¹à¥‹à¤¤à¥‡, à¤¬à¤²à¥à¤•à¤¿ à¤¹à¤® 8 à¤®à¤¿à¤¨à¤Ÿ à¤ªà¥à¤°à¤¾à¤¨à¥‡ à¤…à¤¤à¥€à¤¤ à¤•à¥‹ à¤¦à¥‡à¤– à¤°à¤¹à¥‡ à¤¹à¥‹à¤¤à¥‡ à¤¹à¥ˆà¤‚à¥¤ à¤ªà¥à¤°à¤•à¤¾à¤¶ à¤•à¥€ à¤—à¤¤à¤¿ à¤¸à¥€à¤®à¤¿à¤¤ à¤¹à¥ˆ, à¤…à¤¨à¤‚à¤¤ à¤¨à¤¹à¥€à¤‚à¥¤
                                        </p>

                                        <h4 className="text-cyan-400 font-bold font-display mt-6 mb-2">à¤¤à¥‹ à¤•à¥à¤¯à¤¾ à¤¹à¥ˆ à¤¯à¤¹ à¤à¤¬à¤°à¥‡à¤¶à¤¨?</h4>
                                        <p>
                                            <strong>à¤ªà¤¥-à¤­à¥à¤°à¤® (Aberration) à¤•à¤¾ à¤…à¤¸à¤²à¥€ à¤®à¤°à¥à¤®:</strong> à¤•à¤²à¥à¤ªà¤¨à¤¾ à¤•à¤°à¥‹, à¤¤à¥à¤® à¤à¤• à¤Ÿà¥à¤°à¥‡à¤¨ à¤®à¥‡à¤‚ à¤¬à¥ˆà¤ à¥‡ à¤¹à¥‹ à¤œà¥‹ à¤°à¥à¤•à¥€ à¤¹à¥à¤ˆ à¤¹à¥ˆà¥¤ à¤¬à¤¾à¤¹à¤° à¤¬à¤¾à¤°à¤¿à¤¶ à¤¹à¥‹ à¤°à¤¹à¥€ à¤¹à¥ˆ, à¤¬à¥‚à¤‚à¤¦à¥‡à¤‚ à¤†à¤•à¤¾à¤¶ à¤¸à¥‡ à¤¸à¥€à¤§à¥€, à¤à¤•à¤¦à¤® à¤¸à¥€à¤§à¥€ à¤¨à¥€à¤šà¥‡ à¤—à¤¿à¤° à¤°à¤¹à¥€ à¤¹à¥ˆà¤‚à¥¤ à¤–à¤¿à¤¡à¤¼à¤•à¥€ à¤ªà¤° à¤µà¥‡ à¤¸à¥€à¤§à¥€ à¤°à¥‡à¤–à¤¾ à¤®à¥‡à¤‚ à¤—à¤¿à¤°à¥‡à¤‚à¤—à¥€à¥¤ à¤¯à¤¹ à¤¹à¥ˆ à¤¸à¤¤à¥à¤¯, à¤œà¥ˆà¤¸à¤¾ à¤µà¤¹ à¤¹à¥ˆà¥¤ à¤²à¥‡à¤•à¤¿à¤¨ à¤«à¤¿à¤° à¤Ÿà¥à¤°à¥‡à¤¨ à¤šà¤² à¤ªà¤¡à¤¼à¤¤à¥€ à¤¹à¥ˆ... à¤”à¤° à¤à¤• à¤šà¤®à¤¤à¥à¤•à¤¾à¤° à¤˜à¤Ÿà¤¤à¤¾ à¤¹à¥ˆà¥¤ à¤µà¤¹à¥€ à¤¬à¥‚à¤‚à¤¦à¥‡à¤‚ à¤œà¥‹ à¤¸à¥€à¤§à¥€ à¤—à¤¿à¤° à¤°à¤¹à¥€ à¤¥à¥€à¤‚, à¤…à¤¬ à¤¤à¥à¤®à¥à¤¹à¥‡à¤‚ à¤–à¤¿à¤¡à¤¼à¤•à¥€ à¤ªà¤° à¤¤à¤¿à¤°à¤›à¥€ à¤†à¤¤à¥€ à¤¹à¥à¤ˆ à¤¦à¤¿à¤–à¤¤à¥€ à¤¹à¥ˆà¤‚! à¤œà¤¿à¤¤à¤¨à¥€ à¤¤à¥‡à¤œà¤¼ à¤Ÿà¥à¤°à¥‡à¤¨ à¤­à¤¾à¤—à¥‡à¤—à¥€, à¤¬à¥‚à¤‚à¤¦à¥‡à¤‚ à¤‰à¤¤à¤¨à¥€ à¤¹à¥€ à¤¤à¤¿à¤°à¤›à¥€ à¤¦à¤¿à¤–à¥‡à¤‚à¤—à¥€à¥¤
                                        </p>
                                        <p>
                                            à¤†à¤ª à¤à¤• à¤šà¤²à¤¤à¥€ à¤¹à¥à¤ˆ à¤Ÿà¥à¤°à¥‡à¤¨ à¤®à¥‡à¤‚ à¤¹à¥ˆà¤‚à¥¤ à¤¬à¤¾à¤¹à¤° à¤¬à¤¾à¤°à¤¿à¤¶ à¤¸à¥€à¤§à¥€ à¤—à¤¿à¤° à¤°à¤¹à¥€ à¤¹à¥ˆ, à¤¯à¤¹ à¤à¤• à¤¤à¤¥à¥à¤¯ à¤¹à¥ˆà¥¤ à¤²à¥‡à¤•à¤¿à¤¨ à¤†à¤ªà¤•à¥‹ à¤–à¤¿à¤¡à¤¼à¤•à¥€ à¤¸à¥‡ à¤µà¤¹ à¤¤à¤¿à¤°à¤›à¥€ à¤†à¤¤à¥€ à¤¹à¥à¤ˆ à¤¦à¤¿à¤–à¤¤à¥€ à¤¹à¥ˆà¥¤ à¤•à¥à¤¯à¥‹à¤‚? à¤•à¥à¤¯à¤¾ à¤¬à¤¾à¤°à¤¿à¤¶ à¤¨à¥‡ à¤…à¤ªà¤¨à¥€ à¤¦à¤¿à¤¶à¤¾ à¤¬à¤¦à¤² à¤¦à¥€? à¤¨à¤¹à¥€à¤‚à¥¤ à¤¬à¤¾à¤°à¤¿à¤¶ à¤µà¥ˆà¤¸à¥€ à¤¹à¥€ à¤¹à¥ˆà¥¤ à¤†à¤ªà¤•à¥€ à¤…à¤ªà¤¨à¥€ à¤—à¤¤à¤¿ à¤¨à¥‡ à¤†à¤ªà¤•à¥‡ à¤²à¤¿à¤ à¤‰à¤¸ à¤¤à¤¥à¥à¤¯ à¤•à¥‹ à¤µà¤¿à¤•à¥ƒà¤¤ à¤•à¤° à¤¦à¤¿à¤¯à¤¾ à¤¹à¥ˆ, à¤à¤• à¤à¥à¤•à¤¾à¤µ à¤¦à¥‡ à¤¦à¤¿à¤¯à¤¾ à¤¹à¥ˆà¥¤ à¤†à¤ªà¤•à¥€ à¤—à¤¤à¤¿ à¤”à¤° à¤¬à¤¾à¤°à¤¿à¤¶ à¤•à¥€ à¤—à¤¤à¤¿ à¤®à¤¿à¤²à¤•à¤° à¤à¤• à¤†à¤­à¤¾à¤¸à¥€ (apparent) à¤¦à¤¿à¤¶à¤¾ à¤¬à¤¨à¤¾ à¤°à¤¹à¥€ à¤¹à¥ˆà¥¤
                                        </p>
                                        <p>
                                            à¤•à¥à¤¯à¤¾ à¤¬à¤¾à¤°à¤¿à¤¶ à¤¨à¥‡ à¤…à¤ªà¤¨à¤¾ à¤¢à¤‚à¤— à¤¬à¤¦à¤² à¤²à¤¿à¤¯à¤¾? à¤•à¥à¤¯à¤¾ à¤†à¤•à¤¾à¤¶ à¤à¥à¤• à¤—à¤¯à¤¾? à¤¨à¤¹à¥€à¤‚à¥¤ à¤•à¥à¤› à¤­à¥€ à¤¨à¤¹à¥€à¤‚ à¤¬à¤¦à¤²à¤¾à¥¤ à¤¬à¤¦à¤²à¤¾ à¤¹à¥ˆ à¤¤à¥‹ à¤¬à¤¸ à¤¤à¥à¤®à¥à¤¹à¤¾à¤°à¤¾ à¤…à¤ªà¤¨à¤¾ à¤µà¥‡à¤—, à¤¤à¥à¤®à¥à¤¹à¤¾à¤°à¥€ à¤…à¤ªà¤¨à¥€ à¤—à¤¤à¤¿à¥¤ à¤¤à¥à¤®à¥à¤¹à¤¾à¤°à¥€ à¤—à¤¤à¤¿ à¤”à¤° à¤¬à¤¾à¤°à¤¿à¤¶ à¤•à¥€ à¤—à¤¤à¤¿, à¤‡à¤¨ à¤¦à¥‹à¤¨à¥‹à¤‚ à¤¨à¥‡ à¤®à¤¿à¤²à¤•à¤° à¤¤à¥à¤®à¥à¤¹à¤¾à¤°à¥€ à¤†à¤à¤–à¥‹à¤‚ à¤•à¥‡ à¤²à¤¿à¤ à¤à¤• à¤¨à¤¯à¤¾, à¤¤à¤¿à¤°à¤›à¤¾ à¤¸à¤¤à¥à¤¯ à¤°à¤š à¤¦à¤¿à¤¯à¤¾ à¤¹à¥ˆà¥¤ à¤¬à¥à¤°à¥ˆà¤¡à¤²à¥€ à¤¨à¥‡ à¤•à¤¹à¤¾, à¤¤à¤¾à¤°à¥‹à¤‚ à¤•à¥‡ à¤¸à¤¾à¤¥ à¤­à¥€ à¤ à¥€à¤• à¤¯à¤¹à¥€ à¤¹à¥‹ à¤°à¤¹à¤¾ à¤¹à¥ˆ!
                                        </p>
                                        <p>
                                            à¤¤à¤¾à¤°à¥‡ à¤¸à¥‡ à¤ªà¥à¤°à¤•à¤¾à¤¶ à¤•à¥€ à¤•à¤¿à¤°à¤£à¥‡à¤‚ à¤¸à¥€à¤§à¥€ à¤† à¤°à¤¹à¥€ à¤¹à¥ˆà¤‚, à¤µà¤°à¥à¤·à¤¾ à¤•à¥€ à¤¬à¥‚à¤‚à¤¦à¥‹à¤‚ à¤•à¥€ à¤¤à¤°à¤¹à¥¤ à¤”à¤° à¤¹à¤®à¤¾à¤°à¥€ à¤ªà¥ƒà¤¥à¥à¤µà¥€ à¤à¤• à¤¬à¤¹à¥à¤¤ à¤¤à¥‡à¤œà¤¼ à¤°à¤«à¤¼à¥à¤¤à¤¾à¤° à¤Ÿà¥à¤°à¥‡à¤¨ à¤•à¥€ à¤¤à¤°à¤¹ à¤‡à¤¸ à¤¬à¥à¤°à¤¹à¥à¤®à¤¾à¤‚à¤¡ à¤®à¥‡à¤‚ à¤­à¤¾à¤—à¥€ à¤œà¤¾ à¤°à¤¹à¥€ à¤¹à¥ˆà¥¤ à¤…à¤ªà¤¨à¥€ à¤‡à¤¸ à¤—à¤¤à¤¿ à¤•à¥‡ à¤•à¤¾à¤°à¤£, à¤¹à¤®à¥‡à¤‚ à¤¤à¤¾à¤°à¥‡ à¤¸à¥‡ à¤†à¤¤à¤¾ à¤¸à¥€à¤§à¤¾ à¤ªà¥à¤°à¤•à¤¾à¤¶ à¤­à¥€ à¤¥à¥‹à¤¡à¤¼à¤¾ à¤¤à¤¿à¤°à¤›à¤¾, à¤¥à¥‹à¤¡à¤¼à¤¾ à¤à¥à¤•à¤¾ à¤¹à¥à¤† à¤ªà¥à¤°à¤¤à¥€à¤¤ à¤¹à¥‹à¤¤à¤¾ à¤¹à¥ˆà¥¤ à¤¯à¤¹à¥€ à¤¹à¥ˆ à¤¤à¤¾à¤°à¤•à¥€à¤¯ à¤ªà¤¥-à¤­à¥à¤°à¤® (Stellar Aberration)à¥¤ à¤¯à¤¹ à¤¤à¤¾à¤°à¥‡ à¤•à¤¾ à¤¨à¤¹à¥€à¤‚, à¤¹à¤®à¤¾à¤°à¥€ à¤…à¤ªà¤¨à¥€ à¤¦à¥Œà¤¡à¤¼ à¤•à¤¾ à¤ªà¤°à¤¿à¤£à¤¾à¤® à¤¹à¥ˆà¥¤
                                        </p>
                                        <p>
                                            à¤¤à¤¾à¤°à¥‡ à¤•à¤¾ à¤ªà¥à¤°à¤•à¤¾à¤¶ à¤¸à¥€à¤§à¤¾ à¤† à¤°à¤¹à¤¾ à¤¹à¥ˆà¥¤ à¤ªà¥ƒà¤¥à¥à¤µà¥€ à¤…à¤ªà¤¨à¥€ à¤—à¤¤à¤¿ à¤®à¥‡à¤‚ à¤¹à¥ˆà¥¤ à¤”à¤° à¤ªà¥ƒà¤¥à¥à¤µà¥€ à¤•à¥€ à¤¯à¤¹ à¤—à¤¤à¤¿, à¤ªà¥à¤°à¤•à¤¾à¤¶ à¤•à¥€ à¤—à¤¤à¤¿ à¤•à¥‡ à¤¸à¤¾à¤¥ à¤®à¤¿à¤²à¤•à¤°, à¤¹à¤®à¤¾à¤°à¥‡ à¤²à¤¿à¤ à¤¤à¤¾à¤°à¥‡ à¤•à¥€ à¤¸à¥à¤¥à¤¿à¤¤à¤¿ à¤•à¥‹ à¤µà¤¿à¤•à¥ƒà¤¤ à¤•à¤° à¤¦à¥‡à¤¤à¥€ à¤¹à¥ˆà¥¤ à¤¹à¤® à¤¤à¤¾à¤°à¥‡ à¤•à¥‹ à¤µà¤¹à¤¾à¤‚ à¤¨à¤¹à¥€à¤‚ à¤¦à¥‡à¤–à¤¤à¥‡ à¤œà¤¹à¤¾à¤‚ à¤µà¤¹ à¤¹à¥ˆ, à¤¹à¤® à¤‰à¤¸à¥‡ à¤µà¤¹à¤¾à¤‚ à¤¦à¥‡à¤–à¤¤à¥‡ à¤¹à¥ˆà¤‚ à¤œà¤¹à¤¾à¤‚ à¤¹à¤®à¤¾à¤°à¥€ à¤…à¤ªà¤¨à¥€ à¤—à¤¤à¤¿ à¤‰à¤¸à¥‡ à¤¦à¤¿à¤–à¤¾à¤¤à¥€ à¤¹à¥ˆà¥¤
                                        </p>
                                        <p className="text-white font-bold">
                                            à¤¤à¥‹, à¤•à¥à¤¯à¤¾ à¤†à¤ª à¤‡à¤¸ à¤¬à¤¾à¤¤ à¤•à¥€ à¤—à¤¹à¤°à¤¾à¤ˆ à¤¦à¥‡à¤– à¤°à¤¹à¥‡ à¤¹à¥ˆà¤‚? à¤µà¤¿à¤•à¥ƒà¤¤à¤¿ à¤¤à¤¾à¤°à¥‡ à¤®à¥‡à¤‚ à¤¨à¤¹à¥€à¤‚ à¤¹à¥ˆ, à¤µà¤¿à¤•à¥ƒà¤¤à¤¿ à¤¦à¥‡à¤–à¤¨à¥‡ à¤µà¤¾à¤²à¥‡ à¤•à¥€ à¤…à¤ªà¤¨à¥€ à¤—à¤¤à¤¿ à¤®à¥‡à¤‚ à¤¹à¥ˆà¥¤ The distortion is in the observer.
                                        </p>

                                        <div className="glass-card p-4 border border-white/20 mt-6 bg-cyan-900/10">
                                            <h4 className="text-cyan-400 font-bold font-display mb-2">à¤ªà¥…à¤°à¤²à¥…à¤•à¥à¤¸ à¤”à¤° à¤à¤¬à¤°à¥‡à¤¶à¤¨ à¤•à¤¾ à¤­à¥‡à¤¦ :</h4>
                                            <ul className="list-disc pl-5 space-y-2">
                                                <li><strong>à¤ªà¥…à¤°à¤²à¥…à¤•à¥à¤¸</strong> à¤¦à¥‚à¤°à¥€ à¤•à¤¾ à¤–à¥‡à¤² à¤¹à¥ˆà¥¤ à¤¯à¤¹ à¤‡à¤¸ à¤ªà¤° à¤¨à¤¿à¤°à¥à¤­à¤° à¤•à¤°à¤¤à¤¾ à¤¹à¥ˆ à¤•à¤¿ à¤¤à¤¾à¤°à¤¾ à¤¹à¤®à¤¸à¥‡ à¤•à¤¿à¤¤à¤¨à¤¾ à¤¦à¥‚à¤° à¤¯à¤¾ à¤ªà¤¾à¤¸ à¤¹à¥ˆà¥¤</li>
                                                <li><strong>à¤à¤¬à¤°à¥‡à¤¶à¤¨</strong> à¤—à¤¤à¤¿ à¤•à¤¾ à¤–à¥‡à¤² à¤¹à¥ˆà¥¤ à¤¯à¤¹ à¤ªà¥à¤°à¤•à¤¾à¤¶ à¤•à¥€ à¤—à¤¤à¤¿ à¤”à¤° à¤ªà¥ƒà¤¥à¥à¤µà¥€ à¤•à¥€ à¤—à¤¤à¤¿ à¤•à¤¾ à¤¸à¤¾à¤ªà¥‡à¤•à¥à¤· à¤ªà¤°à¤¿à¤£à¤¾à¤® à¤¹à¥ˆà¥¤ à¤‡à¤¸à¤•à¤¾ à¤¤à¤¾à¤°à¥‡ à¤•à¥€ à¤¦à¥‚à¤°à¥€ à¤¸à¥‡ à¤•à¥‹à¤ˆ à¤²à¥‡à¤¨à¤¾-à¤¦à¥‡à¤¨à¤¾ à¤¨à¤¹à¥€à¤‚à¥¤</li>
                                            </ul>
                                            <p className="mt-4 font-bold text-center">
                                                à¤¹à¥à¤• à¤¨à¥‡ à¤œà¥‹ à¤¦à¥‡à¤–à¤¾, à¤µà¤¹ à¤à¤• à¤­à¥à¤°à¤® à¤¥à¤¾à¥¤ à¤¬à¥à¤°à¥ˆà¤¡à¤²à¥€ à¤¨à¥‡ à¤‰à¤¸ à¤­à¥à¤°à¤® à¤•à¥‡ à¤ªà¤¾à¤° à¤¦à¥‡à¤–à¤¾à¥¤
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div> 
                        )} 
                        {tab === 'textbook' && (
                            <div className="h-full overflow-y-auto scroller p-4 pb-20">
                                <div className="paper-bg text-sm rounded-sm mb-4 shadow-xl">
                                    <h3 className="text-black font-bold text-xl mb-4 border-b border-black/10 pb-2">Vector Algebra & Relativity (JEE)</h3>
                                    
                                    <div className="bg-yellow-50 p-4 rounded border-l-4 border-yellow-500 mb-4">
                                        <strong className="block text-yellow-800 mb-1">Key Concept: Relative Velocity</strong>
                                        <p className="text-sm">The core of Aberration is simply relative velocity. If rain falls vertically with velocity <Latex tex="\vec{v}_r" dark={false} /> and man moves with <Latex tex="\vec{v}_m" dark={false} />, the rain appears to move with:</p>
                                        <div className="my-2 text-center font-bold"><Latex tex="\vec{v}_{rm} = \vec{v}_r - \vec{v}_m" dark={false} /></div>
                                        <p className="text-sm">This creates a vector triangle where the apparent angle <Latex tex="\theta" dark={false} /> is given by:</p>
                                        <div className="my-2 text-center"><Latex tex="\tan \theta = \frac{v_m}{v_r}" dark={false} /></div>
                                    </div>

                                    <p><strong>1. Stellar Aberration</strong></p>
                                    <p>Replacing rain with light (<Latex tex="v_r = c" dark={false} />) and man with Earth (<Latex tex="v_m = v" dark={false} />):</p>
                                    <div className="my-2 text-center"><Latex tex="\tan \theta \approx \frac{v}{c}" dark={false} /></div>
                                    <p>This proved Earth moves (velocities add vectorially).</p>

                                    <p><strong>2. Time Dilation</strong></p>
                                    <div className="my-2 text-center"><Latex tex="\Delta t' = \frac{\Delta t}{\sqrt{1 - v^2/c^2}} = \gamma \Delta t" dark={false} /></div>
                                    
                                    <p><strong>3. Length Contraction</strong></p>
                                    <div className="my-2 text-center"><Latex tex="L = \frac{L_0}{\gamma}" dark={false} /></div>
                                </div>
                            </div>
                        )}
                        {tab === 'lab' && (
                             <div className="h-full overflow-y-auto scroller p-4 pb-20 space-y-4">
                                <div className="glass-card p-4 border-l-2 border-cyan-500 space-y-4">
                                    <div className="text-[10px] font-bold text-cyan-500 uppercase tracking-wider font-display">System Velocity (v)</div>
                                    <div className="space-y-2"> 
                                        <div className="flex justify-between text-xs text-cyan-400 font-bold font-display"> <span>Rest (0)</span> <span>Max (c)</span> </div> 
                                        <input type="range" min="0" max="99" value={velocity} onChange={(e) => setVelocity(parseFloat(e.target.value))} className="w-full h-1 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-cyan-500" /> 
                                        <div className="text-center text-xs text-slate-500 mt-1">Velocity Factor: <span className="text-cyan-400 font-mono">{(velocity/100).toFixed(2)} c</span></div> 
                                    </div> 
                                </div>
                                <div className="grid grid-cols-2 gap-2 text-[10px] font-mono text-slate-400">
                                    <div className="glass-card p-2 text-center">
                                        <span className="block text-cyan-400 font-bold text-lg mb-1">ðŸ“</span>
                                        Vectors Mode:<br/>Relative Velocity Visualizer
                                    </div>
                                    <div className="glass-card p-2 text-center">
                                        <span className="block text-green-400 font-bold text-lg mb-1">â›°ï¸</span>
                                        Parallax Mode:<br/>Depth Perception
                                    </div>
                                </div>
                             </div>
                        )}
                    </div> 
                </div> 
            )} 
        </div> 
    );
};
// --- 8. MAXWELL OMNI-SCIENCE SOLVER (FULL EDITION) ---
const MaxwellSolver = () => {
    const vibrate = useHaptics();
    const toast = useToast();
    const { btnSize, gap } = useUIAdaptation();

    // --- UI STATE ---
    const [fullScreen, setFullScreen] = useState(false);
    const [playing, setPlaying] = useState(true);
    const [activeTab, setActiveTab] = useState('scope'); // scope, spectro, bode, phase, xt
    const [activeTool, setActiveTool] = useState('none');
    const [view3D, setView3D] = useState(false);
    const [isQuantum, setIsQuantum] = useState(false);
    const [phaseTrails, setPhaseTrails] = useState(true);
    
    // Collapsible Sections
    const [sections, setSections] = useState({ 
        tools: true, gen: true, sim: true, modes: true, probes: true, params: true, scenarios: true 
    });

    // --- PHYSICS PARAMETERS ---
    const [params, setParams] = useState({
        c: 0.5, damp: 0.001, freq: 0.3, width: 20, 
        bcLeft: 'fixed', bcRight: 'absorb',
        srcType: 'pulse' // pulse, chirp, cw, custom
    });
    const [probes, setProbes] = useState({ a: 50, b: 350 });
    const [customEqs, setCustomEqs] = useState({
        matN: "1.0", matG: "0.0", src: "sin(t*freq) * 10"
    });
    // Use Ref for telemetry to prevent high-frequency re-renders
    const telemetryRef = useRef({ energy: 0, trans: 0, time: 0 });
    // We trigger a re-render for UI updates at a lower rate
    const [uiTick, setUiTick] = useState(0); 

    // --- PHYSICS ENGINE REFS ---
    const N = 400;
    const physics = useRef({
        u: new Float64Array(N),
        u_prev: new Float64Array(N),
        u_next: new Float64Array(N),
        cMap: new Float64Array(N).fill(1.0),
        gainMap: new Float64Array(N).fill(0.0),
        t: 0,
        scopeA: new Float64Array(256),
        scopeB: new Float64Array(256),
        phaseHistory: []
    });

    // --- CANVAS & AUDIO REFS ---
    const mainRef = useRef(null);
    const deckRef = useRef(null);
    const reqRef = useRef(null);
    const audioCtx = useRef(null); // { ctx, osc, gain }

    // --- INITIALIZATION ---
    useEffect(() => {
        // Init Audio Context (Suspended)
        if (!audioCtx.current) {
            const AC = window.AudioContext || window.webkitAudioContext;
            const ctx = new AC();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.start();
            gain.gain.value = 0;
            audioCtx.current = { ctx, osc, gain, enabled: false };
        }
        
        // Resize Observer to keep canvases sharp
        const resizeCanvas = (canvas) => {
            if(!canvas) return;
            const parent = canvas.parentElement;
            if(parent) {
                canvas.width = parent.clientWidth;
                canvas.height = parent.clientHeight;
            }
        };

        const ro = new ResizeObserver(entries => {
            if(mainRef.current) resizeCanvas(mainRef.current);
            if(deckRef.current) resizeCanvas(deckRef.current);
        });

        if(mainRef.current) ro.observe(mainRef.current.parentElement);
        if(deckRef.current) ro.observe(deckRef.current.parentElement);

        return () => ro.disconnect();
    }, []);

    // --- MATH PARSER ---
    const safeEval = (expr, vars) => {
        try {
            let code = expr.toLowerCase();
            ['sin', 'cos', 'tan', 'exp', 'pow', 'sqrt', 'abs', 'log', 'pi'].forEach(k => {
                code = code.replace(new RegExp(`(?<!Math\\.)\\b${k}\\b`, 'g'), `Math.${k==='pi'?'PI':k}`);
            });
            const f = new Function(...Object.keys(vars), `return ${code};`);
            return f(...Object.values(vars));
        } catch(e) { return 0; }
    };

    // --- AUDIO ENGINE ---
    const toggleAudio = () => {
        if (audioCtx.current) {
            if (audioCtx.current.ctx.state === 'suspended') audioCtx.current.ctx.resume();
            audioCtx.current.enabled = !audioCtx.current.enabled;
            if (!audioCtx.current.enabled) audioCtx.current.gain.gain.setTargetAtTime(0, audioCtx.current.ctx.currentTime, 0.1);
            if(toast) toast(audioCtx.current.enabled ? "Sonification ON" : "Sonification OFF");
        }
    };

    const updateSonification = (val) => {
        if (audioCtx.current && audioCtx.current.enabled) {
            const { ctx, osc, gain } = audioCtx.current;
            const pitch = 100 + (Math.abs(val) * 800);
            const vol = Math.min(0.15, Math.abs(val) * 0.15);
            osc.frequency.setTargetAtTime(pitch, ctx.currentTime, 0.05);
            gain.gain.setTargetAtTime(vol, ctx.currentTime, 0.05);
        }
    };

    // --- GAME LOOP ---
    useEffect(() => {
        const computeFFT = (data) => {
            const size = 64; 
            const step = Math.floor(data.length/size); 
            const out = new Float32Array(size/2);
            for(let k=0; k<size/2; k++) {
                let re=0, im=0;
                for(let n=0; n<size; n++) {
                    const angle = (2*Math.PI * k * n) / size;
                    re += data[n*step] * Math.cos(angle);
                    im -= data[n*step] * Math.sin(angle);
                }
                out[k] = Math.sqrt(re*re + im*im);
            }
            return out;
        };

        const drawMain = (ctx, w, h) => {
            ctx.fillStyle = '#020202'; ctx.fillRect(0,0,w,h);
            const p = physics.current;
            const step = w/N;
            const cx = w/2, cy = h/2;
            const fov = 300;
            const rotY = view3D ? 30 * Math.PI/180 : 0;
            const rotX = view3D ? 20 * Math.PI/180 : 0;
            
            const project = (x,y,z) => {
                let x1 = x*Math.cos(rotY) - z*Math.sin(rotY); let z1 = x*Math.sin(rotY) + z*Math.cos(rotY);
                let y2 = y*Math.cos(rotX) - z1*Math.sin(rotX); let z2 = y*Math.sin(rotX) + z1*Math.cos(rotX);
                const scale = fov / (fov + z2 + 300);
                return { x: cx + x1*scale, y: cy + y2*scale, s: scale };
            };

            // Draw Materials
            for(let i=0; i<N; i++) {
                let fill = null;
                if(p.gainMap[i]>0) fill=`rgba(0,255,157,${p.gainMap[i]*10})`;
                else if(p.gainMap[i]<0) fill='rgba(255,0,85,0.3)';
                else if(p.cMap[i]>1.2) fill='rgba(0,243,255,0.2)';
                
                if(fill) {
                    if(view3D) {
                        const pt = project((i/N-0.5)*400, 50, 0);
                        if(pt.s > 0) {
                            ctx.fillStyle = fill; ctx.fillRect(pt.x, pt.y, 2*pt.s, 10*pt.s);
                        }
                    } else {
                        ctx.fillStyle = fill; ctx.fillRect(i*step, 0, step+1, h);
                    }
                }
            }

            // Draw Probes
            if(!view3D) {
                ctx.strokeStyle = '#00f3ff'; ctx.strokeRect(probes.a*step, 0, 1, h);
                ctx.strokeStyle = '#ffaa00'; ctx.strokeRect(probes.b*step, 0, 1, h);
            }

            // Draw Wave
            ctx.beginPath();
            ctx.lineWidth = view3D ? 3 : 2;
            ctx.strokeStyle = isQuantum ? '#bc13fe' : '#00f3ff';
            ctx.shadowBlur = 10; ctx.shadowColor = ctx.strokeStyle;
            let started = false;
            for(let i=0; i<N; i++) {
                let val = isQuantum ? (p.u[i]**2)*5 : p.u[i]*10;
                let pt = view3D ? project((i/N-0.5)*400, -val, 0) : {x: i*step, y: h/2 - val};
                if(view3D && pt.s <= 0) continue;
                if(!started) { ctx.moveTo(pt.x, pt.y); started=true; } else ctx.lineTo(pt.x, pt.y);
            }
            ctx.stroke(); ctx.shadowBlur = 0;
        };

        const drawDeck = (ctx, w, h) => {
            const p = physics.current;
            if(activeTab === 'scope') {
                ctx.fillStyle = '#0f172a'; ctx.fillRect(0,0,w,h);
                ctx.strokeStyle = '#333'; ctx.beginPath(); ctx.moveTo(0,h/2); ctx.lineTo(w,h/2); ctx.stroke();
                const drawTrace = (arr, col) => {
                    ctx.beginPath(); ctx.strokeStyle = col;
                    for(let i=0; i<256; i++) { const x = i*(w/256); const y = h/2 - arr[i]*5; if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); }
                    ctx.stroke();
                };
                drawTrace(p.scopeA, '#00f3ff'); drawTrace(p.scopeB, '#ffaa00');
            } else if (activeTab === 'spectro') {
                ctx.drawImage(ctx.canvas, 1, 0, w-1, h, 0, 0, w-1, h);
                const fft = computeFFT(p.scopeB);
                const ch = h/fft.length;
                for(let i=0; i<fft.length; i++) {
                    const val = Math.min(255, fft[i]*200);
                    ctx.fillStyle = `hsl(${240-val}, 100%, 50%)`;
                    ctx.fillRect(w-2, h-(i+1)*ch, 2, ch+1);
                }
            } else if (activeTab === 'phase') {
                if(phaseTrails) { ctx.fillStyle='rgba(15,23,42,0.1)'; ctx.fillRect(0,0,w,h); } else ctx.clearRect(0,0,w,h);
                ctx.strokeStyle = '#334155'; ctx.beginPath(); ctx.moveTo(0,h/2); ctx.lineTo(w,h/2); ctx.moveTo(w/2,0); ctx.lineTo(w/2,h); ctx.stroke();
                ctx.beginPath(); ctx.strokeStyle = '#00ff9d';
                if(p.phaseHistory.length > 1) {
                    p.phaseHistory.forEach((pt, i) => { const x=w/2+pt.u*20; const y=h/2-pt.v*5; if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
                    ctx.stroke();
                }
                const last = p.phaseHistory[p.phaseHistory.length-1];
                if(last) { ctx.fillStyle='#fff'; ctx.beginPath(); ctx.arc(w/2+last.u*20, h/2-last.v*5, 3, 0, 7); ctx.fill(); }
            } else if (activeTab === 'xt') {
                ctx.drawImage(ctx.canvas, 0, 0, w, h-1, 0, 1, w, h-1);
                const id = ctx.createImageData(w,1);
                for(let x=0; x<w; x++) {
                    const idx = Math.floor((x/w)*N); const val = p.u[idx]*10;
                    let r=0,g=0,b=0; if(val>0){r=Math.min(255,val*10); g=r*0.2;} else{b=Math.min(255,Math.abs(val)*10); g=b*0.2;}
                    if(p.gainMap[idx]>0) g+=50;
                    id.data[x*4]=r; id.data[x*4+1]=g; id.data[x*4+2]=b; id.data[x*4+3]=255;
                }
                ctx.putImageData(id, 0, 0);
            }
        };

        const loop = () => {
            if(!playing) { reqRef.current = requestAnimationFrame(loop); return; }
            const p = physics.current;
            
            // Source Logic
            if(params.srcType === 'custom') {
                const val = safeEval(customEqs.src, {t: p.t, freq: params.freq, width: params.width});
                if(!isNaN(val)) { p.u[probes.a] += val; p.u_prev[probes.a] += val; }
            } else if (params.srcType === 'cw') {
                const val = Math.sin(p.t * params.freq) * 10;
                p.u[probes.a] += val; p.u_prev[probes.a] += val;
            } else if (params.srcType === 'pulse' && p.t % 200 === 10) {
                for(let i=0; i<N; i++) { let x=i-probes.a; let val=Math.exp(-(x*x)/(params.width*params.width))*20; p.u[i] += val; p.u_prev[i] += val; }
            } else if (params.srcType === 'chirp' && p.t === 10) {
                for(let i=0; i<N; i++) { let x=i-probes.a; let val=Math.exp(-(x*x)/(params.width*params.width*4)) * Math.sin(0.05*x*x)*20; p.u[i] += val; p.u_prev[i] += val; }
            }

            // FDTD Update
            for(let i=1; i<N-1; i++) {
                const lap = p.u[i+1] - 2*p.u[i] + p.u[i-1];
                const localC = params.c / p.cMap[i];
                const acc = (localC*localC) * lap;
                const vel = p.u[i] - p.u_prev[i];
                const damp = params.damp - p.gainMap[i];
                p.u_next[i] = 2*p.u[i] - p.u_prev[i] + acc - (damp * vel);
                if(Math.abs(p.u_next[i])>100) p.u_next[i]*=0.5; // Stability clamp
            }

            // BCs
            if(params.bcLeft==='fixed') p.u_next[0]=0; else if(params.bcLeft==='free') p.u_next[0]=p.u_next[1]; else if(params.bcLeft==='harmonic') p.u_next[0]=Math.sin(p.t*params.freq)*20;
            if(params.bcRight==='fixed') p.u_next[N-1]=0; else if(params.bcRight==='absorb') p.u_next[N-1]=p.u[N-2]*(1.0-params.damp-0.1);

            for(let i=0; i<N; i++) { p.u_prev[i]=p.u[i]; p.u[i]=p.u_next[i]; }
            p.t++;

            // Data Collection
            for(let i=0; i<255; i++) { p.scopeA[i]=p.scopeA[i+1]; p.scopeB[i]=p.scopeB[i+1]; }
            p.scopeA[255] = p.u[probes.a]; p.scopeB[255] = p.u[probes.b];

            // Phase Tracking
            const phasePt = {u: p.u[probes.b], v: (p.u[probes.b]-p.u_prev[probes.b])*10};
            if(phaseTrails) { p.phaseHistory.push(phasePt); if(p.phaseHistory.length>300) p.phaseHistory.shift(); } else p.phaseHistory=[phasePt];

            // Telemetry Update (Throttled)
            if(p.t%10===0) {
                let e=0; for(let i=0; i<N; i++) e+=p.u[i]**2;
                let rmsA=0, rmsB=0; for(let i=0; i<256; i++) { rmsA+=p.scopeA[i]**2; rmsB+=p.scopeB[i]**2; }
                const db = 10 * Math.log10((rmsB+1e-9)/(rmsA+1e-9));
                telemetryRef.current = { energy: e, trans: db, time: p.t };
                setUiTick(t => t+1); // Trigger React render for stats
                updateSonification(p.u[probes.b]);
            }

            // Render
            if(mainRef.current) drawMain(mainRef.current.getContext('2d'), mainRef.current.width, mainRef.current.height);
            if(deckRef.current) drawDeck(deckRef.current.getContext('2d', {willReadFrequently: true}), deckRef.current.width, deckRef.current.height);

            reqRef.current = requestAnimationFrame(loop);
        };
        reqRef.current = requestAnimationFrame(loop);
        return () => cancelAnimationFrame(reqRef.current);
    }, [playing, params, probes, customEqs, view3D, activeTab, isQuantum, phaseTrails]);

    // --- INTERACTIONS ---
    const handleInteract = (e) => {
        if(!mainRef.current) return;
        const rect = mainRef.current.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        const x = clientX - rect.left;
        const y = clientY - rect.top;
        const idx = Math.floor((x/rect.width)*N);
        const p = physics.current;
        
        if(activeTool === 'none') {
            if(idx>0 && idx<N) { p.u[idx] = (rect.height/2 - y)*0.1; p.u_prev[idx]=p.u[idx]; }
        } else {
            const r = Math.floor(N/20);
            for(let i=Math.max(0,idx-r); i<Math.min(N,idx+r); i++) {
                if(activeTool==='glass') { p.cMap[i]=1.5; p.gainMap[i]=0; }
                if(activeTool==='gain') { p.cMap[i]=1.0; p.gainMap[i]=0.05; }
                if(activeTool==='absorb') { p.cMap[i]=1.0; p.gainMap[i]=-0.2; }
            }
        }
    };

    const applyEqs = () => {
        const p = physics.current;
        for(let i=0; i<N; i++) {
            p.cMap[i] = safeEval(customEqs.matN, {x: i, N: N});
            p.gainMap[i] = safeEval(customEqs.matG, {x: i, N: N});
        }
        if(toast) toast("Material Equations Applied");
    };

    const loadScenario = (type) => {
        const p = physics.current;
        p.u.fill(0); p.u_prev.fill(0); p.cMap.fill(1.0); p.gainMap.fill(0.0);
        setParams(prev => ({...prev, srcType: 'custom'})); 
        
        if(type==='laser') {
            for(let i=Math.floor(N*0.3); i<Math.floor(N*0.7); i++) { p.cMap[i]=1.0; p.gainMap[i]=0.03; }
            p.u[200]=1; p.u_prev[200]=1;
            setParams(prev => ({...prev, bcLeft:'fixed', bcRight:'fixed'}));
        } else if(type==='tunnel') {
            setIsQuantum(true); for(let i=180; i<220; i++) p.cMap[i]=0.1;
            setParams(prev => ({...prev, srcType:'pulse'}));
        } else if(type==='filter') {
            for(let i=100; i<300; i+=20) { for(let j=0; j<10; j++) p.cMap[i+j]=2.0; }
            setParams(prev => ({...prev, srcType:'chirp'}));
        }
    };

    const generatePDF = () => {
        const doc = new jspdf.jsPDF();
        doc.setFillColor(0,0,0); doc.rect(0,0,210,297,'F');
        doc.setTextColor(0,243,255); doc.setFontSize(20); doc.text("MAXWELL OMNI-SCIENCE REPORT", 105, 20, null, null, "center");
        doc.setFontSize(10); doc.setTextColor(200,200,200); doc.text(new Date().toLocaleString(), 105, 30, null, null, "center");
        
        if(mainRef.current) doc.addImage(mainRef.current.toDataURL('image/jpeg'), 'JPEG', 10, 40, 190, 80);
        if(deckRef.current) doc.addImage(deckRef.current.toDataURL('image/jpeg'), 'JPEG', 10, 130, 190, 80);
        
        doc.text(`Energy: ${telemetryRef.current.energy.toFixed(1)} | Trans: ${telemetryRef.current.trans.toFixed(1)} dB`, 10, 220);
        doc.save("maxwell_report.pdf");
    };

    // --- RENDER ---
    return (
        <div className={`flex flex-col h-[calc(100dvh-60px)] -m-4 relative ${fullScreen ? 'fixed inset-0 z-50 m-0 bg-[#050505]' : 'bg-[#050505]'}`}>
            
            {/* HEADER */}
            <div className="flex justify-between items-center p-2 border-b border-[#222] bg-black shrink-0 h-[50px]">
                <div className="text-xs font-bold text-[#00f3ff] tracking-widest pl-2 font-display">MAXWELL <span className="text-[#555]">OMNI-SCIENCE</span></div>
                <div className="flex gap-1">
                    <button onClick={toggleAudio} className={`w-8 h-8 flex items-center justify-center border rounded transition ${audioCtx.current?.enabled ? 'border-[#ffaa00] text-[#ffaa00] shadow-[0_0_10px_rgba(255,170,0,0.3)]' : 'border-[#222] text-[#888]'}`}><i className="fas fa-volume-up"></i></button>
                    <button onClick={generatePDF} className="w-8 h-8 flex items-center justify-center border border-[#222] text-[#888] rounded hover:text-white"><i className="fas fa-file-pdf"></i></button>
                    <button onClick={()=>setFullScreen(!fullScreen)} className="w-8 h-8 flex items-center justify-center border border-[#222] text-[#888] rounded hover:text-white"><i className={`fas fa-${fullScreen?'compress':'expand'}`}></i></button>
                </div>
            </div>

            {/* MAIN GRID */}
            <div className={`flex-1 grid ${fullScreen ? 'grid-cols-[320px_1fr_320px]' : 'lg:grid-cols-[280px_1fr_280px] grid-cols-1'} overflow-hidden min-h-0`}>
                
                {/* LEFT PANEL */}
                <div className={`bg-[#0e1012] border-r border-[#222] flex flex-col overflow-y-auto ${!fullScreen ? 'hidden lg:flex' : ''}`}>
                    
                    {/* Material Brushes */}
                    <div className="p-3 border-b border-[#222]">
                        <div className="text-[10px] font-bold text-[#00f3ff] mb-2 cursor-pointer flex justify-between items-center" onClick={()=>setSections(s=>({...s, tools:!s.tools}))}>MATERIAL BRUSHES <i className={`fas fa-chevron-${sections.tools?'down':'right'}`}></i></div>
                        {sections.tools && (
                            <div className="space-y-2 animate-fade-in">
                                <div className="bg-black border border-[#333] p-2 text-[#aaa] text-[9px] font-mono relative">
                                    <div className="absolute top-0 left-1 text-[8px] text-[#444] font-bold">EQUATION</div>
                                    <Latex tex="n(x) = \sqrt{\epsilon_r \mu_r}" dark={true} />
                                </div>
                                <div className="bg-[#151515] border border-[#333] p-2 rounded">
                                    <div className="text-[9px] text-[#888] mb-1">Refractive Index n(x):</div> <input value={customEqs.matN} onChange={e=>setCustomEqs({...customEqs, matN:e.target.value})} className="w-full bg-[#111] border border-[#333] text-[#00ff9d] text-[10px] p-1 mb-2 font-mono outline-none focus:border-[#00ff9d]" />
                                    <div className="text-[9px] text-[#888] mb-1">Gain/Loss g(x):</div> <input value={customEqs.matG} onChange={e=>setCustomEqs({...customEqs, matG:e.target.value})} className="w-full bg-[#111] border border-[#333] text-[#00ff9d] text-[10px] p-1 font-mono outline-none focus:border-[#00ff9d]" />
                                    <button onClick={applyEqs} className="w-full mt-2 border border-[#ffaa00] text-[#ffaa00] text-[9px] py-1 hover:bg-[#ffaa00]/10 rounded font-bold">APPLY EQUATIONS</button>
                                </div>
                                <div className="grid grid-cols-2 gap-1">
                                    {[
                                        {id:'none', label:'INTERACT', icon:'hand-paper', col:'#fff'},
                                        {id:'glass', label:'GLASS (n=1.5)', icon:'square', col:'#00f3ff'},
                                        {id:'gain', label:'LASER GAIN', icon:'bolt', col:'#00ff9d'},
                                        {id:'absorb', label:'ABSORBER', icon:'eraser', col:'#ff0055'}
                                    ].map(t => (
                                        <button key={t.id} onClick={()=>setActiveTool(t.id)} className={`p-3 bg-[#111] border rounded ${activeTool===t.id ? `border-[${t.col}] text-[${t.col}] shadow-[inset_0_0_10px_${t.col}20]` : 'border-[#222] text-[#666]'} text-[9px] flex flex-col items-center gap-1 hover:bg-[#1a1a1a] transition-all`}>
                                            <i className={`fas fa-${t.icon} text-lg`}></i> {t.label}
                                        </button>
                                    ))}
                                </div>
                                <button onClick={()=>{physics.current.cMap.fill(1); physics.current.gainMap.fill(0); if(toast) toast("Map Cleared");}} className="w-full mt-1 border border-[#333] text-[#888] text-[9px] py-1.5 hover:bg-[#222] rounded flex items-center justify-center gap-2"><i className="fas fa-trash"></i> CLEAR MATERIALS</button>
                            </div>
                        )}
                    </div>

                    {/* Signal Generator */}
                    <div className="p-3 border-b border-[#222]">
                        <div className="text-[10px] font-bold text-[#00f3ff] mb-2 cursor-pointer flex justify-between items-center" onClick={()=>setSections(s=>({...s, gen:!s.gen}))}>SIGNAL GENERATOR <i className={`fas fa-chevron-${sections.gen?'down':'right'}`}></i></div>
                        {sections.gen && (
                            <div className="space-y-2 animate-fade-in">
                                <div className="bg-black border border-[#333] p-2 text-[#aaa] text-[9px] font-mono relative">
                                    <div className="absolute top-0 left-1 text-[8px] text-[#444] font-bold">SOURCE f(t)</div>
                                    <Latex tex="A e^{-(t-t_0)^2/w^2}" dark={true} />
                                </div>
                                <input value={customEqs.src} onChange={e=>{setCustomEqs({...customEqs, src:e.target.value}); setParams({...params, srcType:'custom'})}} className="w-full bg-[#111] border border-[#333] text-[#00ff9d] text-[10px] p-1 font-mono outline-none focus:border-[#00ff9d]" placeholder="Custom Eq..." />
                                <div className="space-y-1">
                                    <ParamInput label="Carrier Freq (Ï‰)" val={params.freq} set={v=>setParams({...params, freq:v})} step="0.05" min="0.1" max="1.2" />
                                    <ParamInput label="Pulse Width (w)" val={params.width} set={v=>setParams({...params, width:v})} step="1" min="5" max="50" />
                                </div>
                                <div className="flex gap-1">
                                    <button onClick={()=>setParams({...params, srcType:'pulse'})} className={`flex-1 border ${params.srcType==='pulse'?'border-[#ff0055] text-[#ff0055] bg-[#ff0055]/10':'border-[#333] text-[#666]'} text-[9px] py-1.5 rounded transition`}>PULSE</button>
                                    <button onClick={()=>setParams({...params, srcType:'chirp'})} className={`flex-1 border ${params.srcType==='chirp'?'border-[#ff0055] text-[#ff0055] bg-[#ff0055]/10':'border-[#333] text-[#666]'} text-[9px] py-1.5 rounded transition`}>CHIRP</button>
                                </div>
                                <button onClick={()=>{setParams({...params, srcType: params.srcType==='cw'?'pulse':'cw'})}} className={`w-full border ${params.srcType==='cw'?'border-[#ffaa00] text-[#ffaa00] shadow-[0_0_10px_rgba(255,170,0,0.2)]':'border-[#333] text-[#888]'} text-[9px] py-1.5 rounded transition`}>CONTINUOUS WAVE</button>
                            </div>
                        )}
                    </div>
                </div>

                {/* CENTER VIZ */}
                <div className="flex flex-col bg-[#020202] border-r border-[#222] min-h-0">
                    {/* Canvas Area */}
                    <div className="relative h-[60%] border-b border-[#222]">
                        <canvas 
                            ref={mainRef}
                            className="w-full h-full block cursor-crosshair touch-none"
                            onMouseDown={(e)=>{if(activeTool!=='none') handleInteract(e)}}
                            onMouseMove={(e)=>{if((e.buttons===1 || (e.touches && e.touches.length>0)) && activeTool!=='none') handleInteract(e)}}
                            onClick={(e)=>{if(activeTool==='none') handleInteract(e)}}
                            onTouchStart={(e)=>{if(activeTool!=='none') handleInteract(e)}}
                            onTouchMove={(e)=>{if(activeTool!=='none') handleInteract(e)}}
                        />
                        <div className="absolute top-3 left-3 border-l-[3px] border-[#00f3ff] bg-black/80 px-2 py-0.5 text-[10px] text-white font-mono pointer-events-none">FIELD AMPLITUDE (E)</div>
                        <div className="absolute bottom-3 right-3 text-xl text-white/20 pointer-events-none"><Latex tex="\partial^2_t u = c^2 \nabla^2 u" dark={true} /></div>
                    </div>

                    {/* Analysis Deck */}
                    <div className="flex-1 flex flex-col bg-[#080808] min-h-0">
                        <div className="flex bg-black border-b border-[#222] overflow-x-auto no-scrollbar shrink-0 h-[35px]">
                            {[
                                {id:'scope', icon:'wave-square'}, {id:'spectro', icon:'water'}, 
                                {id:'bode', icon:'chart-bar'}, {id:'phase', icon:'circle-notch'}, {id:'xt', icon:'stream'}
                            ].map(t => (
                                <button key={t.id} onClick={()=>setActiveTab(t.id)} className={`flex-1 px-4 border-r border-[#222] text-[9px] flex items-center justify-center gap-2 hover:bg-[#111] transition ${activeTab===t.id ? 'text-[#00f3ff] bg-[#151515] border-t-2 border-t-[#00f3ff]' : 'text-[#666]'}`}>
                                    <i className={`fas fa-${t.icon}`}></i> {t.id.toUpperCase()}
                                </button>
                            ))}
                        </div>
                        <div className="relative flex-1 min-h-0">
                            <canvas ref={deckRef} className="w-full h-full block" />
                            <div className="absolute top-2 left-2 pointer-events-none">
                                <span className="bg-black/80 px-2 py-0.5 text-[10px] text-white border-l-[3px]" style={{borderColor: activeTab==='scope'?'#ffaa00':activeTab==='spectro'?'#ff0055':activeTab==='phase'?'#00ff9d':'#fff'}}>
                                    {activeTab.toUpperCase()}
                                </span>
                            </div>
                            {activeTab==='phase' && (
                                <button onClick={()=>setPhaseTrails(!phaseTrails)} className={`absolute top-2 right-2 border px-2 py-0.5 text-[9px] rounded ${phaseTrails?'border-[#00ff9d] text-[#00ff9d] bg-[#00ff9d]/10':'border-[#333] text-[#666]'}`}>TRAILS: {phaseTrails?'ON':'OFF'}</button>
                            )}
                        </div>
                    </div>
                </div>

                {/* RIGHT PANEL */}
                <div className={`bg-[#0e1012] flex flex-col overflow-y-auto ${!fullScreen ? 'hidden lg:flex' : ''}`}>
                    
                    {/* Render Modes */}
                    <div className="p-3 border-b border-[#222]">
                        <div className="text-[10px] font-bold text-[#00f3ff] mb-2 cursor-pointer flex justify-between items-center" onClick={()=>setSections(s=>({...s, modes:!s.modes}))}>RENDER MODES <i className={`fas fa-chevron-${sections.modes?'down':'right'}`}></i></div>
                        {sections.modes && (
                            <div className="animate-fade-in space-y-2">
                                <div className="bg-black border border-[#333] p-2 text-[#aaa] text-[9px] font-mono text-center"><Latex tex="I = |u|^2" dark={true} /></div>
                                <button onClick={()=>setIsQuantum(!isQuantum)} className={`w-full border ${isQuantum ? 'border-[#bc13fe] text-[#bc13fe] bg-[#bc13fe]/10' : 'border-[#333] text-[#aaa]'} text-[9px] py-2 rounded flex items-center justify-center gap-2 transition`}>
                                    <i className={`fas fa-${isQuantum?'atom':'eye'}`}></i> MODE: {isQuantum?'QUANTUM':'CLASSICAL'}
                                </button>
                                <button onClick={()=>setView3D(!view3D)} className={`w-full border ${view3D ? 'border-[#00f3ff] text-[#00f3ff] bg-[#00f3ff]/10' : 'border-[#333] text-[#aaa]'} text-[9px] py-2 rounded flex items-center justify-center gap-2 transition`}>
                                    <i className="fas fa-cube"></i> 3D VIEW
                                </button>
                                <div className="flex gap-1 pt-1">
                                    <button onClick={()=>setPlaying(!playing)} className={`flex-1 border ${playing?'border-[#333] text-[#888]':'border-[#00f3ff] text-[#00f3ff]'} text-[9px] py-2 rounded`}><i className={`fas fa-${playing?'pause':'play'}`}></i></button>
                                    <button onClick={()=>{physics.current.u.fill(0); physics.current.u_prev.fill(0); physics.current.t=0; if(toast) toast("Sim Reset");}} className="flex-1 border border-[#333] text-[#888] hover:text-white text-[9px] py-2 rounded"><i className="fas fa-redo"></i> RESET</button>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Probes */}
                    <div className="p-3 border-b border-[#222]">
                        <div className="text-[10px] font-bold text-[#00f3ff] mb-2 cursor-pointer flex justify-between items-center" onClick={()=>setSections(s=>({...s, probes:!s.probes}))}>PROBE MANAGER <i className={`fas fa-chevron-${sections.probes?'down':'right'}`}></i></div>
                        {sections.probes && (
                            <div className="animate-fade-in space-y-2">
                                <div className="bg-black border border-[#333] p-2 text-[#aaa] text-[9px] font-mono text-center">$$x_A = {probes.a}, \quad x_B = {probes.b}$$</div>
                                <div>
                                    <div className="flex justify-between text-[9px] text-[#00f3ff] mb-1 font-mono"><span>Probe A (In)</span> <span>{probes.a}</span></div>
                                    <input type="range" min="0" max="400" value={probes.a} onChange={e=>setProbes({...probes, a:parseInt(e.target.value)})} className="w-full h-1 bg-[#222] appearance-none rounded" />
                                </div>
                                <div>
                                    <div className="flex justify-between text-[9px] text-[#ffaa00] mb-1 font-mono"><span>Probe B (Out)</span> <span>{probes.b}</span></div>
                                    <input type="range" min="0" max="400" value={probes.b} onChange={e=>setProbes({...probes, b:parseInt(e.target.value)})} className="w-full h-1 bg-[#222] appearance-none rounded" />
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Physics Params */}
                    <div className="p-3 border-b border-[#222]">
                        <div className="text-[10px] font-bold text-[#00f3ff] mb-2 cursor-pointer flex justify-between items-center" onClick={()=>setSections(s=>({...s, params:!s.params}))}>PHYSICS PARAMS <i className={`fas fa-chevron-${sections.params?'down':'right'}`}></i></div>
                        {sections.params && (
                            <div className="animate-fade-in space-y-1">
                                <ParamInput label="Vacuum C" val={params.c} set={v=>setParams({...params, c:v})} step="0.01" min="0.1" max="1.0" />
                                <ParamInput label="Damping" val={params.damp} set={v=>setParams({...params, damp:v})} step="0.001" min="0" max="0.05" />
                                <div className="mt-2 text-[9px] text-[#666] mb-1 font-bold">BOUNDARY CONDITIONS</div>
                                <div className="flex gap-1 mb-2">
                                    <div className="text-[8px] text-[#555] w-8 pt-1">LEFT</div>
                                    {['fixed','free','harmonic'].map(bc=>(<button key={bc} onClick={()=>setParams({...params, bcLeft:bc})} className={`flex-1 border ${params.bcLeft===bc?'border-[#ccc] text-[#fff] bg-[#333]':'border-[#333] text-[#555]'} text-[8px] py-1 rounded transition`}>{bc.substr(0,4).toUpperCase()}</button>))}
                                </div>
                                <div className="flex gap-1">
                                    <div className="text-[8px] text-[#555] w-8 pt-1">RIGHT</div>
                                    {['fixed','absorb'].map(bc=>(<button key={bc} onClick={()=>setParams({...params, bcRight:bc})} className={`flex-1 border ${params.bcRight===bc?'border-[#ccc] text-[#fff] bg-[#333]':'border-[#333] text-[#555]'} text-[8px] py-1 rounded transition`}>{bc.toUpperCase()}</button>))}
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Presets */}
                    <div className="p-3 border-b border-[#222]">
                        <div className="text-[10px] font-bold text-[#00f3ff] mb-2 cursor-pointer flex justify-between items-center" onClick={()=>setSections(s=>({...s, scenarios:!s.scenarios}))}>PRESETS <i className={`fas fa-chevron-${sections.scenarios?'down':'right'}`}></i></div>
                        {sections.scenarios && (
                            <div className="space-y-1 animate-fade-in">
                                {[
                                    {id:'laser', label:'LASER CAVITY', desc:'Gain medium with mirrors'},
                                    {id:'tunnel', label:'QUANTUM TUNNEL', desc:'Barrier penetration'},
                                    {id:'filter', label:'BRAGG FILTER', desc:'Periodic structure'}
                                ].map(s => (
                                    <button key={s.id} className="w-full text-left p-2 border border-[#222] hover:border-[#444] text-[#aaa] hover:text-white bg-[#111] hover:bg-[#1a1a1a] rounded transition group" onClick={()=>loadScenario(s.id)}>
                                        <div className="text-[9px] font-bold text-[#00f3ff] group-hover:text-white">{s.label}</div>
                                        <div className="text-[8px] text-[#555] group-hover:text-[#777]">{s.desc}</div>
                                    </button>
                                ))}
                            </div>
                        )}
                    </div>

                    {/* Telemetry */}
                    <div className="p-3 mt-auto bg-[#080808] border-t border-[#222]">
                        <div className="text-[10px] font-bold text-[#444] mb-2 tracking-widest">REAL-TIME TELEMETRY</div>
                        <div className="flex justify-between text-[9px] text-[#888] border-b border-[#222] py-1 font-mono"><span>Total Energy</span> <span className="text-[#00ff9d]">{telemetryRef.current.energy.toFixed(1)}</span></div>
                        <div className="flex justify-between text-[9px] text-[#888] border-b border-[#222] py-1 font-mono"><span>Transmission</span> <span className="text-[#00ff9d]">{telemetryRef.current.trans.toFixed(1)} dB</span></div>
                        <div className="flex justify-between text-[9px] text-[#888] py-1 font-mono"><span>Time Step</span> <span className="text-[#00ff9d]">{telemetryRef.current.time}</span></div>
                    </div>
                </div>
            </div>

            {/* Mobile Toggle */}
            {!fullScreen && (
                <button onClick={()=>setFullScreen(true)} className="fixed bottom-24 right-4 w-12 h-12 bg-[#ff0055] text-white rounded-full flex items-center justify-center shadow-[0_0_20px_rgba(255,0,85,0.4)] z-50 lg:hidden border-2 border-white/20 backdrop-blur">
                    <i className="fas fa-expand"></i>
                </button>
            )}

            <style>{`
                .no-scrollbar::-webkit-scrollbar { display: none; }
                input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 12px; height: 12px; background: #00f3ff; border: 2px solid #000; border-radius: 50%; cursor: pointer; }
                .animate-fade-in { animation: fadeIn 0.3s ease-out; }
                @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
            `}</style>
        </div>
    );
};
// --- SIMULATION FALLBACK ---
const SimCanvasFallback = ({ type }) => {
    return <div className="rounded-xl overflow-hidden mt-4 shadow-inner border border-white/10 h-60 flex items-center justify-center bg-black/50 text-slate-500 font-mono text-xs">Module {type} Loading...</div>;
};

// --- MAIN APP COMPONENT ---
const App = () => {
    const [view, setView] = useLocalStorage('simux_view', 'home'); 
    const [sim, setSim] = useState(null); 
    const [menu, setMenu] = useState(false);
    const vibrate = useHaptics();
    const audio = useAudioEngine();
    const { mode } = useUIAdaptation();

    useEffect(() => {
        const loader = document.getElementById('loader');
        if (loader) { loader.style.opacity = '0'; setTimeout(() => loader.remove(), 500); }
    }, []);

    const PROFILE = { name: "Abhishek Kumar", role: "Physics Faculty (9+ yrs)", details: ["B.Tech (CSE)", "Ex-Faculty: Jaipuria School", "Ex-Faculty: S.P. College Pune", "Expert: Python, LaTeX"] };
    
    const SIMS = [ 
        { id: 'orbit', title: 'N-Body ODE Solver', desc: 'Solar System, Chaos & Custom ODEs', color: 'text-indigo-400', iconBg: 'bg-indigo-500/20' }, 
        { id: 'em', title: 'Electromagnetism', desc: 'Maxwell & Lorentz Dynamics', color: 'text-violet-400', iconBg: 'bg-violet-500/20' }, 
        { id: 'quantum', title: 'Quantum Mechanics', desc: 'SchrÃ¶dinger & Wells', color: 'text-cyan-400', iconBg: 'bg-cyan-500/20' },
        { id: 'thermo', title: 'Thermodynamics', desc: 'Stat Mech & 3 Laws', color: 'text-amber-400', iconBg: 'bg-amber-500/20' }, 
        { id: 'wave', title: 'Wave Motion', desc: 'String, Sound, & Ripples', color: 'text-pink-400', iconBg: 'bg-pink-500/20' }, 
        { id: 'optics', title: 'Ray Optics', desc: 'Lenses & Mirrors', color: 'text-yellow-400', iconBg: 'bg-yellow-500/20' },
        { id: 'relativity', title: 'Relativity', desc: 'Aberration & Speed of Light', color: 'text-emerald-400', iconBg: 'bg-emerald-500/20' },
        { id: 'maxwell', title: 'Maxwell FDTD', desc: 'Omni-Science Engine', color: 'text-green-400', iconBg: 'bg-green-500/20' }, 
    ];

    const BOOKS = [ 
        { id: 1, title: "Electronics and Circuits", desc: "Analog & Digital Systems", color: "text-purple-400 border-purple-500/30", links: [ { label: "Google Play", url: "https://play.google.com/store/books/details?id=retaEQAAQBAJ" }, { label: "Audiobook", url: "https://play.google.com/store/audiobooks/details?id=AQAAAEBKaVwpBM" } ] }, 
        { id: 2, title: "Quantum Field Theory", desc: "Advanced Physics", color: "text-cyan-400 border-cyan-500/30", links: [ { label: "Amazon", url: "https://a.co/d/gR8mRuz" }, { label: "Pothi", url: "https://store.pothi.com/book/abhishek-kumar-quantum-field-theory-3/" } ] }, 
        { id: 3, title: "Planetary Motion", desc: "Gravity Dynamics", color: "text-blue-400 border-blue-500/30", links: [ { label: "Amazon", url: "https://amzn.in/d/9HdcrQx" }, { label: "Flipkart", url: "https://www.flipkart.com/gravity-planetary-motion/p/itm84b6b08e673e0" } ] }, 
        { id: 4, title: "Relativity: Speed of Light", desc: "Special Relativity", color: "text-amber-400 border-amber-500/30", links: [ { label: "Amazon", url: "https://amzn.in/d/36O230l" }, { label: "Flipkart", url: "https://dl.flipkart.com/s/pO6BTiuuuN" } ] } 
    ];
    
    const YOUTUBE_VIDEOS = [ { id: "OSpU_nuSSQQ", title: "Concept of Angle: Introduction", url: "https://youtu.be/OSpU_nuSSQQ?si=HsnScqm9XnpgNmPx" }, { id: "FzBTUK1d3qk", title: "Degree and Radian: Nakshatra Prediction", url: "https://youtu.be/FzBTUK1d3qk?si=mBxve68JnzsmZYji" } ];

    return (
        <ToastProvider>
            <div className={`flex flex-col h-full bg-transparent text-slate-200 font-sans transition-all duration-300 ${mode==='board'?'scale-100':'scale-100'}`}>
                {/* HEADER */}
                <header className="glass-panel border-b border-white/5 px-4 py-4 flex justify-between items-center shrink-0 sticky top-0 z-30">
                    <div className="flex items-center gap-3 cursor-pointer" onClick={() => { setView('home'); vibrate(); }}>
                        <div className="w-8 h-8 rounded bg-gradient-to-br from-blue-600 to-cyan-500 text-white flex items-center justify-center font-bold shadow-[0_0_15px_rgba(37,99,235,0.5)]">K</div>
                        <span className="font-bold text-white tracking-widest font-display text-lg">KALA-SIMUX</span>
                    </div>
                    <button onClick={() => { setMenu(true); vibrate(); }} className="p-2 text-cyan-400 hover:text-white transition hover:drop-shadow-[0_0_5px_cyan]"><Icons.Menu /></button>
                </header>

                {/* SIDE MENU */}
                <div className={`fixed inset-0 z-50 bg-black/80 backdrop-blur-sm transition-opacity ${menu ? 'opacity-100' : 'opacity-0 pointer-events-none'}`} onClick={() => setMenu(false)}>
                    <div className={`absolute right-0 top-0 bottom-0 w-72 glass-panel border-l border-white/10 shadow-2xl p-6 transition-transform duration-300 ${menu ? 'translate-x-0' : 'translate-x-full'}`} onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-8"><h2 className="font-bold text-xl font-display text-cyan-400">ACCESS</h2><button onClick={() => setMenu(false)} className="text-slate-400 hover:text-white"><Icons.Close /></button></div>
                        <div className="text-center mb-6"> <div className="w-20 h-20 bg-slate-800 border border-cyan-500/50 text-cyan-400 rounded-full mx-auto flex items-center justify-center mb-3 shadow-[0_0_20px_rgba(6,182,212,0.2)]"><Icons.User /></div> <h3 className="font-bold text-lg text-white font-display">{PROFILE.name}</h3> <p className="text-sm text-cyan-500/80">{PROFILE.role}</p> </div>
                        <div className="space-y-3 text-sm text-slate-400 font-mono">{PROFILE.details.map((d, i) => <div key={i} className="pl-3 border-l-2 border-cyan-800">{d}</div>)}</div>
                        <div className="mt-8 pt-4 border-t border-white/10 text-center">
                            <span className="text-[10px] text-green-500 font-mono uppercase tracking-widest">System v22.0 ({mode.toUpperCase()})</span>
                        </div>
                    </div>
                </div>

                {/* MAIN CONTENT */}
                <main className="flex-1 overflow-y-auto scroller p-4 pb-28 relative z-10">
                    {view === 'home' && (
                        <div className="space-y-8 animate-in fade-in duration-500">
                            <div className="relative p-6 rounded-2xl glass-card overflow-hidden border border-white/10 group">
                                <div className="absolute top-0 right-0 w-32 h-32 bg-cyan-500/20 blur-[50px] rounded-full -mr-10 -mt-10"></div>
                                <div className="relative z-10 text-center"> <h1 className="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-500 font-display mb-2 drop-shadow-[0_0_10px_rgba(6,182,212,0.3)]">KALA-SIMUX</h1> <p className="text-xs text-cyan-200/70 font-mono tracking-wider">FROM MOTION WE MEASURE TIME<br/>WITH TIME WE SIMULATE MOTION</p> </div>
                            </div>
                            <div>
                                <h3 className="font-bold text-slate-500 mb-4 text-xs uppercase tracking-[0.2em] font-display pl-2">Simulation Modules</h3>
                                <div className={`grid ${mode === 'board' ? 'grid-cols-2 gap-6' : 'grid-cols-1 gap-3'}`}> {SIMS.map(s => ( <button key={s.id} onClick={() => { setSim(s.id); setView('sim'); vibrate(); audio.init(); }} className="group glass-card p-4 rounded-xl flex items-center gap-4 text-left hover:border-cyan-500/50 hover:shadow-[0_0_15px_rgba(6,182,212,0.15)] relative overflow-hidden transition-all active:scale-95"> <div className="absolute inset-0 bg-gradient-to-r from-cyan-500/10 to-transparent opacity-0 group-hover:opacity-100 transition duration-500"></div> <div className={`w-12 h-12 rounded-lg flex items-center justify-center shrink-0 ${s.iconBg} ${s.color} border border-white/5`}> {s.id === 'quantum' ? <Icons.Quantum /> : s.id === 'wave' ? <Icons.Wave /> : <Icons.Atom />} </div> <div className="relative z-10"> <div className="font-bold text-slate-100 font-display text-sm group-hover:text-cyan-300 transition">{s.title}</div> <div className="text-[10px] text-slate-400 font-mono">{s.desc}</div> </div> <div className="ml-auto text-slate-600 group-hover:text-cyan-400 transition transform group-hover:translate-x-1">â†’</div> </button> ))} </div>
                            </div>
                        </div>
                    )}
                    
                    {view === 'sim' && (
                        <div className="animate-in slide-in-from-bottom duration-500">
                            <button onClick={() => { setView('home'); vibrate(); }} className="flex items-center gap-2 text-cyan-500 mb-4 font-bold text-xs uppercase tracking-widest hover:text-cyan-300 transition"><Icons.Back /> Return to Hub</button>
                            <h2 className="text-xl font-bold text-white mb-2 font-display uppercase tracking-wider">{SIMS.find(s=>s.id===sim)?.title}</h2>
                            <div className="rounded-xl overflow-hidden border border-white/10 shadow-2xl shadow-black/50 bg-black/40"> 
                                {sim === 'orbit' ? <ODESolver /> : 
                                 sim === 'em' ? <EMSolver /> : 
                                 sim === 'thermo' ? <ThermoSolver /> : 
                                 sim === 'wave' ? <WaveSolver /> : 
                                 sim === 'quantum' ? <QuantumSolver /> :
                                 sim === 'optics' ? <RayOpticsSolver /> :
                                 sim === 'relativity' ? <RelativitySolver /> :
                                 sim === 'maxwell' ? <MaxwellSolver /> : // <--- ADD THIS LINE 
                                 <SimCanvasFallback type={sim} />} 
                            </div>
                        </div>
                    )}
                    
                    {view === 'books' && (
                        <div className="space-y-8 animate-in fade-in duration-500">
                            <div className="space-y-4">
                                <h2 className="font-bold text-xl text-white font-display border-l-4 border-purple-500 pl-3">Archives & Texts</h2>
                                {BOOKS.map(b => ( <div key={b.id} className={`glass-card rounded-xl p-4 flex gap-4 border ${b.color} border-opacity-20 hover:border-opacity-60 transition`}> <div className="w-16 h-20 bg-slate-900/50 rounded flex items-center justify-center shrink-0 border border-white/10"> <div className={b.color.split(' ')[0]}><Icons.Book /></div> </div> <div className="flex-1 flex flex-col"> <h3 className="font-bold text-slate-100 font-display text-sm">{b.title}</h3> <p className="text-[10px] text-slate-400 mt-1 mb-3 font-mono">{b.desc}</p> <div className="mt-auto flex gap-2"> {b.links.map((link, i) => ( <a key={i} href={link.url} target="_blank" className="flex-1 bg-white/5 hover:bg-white/10 text-cyan-400 text-[9px] font-bold py-1.5 px-2 rounded border border-white/10 text-center uppercase tracking-wider transition"> {link.label} </a> ))} </div> </div> </div> ))}
                            </div>
                            <div className="space-y-4">
                                <h2 className="font-bold text-xl text-white font-display border-l-4 border-red-500 pl-3 flex items-center gap-2"> Data Feeds </h2>
                                {YOUTUBE_VIDEOS.map(v => ( <a key={v.id} href={v.url} target="_blank" className="block glass-card rounded-xl overflow-hidden group border border-white/10 hover:border-red-500/50 transition relative"> <div className="relative aspect-video bg-black"> <img src={`https://img.youtube.com/vi/${v.id}/mqdefault.jpg`} alt={v.title} className="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition duration-500" /> <div className="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent"></div> <div className="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition duration-300"> <div className="w-12 h-12 bg-red-600/90 rounded-full flex items-center justify-center text-white shadow-[0_0_20px_rgba(220,38,38,0.6)] backdrop-blur"> <Icons.Play /> </div> </div> </div> <div className="p-3"> <h3 className="font-bold text-slate-200 text-xs leading-tight font-display line-clamp-2 group-hover:text-red-400 transition">{v.title}</h3> <div className="mt-2 flex items-center gap-2 text-[9px] text-slate-500 font-bold uppercase tracking-widest font-mono"> <span className="w-1.5 h-1.5 rounded-full bg-red-500 animate-pulse"></span> Live Feed </div> </div> </a> ))}
                            </div>
                        </div>
                    )}
                </main>

                {/* FLOATING DOCK */}
                <div className="fixed bottom-6 left-0 right-0 flex justify-center z-40 pointer-events-none">
                    <nav className={`glass-panel rounded-full px-6 py-2 flex items-center gap-8 pointer-events-auto border border-white/10 shadow-[0_10px_30px_rgba(0,0,0,0.5)] ${mode==='board'?'scale-125':''}`}>
                        <button onClick={() => { setView('home'); vibrate(); }} className={`flex flex-col items-center gap-1 p-2 transition duration-300 ${view!=='books'?'text-cyan-400 scale-110 drop-shadow-[0_0_8px_cyan]':'text-slate-500 hover:text-slate-300'}`}> <Icons.Lab /> <span className="text-[8px] font-bold uppercase tracking-widest font-display">Sims</span> </button>
                        <div className="w-px h-8 bg-white/10"></div>
                        <button onClick={() => { setView('books'); vibrate(); }} className={`flex flex-col items-center gap-1 p-2 transition duration-300 ${view==='books'?'text-purple-400 scale-110 drop-shadow-[0_0_8px_purple]':'text-slate-500 hover:text-slate-300'}`}> <Icons.Book /> <span className="text-[8px] font-bold uppercase tracking-widest font-display">Data</span> </button>
                    </nav>
                </div>
            </div>
        </ToastProvider>
    );
};

const root = ReactDOM.createRoot(document.getElementById('root')); 
root.render(<App />);
</script>
</body>
</html>

